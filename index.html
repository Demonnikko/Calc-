<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<meta content="#000000" name="theme-color"/>
<meta content="dark" name="color-scheme"/>
<meta content="yes" name="mobile-web-app-capable"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Kostyuk CRM" name="apple-mobile-web-app-title"/>
<meta content="telephone=no" name="format-detection"/>
<link href="manifest.webmanifest" rel="manifest"/>
<title>Kostyuk Event CRM</title>
<style>
        /* --- iOS SYSTEM THEME (PLATINUM) --- */
        :root {
            color-scheme: dark;
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --bg-input: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent: #0A84FF;
            --accent-gold: #D4AF37;
            --calendar-red: #FF453A;
            --danger: #FF453A;
            --success: #30D158;
            --separator: #38383A;
            --safe-top: env(safe-area-inset-top);
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- TABS (MENU) FIX --- */
        .tabs {
            position: absolute; /* –í–Ω—É—Ç—Ä–∏ app-shell —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ fixed */
            left: 0; right: 0; bottom: 0;
            height: var(--tabs-total);
            background: rgba(28, 28, 30, 0.95); /* –ß—É—Ç—å –º–µ–Ω–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(255,255,255,0.15);
            padding-top: 6px;
            padding-bottom: var(--safe-bottom);
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
            display: flex; 
            justify-content: space-around; 
            align-items: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∏ –±—ã–ª–∏ –Ω–∞ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
            z-index: 1000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            touch-action: none; /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –Ω–∞ —Å–∞–º–æ–º –º–µ–Ω—é */
        }
        .tab-btn {
            flex: 1; 
            padding: 4px 0 2px; 
            text-align: center; 
            color: var(--text-secondary);
            font-size: 10px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .tab-btn svg { 
            width: 26px; 
            height: 26px; 
            margin-bottom: 4px; 
            display: block; 
            flex-shrink: 0; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∂–∞—Ç–∏–µ –∏–∫–æ–Ω–∫–∏ */
        }
        .tab-btn.active { color: var(--accent); }

        /* --- VIEWS --- */
        .view { display: none; width: 100%; padding-bottom: 40px; }
        .view.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HEADER --- */
        .header{
            padding: 10px calc(16px + var(--safe-right)) 20px calc(16px + var(--safe-left));
            display: flex; justify-content: space-between; align-items: center; 
        }
        .header h1 { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
        .header p { font-size: 13px; color: var(--text-secondary); margin-top: 2px; font-weight: 500; }

        /* --- FORMS & INPUTS --- */
        .section-title { 
            margin: 24px 16px 8px; font-size: 13px; color: var(--text-secondary); 
            text-transform: uppercase; letter-spacing: -0.2px; padding-left: 12px;
        }
        .group-container { 
            margin: 0 16px; background: var(--bg-card); border-radius: 12px; overflow: hidden; 
        }
        
        .input-row {
            position: relative; display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; border-bottom: 0.5px solid var(--separator); min-height: 50px;
        }
        .input-row:last-child { border-bottom: none; }
        .input-row:active { background: #252527; }
        
        .label { font-size: 17px; color: var(--text-primary); flex-shrink: 0; }
        
        .value-wrapper { display: flex; align-items: center; gap: 8px; flex-grow: 1; justify-content: flex-end; overflow: hidden; }
        .value-display { 
            font-size: 17px; color: var(--text-secondary); text-align: right; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .value-display.filled { color: var(--accent); }
        .chevron { color: #555; width: 14px; height: 14px; opacity: 0.5; }

        .native-control { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer; font-size: 16px; z-index: 10;
        }
        
        .text-input { 
            background: transparent; border: none; color: #fff; font-size: 17px; 
            text-align: right; outline: none; width: 100%; 
        }
        .text-input::placeholder { color: var(--text-secondary); }

        /* --- CONTROLS --- */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #39393D; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: #30D158; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- CART --- */
        .service-adder { display: flex; align-items: center; border-top: 0.5px solid var(--separator); }
        .qty-control { display: flex; align-items: center; padding: 0 4px; border-right: 0.5px solid var(--separator); background: #252527; }
        .qty-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--accent); cursor: pointer; }
        .qty-val { width: 28px; text-align: center; font-weight: 600; font-size: 17px; }
        .btn-add-service { 
            flex-grow: 1; background: var(--bg-card); color: var(--accent); 
            font-weight: 600; text-align: center; padding: 14px; font-size: 17px; cursor: pointer; 
        }
        .btn-add-service:active { opacity: 0.7; background: #2c2c2e; }

        .cart-list { margin: 12px 16px 0; display: flex; flex-direction: column; gap: 8px; }
        .cart-item { 
            background: var(--bg-card); padding: 12px 16px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(-5px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .cart-info { flex-grow: 1; }
        .cart-name { font-size: 16px; font-weight: 500; color: #fff; margin-bottom: 2px; }
        .cart-price { font-size: 14px; color: var(--text-secondary); }
        .btn-remove { 
            width: 32px; height: 32px; border-radius: 50%; background: rgba(255,69,58,0.15); 
            color: var(--danger); display: flex; align-items: center; justify-content: center; 
            font-size: 20px; margin-left: 12px; cursor: pointer; 
        }

        /* --- TOTAL PANEL --- */
        .total-panel { 
            margin: 24px 16px 0; padding: 20px; background: var(--bg-card); border-radius: 16px; 
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;
        }
        .total-label { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 4px; }
        .total-sum { font-size: 44px; font-weight: 800; color: var(--accent-gold); line-height: 1; letter-spacing: -1px; margin-bottom: 12px; }
        
        .btn-main { 
            display: flex; width: 100%; background: var(--text-primary); color: #000; 
            font-size: 17px; font-weight: 600; padding: 16px; border-radius: 14px; 
            border: none; cursor: pointer; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.97); opacity: 0.9; }

        .discount-badge { color: var(--success); font-size: 13px; font-weight: 600; margin-bottom: 8px; display: none; }
        .bonus-banner { 
            background: linear-gradient(90deg, #252527, #303033); border: 1px solid rgba(212,175,55,0.3); 
            color: var(--accent-gold); font-size: 13px; font-weight: 600; padding: 12px; 
            border-radius: 10px; margin-bottom: 16px; display: none; text-align: left;
        }

        /* --- SETTINGS --- */
        .btn-add { width: 100%; padding: 14px; text-align: center; color: var(--accent); font-weight: 600; font-size: 16px; background: var(--bg-card); border-top: 0.5px solid var(--separator); cursor: pointer; }
        .btn-add:active { background: #2c2c2e; }
        
        .settings-block { margin-bottom: 16px; background: var(--bg-card); border-radius: 12px; overflow: hidden; }
        .settings-header { 
            padding: 14px 16px; background: #252527; font-weight: 600; color: var(--accent); 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .settings-header .toggle-icon { transition: transform 0.2s; font-size: 12px; }
        .settings-content { display: none; }
        .settings-content.open { display: block; }
        
        .set-row { display: flex; padding: 10px 16px; border-bottom: 0.5px solid var(--separator); align-items: center; gap: 10px; }
        .set-input-name { background: transparent; border: none; color: #fff; flex-grow: 1; font-size: 16px; border-bottom: 1px solid transparent; padding: 4px 0; outline: none; }
        .set-input-name:focus { border-bottom: 1px solid var(--accent); }
        .set-input-price { background: #333; border: none; border-radius: 6px; padding: 6px; color: #fff; width: 80px; text-align: right; font-size: 15px; outline: none; }
        .btn-del-item { color: var(--danger); font-size: 24px; width: 30px; text-align: center; cursor: pointer; line-height: 20px; }

        .btn-reset { margin: 30px 16px; padding: 14px; text-align: center; color: var(--danger); border: 1px solid var(--danger); border-radius: 12px; font-weight: 600; cursor: pointer; }

        /* --- UTILS --- */
        .badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px; display: none; }
        .toast { 
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px); 
            background: rgba(50,50,50,0.9); backdrop-filter: blur(10px); color: #fff; 
            padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 14px; 
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 600; display: flex; align-items: center; gap: 8px; 
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .edit-input, .text-input, select.native-control, input.native-control {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,.10);
            border-radius: 10px;
            padding: 10px 12px;
            outline: none;
        }
        .edit-input:focus, .text-input:focus, select.native-control:focus, input.native-control:focus {
            border-color: rgba(10,132,255,.55);
            box-shadow: 0 0 0 3px rgba(10,132,255,.18);
        }

        .btn-add-item, .btn-delete-hist {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
        }
        .btn-add-item:active { transform: scale(.98); }

        /* --- v14 Polish --- */
        :root{
            --radius-card: 14px;
            --hairline: rgba(255,255,255,.14);
            --shadow-card: 0 6px 24px rgba(0,0,0,.35);
        }
        body{ user-select: text; -webkit-text-size-adjust: 100%; }
        .tab-btn, .btn-main, .qty-btn, .btn-add-service, .btn-remove, .btn-del-item, .btn-add, .settings-header, .btn-reset {
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }
        .group-container, .cart-item, .total-panel, .settings-block { border-radius: var(--radius-card); }
        .group-container { box-shadow: 0 1px 0 rgba(255,255,255,.04) inset; }
        .total-panel { box-shadow: var(--shadow-card); }
        .input-row { border-bottom: none; }
        .input-row::after {
            content:""; position:absolute; left:16px; right:0; bottom:0; height:0.5px;
            background: var(--separator); opacity:.9;
        }
        .input-row:last-child::after { display:none; }
        .input-row:active { background: rgba(255,255,255,.04); }
        .section-title { text-transform: uppercase; letter-spacing: .9px; font-size: 12px; margin-top: 22px; opacity: .9; }
        .tabs { background: rgba(28,28,30,.78); border-top: 0.5px solid var(--hairline); }
        .tab-btn { font-size: 11px; padding: 8px 0 4px; }
        .tab-btn svg { width: 24px; height: 24px; margin-bottom: 3px; opacity: .92; }
        .tab-btn.active { color: var(--accent); }
        .tab-btn:active { transform: scale(.98); opacity: .85; }
        .header h1 { letter-spacing: -0.8px; }
        .header p { opacity: .9; }
        .btn-main {
            background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0)), var(--accent);
            color: #fff; box-shadow: 0 8px 18px rgba(10,132,255,.25);
        }
        .btn-main:active { transform: scale(.98); opacity: .95; }

        /* === v36: SINGLE iOS/PWA ADAPTATION === */
        :root{
            --vvh: 100vh; --vv-offset: 0px; --kb: 0px; --tabs-h: 64px;
            --tabs-total: calc(var(--tabs-h) + var(--safe-bottom));
        }
        html, body{ height: 100%; width: 100%; overflow: hidden !important; background: var(--bg-body); }
        body{ padding-top: 0 !important; padding-bottom: 0 !important; min-height: 0 !important; }
        #app-shell{
            position: fixed; left: 0; right: 0; top: var(--vv-offset, 0px); height: var(--vvh, 100vh);
            overflow: hidden; background: var(--bg-body);
        }
        #app-scroll{
            position: absolute; left: 0; right: 0; top: 0; bottom: var(--tabs-total);
            overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
            padding-top: calc(var(--safe-top) + 10px); padding-bottom: 16px;
        }
        #app-shell .view { padding-bottom: 18px !important; min-height: calc(var(--vvh, 100vh) - var(--tabs-total)) !important; }
        @media (pointer: coarse){
            button, .btn { min-height: 44px; }
            .tab { min-height: 44px; }
        }
</style>
</head>
<body>
<div id="app-shell">
<div id="app-scroll">

<!-- 1. –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† -->
<div class="view active" id="view-calc">
<div class="header">
<div><h1>Kostyuk CRM</h1><p>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–ü</p></div>
</div>
<div class="group-container" style="margin-bottom: 20px;">
<div class="input-row">
<div class="label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</div>
<input class="text-input" id="inp-client" placeholder="–ò–≤–∞–Ω" type="text"/>
</div>
<div class="input-row">
<div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
<input class="text-input" id="inp-phone" placeholder="8 9..." type="tel"/>
</div>
<div class="input-row">
<div class="label">–°—Ç–∞—Ç—É—Å</div>
<div class="value-wrapper"><div class="value-display" id="disp-status">–ò–Ω—Ç–µ—Ä–µ—Å</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" id="inp-status" onchange="App.updateStatus()">
<option selected="" value="new">–ò–Ω—Ç–µ—Ä–µ—Å (–°–ø—Ä–æ—Å–∏–ª)</option>
<option value="think">–î—É–º–∞–µ—Ç</option>
<option value="deposit">–ë—Ä–æ–Ω—å (–û–ø–ª–∞—á–µ–Ω–æ)</option>
<option value="cancel">–û—Ç–∫–∞–∑</option>
</select>
</div>
<div class="input-row">
<div class="label">–°–æ–±—ã—Ç–∏–µ</div>
<div class="value-wrapper"><div class="value-display" id="disp-event-type">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" id="inp-event-type" onchange="App.updateEventType()">
<option disabled="" selected="" value="">–¢–∏–ø</option><option value="–°–≤–∞–¥—å–±–∞">–°–≤–∞–¥—å–±–∞</option><option value="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤</option><option value="–Æ–±–∏–ª–µ–π">–Æ–±–∏–ª–µ–π</option><option value="–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è">–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è</option><option value="–î–µ—Ç—Å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫">–î–µ—Ç—Å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫</option><option value="–í–µ—á–µ—Ä–∏–Ω–∫–∞">–í–µ—á–µ—Ä–∏–Ω–∫–∞</option><option value="–í—ã–ø—É—Å–∫–Ω–æ–π">–í—ã–ø—É—Å–∫–Ω–æ–π</option><option value="–ß–∞—Å—Ç–Ω–æ–µ">–ß–∞—Å—Ç–Ω–æ–µ</option>
</select>
</div>
</div>
<div class="section-title">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</div>
<div class="group-container">
<div class="input-row" style="flex-direction:column; align-items:stretch;">
<div style="display:flex; justify-content:space-between; align-items:center; width: 100%;">
<div class="label flex items-center">–î–∞—Ç–∞ <span class="badge" id="badge-holiday"></span></div>
<div class="value-wrapper"><div class="value-display" id="disp-date">–°–µ–≥–æ–¥–Ω—è</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
</div>
<input class="native-control" id="inp-date" onchange="App.updateDate()" type="date"/>
</div>
<div class="input-row">
<div class="label">–í—Ä–µ–º—è</div>
<input class="text-input" id="inp-time" type="time" value="18:00"/>
</div>
<div class="input-row">
<div class="label">–†–µ–≥–∏–æ–Ω</div>
<div class="value-wrapper"><div class="value-display" id="disp-region">–ù–µ –≤—ã–±—Ä–∞–Ω</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" id="inp-region" onchange="App.updateRegion()"></select>
</div>
<div class="input-row">
<div class="label">–ì–æ—Ä–æ–¥</div>
<div class="value-wrapper"><div class="value-display" id="disp-city">...</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" disabled="" id="inp-city" onchange="App.updateCity()"></select>
</div>
</div>
<div class="section-title">–£—Å–ª—É–≥–∏</div>
<div class="group-container">
<div class="input-row">
<div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
<div class="value-wrapper"><div class="value-display" id="disp-cat">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" id="inp-cat" onchange="App.updateCat()"></select>
</div>
<div class="input-row">
<div class="label">–£—Å–ª—É–≥–∞</div>
<div class="value-wrapper"><div class="value-display" id="disp-svc">...</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" disabled="" id="inp-svc"></select>
</div>
<div class="service-adder">
<div class="qty-control">
<div class="qty-btn" onclick="App.changeQty(-1)">-</div>
<div class="qty-val" id="svc-qty">1</div>
<div class="qty-btn" onclick="App.changeQty(1)">+</div>
</div>
<div class="btn-add-service" onclick="App.addService()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</div>
</div>
</div>
<div class="cart-list" id="cart-list"></div>
<div class="section-title">–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã / –ì–æ—Å—Ç–∏</div>
<div class="group-container">
<div style="display:flex; padding:12px 16px; gap:10px; border-bottom:0.5px solid var(--separator);">
<input class="edit-input" id="inp-manual-name" oninput="App.calc()" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ø–∞" type="text"/>
<input class="edit-input" id="inp-manual-price" oninput="App.calc()" placeholder="‚ÇΩ" style="width:90px; text-align:right;" type="number"/>
</div>
<div class="input-row">
<div class="label">–ì–æ—Å—Ç–∏</div>
<div class="value-wrapper"><div class="value-display" id="disp-guests">–î–æ 50 (0‚ÇΩ)</div><svg class="chevron" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div>
<select class="native-control" id="inp-guests" onchange="App.updateGuests()">
<option value="0">–î–æ 50 —á–µ–ª–æ–≤–µ–∫ (0‚ÇΩ)</option>
<option value="5000">51‚Äì100 —á–µ–ª–æ–≤–µ–∫ (+5 000‚ÇΩ)</option>
<option value="10000">101‚Äì200 —á–µ–ª–æ–≤–µ–∫ (+10 000‚ÇΩ)</option>
<option value="custom">–ë–æ–ª–µ–µ 200 (–°–ª–∞–π–¥–µ—Ä)</option>
</select>
</div>
</div>
<div class="slider-wrap" id="slider-wrap" style="display:none; margin:10px 16px; background:var(--bg-card); padding:16px; border-radius:12px;">
<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:10px; color:#888;"><span>–¢–û–ß–ù–û–ï –ß–ò–°–õ–û</span><span id="slider-val" style="color:#fff;">250</span></div>
<input id="inp-slider" max="500" min="201" oninput="App.calc()" step="5" style="width:100%;" type="range" value="250"/>
</div>
<!-- –ò–¢–û–ì -->
<div class="total-panel">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #333;">
<span style="font-size:15px; color:#fff;">–†–∞–±–æ—Ç–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É (+6%)</span>
<label class="switch">
<input id="inp-tax" onchange="App.calc()" type="checkbox"/>
<span class="slider"></span>
</label>
</div>
<div class="bonus-banner" id="bonus-alert"></div>
<div class="discount-badge" id="discount-badge">‚úÖ –°–∫–∏–¥–∫–∞ 10% –∑–∞ –æ–±—ä–µ–º</div>
<div class="total-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å–º–µ—Ç–∞</div>
<div class="total-sum" id="total-sum">0 ‚ÇΩ</div>
<button class="btn-main" onclick="App.copy()">
<svg fill="none" height="20" stroke="currentColor" viewbox="0 0 24 24" width="20"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
                –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ö–ü
            </button>
</div>
</div>

<!-- 4. –ù–ê–°–¢–†–û–ô–ö–ò (FIXED) -->
<div class="view" id="view-settings">
<div class="header"><h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
<div class="section-title">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ (–ì–æ—Ä–æ–¥–∞)</div>
<div id="settings-travel-list" style="margin: 0 16px;"></div>
<div style="margin: 10px 16px;"><div class="btn-add" onclick="Admin.addRegion()">+ –î–æ–±–∞–≤–∏—Ç—å –†–µ–≥–∏–æ–Ω</div></div>
<div class="section-title">–£—Å–ª—É–≥–∏</div>
<div id="settings-services-list" style="margin: 0 16px;"></div>
<div style="margin: 10px 16px;"><div class="btn-add" onclick="Admin.addCategory()">+ –î–æ–±–∞–≤–∏—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é</div></div>
<div class="section-title">–ö–ü: —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ —Å—Å—ã–ª–∫–∏</div>
<div class="settings-block" style="margin: 0 16px;">
<div class="settings-header" onclick="Admin.toggleSection(this)">
<span>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –±—Ä–æ–Ω–∏</span>
<span class="toggle-icon">‚ñº</span>
</div>
<div class="settings-content open">
<div id="settings-payments-list"></div>
<div class="btn-add" onclick="Admin.addPayment()">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</div>
</div>
</div>
<div class="settings-block" style="margin: 0 16px;">
<div class="settings-header" onclick="Admin.toggleSection(this)">
<span>–°—Å—ã–ª–∫–∏ (–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ / —Å–æ—Ü—Å–µ—Ç–∏ / –æ—Ç–∑—ã–≤—ã)</span>
<span class="toggle-icon">‚ñº</span>
</div>
<div class="settings-content open">
<div id="settings-links-list"></div>
<div class="btn-add" onclick="Admin.addLink()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</div>
</div>
</div>
<div class="section-title">–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ–∫—É—Å–Ω–∏–∫–∞</div>
<div class="settings-block" style="margin: 0 16px;">
<div class="input-row"><div class="label">–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞</div><input class="text-input" id="cfg-performer" placeholder="–ù–∞–ø—Ä. –î–º–∏—Ç—Ä–∏–π –ö–æ—Å—Ç—é–∫"/></div>
<div class="input-row"><div class="label">–ó–∞–¥–∞—Ç–æ–∫ (%)</div><input class="text-input" id="cfg-deposit" placeholder="30" type="number"/></div>
</div>
<div class="section-title">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã</div>
<div class="settings-block" style="margin: 0 16px;">
<div class="settings-header" onclick="Admin.toggleSection(this)">
<span>–ü—Ä–∞–∑–¥–Ω–∏–∫–∏ (–≥–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)</span>
<span class="toggle-icon">‚ñº</span>
</div>
<div class="settings-content open">
<div style="padding: 12px 16px; font-size: 12px; color: var(--text-secondary); line-height:1.3;">
                    –§–æ—Ä–º–∞—Ç –¥–∞—Ç: <b>–ú–ú-–î–î</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12-31). –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–º–Ω–æ–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å–º–µ—Ç—É –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã/–ø–µ—Ä–∏–æ–¥—ã.
                </div>
<div class="section-title" style="margin: 8px 16px 8px;">–¢–æ—á–Ω—ã–µ –¥–∞—Ç—ã</div>
<div id="settings-holidays-list"></div>
<div class="btn-add" onclick="HolidayCfg.addHoliday()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</div>
<div class="section-title" style="margin: 16px 16px 8px;">–ü–µ—Ä–∏–æ–¥—ã</div>
<div id="settings-holidayranges-list"></div>
<div class="btn-add" onclick="HolidayCfg.addRange()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥</div>
</div>
</div>
<div class="btn-reset" onclick="Admin.resetAll()">‚ö†Ô∏è –°–±—Ä–æ—Å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</div>
</div>

<div class="toast" id="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>

<script>
    // --- DB INIT ---
    const DEFAULT_DB = {
        travel: {
            "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è": { fee: 1000, cities: {"–Ø—Ä–æ—Å–ª–∞–≤–ª—å": 0, "–†—ã–±–∏–Ω—Å–∫": 2000, "–¢—É—Ç–∞–µ–≤": 2000, "–£–≥–ª–∏—á": 2000, "–†–æ—Å—Ç–æ–≤": 2000, "–ü–µ—Ä–µ—Å–ª–∞–≤–ª—å-–ó–∞–ª–µ—Å—Å–∫–∏–π": 2000, "–ì–∞–≤—Ä–∏–ª–æ–≤-–Ø–º": 2000, "–î–∞–Ω–∏–ª–æ–≤": 2000, "–ü–æ—à–µ—Ö–æ–Ω—å–µ": 4000, "–ú—ã—à–∫–∏–Ω": 2000, "–õ—é–±–∏–º": 2000} },
            "–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è": { fee: 3000, cities: {"–ö–æ—Å—Ç—Ä–æ–º–∞": 2000, "–í–æ–ª–≥–æ—Ä–µ—á–µ–Ω—Å–∫": 2000, "–ë—É–π": 3000, "–ù–µ—Ä–µ—Ö—Ç–∞": 2000, "–®–∞—Ä—å—è": 6000, "–ú–∞–Ω—Ç—É—Ä–æ–≤–æ": 5500, "–ì–∞–ª–∏—á": 3500} },
            "–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è": { fee: 5000, cities: {"–ò–≤–∞–Ω–æ–≤–æ": 2000, "–ü–ª–µ—Å": 3000, "–ö–∏–Ω–µ—à–º–∞": 3500, "–®—É—è": 3000, "–¢–µ–π–∫–æ–≤–æ": 2500, "–ö–æ—Ö–º–∞": 2500, "–í–∏—á—É–≥–∞": 3000, "–§—É—Ä–º–∞–Ω–æ–≤": 2500, "–†–æ–¥–Ω–∏–∫–∏": 3000, "–ü—Ä–∏–≤–æ–ª–∂—Å–∫": 2000, "–Æ–∂–∞": 4000} },
            "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è": { fee: 10000, cities: {"–í–ª–∞–¥–∏–º–∏—Ä": 10000, "–°—É–∑–¥–∞–ª—å": 10000, "–ö–æ–≤—Ä–æ–≤": 10000, "–ú—É—Ä–æ–º": 17000, "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤": 10000, "–ì—É—Å—å-–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π": 13500} },
            "–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è": { fee: 9000, cities: {"–í–æ–ª–æ–≥–¥–∞": 9000, "–ß–µ—Ä–µ–ø–æ–≤–µ—Ü": 15000, "–°–æ–∫–æ–ª": 12000} },
            "–ú–æ—Å–∫–≤–∞ –∏ –ú–û": { fee: 15000, cities: {"–ú–æ—Å–∫–≤–∞": 15000, "–•–∏–º–∫–∏": 15000, "–ë–∞–ª–∞—à–∏—Ö–∞": 15000} }
        },
        services: {
            "–î–µ—Ç—Å–∫–∏–µ —à–æ—É": { "–î–µ—Ç—Å–∫–æ–µ —à–æ—É (30 –º–∏–Ω)": 11250, "–î–µ—Ç—Å–∫–æ–µ —à–æ—É (40 –º–∏–Ω)": 13750, "–ò–Ω–¥–∏–≤. –¥–µ—Ç—Å–∫–æ–µ —à–æ—É": 21250 },
            "–í–∑—Ä–æ—Å–ª—ã–µ —à–æ—É": { "–®–æ—É (20 –º–∏–Ω)": 17500, "–®–æ—É (30 –º–∏–Ω)": 23750, "–®–æ—É (40 –º–∏–Ω)": 30000 },
            "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è": { "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (30 –º–∏–Ω)": 13000, "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (1 —á)": 20000, "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (2 —á)": 30000, "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (3 —á)": 36000 },
            "–°–ø–µ—Ü-–ø—Ä–æ–µ–∫—Ç—ã": { "–°–≤–∞–¥—å–±–∞ (20 –º–∏–Ω)": 26250, "–°–≤–∞–¥—å–±–∞ (30 –º–∏–Ω)": 32500, "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ (20 –º–∏–Ω)": 26250, "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ (30 –º–∏–Ω)": 32500, "–Æ–±–∏–ª–µ–π (20 –º–∏–Ω)": 23750, "–Æ–±–∏–ª–µ–π (30 –º–∏–Ω)": 30000, "–í—ã–ø—É—Å–∫–Ω–æ–π (20 –º–∏–Ω)": 23750, "–í—ã–ø—É—Å–∫–Ω–æ–π (30 –º–∏–Ω)": 30000 },
            "–ö–æ–Ω—Ü–µ—Ä—Ç—ã": { "–ú–∏–Ω–∏-—à–æ—É –°–ï–ö–†–ï–¢ (1 —á)": 150000, "–°–ø–µ–∫—Ç–∞–∫–ª—å –°–ï–ö–†–ï–¢ (2 —á)": 300000 }
        },
        settings: { extraGuest: 80, holidays: {"12-31":2, "01-01":2, "02-23":1.5, "03-08":1.5}, holidayRanges: [{sm:12, sd:15, em:12, ed:30, k:1.5}] },
        payments: [
            { title: "–¢-–ë–ê–ù–ö", text: "8 909 276 33 86\n–î–º–∏—Ç—Ä–∏–π –ü–∞–≤–ª–æ–≤–∏—á –ö." }
        ],
        links: [
            { label: "–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ", url: "" }
        ]};

    let DB = {};

    // --- Date helpers ---
    const isoLocal = (d = new Date()) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
    };
    const parseISODate = (iso) => {
        if(!iso) return new Date();
        const parts = String(iso).split('-').map(n => parseInt(n,10));
        if(parts.length < 3 || parts.some(n => Number.isNaN(n))) return new Date(iso);
        const [y, m, d] = parts;
        return new Date(y, (m || 1) - 1, d || 1);
    };
    const esc = (v) => String(v ?? '').replace(/[&<>"'`]/g, ch => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '`':'&#96;'
    }[ch]));
    const copyTextToClipboard = async (text) => {
        try {
            if(navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch(e) {}
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly','');
            ta.style.position = 'fixed';
            ta.style.top = '-9999px';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch(e) { return false; }
    };
    let State = { date: isoLocal(), holidayK: 1, cart: [], bonus: "", discount: 0, serviceQty: 1, taxActive: false };
    
    // UI Helpers
    const el = (id) => document.getElementById(id);
    const fmt = (n) => n.toLocaleString('ru-RU') + ' ‚ÇΩ';
    const parseMoney = (v) => {
        const s = String(v ?? '').replace(/[^0-9]/g,'');
        return s ? parseInt(s,10) : 0;
    };
    const switchTab = (tab, btnEl) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+tab).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const btn = btnEl || document.querySelector(`.tab-btn[data-tab="${tab}"]`) || (typeof event !== 'undefined' ? event.currentTarget : null);
        if(btn && btn.classList) btn.classList.add('active');
    };

    // --- STORAGE ---
    const Storage = {
        load: () => {
            const saved = localStorage.getItem('kostyuk_crm_v10');
            if (saved) {
                try { DB = JSON.parse(saved); }
                catch(e) { DB = JSON.parse(JSON.stringify(DEFAULT_DB)); }
            } else {
                DB = JSON.parse(JSON.stringify(DEFAULT_DB));
            }
            if(!Array.isArray(DB.payments)) DB.payments = JSON.parse(JSON.stringify(DEFAULT_DB.payments || []));
            if(!Array.isArray(DB.links)) DB.links = JSON.parse(JSON.stringify(DEFAULT_DB.links || []));

            Admin.render();
            if(typeof HolidayCfg !== "undefined") HolidayCfg.render();
            App.init();
        },
        save: () => { localStorage.setItem('kostyuk_crm_v10', JSON.stringify(DB)); },
        reset: () => { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –±–∞–∑—É?')) { localStorage.removeItem('kostyuk_crm_v10'); location.reload(); } }
    };

    // --- APP LOGIC ---
    const App = {
        init: () => {
            el('inp-date').value = State.date;
            // Regions
            const rSel = el('inp-region'); rSel.innerHTML='<option disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ</option>';
            for(let r in DB.travel) rSel.add(new Option(r, r));
            // Categories
            const cSel = el('inp-cat'); cSel.innerHTML='<option disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ</option>';
            for(let c in DB.services) cSel.add(new Option(c, c));
            
            App.updateDate();
            
            const p = el('cfg-performer');
            if(p){
                p.value = (DB.touchCfg && DB.touchCfg.performer) ? DB.touchCfg.performer : '';
                p.oninput = () => { if(!DB.touchCfg) DB.touchCfg = { performer: '–§–æ–∫—É—Å–Ω–∏–∫', depositPercent: 30 }; DB.touchCfg.performer = p.value.trim() || '–§–æ–∫—É—Å–Ω–∏–∫'; Storage.save(); };
            }
            const d = el('cfg-deposit');
            if(d){
                d.value = (DB.touchCfg && typeof DB.touchCfg.depositPercent === 'number') ? DB.touchCfg.depositPercent : 30;
                d.oninput = () => { if(!DB.touchCfg) DB.touchCfg = { performer: '–§–æ–∫—É—Å–Ω–∏–∫', depositPercent: 30 }; DB.touchCfg.depositPercent = Math.max(0, Math.min(100, parseInt(d.value||'30')||30)); Storage.save(); };
            }
        },
        updateDate: () => {
            const val = el('inp-date').value; if(!val) return;
            State.date = val; const d = parseISODate(val);
            el('disp-date').innerText = d.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});
            el('disp-date').classList.add('filled');
            const m = d.getMonth()+1, day = d.getDate();
            const key = `${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            let k = 1;
            if(DB.settings.holidays[key]) k = DB.settings.holidays[key];
            else {
                const md = (d.getMonth()+1) * 100 + d.getDate();
                for(let r of DB.settings.holidayRanges) {
                    const sm = r.sm || 1, sd = r.sd || 1;
                    const em = r.em || sm, ed = r.ed || sd;
                    const start = sm * 100 + sd;
                    const end = em * 100 + ed;
                    const inRange = start <= end ? (md >= start && md <= end) : (md >= start || md <= end);
                    if(inRange) { k = HolidayCfg.parseK(r.k); break; }
                }
            }
            State.holidayK = k;
            el('badge-holiday').style.display = k > 1 ? 'inline-block' : 'none';
            el('badge-holiday').innerText = `x${k}`;
            App.calc();
        },
        updateRegion: () => {
            const r = el('inp-region').value; el('disp-region').innerText=r; el('disp-region').classList.add('filled');
            const cSel = el('inp-city'); cSel.innerHTML=''; cSel.disabled=false;
            for(let c in DB.travel[r].cities) cSel.add(new Option(c, c));
            cSel.add(new Option("–î—Ä—É–≥–æ–π", "other")); cSel.value="";
            el('disp-city').innerText="..."; el('disp-city').classList.remove('filled'); App.calc();
        },
        updateCity: () => { const v = el('inp-city').value; el('disp-city').innerText=v==='other'?'–î—Ä—É–≥–æ–π':v; el('disp-city').classList.add('filled'); App.calc(); },
        updateCat: () => {
            const c = el('inp-cat').value; el('disp-cat').innerText=c; el('disp-cat').classList.add('filled');
            const sSel = el('inp-svc'); sSel.innerHTML=''; sSel.disabled=false;
            for(let s in DB.services[c]) sSel.add(new Option(s, s)); sSel.value="";
            el('disp-svc').innerText="..."; el('disp-svc').classList.remove('filled');
        },
        updateEventType: () => { const v=el('inp-event-type').value; el('disp-event-type').innerText=v; el('disp-event-type').classList.add('filled'); },
        updateStatus: () => { 
            const s = el('inp-status').value;
            const names = {'new':'–°–ø—Ä–æ—Å–∏–ª', 'think':'–î—É–º–∞–µ—Ç', 'deposit':'–ë—Ä–æ–Ω—å', 'cancel':'–û—Ç–∫–∞–∑'};
            el('disp-status').innerText = names[s]; el('disp-status').classList.add('filled');
        },
        changeQty: (d) => { let q=State.serviceQty+d; if(q<1)q=1; State.serviceQty=q; el('svc-qty').innerText=q; },
        addService: () => {
            const cat = el('inp-cat').value, svc = el('inp-svc').value;
            if(!cat || !svc) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É!");
            State.cart.push({ name: svc, price: DB.services[cat][svc], qty: State.serviceQty });
            State.serviceQty=1; el('svc-qty').innerText=1;
            el('disp-svc').innerText="..."; el('disp-svc').classList.remove('filled'); el('inp-svc').value="";
            App.renderCart(); App.calc();
        },
        removeService: (i) => { State.cart.splice(i,1); App.renderCart(); App.calc(); },
        renderCart: () => {
            const div = el('cart-list'); div.innerHTML='';
            State.cart.forEach((it,i) => {
                const k=State.holidayK, tot=Math.round(it.price*it.qty*k);
                div.innerHTML += `<div class="cart-item"><div class="cart-info"><div class="cart-name">${it.name} ${it.qty>1?`(x${it.qty})`:''}</div><div class="cart-price">${fmt(tot)}</div></div><div class="btn-remove" onclick="App.removeService(${i})">√ó</div></div>`;
            });
        },
        updateGuests: () => {
            const v=el('inp-guests').value;
            let t="–î–æ 50"; if(v==='5000')t="50-100"; if(v==='10000')t="100-200"; if(v==='custom')t="–°–ª–∞–π–¥–µ—Ä";
            el('slider-wrap').style.display = v==='custom'?'block':'none';
            el('disp-guests').innerText=t; App.calc();
        },
        calc: () => {
            const k = State.holidayK;
            let sTot=0; State.cart.forEach(i=> sTot+=i.price*i.qty*k); sTot=Math.round(sTot);
            State.discount=0; if(State.cart.length>1) { State.discount=Math.round(sTot*0.1); sTot-=State.discount; el('discount-badge').style.display='block'; }
            else el('discount-badge').style.display='none';

            const reg=el('inp-region').value, cit=el('inp-city').value;
            let road=0; if(reg&&cit) road = (cit==='other')?DB.travel[reg].fee : DB.travel[reg].cities[cit];
            const rTot=Math.round(road*(k>1?1.5:1));

            const gV=el('inp-guests').value; let guest=0;
            if(gV==='5000')guest=5000; if(gV==='10000')guest=10000;
            if(gV==='custom') { const n=parseInt(el('inp-slider').value); el('slider-val').innerText=n; guest = Math.max(0, (n-200) * DB.settings.extraGuest); }
            
            const man = parseMoney(el('inp-manual-price').value);
            
            let preTax = sTot+rTot+guest+man;
            State.taxActive = el('inp-tax').checked;
            let taxVal = State.taxActive ? Math.round(preTax*0.06) : 0;
            
            const total = preTax + taxVal;
            State.final = { total, sTot, rTot, guest, man, k, taxVal };

            let b = [];
            if(total>=15000) b.push("üéüÔ∏è 2 –±–∏–ª–µ—Ç–∞ –Ω–∞ —à–æ—É"); 
            if(total>=25000) b=["üé© –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å","üéüÔ∏è 2 –±–∏–ª–µ—Ç–∞"]; 
            if(total>=40000) b=["üî• –û–ø–∞—Å–Ω—ã–π —Ç—Ä—é–∫","üé© –§–æ–∫—É—Å","üéüÔ∏è 2 –±–∏–ª–µ—Ç–∞"];
            State.bonusList=b;
            el('bonus-alert').style.display=b.length>0?'block':'none';
            el('bonus-alert').innerText = b.length>0 ? b[0]+(b.length>1?" (+ –µ—â–µ)":"") : "";
            el('total-sum').innerText = fmt(total);
        },
        copy: () => {
            if(!State.final || State.final.total===0) return alert('0 ‚ÇΩ');

            const name = el('inp-client').value.trim() || '–ö–ª–∏–µ–Ω—Ç';
            const type = el('inp-event-type').value || '–°–æ–±—ã—Ç–∏–µ';
            const phone = el('inp-phone').value || '';
            const depPct = (DB.touchCfg && typeof DB.touchCfg.depositPercent === 'number') ? DB.touchCfg.depositPercent : 30;

            const dateStr = parseISODate(State.date).toLocaleDateString('ru-RU',{weekday:'short', day:'numeric', month:'long'});
            let lines = [`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${name}!`];
            lines.push(``);
            lines.push(`‚ú® **–†–ê–°–ß–ï–¢: ${type.toUpperCase()}** ‚ú®`);
            lines.push(``);
            lines.push(`üìÖ **${dateStr}**`);
            const cityText = (el('disp-city')?.innerText || el('inp-city')?.value || '').trim();
            if(cityText) lines.push(`üìç **${cityText}**`);
            lines.push(``);
            lines.push(`üé© **–ü—Ä–æ–≥—Ä–∞–º–º–∞:**`);
            State.cart.forEach(i => lines.push(`‚Ä¢ ${i.name} ‚Äî ${fmt(Math.round(i.price*i.qty*State.final.k))}`));

            if(State.discount>0) lines.push(`üéÅ –°–∫–∏–¥–∫–∞ 10%: -${fmt(State.discount)}`);
            if(State.final.rTot>0) lines.push(`üöï –õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${fmt(State.final.rTot)}`);
            if(State.final.guest>0) lines.push(`üë• –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –≥–æ—Å—Ç–µ–π: ${fmt(State.final.guest)}`);
            if(State.final.man>0) lines.push(`üîπ –î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã: ${fmt(State.final.man)}`);
            if(State.final.taxVal>0) lines.push(`üìÑ –ù–∞–ª–æ–≥ / –î–æ–∫—É–º–µ–Ω—Ç—ã (6%): ${fmt(State.final.taxVal)}`);

            if(State.bonusList.length>0) { lines.push(``); lines.push(`üéÅ **–í–ê–®–ò –ë–û–ù–£–°–´:**`); State.bonusList.forEach(b=>lines.push(`‚úÖ ${b}`)); }

            const dep = depPct > 0 ? Math.round(State.final.total * (depPct/100)) : 0;
            lines.push(``);
            lines.push(`üí∞ **–ò–¢–û–ì–û: ${fmt(State.final.total)}**`);
            if(depPct > 0) lines.push(`üí≥ –ó–∞–¥–∞—Ç–æ–∫ (${depPct}%): ${fmt(dep)}`);
            lines.push(``);

            // –†–µ–∫–≤–∏–∑–∏—Ç—ã
            if(Array.isArray(DB.payments) && DB.payments.length > 0){
                lines.push(`üì≤ **–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –±—Ä–æ–Ω–∏:**`);
                DB.payments.forEach((p, idx) => {
                    const title = String(p?.title ?? '').trim();
                    const text = String(p?.text ?? '').trim();
                    if(!title && !text) return;

                    if(title) lines.push(`${title}:`);
                    if(text){
                        text.split('\n').forEach(line => {
                            const ln = String(line ?? '').trim();
                            if(ln) lines.push(ln);
                        });
                    }
                    if(idx !== DB.payments.length - 1) lines.push(``);
                });
                lines.push(``);
            }

            // –°—Å—ã–ª–∫–∏
            if(Array.isArray(DB.links) && DB.links.length > 0){
                const list = DB.links
                    .map(l => ({ label: String(l?.label ?? '').trim(), url: String(l?.url ?? '').trim() }))
                    .filter(l => l.url.length > 0);

                if(list.length > 0){
                    lines.push(`üîó **–°—Å—ã–ª–∫–∏:**`);
                    list.forEach(l => lines.push(`‚Ä¢ ${l.label || '–°—Å—ã–ª–∫–∞'}: ${l.url}`));
                    lines.push(``);
                }
            }

            lines.push(`‚ö†Ô∏è _–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –±—Ä–æ–Ω–∏—Ä—É—é—Ç—Å—è –∑–∞ –í–∞–º–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∑–∞–¥–∞—Ç–∫–∞._`);

            copyTextToClipboard(lines.join('\n')).then((ok)=> {
                if(ok){
                    el('toast').innerText = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    el('toast').classList.add('show');
                    setTimeout(()=>el('toast').classList.remove('show'), 2000);
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
                }
            });
        }
    };

    // --- ADMIN ---
    const Admin = {
        render: () => {
            const tDiv = el('settings-travel-list'); tDiv.innerHTML = '';
            for (let r in DB.travel) {
                const cities = DB.travel[r].cities; let cHtml = '';
                for(let c in cities) { cHtml += `<div class="set-row"><input class="set-input-name" value="${c}" onchange="Admin.renameCity('${r}','${c}',this.value)"><input type="number" class="set-input-price" value="${cities[c]}" onchange="Admin.setCityPrice('${r}','${c}',this.value)"><div class="btn-del-item" onclick="Admin.delCity('${r}','${c}')">√ó</div></div>`; }
                tDiv.innerHTML += `<div class="settings-block"><div class="settings-header" onclick="Admin.toggleSection(this)"><span>${r}</span><span class="toggle-icon">‚ñº</span></div><div class="settings-content"><div class="set-row" style="background:#2C2C2E;"><span style="font-size:15px; color:#aaa;">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</span><input type="number" class="set-input-price" value="${DB.travel[r].fee}" onchange="Admin.setRegionFee('${r}',this.value)"></div>${cHtml}<div class="btn-add-item" onclick="Admin.addCity('${r}')">+ –ì–æ—Ä–æ–¥</div><div class="btn-del-item" style="width:100%; font-size:14px; padding:10px;" onclick="Admin.delRegion('${r}')">–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</div></div></div>`;
            }
            const sDiv = el('settings-services-list'); sDiv.innerHTML = '';
            for (let c in DB.services) {
                let sHtml = '';
                for(let s in DB.services[c]) { sHtml += `<div class="set-row"><input class="set-input-name" value="${s}" onchange="Admin.renameSvc('${c}','${s}',this.value)"><input type="number" class="set-input-price" value="${DB.services[c][s]}" onchange="Admin.setSvcPrice('${c}','${s}',this.value)"><div class="btn-del-item" onclick="Admin.delSvc('${c}','${s}')">√ó</div></div>`; }
                sDiv.innerHTML += `<div class="settings-block"><div class="settings-header" onclick="Admin.toggleSection(this)"><span>${c}</span><span class="toggle-icon">‚ñº</span></div><div class="settings-content">${sHtml}<div class="btn-add-item" onclick="Admin.addSvc('${c}')">+ –£—Å–ª—É–≥–∞</div><div class="btn-del-item" style="width:100%; font-size:14px; padding:10px;" onclick="Admin.delCat('${c}')">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div></div></div>`;
            }
            // Payments
            const pDiv = el('settings-payments-list');
            if(pDiv){
                pDiv.innerHTML = '';
                const list = Array.isArray(DB.payments) ? DB.payments : [];
                if(list.length === 0){
                    pDiv.innerHTML = `<div style="padding:14px 16px; color:#888; font-size:13px;">–ü—É—Å—Ç–æ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –ö–ü.</div>`;
                } else {
                    list.forEach((p, idx) => {
                        const title = esc(p?.title ?? '');
                        const text = esc(p?.text ?? '');
                        pDiv.innerHTML += `
                            <div class="set-row" style="flex-direction:column; align-items:stretch;">
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <input class="set-input-name" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–ë–ü, –¢–∏–Ω—å–∫–æ—Ñ—Ñ, –ù–∞–ª–∏—á–Ω—ã–µ)" value="${title}" oninput="Admin.setPaymentTitle(${idx}, this.value)">
                                    <div class="btn-del-item" onclick="Admin.delPayment(${idx})">√ó</div>
                                </div>
                                <textarea class="edit-input" style="width:100%; margin-top:8px; min-height:78px; font-size:14px; resize:vertical;"
                                    placeholder="–õ—é–±—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã/–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫." oninput="Admin.setPaymentText(${idx}, this.value)">${text}</textarea>
                            </div>`;
                    });
                }
            }
            // Links
            const lDiv = el('settings-links-list');
            if(lDiv){
                lDiv.innerHTML = '';
                const list = Array.isArray(DB.links) ? DB.links : [];
                if(list.length === 0){
                    lDiv.innerHTML = `<div style="padding:14px 16px; color:#888; font-size:13px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å—Å—ã–ª–æ–∫ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ, —Å–æ—Ü—Å–µ—Ç–∏, –æ—Ç–∑—ã–≤—ã, —Å–∞–π—Ç.</div>`;
                } else {
                    list.forEach((l, idx) => {
                        const label = esc(l?.label ?? '');
                        const url = esc(l?.url ?? '');
                        lDiv.innerHTML += `
                            <div class="set-row">
                                <input class="set-input-name" style="flex:1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Instagram)" value="${label}" oninput="Admin.setLinkLabel(${idx}, this.value)">
                                <input class="set-input-name" style="flex:2; font-size:14px;" placeholder="–°—Å—ã–ª–∫–∞ (https://...)" value="${url}" oninput="Admin.setLinkUrl(${idx}, this.value)">
                                <div class="btn-del-item" onclick="Admin.delLink(${idx})">√ó</div>
                            </div>`;
                    });
                }
            }
        },
        toggleSection: (el) => { const c = el.nextElementSibling; c.classList.toggle('open'); el.querySelector('.toggle-icon').style.transform = c.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)'; },
        addRegion: () => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:"); if(n && !DB.travel[n]) { DB.travel[n]={fee:0, cities:{}}; Storage.save(); Admin.render(); } },
        delRegion: (r) => { if(confirm(`–£–¥–∞–ª–∏—Ç—å ${r}?`)) { delete DB.travel[r]; Storage.save(); Admin.render(); App.init(); } },
        setRegionFee: (r,v) => { DB.travel[r].fee=parseInt(v); Storage.save(); },
        addCity: (r) => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:"); if(n) { DB.travel[r].cities[n]=0; Storage.save(); Admin.render(); App.init(); } },
        delCity: (r,c) => { delete DB.travel[r].cities[c]; Storage.save(); Admin.render(); App.init(); },
        renameCity: (r,oldC,newC) => { if(oldC===newC || !newC) return; const price = DB.travel[r].cities[oldC]; delete DB.travel[r].cities[oldC]; DB.travel[r].cities[newC] = price; Storage.save(); App.init(); },
        setCityPrice: (r,c,v) => { DB.travel[r].cities[c]=parseInt(v); Storage.save(); },
        addCategory: () => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:"); if(n && !DB.services[n]) { DB.services[n]={}; Storage.save(); Admin.render(); App.init(); } },
        delCat: (c) => { if(confirm(`–£–¥–∞–ª–∏—Ç—å ${c}?`)) { delete DB.services[c]; Storage.save(); Admin.render(); App.init(); } },
        addSvc: (c) => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏:"); if(n) { DB.services[c][n]=0; Storage.save(); Admin.render(); App.init(); } },
        delSvc: (c,s) => { delete DB.services[c][s]; Storage.save(); Admin.render(); App.init(); },
        renameSvc: (c,oldS,newS) => { if(oldS===newS || !newS) return; const price = DB.services[c][oldS]; delete DB.services[c][oldS]; DB.services[c][newS] = price; Storage.save(); App.init(); },
        setSvcPrice: (c,s,v) => { DB.services[c][s]=parseInt(v); Storage.save(); },
        
        // Payments / Links
        addPayment: () => {
            if(!Array.isArray(DB.payments)) DB.payments = [];
            DB.payments.push({ title: "–ù–æ–≤—ã–π —Å–ø–æ—Å–æ–±", text: "" });
            Storage.save(); Admin.render();
        },
        delPayment: (idx) => { if(!Array.isArray(DB.payments)) return; DB.payments.splice(idx,1); Storage.save(); Admin.render(); },
        setPaymentTitle: (idx, v) => { if(!Array.isArray(DB.payments)) return; DB.payments[idx].title = v; Storage.save(); },
        setPaymentText: (idx, v) => { if(!Array.isArray(DB.payments)) return; DB.payments[idx].text = v; Storage.save(); },

        addLink: () => {
            if(!Array.isArray(DB.links)) DB.links = [];
            DB.links.push({ label: "–°—Å—ã–ª–∫–∞", url: "" });
            Storage.save(); Admin.render();
        },
        delLink: (idx) => { if(!Array.isArray(DB.links)) return; DB.links.splice(idx,1); Storage.save(); Admin.render(); },
        setLinkLabel: (idx, v) => { if(!Array.isArray(DB.links)) return; DB.links[idx].label = v; Storage.save(); },
        setLinkUrl: (idx, v) => { if(!Array.isArray(DB.links)) return; DB.links[idx].url = v; Storage.save(); },

        resetAll: () => Storage.reset()
    };

    // --- HOLIDAYS ---
    const HolidayCfg = {
        ensure: () => {
            if(!DB.settings) DB.settings = {};
            if(!DB.settings.holidays || typeof DB.settings.holidays !== 'object') {
                DB.settings.holidays = JSON.parse(JSON.stringify(DEFAULT_DB.settings.holidays || {}));
            }
            if(!Array.isArray(DB.settings.holidayRanges)) {
                DB.settings.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.settings.holidayRanges || []));
            }
        },
        normalizeMD: (raw) => {
            const s = String(raw || '').trim().replace(/[./\s]/g, '-');
            const m = s.match(/^(\d{1,2})-(\d{1,2})$/);
            if(!m) return null;
            let mm = Math.max(1, Math.min(12, parseInt(m[1],10)));
            let dd = Math.max(1, Math.min(31, parseInt(m[2],10)));
            return `${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
        },
        parseK: (v) => {
            let k = parseFloat(String(v).replace(',','.'));
            if(Number.isNaN(k)) k = 1;
            k = Math.max(1, Math.min(5, k));
            return Math.round(k * 100) / 100;
        },
        render: () => {
            HolidayCfg.ensure();
            const list = el('settings-holidays-list');
            const ranges = el('settings-holidayranges-list');
            if(!list || !ranges) return;

            const keys = Object.keys(DB.settings.holidays || {}).sort();
            list.innerHTML = keys.length ? '' : `<div style="padding: 10px 16px; color: rgba(255,255,255,.55); font-size: 13px;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞—Ç. –î–æ–±–∞–≤—å, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å ‚Äú–¥–æ—Ä–æ–≥–∏–µ‚Äù –¥–Ω–∏.</div>`;

            keys.forEach((key) => {
                const kVal = DB.settings.holidays[key];
                const row = document.createElement('div');
                row.className = 'set-row';
                row.innerHTML = `<input class="set-input-name" value="${esc(key)}" placeholder="–ú–ú-–î–î" inputmode="numeric"><input class="set-input-price" value="${esc(kVal)}" placeholder="√ó1.5" inputmode="decimal"><div class="btn-del-item" title="–£–¥–∞–ª–∏—Ç—å">√ó</div>`;
                const inpKey = row.children[0];
                const inpK = row.children[1];
                const btnDel = row.children[2];

                inpKey.onblur = () => {
                    const newKey = HolidayCfg.normalizeMD(inpKey.value);
                    if(!newKey) { inpKey.value = key; return; }
                    const kNow = HolidayCfg.parseK(inpK.value);
                    if(newKey !== key) { delete DB.settings.holidays[key]; }
                    DB.settings.holidays[newKey] = kNow;
                    Storage.save(); HolidayCfg.render();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };
                inpK.onblur = () => {
                    const kk = HolidayCfg.parseK(inpK.value);
                    DB.settings.holidays[key] = kk;
                    inpK.value = kk;
                    Storage.save();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };
                btnDel.onclick = () => {
                    delete DB.settings.holidays[key];
                    Storage.save(); HolidayCfg.render();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };
                list.appendChild(row);
            });

            const rs = DB.settings.holidayRanges || [];
            ranges.innerHTML = rs.length ? '' : `<div style="padding: 10px 16px; color: rgba(255,255,255,.55); font-size: 13px;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–µ—Ä–∏–æ–¥–æ–≤. –î–æ–±–∞–≤—å, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Å–µ–∑–æ–Ω–Ω—ã–µ –Ω–∞–¥–±–∞–≤–∫–∏.</div>`;

            rs.forEach((r, i) => {
                const start = `${String(r.sm||1).padStart(2,'0')}-${String(r.sd||1).padStart(2,'0')}`;
                const end = `${String(r.em||1).padStart(2,'0')}-${String(r.ed||1).padStart(2,'0')}`;
                const kVal = HolidayCfg.parseK(r.k ?? 1);

                const wrap = document.createElement('div');
                wrap.className = 'set-row'; wrap.style.gap = '8px';
                wrap.innerHTML = `<input class="set-input-name" style="max-width:92px;" value="${esc(start)}" placeholder="–ú–ú-–î–î" inputmode="numeric"><div style="opacity:.6; font-weight:700;">‚Üí</div><input class="set-input-name" style="max-width:92px;" value="${esc(end)}" placeholder="–ú–ú-–î–î" inputmode="numeric"><input class="set-input-price" style="width:72px;" value="${esc(kVal)}" placeholder="√ó1.5" inputmode="decimal"><div class="btn-del-item" title="–£–¥–∞–ª–∏—Ç—å">√ó</div>`;
                const inpStart = wrap.children[0];
                const inpEnd = wrap.children[2];
                const inpK = wrap.children[3];
                const btnDel = wrap.children[4];

                const saveRow = () => {
                    const s1 = HolidayCfg.normalizeMD(inpStart.value);
                    const s2 = HolidayCfg.normalizeMD(inpEnd.value);
                    if(!s1 || !s2) { inpStart.value = start; inpEnd.value = end; return; }
                    const [sm, sd] = s1.split('-').map(n=>parseInt(n,10));
                    const [em, ed] = s2.split('-').map(n=>parseInt(n,10));
                    const kk = HolidayCfg.parseK(inpK.value);
                    DB.settings.holidayRanges[i] = { sm, sd, em, ed, k: kk };
                    inpStart.value = s1; inpEnd.value = s2; inpK.value = kk;
                    Storage.save(); try { App.updateDate(); App.calc(); } catch(e){}
                };
                inpStart.onblur = saveRow; inpEnd.onblur = saveRow; inpK.onblur = saveRow;
                btnDel.onclick = () => {
                    DB.settings.holidayRanges.splice(i, 1);
                    Storage.save(); HolidayCfg.render();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };
                ranges.appendChild(wrap);
            });
        },
        addHoliday: () => {
            HolidayCfg.ensure();
            const candidates = ['12-31','01-01','03-08','02-23','06-01','09-01'];
            let key = candidates.find(k => !(k in DB.settings.holidays));
            if(!key){
                const d = new Date();
                key = `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            }
            DB.settings.holidays[key] = 1.5;
            Storage.save(); HolidayCfg.render(); try { App.updateDate(); App.calc(); } catch(e){}
        },
        addRange: () => {
            HolidayCfg.ensure();
            DB.settings.holidayRanges.push({ sm: 12, sd: 15, em: 12, ed: 30, k: 1.5 });
            Storage.save(); HolidayCfg.render(); try { App.updateDate(); App.calc(); } catch(e){}
        }
    };

    Storage.load();

    // --- expose functions for inline handlers ---
    try {
      window.switchTab = switchTab;
      window.App = App;
      window.Admin = Admin;
      window.HolidayCfg = HolidayCfg;
    } catch(e) {}
</script>

<script>
/* === v36 viewport stabilizer (iOS / PWA) === */
(function(){
  const root = document.documentElement;
  function isStandalone(){ return window.matchMedia && window.matchMedia('(display-mode: standalone)').matches || (window.navigator && window.navigator.standalone); }
  function updateVV(){
    const vv = window.visualViewport;
    if(!vv){
      root.style.setProperty('--vvh', window.innerHeight + 'px');
      root.style.setProperty('--vv-offset', '0px');
      root.style.setProperty('--kb', '0px');
      return;
    }
    root.style.setProperty('--vvh', vv.height + 'px');
    root.style.setProperty('--vv-offset', vv.offsetTop + 'px');
    const kb = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
    root.style.setProperty('--kb', kb + 'px');
  }
  updateVV();
  window.addEventListener('resize', updateVV, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', updateVV, {passive:true});
    window.visualViewport.addEventListener('scroll', updateVV, {passive:true});
  }
  if(isStandalone()){ root.classList.add('pwa-fixed'); document.body.classList.add('pwa-fixed'); }
})();
</script>

<!-- TABS -->
<div class="tabs">
<div class="tab-btn active" data-tab="calc" onclick="switchTab('calc', this)"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
<div class="tab-btn" data-tab="settings" onclick="switchTab('settings', this)"><svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>

</div>
</div>
</body>
</html>
