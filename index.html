<!-- /illusionist-os.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Illusionist OS — Умный калькулятор</title>

  <!-- PWA-ish -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Illusionist OS" />
  <meta name="theme-color" content="#050507" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg:#050507;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.08);
      --gold:#f59e0b;
      --muted:#94a3b8;
      --text:#e5e7eb;
    }

    html,body{height:100%; background:var(--bg); color:var(--text);}
    body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow-x:hidden;}

    .font-cinzel{font-family:Cinzel, serif;}
    .mono{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* subtle glass panels */
    .glass{
      background: var(--panel);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Splash */
    #splash{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(800px 600px at 30% 20%, rgba(245,158,11,.10), transparent 60%),
                  radial-gradient(700px 500px at 70% 80%, rgba(99,102,241,.10), transparent 60%),
                  var(--bg);
      z-index:50;
      transition: opacity .65s ease, transform .65s ease;
    }
    #splash.hide{opacity:0; transform: translateY(-6px); pointer-events:none;}

    /* Settings modal */
    #view-settings{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      z-index:40;
    }
    #view-settings.active{display:block;}
    #view-settings .panel{
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:min(980px, calc(100% - 24px));
      max-height: calc(100% - 24px);
      overflow:auto;
      border-radius: 18px;
    }

    /* Admin accordion */
    .admin-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
      gap:12px;
    }
    .admin-content{
      max-height:0;
      overflow:hidden;
      transition:max-height .35s ease;
      padding-top:0;
    }
    .admin-content.open{
      max-height:1200px;
      padding-top:10px;
    }

    /* small controls */
    .edit-row{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 0;
    }
    .edit-input{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      color: #e2e8f0;
      outline: none;
    }
    .edit-input:focus{border-color: rgba(245,158,11,.35); box-shadow: 0 0 0 3px rgba(245,158,11,.10);}

    .btn-add-mini{
      background: rgba(245,158,11,.12);
      border: 1px solid rgba(245,158,11,.25);
      color: rgba(245,158,11,.95);
      border-radius: 12px;
      padding: 7px 10px;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .btn-add-mini:hover{background: rgba(245,158,11,.18);}
    .btn-del-mini{
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.20);
      color: rgba(239,68,68,.95);
      border-radius: 12px;
      width: 34px;
      height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .btn-del-mini:hover{background: rgba(239,68,68,.16);}

    .btn-icon{
      width:44px; height:44px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .btn-icon:hover{background: rgba(255,255,255,.08);}

    .btn-gold{
      width:100%;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 800;
      letter-spacing:.02em;
      background: linear-gradient(135deg, rgba(245,158,11,.95), rgba(245,158,11,.65));
      color: #120a00;
      border: 1px solid rgba(245,158,11,.35);
      box-shadow: 0 10px 25px rgba(245,158,11,.15);
    }
    .btn-gold:hover{filter: brightness(1.03);}

    .animate-enter{animation: enter .25s ease both;}
    @keyframes enter{from{opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;}}

    /* Canvas bg */
    #bg-canvas{position:fixed; inset:0; z-index:0; pointer-events:none;}

    /* Error styles (ВАЖНО) */
    .error-input {
      border-color: #ef4444 !important;
      animation: shake 0.3s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* ============================================
       ЧАСТЬ 1: Data reliability styles (NEW)
       ============================================ */

    /* Backup status indicator */
    .backup-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--muted);
    }
    .backup-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }
    .backup-dot.warning { background: #f59e0b; }
    .backup-dot.error { background: #ef4444; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Data management buttons */
    .btn-data {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      transition: all 0.2s;
      user-select: none;
    }
    .btn-export {
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.25);
      color: rgba(34, 197, 94, 0.95);
    }
    .btn-export:hover { background: rgba(34, 197, 94, 0.18); }
    .btn-import {
      background: rgba(59, 130, 246, 0.12);
      border: 1px solid rgba(59, 130, 246, 0.25);
      color: rgba(59, 130, 246, 0.95);
    }
    .btn-import:hover { background: rgba(59, 130, 246, 0.18); }
    .btn-backup {
      background: rgba(168, 85, 247, 0.12);
      border: 1px solid rgba(168, 85, 247, 0.25);
      color: rgba(168, 85, 247, 0.95);
    }
    .btn-backup:hover { background: rgba(168, 85, 247, 0.18); }

    /* Backup slots */
    .backup-slot {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 56px;
    }
    .backup-slot:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(245,158,11,0.3);
    }
    .backup-slot.empty {
      opacity: 0.4;
      cursor: default;
    }
    .backup-slot.empty:hover {
      background: rgba(255,255,255,0.03);
      border-color: rgba(255,255,255,0.08);
    }

    /* Hidden file input */
    #import-file-input {
      display: none;
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- 1) hidden import input (NEW) -->
  <input type="file" id="import-file-input" accept=".json,.backup" />

  <canvas id="bg-canvas"></canvas>

  <!-- Splash -->
  <div id="splash">
    <div class="text-center px-6">
      <div class="mx-auto mb-5 w-16 h-16 rounded-2xl flex items-center justify-center glass">
        <i data-lucide="sparkles" class="w-8 h-8 text-amber-400"></i>
      </div>
      <div class="font-cinzel text-2xl tracking-wide text-white">Illusionist OS</div>
      <div class="mt-2 text-slate-400 font-semibold">Умный калькулятор</div>
      <div class="mt-6 text-xs text-slate-500">Нажми, чтобы пропустить • или подожди пару секунд</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 opacity-0 -translate-y-4 transition-all duration-300">
    <div class="glass rounded-2xl px-4 py-3 shadow-xl">
      <div class="flex items-center gap-2">
        <i data-lucide="bell" class="w-4 h-4 text-amber-400"></i>
        <div id="toast-msg" class="text-sm text-slate-200 font-semibold"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="relative z-10 px-4 pt-5">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl glass flex items-center justify-center">
          <i data-lucide="wand-2" class="w-5 h-5 text-amber-400"></i>
        </div>
        <div>
          <div class="font-cinzel text-white tracking-wide">Illusionist OS</div>

          <!-- 2) subtitle + indicator (REPLACED) -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-400 font-semibold">Умный калькулятор</span>
            <div id="backup-indicator" class="backup-status">
              <span class="backup-dot"></span>
              <span id="backup-status-text">Сохранено</span>
            </div>
          </div>
        </div>
      </div>

      <button id="btn-settings" class="btn-icon" aria-label="Настройки">
        <i data-lucide="settings" class="w-5 h-5 text-slate-200"></i>
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="relative z-10 px-4 pb-10">
    <div class="max-w-4xl mx-auto mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">

      <!-- Left: inputs -->
      <section class="glass rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-extrabold text-white tracking-wide">Данные</div>
          <div id="holiday-alert" class="hidden text-[11px] font-extrabold text-amber-400 bg-amber-500/10 border border-amber-500/20 px-3 py-1 rounded-full">
            Праздник: x<span id="holiday-k">1</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-400 font-bold">Дата</label>
            <input type="date" id="inp-date" class="w-full mt-1 edit-input" />
          </div>
          <div>
            <label class="text-xs text-slate-400 font-bold">Время</label>
            <input type="time" id="inp-time" class="w-full mt-1 edit-input" value="18:00" />
          </div>
        </div>

        <div class="mt-3">
          <label class="text-xs text-slate-400 font-bold">Клиент</label>
          <input id="inp-client" class="w-full mt-1 edit-input" placeholder="Имя клиента" />
        </div>

        <div class="mt-3">
          <label class="text-xs text-slate-400 font-bold">Тип события</label>
          <select id="inp-event-type" class="w-full mt-1 edit-input">
            <option>Мероприятие</option>
            <option>Микромагия</option>
            <option>Сцена</option>
            <option>Концерт</option>
            <option>Репетиция</option>
            <option>Детское шоу</option>
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-3">
          <div>
            <label class="text-xs text-slate-400 font-bold">Регион</label>
            <select id="inp-region" class="w-full mt-1 edit-input"></select>
          </div>
          <div>
            <label class="text-xs text-slate-400 font-bold">Город</label>
            <select id="inp-city" class="w-full mt-1 edit-input" disabled></select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-3">
          <div>
            <label class="text-xs text-slate-400 font-bold">Категория</label>
            <select id="inp-cat" class="w-full mt-1 edit-input"></select>
          </div>
          <div>
            <label class="text-xs text-slate-400 font-bold">Услуга</label>
            <select id="inp-svc" class="w-full mt-1 edit-input" disabled></select>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-3">
          <div class="flex items-center gap-2">
            <button id="btn-qty-minus" class="btn-icon w-10 h-10 rounded-xl" aria-label="Минус">
              <i data-lucide="minus" class="w-5 h-5 text-slate-200"></i>
            </button>
            <div class="glass rounded-xl px-4 py-2 text-sm font-extrabold mono">
              x<span id="svc-qty">1</span>
            </div>
            <button id="btn-qty-plus" class="btn-icon w-10 h-10 rounded-xl" aria-label="Плюс">
              <i data-lucide="plus" class="w-5 h-5 text-slate-200"></i>
            </button>
          </div>

          <button id="btn-add-service" class="flex-1 btn-gold">
            Добавить в корзину
          </button>
        </div>

        <div class="mt-4 border-t border-white/10 pt-4">
          <div class="text-sm font-extrabold text-white mb-2">Доплаты</div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-slate-400 font-bold">Название доплаты</label>
              <input id="inp-manual-name" class="w-full mt-1 edit-input" placeholder="Напр. Аренда зала" />
            </div>
            <div>
              <label class="text-xs text-slate-400 font-bold">Сумма</label>
              <input id="inp-manual-price" type="number" class="w-full mt-1 edit-input text-right mono" placeholder="0" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="text-xs text-slate-400 font-bold">Гости</label>
              <select id="inp-guests" class="w-full mt-1 edit-input">
                <option value="0">Без доплаты</option>
                <option value="1000">+1 000 ₽</option>
                <option value="2000">+2 000 ₽</option>
                <option value="3000">+3 000 ₽</option>
              </select>
            </div>
            <div class="flex items-end">
              <label class="flex items-center gap-2 text-xs text-slate-300 font-bold select-none">
                <input type="checkbox" id="inp-tax" class="accent-amber-500" />
                Договор (+6%)
              </label>
            </div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <button id="btn-copy-prices" class="glass rounded-2xl px-4 py-3 font-extrabold text-slate-100 border border-white/10 hover:bg-white/10 transition">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="list" class="w-4 h-4 text-amber-400"></i>
              Цены + бонусы (категория)
            </span>
          </button>
          <button id="btn-copy-quote" class="btn-gold">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="copy" class="w-4 h-4"></i>
              Скопировать КП
            </span>
          </button>
        </div>

      </section>

      <!-- Right: cart & result -->
      <section class="glass rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-extrabold text-white tracking-wide">Корзина</div>
          <div id="discount-badge" class="hidden text-[11px] font-extrabold text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-3 py-1 rounded-full">
            Скидка 10% за комплект
          </div>
        </div>

        <div id="cart-list" class="space-y-2"></div>

        <div class="mt-4 border-t border-white/10 pt-4">
          <div class="flex items-baseline justify-between">
            <div class="text-slate-300 font-bold">Итого</div>
            <div id="total-sum" class="text-2xl font-extrabold text-amber-400 mono">0 ₽</div>
          </div>

          <div class="mt-3">
            <div class="text-xs text-slate-400 font-bold mb-2">Бонусы (что клиент получает)</div>
            <div id="bonus-list" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="mt-4 text-[12px] text-slate-500 leading-relaxed">
            Клиенту не нужен “Smart Calc”. Клиенту нужен ответ: <span class="text-slate-300 font-bold">сколько</span> и
            <span class="text-slate-300 font-bold">что он получит</span>. Поэтому бонусы всегда видны по сумме.
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Settings modal -->
  <div id="view-settings" aria-hidden="true">
    <div class="panel glass p-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="font-cinzel text-white text-lg">Настройки</div>
          <div class="text-xs text-slate-400 font-semibold">Админка базы цен • реквизиты • бонусы</div>
        </div>

        <!-- ВАЖНО: id для закрытия -->
        <button id="btn-close-settings" class="text-slate-400 hover:text-white btn-icon" aria-label="Закрыть">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- ============ DATA MANAGEMENT SECTION (NEW) ============ -->
      <div class="glass rounded-2xl p-4 mb-4 border-2 border-emerald-500/20">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i data-lucide="database" class="w-5 h-5 text-emerald-400"></i>
            <span class="text-sm font-extrabold text-white">Управление данными</span>
          </div>
          <div class="text-[10px] text-slate-500 mono" id="db-version-display">v2.0</div>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-4">
          <button id="btn-export-data" class="btn-data btn-export">
            <i data-lucide="download" class="w-4 h-4"></i>
            Экспорт
          </button>
          <button id="btn-import-data" class="btn-data btn-import">
            <i data-lucide="upload" class="w-4 h-4"></i>
            Импорт
          </button>
          <button id="btn-create-backup" class="btn-data btn-backup">
            <i data-lucide="save" class="w-4 h-4"></i>
            Бэкап
          </button>
        </div>

        <div class="mb-3">
          <div class="text-xs text-slate-400 font-bold mb-2 flex items-center justify-between">
            <span>Автобэкапы (5 слотов)</span>
            <span class="text-[10px] text-slate-500" id="last-backup-time">—</span>
          </div>
          <div class="grid grid-cols-5 gap-2" id="backup-slots-container"></div>
        </div>

        <div class="bg-white/5 rounded-lg p-3">
          <div class="flex items-center justify-between text-[11px]">
            <div class="flex items-center gap-2">
              <i data-lucide="shield-check" class="w-4 h-4 text-emerald-400"></i>
              <span class="text-slate-300">Целостность данных</span>
            </div>
            <span class="text-emerald-400 font-bold" id="data-integrity-status">OK</span>
          </div>
          <div class="mt-2 grid grid-cols-3 gap-2 text-[10px] text-slate-500">
            <div>Услуг: <span class="text-slate-300" id="stats-services">0</span></div>
            <div>Регионов: <span class="text-slate-300" id="stats-regions">0</span></div>
            <div>Бонусов: <span class="text-slate-300" id="stats-bonuses">0</span></div>
          </div>
        </div>
      </div>
      <!-- ============ END DATA MANAGEMENT ============ -->

      <!-- Profile -->
      <div class="glass rounded-2xl p-4 mb-4">
        <div class="text-sm font-extrabold text-white mb-3">Профиль</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-400 font-bold">Подпись</label>
            <input id="cfg-performer" class="w-full mt-1 edit-input" placeholder="Напр. Дмитрий" />
          </div>
          <div>
            <label class="text-xs text-slate-400 font-bold">Бронь (%)</label>
            <input id="cfg-deposit" type="number" class="w-full mt-1 edit-input text-right mono" placeholder="30" />
          </div>
        </div>
      </div>

      <!-- Admin quick actions -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
        <button id="btn-add-region" class="btn-add-mini text-xs">+ Регион</button>
        <button id="btn-add-category" class="btn-add-mini text-xs">+ Категория</button>
        <button id="btn-add-holiday" class="btn-add-mini text-xs">+ Праздник</button>
        <button id="btn-add-range" class="btn-add-mini text-xs">+ Период</button>
        <button id="btn-add-bonus" class="btn-add-mini text-xs">+ Бонус</button>
        <button id="btn-add-payment" class="btn-add-mini text-xs">+ Реквизиты</button>
        <button id="btn-add-link" class="btn-add-mini text-xs">+ Ссылка</button>
        <button id="btn-reset-db" class="btn-add-mini text-xs bg-red-500/10 border-red-500/25 text-red-300">Сброс БД</button>
      </div>

      <!-- Admin sections -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 pb-4">
        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-extrabold text-white mb-2">Логистика</div>
          <div id="settings-travel-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-extrabold text-white mb-2">Услуги</div>
          <div id="settings-services-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-extrabold text-white mb-2">Праздничные даты</div>
          <div id="settings-holidays-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-extrabold text-white mb-2">Праздничные периоды</div>
          <div id="settings-ranges-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-extrabold text-white mb-2">Бонусы</div>
          <div id="settings-bonuses-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-extrabold text-white mb-2">Реквизиты</div>
          <div id="settings-payments-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-4 lg:col-span-2">
          <div class="text-sm font-extrabold text-white mb-2">Ссылки</div>
          <div id="settings-links-list" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT (единый) -->
  <script>
    'use strict';

    /* ============================================
       ЧАСТЬ 3: Константы (NEW)
       ============================================ */
    const DB_VERSION = '2.0';
    const STORAGE_KEY = 'illusionist_calc_db';
    const BACKUP_KEY = 'illusionist_backups';
    const MAX_BACKUPS = 5;
    const AUTO_BACKUP_INTERVAL = 5 * 60 * 1000; // 5 минут

    // ============================================================================
    // ЧАСТЬ 1: УТИЛИТЫ И БЕЗОПАСНОСТЬ (part1-utils-security.js)
    // ============================================================================

    const Utils = {
      // SANITIZATION & VALIDATION
      escapeHtml: (text) => {
        if (!text) return '';
        const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
        return String(text).replace(/[&<>"']/g, (m) => map[m]);
      },

      sanitizeText: (text, maxLength = 1000) => {
        if (!text) return '';
        return String(text)
          .replace(/[\x00-\x1F\x7F]/g, '')
          .substring(0, maxLength)
          .trim();
      },

      sanitizeNumber: (value, min = 0, max = 999999, defaultValue = null) => {
        const num = parseInt(value, 10);
        if (isNaN(num)) return defaultValue !== null ? defaultValue : min;
        return Math.max(min, Math.min(max, num));
      },

      sanitizeFloat: (value, min = 0, max = 100, defaultValue = null) => {
        const num = parseFloat(value);
        if (isNaN(num)) return defaultValue !== null ? defaultValue : min;
        return Math.max(min, Math.min(max, num));
      },

      validateDateKey: (key) => {
        if (!key || typeof key !== 'string') return false;
        const regex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
        if (!regex.test(key)) return false;
        const [m, d] = key.split('-').map(Number);
        const daysInMonth = [31,29,31,30,31,30,31,31,30,31,30,31];
        return d <= daysInMonth[m - 1];
      },

      formatPrice: (num) => {
        if (typeof num !== 'number' || isNaN(num)) return '0';
        return Math.round(num).toLocaleString('ru-RU');
      },

      // DOM HELPERS
      createElement: (tag, className = '', textContent = '') => {
        const el = document.createElement(tag);
        if (className) el.className = className;
        if (textContent) el.textContent = textContent;
        return el;
      },

      clearElement: (element) => {
        if (!element) return;
        while (element.firstChild) element.removeChild(element.firstChild);
      },

      addOption: (select, value, text) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = text;
        select.appendChild(option);
      },

      // CLIPBOARD
      copyToClipboard: async (text) => {
        if (!text) return false;
        if (navigator.clipboard && window.isSecureContext) {
          try { await navigator.clipboard.writeText(text); return true; }
          catch (err) { console.warn('Clipboard API failed, trying fallback...', err); }
        }
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.top = '0';
          textArea.style.left = '-9999px';
          textArea.style.opacity = '0';
          textArea.setAttribute('readonly', '');
          document.body.appendChild(textArea);
          textArea.select();
          textArea.setSelectionRange(0, 99999);
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          return successful;
        } catch (err) {
          console.error('Fallback clipboard failed:', err);
          return false;
        }
      },

      // PERFORMANCE
      debounce: (func, wait = 300) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => { clearTimeout(timeout); func(...args); };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      throttle: (func, limit = 300) => {
        let inThrottle;
        return function(...args) {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      },

      // DATE
      formatDate: (dateString) => {
        if (!dateString) return '';
        try {
          const date = new Date(dateString + 'T00:00:00');
          if (isNaN(date.getTime())) return dateString;
          return date.toLocaleDateString('ru-RU', {day:'numeric', month:'long', weekday:'short'});
        } catch (e) {
          console.error('Date formatting error:', e);
          return dateString;
        }
      },

      /* ============================================
         NEW: formatDateTime + simpleHash
         ============================================ */
      formatDateTime: (timestamp) => {
        if (!timestamp) return '—';
        try {
          const date = new Date(timestamp);
          return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch (e) {
          return '—';
        }
      },

      simpleHash: (str) => {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return Math.abs(hash).toString(16);
      },

      // STORAGE HELPERS
      saveToStorage: (key, value) => {
        try { localStorage.setItem(key, JSON.stringify(value)); return true; }
        catch (err) { console.error('Storage save error:', err); return false; }
      },

      loadFromStorage: (key, defaultValue = null) => {
        try {
          const item = localStorage.getItem(key);
          if (item === null) return defaultValue;
          return JSON.parse(item);
        } catch (err) {
          console.error('Storage load error:', err);
          return defaultValue;
        }
      },

      // VALIDATION HELPERS
      isValidObject: (obj) => obj !== null && typeof obj === 'object' && !Array.isArray(obj),

      deepMerge: (target, source) => {
        const output = { ...target };
        if (Utils.isValidObject(target) && Utils.isValidObject(source)) {
          Object.keys(source).forEach(key => {
            if (Utils.isValidObject(source[key])) {
              output[key] = (key in target) ? Utils.deepMerge(target[key], source[key]) : source[key];
            } else {
              output[key] = source[key];
            }
          });
        }
        return output;
      },

      tryCatch: (fn, fallback = null) => { try { return fn(); } catch (err) { console.error(err); return fallback; } },

      validateInput: (input, validator, errorClass = 'error-input') => {
        if (!input) return false;
        const isValid = validator(input.value);
        if (!isValid) {
          input.classList.add(errorClass);
          setTimeout(() => input.classList.remove(errorClass), 300);
        }
        return isValid;
      }
    };

    // ============================================================================
    // ОРИГИНАЛ: DEFAULT_DB (нужен!)
    // + добавлен version: DB_VERSION
    // ============================================================================

    const DEFAULT_DB = {
      version: DB_VERSION,
      travel: {
        "Ярославская область": { fee: 3000, cities: { "Ярославль": 0, "Ростов Великий": 1500 } },
        "Костромская область": { fee: 5000, cities: { "Кострома": 0 } }
      },
      services: {
        "Сцена": {
          "Шоу Секрет (45 минут)": 35000,
          "Шоу Секрет (60 минут)": 45000
        },
        "Микромагия": {
          "Микромагия (30 минут)": 20000,
          "Микромагия (60 минут)": 30000
        },
        "Детские шоу": {
          "Индив. детское шоу (30 минут + мастер класс 1 час)": 25000,
          "Детское шоу (60 минут)": 35000
        }
      },
      holidays: {
        "12-31": 2.0,
        "01-01": 2.0
      },
      holidayRanges: [
        { sm: 12, sd: 20, em: 12, ed: 30, k: 1.5 }
      ],
      bonuses: [
        { threshold: 30000, text: "Мини-сувенир гостям" },
        { threshold: 50000, text: "Фото/видео с фишкой шоу" },
        { threshold: 70000, text: "Доп. интерактив / сюрприз эффект" }
      ],
      payments: [
        { title: "Перевод", text: "СБП / карта: +7 (___) ___-__-__" }
      ],
      links: [
        { label: "Портфолио", url: "https://example.com" }
      ],
      config: {
        performer: "Illusionist",
        deposit: 30
      }
    };

    // ============================================================================
    // ОРИГИНАЛ: DB / State
    // ============================================================================

    let DB = {};
    let State = {
      date: (function(){
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      })(),
      holidayK: 1,
      serviceQty: 1,
      cart: [],
      finalTotal: 0,
      finalDetails: { servicesTotal:0, discount:0, travel:0, manPrice:0, guestPrice:0, tax:0, k:1 },
      activeBonuses: []
    };

    /* ============================================
       ЧАСТЬ 4: DataManager (NEW)
       (после DEFAULT_DB, перед App)
       ============================================ */
    const DataManager = {
      calculateChecksum: (data) => {
        const str = JSON.stringify(data);
        return Utils.simpleHash(str);
      },

      validateData: (data) => {
        if (!data || typeof data !== 'object') {
          return { valid: false, error: 'Некорректный формат данных' };
        }

        // минимально требуемые поля (holidayRanges допускаем опционально)
        const required = ['travel', 'services', 'holidays', 'bonuses', 'payments', 'links', 'config'];
        for (const key of required) {
          if (!(key in data)) return { valid: false, error: `Отсутствует поле: ${key}` };
        }

        if (!Utils.isValidObject(data.travel)) return { valid: false, error: 'Некорректная структура travel' };
        if (!Utils.isValidObject(data.services)) return { valid: false, error: 'Некорректная структура services' };
        if (!Utils.isValidObject(data.holidays)) return { valid: false, error: 'Некорректная структура holidays' };

        if (!Array.isArray(data.bonuses)) return { valid: false, error: 'bonuses должен быть массивом' };
        if (!Array.isArray(data.payments)) return { valid: false, error: 'payments должен быть массивом' };
        if (!Array.isArray(data.links)) return { valid: false, error: 'links должен быть массивом' };

        // holidayRanges опционально, но если есть — должен быть массивом
        if ('holidayRanges' in data && !Array.isArray(data.holidayRanges)) {
          return { valid: false, error: 'holidayRanges должен быть массивом' };
        }

        return { valid: true };
      },

      exportData: () => {
        try {
          const exportData = {
            ...DB,
            version: DB_VERSION,
            exportedAt: new Date().toISOString(),
            checksum: DataManager.calculateChecksum(DB)
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = `illusionist-backup-${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          App.showToast('Данные экспортированы!');
          console.log('✅ Data exported');
          return true;
        } catch (err) {
          console.error('❌ Export error:', err);
          App.showToast('Ошибка экспорта');
          return false;
        }
      },

      importData: (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              const validation = DataManager.validateData(data);

              if (!validation.valid) {
                App.showToast(validation.error);
                reject(new Error(validation.error));
                return;
              }

              // Verify checksum if present
              if (data.checksum) {
                const { checksum, exportedAt, ...cleanData } = data;
                const calculated = DataManager.calculateChecksum(cleanData);
                if (checksum !== calculated) {
                  if (!confirm('Контрольная сумма не совпадает. Данные могли быть изменены. Продолжить?')) {
                    reject(new Error('Cancelled'));
                    return;
                  }
                }
              }

              // Create backup before import
              DataManager.createBackup('Перед импортом');

              // Remove metadata and apply
              const { checksum, exportedAt, ...importedData } = data;

              // гарантируем поля по дефолту
              DB = {
                ...JSON.parse(JSON.stringify(DEFAULT_DB)),
                ...importedData,
                version: DB_VERSION
              };

              // если holidayRanges отсутствует — подставим дефолт
              if (!Array.isArray(DB.holidayRanges)) DB.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.holidayRanges));

              Storage.save();

              App.updateUI();
              if (typeof Admin !== 'undefined') Admin.render();
              DataManager.updateStats();

              App.showToast('Данные импортированы!');
              console.log('✅ Data imported');
              resolve(true);
            } catch (err) {
              console.error('❌ Import error:', err);
              App.showToast('Ошибка чтения файла');
              reject(err);
            }
          };

          reader.onerror = () => {
            App.showToast('Ошибка чтения файла');
            reject(new Error('File read error'));
          };

          reader.readAsText(file);
        });
      },

      createBackup: (label = null) => {
        try {
          const backups = Utils.loadFromStorage(BACKUP_KEY, []);

          const backup = {
            id: Date.now(),
            label: label || `Бэкап ${backups.length + 1}`,
            timestamp: new Date().toISOString(),
            data: JSON.parse(JSON.stringify(DB)),
            checksum: DataManager.calculateChecksum(DB)
          };

          backups.unshift(backup);
          if (backups.length > MAX_BACKUPS) backups.pop();

          Utils.saveToStorage(BACKUP_KEY, backups);
          DataManager.renderBackupSlots();

          App.showToast('Бэкап создан!');
          console.log('✅ Backup created:', backup.label);
          return true;
        } catch (err) {
          console.error('❌ Backup error:', err);
          App.showToast('Ошибка создания бэкапа');
          return false;
        }
      },

      restoreBackup: (backupId) => {
        try {
          const backups = Utils.loadFromStorage(BACKUP_KEY, []);
          const backup = backups.find(b => b.id === backupId);

          if (!backup) {
            App.showToast('Бэкап не найден');
            return false;
          }

          if (!confirm(`Восстановить "${backup.label}"?\nТекущие данные будут заменены.`)) {
            return false;
          }

          const calculated = DataManager.calculateChecksum(backup.data);
          if (backup.checksum !== calculated) {
            if (!confirm('Контрольная сумма не совпадает. Продолжить?')) return false;
          }

          DB = {
            ...JSON.parse(JSON.stringify(DEFAULT_DB)),
            ...backup.data,
            version: DB_VERSION
          };
          if (!Array.isArray(DB.holidayRanges)) DB.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.holidayRanges));

          Storage.save();

          App.updateUI();
          if (typeof Admin !== 'undefined') Admin.render();
          DataManager.updateStats();

          App.showToast('Данные восстановлены!');
          console.log('✅ Restored:', backup.label);
          return true;
        } catch (err) {
          console.error('❌ Restore error:', err);
          App.showToast('Ошибка восстановления');
          return false;
        }
      },

      deleteBackup: (backupId) => {
        try {
          let backups = Utils.loadFromStorage(BACKUP_KEY, []);
          backups = backups.filter(b => b.id !== backupId);
          Utils.saveToStorage(BACKUP_KEY, backups);
          DataManager.renderBackupSlots();
          App.showToast('Бэкап удалён');
          return true;
        } catch (err) {
          console.error('❌ Delete backup error:', err);
          return false;
        }
      },

      autoBackup: () => {
        const backups = Utils.loadFromStorage(BACKUP_KEY, []);
        const lastBackup = backups[0];

        if (lastBackup) {
          const currentChecksum = DataManager.calculateChecksum(DB);
          if (lastBackup.checksum === currentChecksum) return; // no changes
        }

        try {
          const backup = {
            id: Date.now(),
            label: 'Автобэкап',
            timestamp: new Date().toISOString(),
            data: JSON.parse(JSON.stringify(DB)),
            checksum: DataManager.calculateChecksum(DB)
          };

          const allBackups = Utils.loadFromStorage(BACKUP_KEY, []);
          allBackups.unshift(backup);
          if (allBackups.length > MAX_BACKUPS) allBackups.pop();
          Utils.saveToStorage(BACKUP_KEY, allBackups);

          DataManager.renderBackupSlots();
          console.log('✅ Auto-backup created');
        } catch (err) {
          console.error('❌ Auto-backup error:', err);
        }
      },

      renderBackupSlots: () => {
        const container = document.getElementById('backup-slots-container');
        if (!container) return;

        const backups = Utils.loadFromStorage(BACKUP_KEY, []);
        Utils.clearElement(container);

        for (let i = 0; i < MAX_BACKUPS; i++) {
          const backup = backups[i];
          const slot = Utils.createElement('div', `backup-slot ${backup ? '' : 'empty'}`);

          if (backup) {
            slot.innerHTML = `
              <div class="text-[10px] font-bold text-amber-400 truncate">${Utils.escapeHtml(backup.label)}</div>
              <div class="text-[9px] text-slate-500">${Utils.formatDateTime(backup.timestamp)}</div>
            `;
            slot.title = `${backup.label}\nПравый клик — удалить`;
            slot.addEventListener('click', () => DataManager.restoreBackup(backup.id));
            slot.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              if (confirm(`Удалить "${backup.label}"?`)) {
                DataManager.deleteBackup(backup.id);
              }
            });
          } else {
            slot.innerHTML = `
              <div class="text-[10px] text-slate-600">Пусто</div>
              <div class="text-[9px] text-slate-700">—</div>
            `;
          }

          container.appendChild(slot);
        }

        const lastBackupEl = document.getElementById('last-backup-time');
        if (lastBackupEl && backups[0]) {
          lastBackupEl.textContent = `Последний: ${Utils.formatDateTime(backups[0].timestamp)}`;
        } else if (lastBackupEl) {
          lastBackupEl.textContent = '—';
        }
      },

      updateStats: () => {
        const servicesCount = Object.values(DB.services || {})
          .reduce((sum, cat) => sum + Object.keys(cat || {}).length, 0);
        const regionsCount = Object.keys(DB.travel || {}).length;
        const bonusesCount = (DB.bonuses || []).length;

        const servicesEl = document.getElementById('stats-services');
        const regionsEl = document.getElementById('stats-regions');
        const bonusesEl = document.getElementById('stats-bonuses');
        const versionEl = document.getElementById('db-version-display');
        const integrityEl = document.getElementById('data-integrity-status');

        if (servicesEl) servicesEl.textContent = servicesCount;
        if (regionsEl) regionsEl.textContent = regionsCount;
        if (bonusesEl) bonusesEl.textContent = bonusesCount;
        if (versionEl) versionEl.textContent = `v${DB.version || DB_VERSION}`;

        if (integrityEl) {
          const isValid = DataManager.validateData(DB).valid;
          integrityEl.textContent = isValid ? 'OK' : 'ОШИБКА';
          integrityEl.className = isValid ? 'text-emerald-400 font-bold' : 'text-red-400 font-bold';
        }
      },

      updateBackupIndicator: (status = 'saved') => {
        const dot = document.querySelector('#backup-indicator .backup-dot');
        const text = document.getElementById('backup-status-text');
        if (!dot || !text) return;

        switch (status) {
          case 'saving':
            dot.className = 'backup-dot warning';
            text.textContent = 'Сохранение...';
            break;
          case 'saved':
            dot.className = 'backup-dot';
            text.textContent = 'Сохранено';
            break;
          case 'error':
            dot.className = 'backup-dot error';
            text.textContent = 'Ошибка!';
            break;
        }
      },

      init: () => {
        // File input handler
        const fileInput = document.getElementById('import-file-input');
        if (fileInput) {
          fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
              DataManager.importData(e.target.files[0])
                .catch(err => console.error(err))
                .finally(() => { fileInput.value = ''; });
            }
          });
        }

        // Export button
        const exportBtn = document.getElementById('btn-export-data');
        if (exportBtn) exportBtn.addEventListener('click', DataManager.exportData);

        // Import button
        const importBtn = document.getElementById('btn-import-data');
        if (importBtn) {
          importBtn.addEventListener('click', () => {
            document.getElementById('import-file-input')?.click();
          });
        }

        // Manual backup button
        const backupBtn = document.getElementById('btn-create-backup');
        if (backupBtn) {
          backupBtn.addEventListener('click', () => {
            const label = prompt('Название бэкапа:', `Бэкап ${new Date().toLocaleDateString('ru-RU')}`);
            if (label !== null) DataManager.createBackup(label || undefined);
          });
        }

        // Render initial state
        DataManager.renderBackupSlots();
        DataManager.updateStats();
        DataManager.updateBackupIndicator('saved');

        // Setup auto-backup every 5 minutes
        setInterval(DataManager.autoBackup, AUTO_BACKUP_INTERVAL);

        console.log('✅ DataManager initialized');
      }
    };

    // ============================================================================
    // ЧАСТЬ 2: APP MODULE (part2-app-module.js) + биндинги админ-кнопок
    // ============================================================================

    const App = {
      init: () => {
        try {
          if (!Storage.load()) {
            console.error('Failed to load storage, using defaults');
          }

          // NEW: init data manager after DB is loaded
          DataManager.init();

          App.migrateServicesNames();
          App.setupEventListeners();
          App.initProfileInputs();
          App.updateUI();

          const dateInput = document.getElementById('inp-date');
          if (dateInput) {
            dateInput.value = State.date;
            App.updateDate();
          }

          App.renderParticles();

          if (window.lucide) lucide.createIcons();

          App.startSplash();
          App.registerSW();

          // Ensure indicator reflects actual state
          DataManager.updateBackupIndicator('saved');

          console.log('✅ App initialized successfully');
        } catch (err) {
          console.error('❌ App initialization failed:', err);
          App.showToast('Ошибка инициализации');
          DataManager.updateBackupIndicator('error');
        }
      },

      setupEventListeners: () => {
        // Settings
        const btnSettings = document.getElementById('btn-settings');
        if (btnSettings) btnSettings.addEventListener('click', App.toggleSettings);

        const btnCloseSettings = document.getElementById('btn-close-settings');
        if (btnCloseSettings) btnCloseSettings.addEventListener('click', App.toggleSettings);

        // Date
        const dateInput = document.getElementById('inp-date');
        if (dateInput) dateInput.addEventListener('change', App.updateDate);

        // Region / city
        const regionSelect = document.getElementById('inp-region');
        if (regionSelect) regionSelect.addEventListener('change', App.updateRegion);

        const citySelect = document.getElementById('inp-city');
        if (citySelect) citySelect.addEventListener('change', App.calc);

        // Category / svc
        const catSelect = document.getElementById('inp-cat');
        if (catSelect) catSelect.addEventListener('change', App.updateCat);

        // Qty
        const btnQtyMinus = document.getElementById('btn-qty-minus');
        if (btnQtyMinus) btnQtyMinus.addEventListener('click', () => App.changeQty(-1));

        const btnQtyPlus = document.getElementById('btn-qty-plus');
        if (btnQtyPlus) btnQtyPlus.addEventListener('click', () => App.changeQty(1));

        // Add service
        const btnAddService = document.getElementById('btn-add-service');
        if (btnAddService) btnAddService.addEventListener('click', App.addService);

        // Copy prices
        const btnCopyPrices = document.getElementById('btn-copy-prices');
        if (btnCopyPrices) btnCopyPrices.addEventListener('click', App.copyPriceList);

        // Manual price (debounce)
        const manualPriceInput = document.getElementById('inp-manual-price');
        if (manualPriceInput) {
          manualPriceInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(manualPriceInput.value, 0, 999999);
            manualPriceInput.value = value || '';
            App.calc();
          }, 300));
        }

        // Guests
        const guestsSelect = document.getElementById('inp-guests');
        if (guestsSelect) guestsSelect.addEventListener('change', App.calc);

        // Tax
        const taxCheckbox = document.getElementById('inp-tax');
        if (taxCheckbox) taxCheckbox.addEventListener('change', App.calc);

        // Copy quote
        const btnCopyQuote = document.getElementById('btn-copy-quote');
        if (btnCopyQuote) btnCopyQuote.addEventListener('click', App.copyQuote);

        // === Admin buttons (чтобы не было “кнопки не работают”) ===
        const bind = (id, fn) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('click', fn);
        };

        bind('btn-add-bonus', () => { if (typeof Admin !== 'undefined') Admin.addBonus(); });
        bind('btn-add-region', () => { if (typeof Admin !== 'undefined') Admin.addRegion(); });
        bind('btn-add-category', () => { if (typeof Admin !== 'undefined') Admin.addCategory(); });
        bind('btn-add-holiday', () => { if (typeof Admin !== 'undefined') Admin.addHoliday(); });
        bind('btn-add-range', () => { if (typeof Admin !== 'undefined') Admin.addRange(); });
        bind('btn-add-payment', () => { if (typeof Admin !== 'undefined') Admin.addPayment(); });
        bind('btn-add-link', () => { if (typeof Admin !== 'undefined') Admin.addLink(); });
        bind('btn-reset-db', () => { if (typeof Admin !== 'undefined') Admin.reset(); });

        console.log('✅ Event listeners attached');
      },

      initProfileInputs: () => {
        const performerInput = document.getElementById('cfg-performer');
        if (performerInput) {
          performerInput.value = DB.config?.performer || 'Illusionist';
          performerInput.addEventListener('input', Utils.debounce(() => {
            DB.config.performer = Utils.sanitizeText(performerInput.value, 100);
            Storage.save();
            DataManager.updateStats();
          }, 500));
        }

        const depositInput = document.getElementById('cfg-deposit');
        if (depositInput) {
          depositInput.value = DB.config?.deposit || 30;
          depositInput.addEventListener('input', Utils.debounce(() => {
            const value = Utils.sanitizeNumber(depositInput.value, 0, 100, 30);
            depositInput.value = value;
            DB.config.deposit = value;
            Storage.save();
            DataManager.updateStats();
          }, 500));
        }
      },

      migrateServicesNames: () => {
        try {
          if (!DB.services || !DB.services["Детские шоу"]) return;
          const oldKey = "Индив. детское шоу";
          const newKey = "Индив. детское шоу (30 минут + мастер класс 1 час)";
          if (DB.services["Детские шоу"][oldKey] != null && DB.services["Детские шоу"][newKey] == null) {
            DB.services["Детские шоу"][newKey] = DB.services["Детские шоу"][oldKey];
            delete DB.services["Детские шоу"][oldKey];
            Storage.save();
            console.log('✅ Service names migrated');
          }
        } catch (err) {
          console.error('Migration error:', err);
        }
      },

      registerSW: () => {
        if (!('serviceWorker' in navigator)) {
          console.log('Service Worker not supported');
          return;
        }
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('./service-worker.js')
            .then(reg => console.log('✅ SW registered:', reg.scope))
            .catch(err => console.log('❌ SW registration failed (ok if single-file):', err));
        });
      },

      startSplash: () => {
        const splash = document.getElementById('splash');
        if (!splash) return;

        if (window.lucide) {
          try { lucide.createIcons(); } catch (err) { console.warn('Lucide icons init error:', err); }
        }

        const MIN_MS = 2800;
        let dismissed = false;

        const hide = () => {
          if (dismissed) return;
          dismissed = true;
          splash.classList.add('hide');
          setTimeout(() => { if (splash.parentNode) splash.remove(); }, 700);
        };

        splash.addEventListener('click', hide, { once: true });
        splash.addEventListener('touchstart', hide, { once: true, passive: true });
        setTimeout(hide, MIN_MS);
      },

      updateUI: () => {
        try {
          App.updateRegionSelect();
          App.updateCategorySelect();
          App.updateCat();
          if (window.lucide) lucide.createIcons();
          DataManager.updateStats();
          DataManager.renderBackupSlots();
        } catch (err) {
          console.error('UI update error:', err);
        }
      },

      updateRegionSelect: () => {
        const regionSelect = document.getElementById('inp-region');
        if (!regionSelect) return;
        const currentValue = regionSelect.value;
        Utils.clearElement(regionSelect);
        Utils.addOption(regionSelect, '', 'Выберите...');
        regionSelect.options[0].disabled = true;
        regionSelect.options[0].selected = true;

        if (DB.travel && Utils.isValidObject(DB.travel)) {
          Object.keys(DB.travel).sort().forEach(region => Utils.addOption(regionSelect, region, region));
        }
        if (currentValue && DB.travel[currentValue]) regionSelect.value = currentValue;
      },

      updateCategorySelect: () => {
        const catSelect = document.getElementById('inp-cat');
        if (!catSelect) return;
        const currentValue = catSelect.value;
        Utils.clearElement(catSelect);
        Utils.addOption(catSelect, '', 'Выберите...');
        catSelect.options[0].disabled = true;
        catSelect.options[0].selected = true;

        if (DB.services && Utils.isValidObject(DB.services)) {
          Object.keys(DB.services).sort().forEach(category => Utils.addOption(catSelect, category, category));
        }
        if (currentValue && DB.services[currentValue]) catSelect.value = currentValue;
      },

      updateDate: () => {
        const dateInput = document.getElementById('inp-date');
        if (!dateInput) return;
        const val = dateInput.value;
        if (!val) return;

        try {
          State.date = val;
          const [y, m, d] = val.split('-').map(Number);
          if (!m || !d) return;
          const key = `${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

          let k = (DB.holidays && DB.holidays[key]) ? Utils.sanitizeFloat(DB.holidays[key], 1, 10) : 1;

          if (k === 1 && DB.holidayRanges && Array.isArray(DB.holidayRanges)) {
            const md = m * 100 + d;
            for (let range of DB.holidayRanges) {
              if (!Utils.isValidObject(range)) continue;
              const start = (range.sm || 0) * 100 + (range.sd || 0);
              const end = (range.em || 0) * 100 + (range.ed || 0);
              const inRange = start <= end ? (md >= start && md <= end) : (md >= start || md <= end);
              if (inRange) { k = Utils.sanitizeFloat(range.k, 1, 10); break; }
            }
          }

          State.holidayK = k;

          const badge = document.getElementById('holiday-alert');
          const kSpan = document.getElementById('holiday-k');
          if (badge && kSpan) {
            if (k > 1) { badge.classList.remove('hidden'); kSpan.textContent = k; }
            else badge.classList.add('hidden');
          }

          App.calc();
        } catch (err) {
          console.error('Date update error:', err);
        }
      },

      updateRegion: () => {
        const regionSelect = document.getElementById('inp-region');
        const citySelect = document.getElementById('inp-city');
        if (!regionSelect || !citySelect) return;

        const region = regionSelect.value;
        Utils.clearElement(citySelect);
        citySelect.disabled = false;

        if (region && DB.travel && DB.travel[region] && DB.travel[region].cities) {
          const cities = DB.travel[region].cities;
          Object.keys(cities).sort().forEach(city => Utils.addOption(citySelect, city, city));
          Utils.addOption(citySelect, 'other', 'Другой');
        } else {
          citySelect.disabled = true;
        }

        App.calc();
      },

      updateCat: () => {
        const catSelect = document.getElementById('inp-cat');
        const svcSelect = document.getElementById('inp-svc');
        if (!catSelect || !svcSelect) return;

        const category = catSelect.value;
        Utils.clearElement(svcSelect);
        svcSelect.disabled = false;

        if (category && DB.services && DB.services[category]) {
          const services = DB.services[category];
          Object.keys(services).sort().forEach(service => Utils.addOption(svcSelect, service, service));
        } else {
          svcSelect.disabled = true;
        }
      },

      changeQty: (delta) => {
        const qtySpan = document.getElementById('svc-qty');
        if (!qtySpan) return;
        let newQty = State.serviceQty + delta;
        newQty = Utils.sanitizeNumber(newQty, 1, 99);
        State.serviceQty = newQty;
        qtySpan.textContent = newQty;
      },

      addService: () => {
        const catSelect = document.getElementById('inp-cat');
        const svcSelect = document.getElementById('inp-svc');
        if (!catSelect || !svcSelect) return;

        const cat = catSelect.value;
        const svc = svcSelect.value;

        if (!cat || !svc) {
          App.showToast('Выберите услугу!');
          return;
        }

        const basePrice = DB.services?.[cat]?.[svc];
        if (typeof basePrice !== 'number' || isNaN(basePrice) || basePrice < 0) {
          App.showToast('Некорректная цена услуги');
          return;
        }

        State.cart.push({ name: Utils.sanitizeText(svc, 200), price: basePrice, qty: State.serviceQty });

        State.serviceQty = 1;
        const qtySpan = document.getElementById('svc-qty');
        if (qtySpan) qtySpan.textContent = 1;

        App.renderCart();
        App.calc();
        App.showToast('Услуга добавлена');
      },

      removeService: (idx) => {
        if (idx >= 0 && idx < State.cart.length) {
          State.cart.splice(idx, 1);
          App.renderCart();
          App.calc();
        }
      },

      renderCart: () => {
        const cartList = document.getElementById('cart-list');
        if (!cartList) return;

        Utils.clearElement(cartList);

        State.cart.forEach((item, idx) => {
          const total = Math.round(item.price * item.qty * State.holidayK);

          const wrapper = Utils.createElement(
            'div',
            'flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/5 animate-enter'
          );

          const leftDiv = Utils.createElement('div');

          const nameDiv = Utils.createElement('div', 'text-sm font-medium text-white');
          nameDiv.textContent = item.name;

          if (item.qty > 1) {
            const qtySpan = Utils.createElement('span', 'text-amber-500 text-xs');
            qtySpan.textContent = ` x${item.qty}`;
            nameDiv.appendChild(qtySpan);
          }

          const priceDiv = Utils.createElement('div', 'text-xs text-slate-400 mono');
          priceDiv.textContent = `${Utils.formatPrice(item.price)} ₽`;

          leftDiv.appendChild(nameDiv);
          leftDiv.appendChild(priceDiv);

          const rightDiv = Utils.createElement('div', 'flex items-center gap-3');

          const totalSpan = Utils.createElement('span', 'font-extrabold text-amber-400 text-sm mono');
          totalSpan.textContent = `${Utils.formatPrice(total)} ₽`;

          const delBtn = Utils.createElement('button', 'text-slate-600 hover:text-red-400');
          delBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
          delBtn.addEventListener('click', () => App.removeService(idx));

          rightDiv.appendChild(totalSpan);
          rightDiv.appendChild(delBtn);

          wrapper.appendChild(leftDiv);
          wrapper.appendChild(rightDiv);
          cartList.appendChild(wrapper);
        });

        if (window.lucide) lucide.createIcons();
      },

      calc: () => {
        try {
          const k = State.holidayK || 1;
          let servicesTotal = 0;

          State.cart.forEach(item => {
            if (typeof item.price === 'number' && typeof item.qty === 'number') {
              servicesTotal += item.price * item.qty * k;
            }
          });

          let discount = 0;
          const discountBadge = document.getElementById('discount-badge');
          if (State.cart.length > 1) {
            discount = Math.round(servicesTotal * 0.1);
            if (discountBadge) discountBadge.classList.remove('hidden');
          } else {
            if (discountBadge) discountBadge.classList.add('hidden');
          }
          servicesTotal -= discount;

          // Travel
          const regionSelect = document.getElementById('inp-region');
          const citySelect = document.getElementById('inp-city');
          let travel = 0;

          if (regionSelect && citySelect) {
            const region = regionSelect.value;
            const city = citySelect.value;

            if (region && city && DB.travel?.[region]) {
              const baseTravel = city === 'other'
                ? (DB.travel[region].fee || 0)
                : (DB.travel[region].cities?.[city] || 0);

              travel = Math.round(baseTravel * (k > 1 ? 1.5 : 1));
            }
          }

          const manualPriceInput = document.getElementById('inp-manual-price');
          const manPrice = manualPriceInput ? Utils.sanitizeNumber(manualPriceInput.value, 0, 999999, 0) : 0;

          const guestsSelect = document.getElementById('inp-guests');
          const guestPrice = guestsSelect ? Utils.sanitizeNumber(guestsSelect.value, 0, 999999, 0) : 0;

          const taxCheckbox = document.getElementById('inp-tax');
          const useTax = taxCheckbox ? taxCheckbox.checked : false;

          let preTax = servicesTotal + travel + manPrice + guestPrice;
          const tax = useTax ? Math.round(preTax * 0.06) : 0;

          State.finalTotal = preTax + tax;
          State.finalDetails = { servicesTotal, discount, travel, manPrice, guestPrice, tax, k };

          const totalSumEl = document.getElementById('total-sum');
          if (totalSumEl) totalSumEl.textContent = `${Utils.formatPrice(State.finalTotal)} ₽`;

          App.updateBonuses();
        } catch (err) {
          console.error('Calculation error:', err);
        }
      },

      updateBonuses: () => {
        State.activeBonuses = App.getBonusesForTotal(State.finalTotal);
        const bonusListEl = document.getElementById('bonus-list');
        if (!bonusListEl) return;

        Utils.clearElement(bonusListEl);

        if (State.activeBonuses.length > 0) {
          State.activeBonuses.forEach(bonus => {
            const bonusDiv = Utils.createElement(
              'div',
              'inline-block bg-amber-500/10 text-amber-400 border border-amber-500/20 px-3 py-1 rounded-full text-xs font-extrabold uppercase tracking-wider animate-enter'
            );
            bonusDiv.textContent = bonus.text;
            bonusListEl.appendChild(bonusDiv);
          });
        }
      },

      getBonusesForTotal: (total) => {
        if (!DB.bonuses || !Array.isArray(DB.bonuses) || DB.bonuses.length === 0) return [];
        return DB.bonuses
          .filter(b => Utils.isValidObject(b) && typeof b.threshold === 'number' && !isNaN(b.threshold) && typeof b.text === 'string' && b.text.length > 0 && total >= b.threshold)
          .slice()
          .sort((a, b) => (a.threshold || 0) - (b.threshold || 0));
      },

      copyPriceList: async () => {
        const catSelect = document.getElementById('inp-cat');
        if (!catSelect) return;

        const cat = catSelect.value;
        if (!cat || !DB.services || !DB.services[cat]) {
          App.showToast('Выберите категорию');
          return;
        }

        const services = DB.services[cat];
        if (Object.keys(services).length === 0) {
          App.showToast('Категория пустая');
          return;
        }

        const k = State.holidayK || 1;
        const dateInput = document.getElementById('inp-date');
        const dateRaw = dateInput ? dateInput.value : '';
        const dateFmt = Utils.formatDate(dateRaw);

        const bonusesSorted = (DB.bonuses || [])
          .filter(b => Utils.isValidObject(b) && typeof b.threshold === 'number')
          .slice()
          .sort((a, b) => (a.threshold || 0) - (b.threshold || 0));
        const hasBonuses = bonusesSorted.length > 0;

        let text = `ЦЕНЫ: ${Utils.sanitizeText(cat, 100)}\n`;
        if (dateFmt) text += `Дата: ${dateFmt}\n`;
        if (k > 1) text += `Праздничный коэффициент: x${k}\n`;
        text += `\n`;

        const lines = [];

        Object.keys(services).forEach(name => {
          const base = services[name];
          if (typeof base !== 'number' || isNaN(base) || base < 0) return;

          const price = Math.round(base * k);
          const safeName = Utils.sanitizeText(name, 200);

          let bonusLine = '';

          if (hasBonuses) {
            const earned = bonusesSorted.filter(b => price >= (b.threshold || 0));
            if (earned.length > 0) {
              const bonusTexts = earned.map(b => `✅ ${Utils.sanitizeText(b.text, 200)}`).join(', ');
              bonusLine = `  Бонусы: ${bonusTexts}`;
            } else {
              const next = bonusesSorted.find(b => price < (b.threshold || 0));
              if (next) {
                const diff = Math.max(0, (next.threshold || 0) - price);
                const nextText = Utils.sanitizeText(next.text, 200);
                bonusLine = `  Бонусы: пока нет (ещё ${Utils.formatPrice(diff)} ₽ до "${nextText}")`;
              } else {
                bonusLine = `  Бонусы: все разблокированы! 🎉`;
              }
            }
          }

          lines.push(`• ${safeName} — ${Utils.formatPrice(price)} ₽${bonusLine ? `\n${bonusLine}` : ''}`);
        });

        text += lines.join('\n') + '\n';

        if (hasBonuses) {
          text += `\nБОНУСЫ ПО СУММЕ:\n`;
          bonusesSorted.forEach(b => {
            const threshold = Utils.formatPrice(b.threshold || 0);
            const bonusText = Utils.sanitizeText(b.text, 200);
            text += `• От ${threshold} ₽ — ${bonusText}\n`;
          });
        }

        const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
        text += `\nВаш ${performer}`;

        const success = await Utils.copyToClipboard(text);
        App.showToast(success ? 'Цены + бонусы скопированы!' : 'Не удалось скопировать');
      },

      copyQuote: async () => {
        if (!State.finalTotal || State.finalTotal <= 0) {
          App.showToast('Сумма 0 ₽');
          return;
        }

        const clientInput = document.getElementById('inp-client');
        const client = clientInput ? (Utils.sanitizeText(clientInput.value, 100) || 'Клиент') : 'Клиент';

        const eventSelect = document.getElementById('inp-event-type');
        const type = eventSelect ? eventSelect.value : 'Мероприятие';

        const dateInput = document.getElementById('inp-date');
        const dateRaw = dateInput ? dateInput.value : '';
        const dateFmt = Utils.formatDate(dateRaw) || dateRaw;

        const timeInput = document.getElementById('inp-time');
        const time = timeInput ? timeInput.value : '18:00';

        const citySelect = document.getElementById('inp-city');
        const city = citySelect ? citySelect.value : '';

        const depPct = DB.config?.deposit || 30;
        const deposit = Math.round(State.finalTotal * (depPct / 100));

        let text = `${client}\n\n`;
        text += `РАСЧЕТ: ${type.toUpperCase()}\n`;
        text += `${dateFmt} / ${time}\n`;
        if (city && city !== 'other') text += `${Utils.sanitizeText(city, 100)}\n`;
        text += `\nПрограмма:\n`;

        State.cart.forEach(item => {
          const price = Math.round(item.price * item.qty * State.finalDetails.k);
          const safeName = Utils.sanitizeText(item.name, 200);
          text += `• ${safeName}${item.qty > 1 ? ` x${item.qty}` : ''} — ${Utils.formatPrice(price)} ₽\n`;
        });

        if (State.finalDetails.discount > 0) text += `Скидка 10%: -${Utils.formatPrice(State.finalDetails.discount)} ₽\n`;
        if (State.finalDetails.travel > 0) text += `Логистика: ${Utils.formatPrice(State.finalDetails.travel)} ₽\n`;
        if (State.finalDetails.guestPrice > 0) text += `Доплата за гостей: ${Utils.formatPrice(State.finalDetails.guestPrice)} ₽\n`;
        if (State.finalDetails.manPrice > 0) {
          const manNameInput = document.getElementById('inp-manual-name');
          const manName = manNameInput ? (Utils.sanitizeText(manNameInput.value, 100) || 'Доп') : 'Доп';
          text += `${manName}: ${Utils.formatPrice(State.finalDetails.manPrice)} ₽\n`;
        }
        if (State.finalDetails.tax > 0) text += `Договор (+6%): ${Utils.formatPrice(State.finalDetails.tax)} ₽\n`;

        const earned = App.getBonusesForTotal(State.finalTotal);
        if (earned.length > 0) {
          text += `\nБонусы:\n`;
          earned.forEach(b => { text += `• ${Utils.sanitizeText(b.text, 200)}\n`; });
        }

        text += `\nИТОГО: ${Utils.formatPrice(State.finalTotal)} ₽\n`;
        text += `Бронь даты (${depPct}%): ${Utils.formatPrice(deposit)} ₽\n`;

        if (DB.payments && Array.isArray(DB.payments)) {
          text += `\nРеквизиты:\n`;
          DB.payments.forEach(p => {
            if (Utils.isValidObject(p)) {
              const title = Utils.sanitizeText(p.title, 100);
              const payText = Utils.sanitizeText(p.text, 500);
              text += `${title}: ${payText}\n`;
            }
          });
        }

        if (DB.links && Array.isArray(DB.links)) {
          text += `\nСсылки:\n`;
          DB.links.forEach(l => {
            if (Utils.isValidObject(l)) {
              const label = Utils.sanitizeText(l.label, 100);
              const url = Utils.sanitizeText(l.url, 500);
              text += `• ${label}: ${url}\n`;
            }
          });
        }

        const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
        text += `\nВаш ${performer}`;

        const success = await Utils.copyToClipboard(text);
        App.showToast(success ? 'КП скопировано!' : 'Не удалось скопировать');
      },

      toggleSettings: () => {
        const modal = document.getElementById('view-settings');
        if (!modal) return;

        const isOpen = modal.classList.contains('active');

        if (!isOpen) {
          if (typeof Admin !== 'undefined' && Admin.render) Admin.render();
          // NEW: refresh data blocks
          DataManager.renderBackupSlots();
          DataManager.updateStats();
          modal.classList.add('active');
          if (window.lucide) lucide.createIcons();
        } else {
          modal.classList.remove('active');
          App.updateUI();
        }
      },

      showToast: (msg) => {
        const toast = document.getElementById('toast');
        const msgEl = document.getElementById('toast-msg');
        if (!toast || !msgEl) return;

        msgEl.textContent = Utils.sanitizeText(msg, 200);
        toast.classList.remove('opacity-0', '-translate-y-4');
        toast.classList.add('opacity-100', 'translate-y-0');

        setTimeout(() => {
          toast.classList.add('opacity-0', '-translate-y-4');
          toast.classList.remove('opacity-100', 'translate-y-0');
        }, 2500);
      },

      renderParticles: () => {
        const canvas = document.getElementById('bg-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        let particles = [];
        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.addEventListener('resize', Utils.throttle(resize, 250));
        resize();

        for (let i = 0; i < 40; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 2,
            d: Math.random() * Math.PI * 2,
            s: Math.random() * 0.5 + 0.1,
            c: Math.random() > 0.5 ? '#f59e0b' : '#64748b'
          });
        }

        function animate() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach(p => {
            p.x += Math.cos(p.d) * p.s;
            p.y += Math.sin(p.d) * p.s;

            if (p.x < 0) p.x = canvas.width;
            if (p.x > canvas.width) p.x = 0;
            if (p.y < 0) p.y = canvas.height;
            if (p.y > canvas.height) p.y = 0;

            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.c;
            ctx.globalAlpha = 0.3;
            ctx.fill();
          });
          requestAnimationFrame(animate);
        }
        animate();
      }
    };

    // ============================================================================
    // ЧАСТЬ 3: ADMIN + STORAGE (part3-admin-storage.js)
    // + обновленные Storage.save/load (NEW reliability hooks)
    // ============================================================================

    const Storage = {
      save: () => {
        // indicator: saving
        if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('saving');

        try {
          DB.version = DB_VERSION;

          const serialized = JSON.stringify(DB);
          localStorage.setItem(STORAGE_KEY, serialized);

          if (typeof DataManager !== 'undefined') {
            DataManager.updateBackupIndicator('saved');
            DataManager.updateStats();
          }

          console.log('✅ Database saved');
          return true;
        } catch (err) {
          console.error('❌ Storage save error:', err);
          if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('error');

          if (err.name === 'QuotaExceededError') {
            console.error('localStorage quota exceeded');
            if (typeof App !== 'undefined' && App.showToast) App.showToast('Хранилище переполнено');
          }
          return false;
        }
      },

      load: () => {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) {
            console.log('No stored data, using defaults');
            DB = JSON.parse(JSON.stringify(DEFAULT_DB));
            DB.version = DB_VERSION;
            if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('saved');
            return true;
          }

          const parsed = JSON.parse(stored);

          DB = {
            ...JSON.parse(JSON.stringify(DEFAULT_DB)),
            travel: Utils.isValidObject(parsed.travel) ? parsed.travel : DEFAULT_DB.travel,
            services: Utils.isValidObject(parsed.services) ? parsed.services : DEFAULT_DB.services,
            holidays: Utils.isValidObject(parsed.holidays) ? parsed.holidays : DEFAULT_DB.holidays,
            holidayRanges: Array.isArray(parsed.holidayRanges) ? parsed.holidayRanges : DEFAULT_DB.holidayRanges,
            bonuses: Array.isArray(parsed.bonuses) ? parsed.bonuses : DEFAULT_DB.bonuses,
            payments: Array.isArray(parsed.payments) ? parsed.payments : DEFAULT_DB.payments,
            links: Array.isArray(parsed.links) ? parsed.links : DEFAULT_DB.links,
            config: Utils.isValidObject(parsed.config) ? { ...DEFAULT_DB.config, ...parsed.config } : DEFAULT_DB.config,
            version: DB_VERSION
          };

          console.log('✅ Database loaded');
          if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('saved');
          return true;
        } catch (err) {
          console.error('❌ Storage load error:', err);
          DB = JSON.parse(JSON.stringify(DEFAULT_DB));
          DB.version = DB_VERSION;
          if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('error');
          return false;
        }
      },

      reset: () => {
        try {
          localStorage.removeItem(STORAGE_KEY);
          console.log('✅ Database reset');
          if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('saved');
          return true;
        } catch (err) {
          console.error('❌ Storage reset error:', err);
          if (typeof DataManager !== 'undefined') DataManager.updateBackupIndicator('error');
          return false;
        }
      }
    };

    const Admin = {
      render: () => {
        try {
          Admin.renderTravel();
          Admin.renderServices();
          Admin.renderHolidays();
          Admin.renderRanges();
          Admin.renderBonuses();
          Admin.renderPayments();
          Admin.renderLinks();

          if (window.lucide) lucide.createIcons();
          if (typeof DataManager !== 'undefined') DataManager.updateStats();
          console.log('✅ Admin UI rendered');
        } catch (err) {
          console.error('❌ Admin render error:', err);
        }
      },

      toggleSection: (headerElement) => {
        if (!headerElement) return;
        const content = headerElement.nextElementSibling;
        const icon = headerElement.querySelector('i');
        if (content) content.classList.toggle('open');
        if (icon) icon.style.transform = content && content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)';
      },

      // TRAVEL
      renderTravel: () => {
        const container = document.getElementById('settings-travel-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.travel || !Utils.isValidObject(DB.travel)) {
          container.textContent = 'Нет регионов';
          return;
        }

        Object.keys(DB.travel).sort().forEach(region => {
          const regionData = DB.travel[region];
          if (!Utils.isValidObject(regionData)) return;

          const wrapper = Utils.createElement('div', 'bg-white/5 rounded-lg p-3 mb-2');

          const header = Utils.createElement('div', 'admin-header');
          header.addEventListener('click', function() { Admin.toggleSection(this); });

          const titleSpan = Utils.createElement('span', 'font-bold text-sm text-amber-500');
          titleSpan.textContent = region;

          const iconEl = document.createElement('i');
          iconEl.setAttribute('data-lucide', 'chevron-down');
          iconEl.className = 'w-4 h-4 text-slate-500 transition-transform';

          header.appendChild(titleSpan);
          header.appendChild(iconEl);

          const content = Utils.createElement('div', 'admin-content');

          const feeRow = Admin.createFeeRow(region, regionData.fee || 0);
          content.appendChild(feeRow);

          if (Utils.isValidObject(regionData.cities)) {
            Object.keys(regionData.cities).sort().forEach(city => {
              const cityRow = Admin.createCityRow(region, city, regionData.cities[city]);
              content.appendChild(cityRow);
            });
          }

          const addCityBtn = Utils.createElement('button', 'btn-add-mini mt-1 text-xs', '+ Город');
          addCityBtn.addEventListener('click', (e) => { e.stopPropagation(); Admin.addCity(region); });
          content.appendChild(addCityBtn);

          const delRegionBtn = Utils.createElement(
            'button',
            'text-[10px] text-red-400 mt-3 w-full text-right opacity-50 hover:opacity-100',
            'Удалить регион'
          );
          delRegionBtn.addEventListener('click', (e) => { e.stopPropagation(); Admin.delRegion(region); });
          content.appendChild(delRegionBtn);

          wrapper.appendChild(header);
          wrapper.appendChild(content);
          container.appendChild(wrapper);
        });
      },

      createFeeRow: (region, fee) => {
        const row = Utils.createElement('div', 'edit-row mb-3 pb-3 border-b border-white/5');
        const label = Utils.createElement('span', 'text-xs text-slate-400 w-full', 'База:');
        const input = Utils.createElement('input', 'edit-input w-24 text-right mono');
        input.type = 'number';
        input.value = fee;
        input.min = '0';
        input.addEventListener('change', () => Admin.setRegionFee(region, input.value));
        row.appendChild(label);
        row.appendChild(input);
        return row;
      },

      createCityRow: (region, city, price) => {
        const row = Utils.createElement('div', 'edit-row ml-4');

        const nameInput = Utils.createElement('input', 'edit-input');
        nameInput.value = city;
        nameInput.maxLength = 100;
        nameInput.addEventListener('change', () => {
          const newName = Utils.sanitizeText(nameInput.value, 100);
          if (newName && newName !== city) Admin.renameCity(region, city, newName);
          else nameInput.value = city;
        });

        const priceInput = Utils.createElement('input', 'edit-input w-24 text-right mono');
        priceInput.type = 'number';
        priceInput.value = price;
        priceInput.min = '0';
        priceInput.addEventListener('change', () => Admin.setCityPrice(region, city, priceInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delCity(region, city));

        row.appendChild(nameInput);
        row.appendChild(priceInput);
        row.appendChild(delBtn);
        return row;
      },

      addRegion: () => {
        const name = prompt('Название региона:');
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 100);
        if (!sanitized) { App.showToast('Некорректное имя'); return; }

        if (DB.travel[sanitized]) { App.showToast('Регион уже существует'); return; }

        DB.travel[sanitized] = { fee: 0, cities: {} };
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      delRegion: (region) => {
        if (!confirm(`Удалить регион "${region}"?`)) return;
        delete DB.travel[region];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      setRegionFee: (region, value) => {
        if (!DB.travel[region]) return;
        DB.travel[region].fee = Utils.sanitizeNumber(value, 0);
        Storage.save();
      },

      addCity: (region) => {
        if (!DB.travel[region]) return;
        const name = prompt('Название города:');
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 100);
        if (!sanitized) { App.showToast('Некорректное имя'); return; }

        DB.travel[region].cities[sanitized] = 0;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      delCity: (region, city) => {
        if (!DB.travel[region] || !DB.travel[region].cities) return;
        delete DB.travel[region].cities[city];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      renameCity: (region, oldName, newName) => {
        if (!DB.travel[region] || !DB.travel[region].cities) return;
        if (oldName === newName) return;
        const price = DB.travel[region].cities[oldName];
        delete DB.travel[region].cities[oldName];
        DB.travel[region].cities[newName] = price;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      setCityPrice: (region, city, value) => {
        if (!DB.travel[region] || !DB.travel[region].cities) return;
        DB.travel[region].cities[city] = Utils.sanitizeNumber(value, 0);
        Storage.save();
      },

      // SERVICES
      renderServices: () => {
        const container = document.getElementById('settings-services-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.services || !Utils.isValidObject(DB.services)) {
          container.textContent = 'Нет категорий';
          return;
        }

        Object.keys(DB.services).sort().forEach(category => {
          const services = DB.services[category];
          if (!Utils.isValidObject(services)) return;

          const wrapper = Utils.createElement('div', 'bg-white/5 rounded-lg p-3 mb-2');

          const header = Utils.createElement('div', 'admin-header');
          header.addEventListener('click', function() { Admin.toggleSection(this); });

          const titleSpan = Utils.createElement('span', 'font-bold text-sm text-purple-400');
          titleSpan.textContent = category;

          const iconEl = document.createElement('i');
          iconEl.setAttribute('data-lucide', 'chevron-down');
          iconEl.className = 'w-4 h-4 text-slate-500 transition-transform';

          header.appendChild(titleSpan);
          header.appendChild(iconEl);

          const content = Utils.createElement('div', 'admin-content');

          Object.keys(services).sort().forEach(service => {
            const serviceRow = Admin.createServiceRow(category, service, services[service]);
            content.appendChild(serviceRow);
          });

          const addSvcBtn = Utils.createElement('button', 'btn-add-mini mt-1 text-xs', '+ Услуга');
          addSvcBtn.addEventListener('click', (e) => { e.stopPropagation(); Admin.addSvc(category); });
          content.appendChild(addSvcBtn);

          const delCatBtn = Utils.createElement(
            'button',
            'text-[10px] text-red-400 mt-3 w-full text-right opacity-50 hover:opacity-100',
            'Удалить категорию'
          );
          delCatBtn.addEventListener('click', (e) => { e.stopPropagation(); Admin.delCat(category); });
          content.appendChild(delCatBtn);

          wrapper.appendChild(header);
          wrapper.appendChild(content);
          container.appendChild(wrapper);
        });
      },

      createServiceRow: (category, service, price) => {
        const row = Utils.createElement('div', 'edit-row ml-4');

        const nameInput = Utils.createElement('input', 'edit-input');
        nameInput.value = service;
        nameInput.maxLength = 200;
        nameInput.addEventListener('change', () => {
          const newName = Utils.sanitizeText(nameInput.value, 200);
          if (newName && newName !== service) Admin.renameSvc(category, service, newName);
          else nameInput.value = service;
        });

        const priceInput = Utils.createElement('input', 'edit-input w-24 text-right mono');
        priceInput.type = 'number';
        priceInput.value = price;
        priceInput.min = '0';
        priceInput.addEventListener('change', () => Admin.setSvcPrice(category, service, priceInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delSvc(category, service));

        row.appendChild(nameInput);
        row.appendChild(priceInput);
        row.appendChild(delBtn);
        return row;
      },

      addCategory: () => {
        const name = prompt('Название категории:');
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 100);
        if (!sanitized) { App.showToast('Некорректное имя'); return; }
        if (DB.services[sanitized]) { App.showToast('Категория уже существует'); return; }

        DB.services[sanitized] = {};
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      delCat: (category) => {
        if (!confirm(`Удалить категорию "${category}"?`)) return;
        delete DB.services[category];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      addSvc: (category) => {
        if (!DB.services[category]) return;
        const name = prompt('Название услуги:');
        if (!name) return;

        const sanitized = Utils.sanitizeText(name, 200);
        if (!sanitized) { App.showToast('Некорректное имя'); return; }

        DB.services[category][sanitized] = 0;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      delSvc: (category, service) => {
        if (!DB.services[category]) return;
        delete DB.services[category][service];
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      renameSvc: (category, oldName, newName) => {
        if (!DB.services[category]) return;
        if (oldName === newName) return;
        const price = DB.services[category][oldName];
        delete DB.services[category][oldName];
        DB.services[category][newName] = price;
        Storage.save();
        Admin.render();
        App.updateUI();
      },

      setSvcPrice: (category, service, value) => {
        if (!DB.services[category]) return;
        DB.services[category][service] = Utils.sanitizeNumber(value, 0);
        Storage.save();
      },

      // HOLIDAYS
      renderHolidays: () => {
        const container = document.getElementById('settings-holidays-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.holidays || !Utils.isValidObject(DB.holidays)) {
          container.textContent = 'Нет праздничных дат';
          return;
        }

        Object.keys(DB.holidays).sort().forEach(key => {
          container.appendChild(Admin.createHolidayRow(key, DB.holidays[key]));
        });
      },

      createHolidayRow: (key, value) => {
        const row = Utils.createElement('div', 'edit-row');

        const keyInput = Utils.createElement('input', 'edit-input text-center mono');
        keyInput.value = key;
        keyInput.placeholder = 'MM-DD';
        keyInput.maxLength = 5;
        keyInput.addEventListener('change', () => {
          const newKey = keyInput.value.trim();
          if (Utils.validateDateKey(newKey) && newKey !== key) {
            Admin.updateHolidayKey(key, newKey);
          } else {
            keyInput.value = key;
            if (!Utils.validateDateKey(newKey)) {
              Utils.validateInput(keyInput, () => false);
              App.showToast('Неверный формат даты (MM-DD)');
            }
          }
        });

        const valInput = Utils.createElement('input', 'edit-input w-20 text-center text-amber-400 font-extrabold mono');
        valInput.type = 'number';
        valInput.value = value;
        valInput.min = '1';
        valInput.max = '10';
        valInput.step = '0.1';
        valInput.addEventListener('change', () => Admin.updateHolidayVal(key, valInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delHoliday(key));

        row.appendChild(keyInput);
        row.appendChild(valInput);
        row.appendChild(delBtn);
        return row;
      },

      addHoliday: () => {
        const date = prompt('Дата (ММ-ДД):', '12-31');
        if (!date) return;
        if (!Utils.validateDateKey(date)) { App.showToast('Неверный формат даты (MM-DD)'); return; }
        DB.holidays[date] = 1.5;
        Storage.save();
        Admin.render();
      },

      delHoliday: (key) => { delete DB.holidays[key]; Storage.save(); Admin.render(); },

      updateHolidayKey: (oldKey, newKey) => {
        const value = DB.holidays[oldKey];
        delete DB.holidays[oldKey];
        DB.holidays[newKey] = value;
        Storage.save();
        Admin.render();
      },

      updateHolidayVal: (key, value) => { DB.holidays[key] = Utils.sanitizeFloat(value, 1, 10); Storage.save(); },

      // RANGES
      renderRanges: () => {
        const container = document.getElementById('settings-ranges-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.holidayRanges || !Array.isArray(DB.holidayRanges) || DB.holidayRanges.length === 0) {
          container.textContent = 'Нет периодов';
          return;
        }

        DB.holidayRanges.forEach((range, index) => container.appendChild(Admin.createRangeRow(range, index)));
      },

      createRangeRow: (range, index) => {
        const row = Utils.createElement('div', 'edit-row');

        const start = `${String(range.sm || 12).padStart(2, '0')}-${String(range.sd || 1).padStart(2, '0')}`;
        const end = `${String(range.em || 12).padStart(2, '0')}-${String(range.ed || 31).padStart(2, '0')}`;

        const startInput = Utils.createElement('input', 'edit-input text-center text-xs px-1 mono');
        startInput.value = start;
        startInput.maxLength = 5;
        startInput.addEventListener('change', () => Admin.updateRange(index, 'start', startInput.value));

        const arrow = Utils.createElement('span', 'text-slate-500', '→');

        const endInput = Utils.createElement('input', 'edit-input text-center text-xs px-1 mono');
        endInput.value = end;
        endInput.maxLength = 5;
        endInput.addEventListener('change', () => Admin.updateRange(index, 'end', endInput.value));

        const kInput = Utils.createElement('input', 'edit-input w-16 text-center text-amber-400 font-extrabold mono');
        kInput.type = 'number';
        kInput.value = range.k || 1.5;
        kInput.min = '1';
        kInput.max = '10';
        kInput.step = '0.1';
        kInput.addEventListener('change', () => Admin.updateRange(index, 'k', kInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delRange(index));

        row.appendChild(startInput);
        row.appendChild(arrow);
        row.appendChild(endInput);
        row.appendChild(kInput);
        row.appendChild(delBtn);
        return row;
      },

      addRange: () => {
        if (!DB.holidayRanges) DB.holidayRanges = [];
        DB.holidayRanges.push({ sm: 12, sd: 20, em: 12, ed: 30, k: 1.5 });
        Storage.save();
        Admin.render();
      },

      delRange: (index) => {
        if (!DB.holidayRanges || index < 0 || index >= DB.holidayRanges.length) return;
        DB.holidayRanges.splice(index, 1);
        Storage.save();
        Admin.render();
      },

      updateRange: (index, field, value) => {
        if (!DB.holidayRanges || index < 0 || index >= DB.holidayRanges.length) return;
        const range = DB.holidayRanges[index];

        if (field === 'k') {
          range.k = Utils.sanitizeFloat(value, 1, 10);
        } else {
          const parts = value.split('-');
          const m = Utils.sanitizeNumber(parts[0], 1, 12);
          const d = Utils.sanitizeNumber(parts[1], 1, 31);
          if (m && d) {
            if (field === 'start') { range.sm = m; range.sd = d; }
            else if (field === 'end') { range.em = m; range.ed = d; }
          }
        }
        Storage.save();
      },

      // BONUSES
      renderBonuses: () => {
        const container = document.getElementById('settings-bonuses-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.bonuses || !Array.isArray(DB.bonuses) || DB.bonuses.length === 0) {
          container.textContent = 'Нет бонусов';
          return;
        }

        DB.bonuses.forEach((bonus, index) => container.appendChild(Admin.createBonusRow(bonus, index)));
      },

      createBonusRow: (bonus, index) => {
        const row = Utils.createElement('div', 'edit-row');

        const label = Utils.createElement('span', 'text-xs text-slate-500 w-8', 'От');

        const thresholdInput = Utils.createElement('input', 'edit-input w-24 text-right mono');
        thresholdInput.type = 'number';
        thresholdInput.value = bonus.threshold || 0;
        thresholdInput.placeholder = 'Сумма';
        thresholdInput.min = '0';
        thresholdInput.addEventListener('change', () => Admin.updateBonus(index, 'threshold', thresholdInput.value));

        const textInput = Utils.createElement('input', 'edit-input flex-1');
        textInput.value = bonus.text || '';
        textInput.placeholder = 'Текст бонуса';
        textInput.maxLength = 200;
        textInput.addEventListener('input', () => Admin.updateBonus(index, 'text', textInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delBonus(index));

        row.appendChild(label);
        row.appendChild(thresholdInput);
        row.appendChild(textInput);
        row.appendChild(delBtn);
        return row;
      },

      addBonus: () => {
        if (!DB.bonuses) DB.bonuses = [];
        DB.bonuses.push({ threshold: 10000, text: 'Бонус' });
        Storage.save();
        Admin.render();
        App.calc();
      },

      delBonus: (index) => {
        if (!DB.bonuses || index < 0 || index >= DB.bonuses.length) return;
        DB.bonuses.splice(index, 1);
        Storage.save();
        Admin.render();
        App.calc();
      },

      updateBonus: (index, field, value) => {
        if (!DB.bonuses || index < 0 || index >= DB.bonuses.length) return;
        if (field === 'threshold') DB.bonuses[index].threshold = Utils.sanitizeNumber(value, 0);
        else if (field === 'text') DB.bonuses[index].text = Utils.sanitizeText(value, 200);
        Storage.save();
        App.calc();
      },

      // PAYMENTS
      renderPayments: () => {
        const container = document.getElementById('settings-payments-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.payments || !Array.isArray(DB.payments) || DB.payments.length === 0) {
          container.textContent = 'Нет реквизитов';
          return;
        }

        DB.payments.forEach((payment, index) => container.appendChild(Admin.createPaymentCard(payment, index)));
      },

      createPaymentCard: (payment, index) => {
        const wrapper = Utils.createElement('div', 'bg-white/5 rounded-lg p-2 mb-2 relative group');

        const titleInput = Utils.createElement('input', 'bg-transparent text-amber-500 font-extrabold text-xs w-full mb-1 outline-none');
        titleInput.value = payment.title || '';
        titleInput.maxLength = 100;
        titleInput.addEventListener('input', () => Admin.updatePayment(index, 'title', titleInput.value));

        const textArea = document.createElement('textarea');
        textArea.className = 'bg-transparent text-slate-300 text-xs w-full outline-none resize-none h-auto';
        textArea.rows = 1;
        textArea.value = payment.text || '';
        textArea.maxLength = 500;
        textArea.addEventListener('input', () => {
          Admin.updatePayment(index, 'text', textArea.value);
          textArea.style.height = 'auto';
          textArea.style.height = textArea.scrollHeight + 'px';
        });

        const delBtn = Utils.createElement('button', 'absolute top-2 right-2 btn-del-mini opacity-0 group-hover:opacity-100 transition');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delPayment(index));

        wrapper.appendChild(titleInput);
        wrapper.appendChild(textArea);
        wrapper.appendChild(delBtn);
        return wrapper;
      },

      addPayment: () => {
        if (!DB.payments) DB.payments = [];
        DB.payments.push({ title: 'Банк', text: '' });
        Storage.save();
        Admin.render();
      },

      delPayment: (index) => {
        if (!DB.payments || index < 0 || index >= DB.payments.length) return;
        DB.payments.splice(index, 1);
        Storage.save();
        Admin.render();
      },

      updatePayment: (index, field, value) => {
        if (!DB.payments || index < 0 || index >= DB.payments.length) return;
        if (field === 'title') DB.payments[index].title = Utils.sanitizeText(value, 100);
        else if (field === 'text') DB.payments[index].text = Utils.sanitizeText(value, 500);
        Storage.save();
      },

      // LINKS
      renderLinks: () => {
        const container = document.getElementById('settings-links-list');
        if (!container) return;

        Utils.clearElement(container);

        if (!DB.links || !Array.isArray(DB.links) || DB.links.length === 0) {
          container.textContent = 'Нет ссылок';
          return;
        }

        DB.links.forEach((link, index) => container.appendChild(Admin.createLinkRow(link, index)));
      },

      createLinkRow: (link, index) => {
        const row = Utils.createElement('div', 'edit-row');

        const labelInput = Utils.createElement('input', 'edit-input w-1/3');
        labelInput.value = link.label || '';
        labelInput.maxLength = 50;
        labelInput.addEventListener('input', () => Admin.updateLink(index, 'label', labelInput.value));

        const urlInput = Utils.createElement('input', 'edit-input flex-1');
        urlInput.value = link.url || '';
        urlInput.placeholder = 'https://...';
        urlInput.maxLength = 500;
        urlInput.addEventListener('input', () => Admin.updateLink(index, 'url', urlInput.value));

        const delBtn = Utils.createElement('button', 'btn-del-mini');
        delBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
        delBtn.addEventListener('click', () => Admin.delLink(index));

        row.appendChild(labelInput);
        row.appendChild(urlInput);
        row.appendChild(delBtn);
        return row;
      },

      addLink: () => {
        if (!DB.links) DB.links = [];
        DB.links.push({ label: 'Сайт', url: '' });
        Storage.save();
        Admin.render();
      },

      delLink: (index) => {
        if (!DB.links || index < 0 || index >= DB.links.length) return;
        DB.links.splice(index, 1);
        Storage.save();
        Admin.render();
      },

      updateLink: (index, field, value) => {
        if (!DB.links || index < 0 || index >= DB.links.length) return;
        if (field === 'label') DB.links[index].label = Utils.sanitizeText(value, 50);
        else if (field === 'url') DB.links[index].url = Utils.sanitizeText(value, 500);
        Storage.save();
      },

      reset: () => {
        if (!confirm('Сбросить базу цен к заводским настройкам? Это действие необратимо!')) return;
        Storage.reset();
        location.reload();
      }
    };

    // ============================================================================
    // BOOT (НЕ ТРОГАЙ)
    // ============================================================================
    window.onload = App.init;
  </script>
</body>
</html>
