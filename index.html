<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / iOS Home Screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Productive Magic">
    <meta name="theme-color" content="#0b0c10">

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180-pm.png">
    <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167-pm.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152-pm.png">
    <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120-pm.png">

    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32-pm.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192-pm.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512-pm.png">
<title>Productive Magic</title>
<style>
        /* --- iOS SYSTEM THEME (PLATINUM) --- */
        :root {
            color-scheme: dark;
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --bg-input: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent: #0A84FF;
            --accent-gold: #D4AF37;
            --calendar-red: #FF453A;
            --danger: #FF453A;
            --success: #30D158;
            --separator: #38383A;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        
            --tabs-height: 72px; /* visual bar height */
            --tabs-h: calc(var(--tabs-height) + var(--safe-bottom));
            --tabs-total: var(--tabs-h);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0; padding: 0;
            padding-top: calc(var(--safe-top) + 10px);
            padding-bottom: var(--tabs-h);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- TABS --- */
        .tabs {
            left: 0; width: 100%;
            height: var(--tabs-h);
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(255,255,255,0.15);
            padding-bottom: var(--safe-bottom);
            display: flex; justify-content: space-around;
            z-index: 500;
        }
        body:not(.pwa-fixed) .tabs{ position: fixed; bottom: 0; }
        body.pwa-fixed #app-shell .tabs{ position: absolute; bottom: 0; }
        .tab-btn {
            flex: 1; padding: 8px 0 2px; text-align: center; color: var(--text-secondary);
            font-size: 10px; font-weight: 500; cursor: pointer; transition: color 0.2s;
        }
        .tab-btn svg { width: 28px; height: 28px; margin: 0 auto 2px; display: block; }
        .tab-btn.active { color: var(--accent); }

        /* --- VIEWS --- */
        .view { display: none; width: 100%; padding-bottom: 40px; }
        .view.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HEADER --- */
        .header { padding: 10px 16px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 34px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
        .header p { font-size: 13px; color: var(--text-secondary); margin-top: 2px; font-weight: 500; }
        .header-btn-add { font-size: 28px; color: var(--accent); cursor: pointer; padding: 5px; line-height: 1; }

        /* --- FORMS & INPUTS --- */
        .section-title { 
            margin: 24px 16px 8px; font-size: 13px; color: var(--text-secondary); 
            text-transform: uppercase; letter-spacing: -0.2px; padding-left: 12px;
        }
        .group-container { 
            margin: 0 16px; background: var(--bg-card); border-radius: 12px; overflow: hidden; 
        }
        
        .input-row {
            position: relative; display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; border-bottom: 0.5px solid var(--separator); min-height: 50px;
        }
        .input-row:last-child { border-bottom: none; }
        .input-row:active { background: #252527; }
        
        .label { font-size: 17px; color: var(--text-primary); flex-shrink: 0; }
        
        .value-wrapper { display: flex; align-items: center; gap: 8px; flex-grow: 1; justify-content: flex-end; overflow: hidden; }
        .value-display { 
            font-size: 17px; color: var(--text-secondary); text-align: right; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .value-display.filled { color: var(--accent); }
        .chevron { color: #555; width: 14px; height: 14px; opacity: 0.5; }

        .native-control { 
            position: absolute; top: var(--vv-top, 0px); left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer; font-size: 16px; z-index: 10;
        }
        
        .text-input { 
            background: transparent; border: none; color: #fff; font-size: 17px; 
            text-align: right; outline: none; width: 100%; 
        }
        .text-input::placeholder { color: var(--text-secondary); }

        /* --- CONTROLS --- */
        /* iOS Switch */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #39393D; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: #30D158; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- CART --- */
        .service-adder { display: flex; align-items: center; border-top: 0.5px solid var(--separator); }
        .qty-control { display: flex; align-items: center; padding: 0 4px; border-right: 0.5px solid var(--separator); background: #252527; }
        .qty-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--accent); cursor: pointer; }
        .qty-val { width: 28px; text-align: center; font-weight: 600; font-size: 17px; }
        .btn-add-service { 
            flex-grow: 1; background: var(--bg-card); color: var(--accent); 
            font-weight: 600; text-align: center; padding: 14px; font-size: 17px; cursor: pointer; 
        }
        .btn-add-service:active { opacity: 0.7; background: #2c2c2e; }

        .cart-list { margin: 12px 16px 0; display: flex; flex-direction: column; gap: 8px; }
        .cart-item { 
            background: var(--bg-card); padding: 12px 16px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(-5px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .cart-info { flex-grow: 1; }
        .cart-name { font-size: 16px; font-weight: 500; color: #fff; margin-bottom: 2px; }
        .cart-price { font-size: 14px; color: var(--text-secondary); }
        .btn-remove { 
            width: 32px; height: 32px; border-radius: 50%; background: rgba(255,69,58,0.15); 
            color: var(--danger); display: flex; align-items: center; justify-content: center; 
            font-size: 20px; margin-left: 12px; cursor: pointer; 
        }

        /* --- TOTAL PANEL --- */
        .total-panel { 
            margin: 24px 16px 0; padding: 20px; background: var(--bg-card); border-radius: 16px; 
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;
        }
        .total-label { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 4px; }
        .total-sum { font-size: 44px; font-weight: 800; color: var(--accent-gold); line-height: 1; letter-spacing: -1px; margin-bottom: 12px; }
        
        .btn-main { 
            display: flex; width: 100%; background: var(--text-primary); color: #000; 
            font-size: 17px; font-weight: 600; padding: 16px; border-radius: 14px; 
            border: none; cursor: pointer; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        
        .btn-secondary{
            width: 100%;
            margin-top: 10px;
            padding: 12px 16px;
            border-radius: 14px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.14);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
        }
        .btn-secondary:active{ transform: scale(0.99); }

        /* Sales modal */
        #sales-modal .modal-header{
            position: sticky; top: 0;
            background: rgba(18,18,18,0.9);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 2;
        }
        #sales-search{
            margin: 10px 0 12px 0;
        }
        .sales-list{
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sales-item{
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 14px;
            padding: 12px;
            cursor: pointer;
        }
        .sales-item.active{
            border-color: rgba(10,132,255,0.55);
            box-shadow: 0 0 0 3px rgba(10,132,255,0.16);
        }
        .sales-item .title{
            font-weight: 800;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .sales-item .hint{
            font-size: 12px;
            opacity: 0.72;
            line-height: 1.25;
        }
.btn-main:active { transform: scale(0.97); opacity: 0.9; }

        .discount-badge { color: var(--success); font-size: 13px; font-weight: 600; margin-bottom: 8px; display: none; }
        .bonus-banner { 
            background: linear-gradient(90deg, #252527, #303033); border: 1px solid rgba(212,175,55,0.3); 
            color: var(--accent-gold); font-size: 13px; font-weight: 600; padding: 12px; 
            border-radius: 10px; margin-bottom: 16px; display: none; text-align: left;
        }

        /* --- CALENDAR --- */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px 16px; }
        .current-month { font-size: 20px; font-weight: 700; color: var(--accent-gold); }
        .month-nav { font-size: 24px; color: var(--accent); padding: 5px 15px; cursor: pointer; }
        
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 8px; padding: 0 8px; }
        .weekday { text-align: center; font-size: 12px; color: #666; font-weight: 600; text-transform: uppercase; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); row-gap: 8px; padding: 0 8px; }
        .day-cell { 
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 18px; position: relative; border-radius: 50%; cursor: pointer;
        }
        .day-cell.today { color: var(--calendar-red); font-weight: 700; }
        .day-cell.selected { background: #fff; color: #000 !important; font-weight: 600; }
        .day-cell.today.selected { background: var(--calendar-red); color: #fff !important; }
        
        .day-dots { display: flex; gap: 3px; position: absolute; bottom: 6px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; background: #555; }
        .dot.active { background: var(--accent); }

        .events-container { margin-top: 24px; border-top: 0.5px solid var(--separator); }
        .selected-date-title { 
            padding: 12px 16px; font-size: 13px; color: var(--text-secondary); 
            text-transform: uppercase; font-weight: 600; background: #121212; 
        }
        .event-item { display: flex; padding: 12px 16px; border-bottom: 0.5px solid var(--separator); align-items: center; }
        .event-time { width: 50px; font-size: 15px; color: var(--text-secondary); font-weight: 500; }
        .event-details { flex-grow: 1; padding-left: 10px; border-left: 3px solid var(--accent); }
        .event-title { font-size: 16px; font-weight: 600; color: #fff; }
        .event-sub { font-size: 13px; color: var(--text-secondary); }
        .event-price { font-size: 15px; font-weight: 600; color: #fff; margin-right: 10px; }

        /* --- SETTINGS --- */
        .btn-add { width: 100%; padding: 14px; text-align: center; color: var(--accent); font-weight: 600; font-size: 16px; background: var(--bg-card); border-top: 0.5px solid var(--separator); cursor: pointer; }
        .btn-add:active { background: #2c2c2e; }
        
        .settings-block { margin-bottom: 16px; background: var(--bg-card); border-radius: 12px; overflow: hidden; }
        .settings-header { 
            padding: 14px 16px; background: #252527; font-weight: 600; color: var(--accent); 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .settings-header .toggle-icon { transition: transform 0.2s; font-size: 12px; }
        .settings-content { display: none; }
        .settings-content.open { display: block; }
        
        .set-row { display: flex; padding: 10px 16px; border-bottom: 0.5px solid var(--separator); align-items: center; gap: 10px; }
        .set-input-name { background: transparent; border: none; color: #fff; flex-grow: 1; font-size: 16px; border-bottom: 1px solid transparent; padding: 4px 0; outline: none; }
        .set-input-name:focus { border-bottom: 1px solid var(--accent); }
        .set-input-price { background: #333; border: none; border-radius: 6px; padding: 6px; color: #fff; width: 80px; text-align: right; font-size: 15px; outline: none; }
        .btn-del-item { color: var(--danger); font-size: 24px; width: 30px; text-align: center; cursor: pointer; line-height: 20px; }

        .btn-reset { margin: 30px 16px; padding: 14px; text-align: center; color: var(--danger); border: 1px solid var(--danger); border-radius: 12px; font-weight: 600; cursor: pointer; }

        /* --- UTILS --- */
        .badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 8px; display: none; }
        .toast { 
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px); 
            background: rgba(50,50,50,0.9); backdrop-filter: blur(10px); color: #fff; 
            padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 14px; 
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 600; display: flex; align-items: center; gap: 8px; 
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .conflict-alert { color: var(--danger); font-size: 12px; font-weight: 600; margin-top: 6px; display: none; }

        /* HISTORY */
        .history-list { margin: 0 16px; display: flex; flex-direction: column; gap: 10px; }
        .history-item { background: var(--bg-card); padding: 14px; border-radius: 12px; border-left: 4px solid var(--separator); position: relative; }
        .history-item.status-new { border-left-color: var(--separator); } 
        .history-item.status-think { border-left-color: var(--accent); }
        .history-item.status-deposit { border-left-color: var(--success); }
        .history-item.status-cancel { border-left-color: var(--danger); }
        .hist-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .hist-name { font-weight: 600; font-size: 16px; } .hist-date { font-size: 13px; color: var(--text-secondary); }
        .hist-bot { display: flex; justify-content: space-between; align-items: flex-end; }
        .hist-det { font-size: 13px; color: #888; max-width: 70%; }
        .hist-price { font-size: 16px; font-weight: 700; color: var(--accent-gold); }
        .btn-hist-del { position: absolute; top: 10px; right: 10px; color: var(--danger); opacity: 0.5; font-size: 18px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 600; display: none; align-items: flex-end; }
        .modal.active { display: flex; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-card { background: #1C1C1E; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; padding-bottom: 50px; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    
        /* --- v11: missing utility classes (keep existing UI, just make it consistent) --- */
        .edit-input, .text-input, select.native-control, input.native-control {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,.10);
            border-radius: 10px;
            padding: 10px 12px;
            outline: none;
        }
        .edit-input:focus, .text-input:focus, select.native-control:focus, input.native-control:focus {
            border-color: rgba(10,132,255,.55);
            box-shadow: 0 0 0 3px rgba(10,132,255,.18);
        }



/* --- FIX: visible controls in modal (no white fields) --- */
.native-control-inline{
    background: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 10px;
    padding: 10px 12px;
    outline: none;
    font-size: 16px;
    line-height: 1.2;
    min-width: 120px;
    text-align: right;
    appearance: none;
    -webkit-appearance: none;
    color-scheme: dark;
}
.native-control-inline:focus{
    border-color: rgba(10,132,255,.55);
    box-shadow: 0 0 0 3px rgba(10,132,255,.18);
}
/* Safari/iOS: force text color inside date/time */
#event-modal input[type="date"].native-control-inline,
#event-modal input[type="time"].native-control-inline{
    -webkit-text-fill-color: var(--text-primary);
}
#event-modal select.native-control-inline{
    padding-right: 34px;
    background-image:
        linear-gradient(45deg, transparent 50%, #8E8E93 50%),
        linear-gradient(135deg, #8E8E93 50%, transparent 50%);
    background-position:
        calc(100% - 18px) 50%,
        calc(100% - 13px) 50%;
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
}


/* --- Notes (Calendar Event) --- */
.notes-area{
    width: 100%;
    margin-top: 10px;
    background: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 12px;
    padding: 12px;
    font-size: 16px;
    line-height: 1.35;
    outline: none;
    resize: none;
    min-height: 110px;
    -webkit-text-fill-color: var(--text-primary);
}
.notes-area::placeholder{ color: var(--text-secondary); }
.notes-area:focus{
    border-color: rgba(10,132,255,.55);
    box-shadow: 0 0 0 3px rgba(10,132,255,.18);
}

        .btn-add-item, .btn-delete-hist {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
        }
        .btn-add-item:active, .btn-delete-hist:active { transform: scale(.98); }

        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            line-height: 1;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.12);
            background: rgba(255,255,255,.06);
            margin-right: 6px;
            white-space: nowrap;
        }
        .status-badge.sb-new { color: #0A84FF; border-color: rgba(10,132,255,.35); background: rgba(10,132,255,.12); }
        .status-badge.sb-think { color: #FFD60A; border-color: rgba(255,214,10,.35); background: rgba(255,214,10,.12); }
        .status-badge.sb-deposit { color: #30D158; border-color: rgba(48,209,88,.35); background: rgba(48,209,88,.12); }
        .status-badge.sb-cancel { color: #FF453A; border-color: rgba(255,69,58,.35); background: rgba(255,69,58,.12); }

/* --- v14: Apple-like polish (only overrides, nothing removed) --- */
:root{
  --radius-card: 14px;
  --radius-modal: 22px;
  --hairline: rgba(255,255,255,.14);
  --shadow-card: 0 6px 24px rgba(0,0,0,.35);
  --shadow-elev: 0 10px 40px rgba(0,0,0,.55);
}

/* Let users copy text like in real apps */
body{
  user-select: text;
  -webkit-text-size-adjust: 100%;
}
.tab-btn, .btn-main, .qty-btn, .btn-add-service, .header-btn-add, .btn-remove, .btn-del-item,
.btn-add, .settings-header, .month-nav, .day-cell, .btn-reset, .btn-close, .btn-save{
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
}

/* Softer, more iOS-like grouped cards */
.group-container,
.cart-item,
.total-panel,
.settings-block,
.history-item{
  border-radius: var(--radius-card);
}
.group-container{
  box-shadow: 0 1px 0 rgba(255,255,255,.04) inset;
}
.total-panel{ box-shadow: var(--shadow-card); }

/* Inset separators (like iOS Settings) */
.input-row{ border-bottom: none; }
.input-row::after{
  content:"";
  position:absolute;
  left:16px;
  right:0;
  bottom:0;
  height:0.5px;
  background: var(--separator);
  opacity:.9;
}
.input-row:last-child::after{ display:none; }
.input-row:active{ background: rgba(255,255,255,.04); }

/* Section label: calmer and cleaner */
.section-title{
  text-transform: uppercase;
  letter-spacing: .9px;
  font-size: 12px;
  margin-top: 22px;
  opacity: .9;
}

/* Tabs: bigger text, cleaner spacing */
.tabs{
  background: rgba(28,28,30,.78);
  border-top: 0.5px solid var(--hairline);
}
.tab-btn{
  font-size: 11px;
  padding: 8px 0 4px;
}
.tab-btn svg{
  width: 24px;
  height: 24px;
  margin-bottom: 3px;
  opacity: .92;
}
.tab-btn.active{ color: var(--accent); }
.tab-btn:active{ transform: scale(.98); opacity: .85; }

/* Header: iOS large-title vibe */
.header{
  padding-top: calc(var(--safe-top) + 6px);
}
.header h1{
  letter-spacing: -0.8px;
}
.header p{
  opacity: .9;
}

/* Primary button: true iOS blue */
.btn-main{
  background:
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0)) ,
    var(--accent);
  color: #fff;
  box-shadow: 0 8px 18px rgba(10,132,255,.25);
}
.btn-main:active{
  transform: scale(.98);
  opacity: .95;
}

/* Calendar: remove "gold month" (gold reserved for money) */
.current-month{ color: var(--text-primary); }
.weekday{ color: rgba(255,255,255,.38); font-weight: 600; }

/* Calendar selected day: premium highlight instead of white bubble */
.day-cell{
  background: transparent;
  transition: transform .12s ease, background .12s ease;
}
.day-cell:active{ transform: scale(.92); background: rgba(255,255,255,.05); }
.day-cell.selected{
  background: rgba(10,132,255,.18);
  border: 1px solid rgba(10,132,255,.55);
  color: #fff !important;
  font-weight: 700;
}
.day-cell.today{ color: var(--calendar-red); }
.day-cell.today.selected{
  background: rgba(255,69,58,.18);
  border: 1px solid rgba(255,69,58,.65);
  color:#fff !important;
}

/* Events list: grouped card style */
.events-container{
  margin: 18px 16px 0;
  background: var(--bg-card);
  border-radius: var(--radius-card);
  overflow: hidden;
  border: 0.5px solid rgba(255,255,255,.06);
}
.selected-date-title{
  background: rgba(255,255,255,.03);
  border-bottom: 0.5px solid rgba(255,255,255,.10);
}
.event-item{
  border-bottom: 0.5px solid rgba(255,255,255,.08);
}
.event-item:last-child{ border-bottom: none; }

/* Modal: iOS sheet feel + grabber + safe area */
.modal{ backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); }
.modal-card{
  border-radius: var(--radius-modal) var(--radius-modal) 0 0;
  box-shadow: var(--shadow-elev);
  max-height: calc(100vh - 24px);
  overflow: auto;
  padding-bottom: calc(22px + var(--safe-bottom));
}
.modal-card::before{
  content:"";
  display:block;
  width: 42px;
  height: 5px;
  border-radius: 999px;
  background: rgba(255,255,255,.20);
  margin: -6px auto 14px;
}

/* Notes textarea: nicer focus + auto-feel */
.notes-area{
  min-height: 120px;
  border-radius: 14px;
}
.notes-area:focus{
  border-color: rgba(10,132,255,.55);
  box-shadow: 0 0 0 3px rgba(10,132,255,.18);
}

/* --- Touch (–±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã —Ñ–æ–∫—É—Å–Ω–∏–∫–∞) --- */
.touch-card{
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  padding: 12px;
}
.touch-actions{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 8px;
  margin-bottom: 10px;
}
.touch-btn{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: var(--text-primary);
  border-radius: 12px;
  padding: 10px 8px;
  font-size: 12px;
  font-weight: 600;
  line-height: 1;
  cursor: pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.touch-btn:active{ transform: scale(.98); background: rgba(255,255,255,.10); }
.touch-message{
  width: 100%;
  margin-top: 10px;
  background: var(--bg-input);
  color: var(--text-primary);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 12px;
  font-size: 15px;
  line-height: 1.35;
  outline: none;
  resize: none;
  min-height: 140px;
}
.touch-message:focus{
  border-color: rgba(10,132,255,.55);
  box-shadow: 0 0 0 3px rgba(10,132,255,.18);
}
.touch-toolbar{
  display:flex;
  gap: 8px;
  margin-top: 10px;
}
.touch-pill{
  flex: 1;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: var(--text-primary);
  border-radius: 12px;
  padding: 10px 10px;
  font-weight: 700;
  font-size: 13px;
  cursor:pointer;
}

.touch-pill.danger{
  background: rgba(255,69,58,.14);
  border-color: rgba(255,69,58,.30);
  color: var(--danger);
}
.touch-pill.ghost{
  background: rgba(255,255,255,.03);
}
.touch-pill:active{ transform: scale(.99); }
.touch-primary{
  background: rgba(10,132,255,.18);
  border-color: rgba(10,132,255,.35);
}
.touch-chips{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 2px;
}
.touch-chip{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: var(--text-primary);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 12px;
  font-weight: 700;
  cursor:pointer;
}
.touch-chip.active{
  background: rgba(10,132,255,.18);
  border-color: rgba(10,132,255,.35);
}
.touch-faq-title{
  margin-top: 12px;
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 700;
}
.touch-faq{
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.touch-faq button{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color: var(--text-primary);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 12px;
  font-weight: 700;
  cursor:pointer;
}
.touch-faq button:active{ transform: scale(.99); }
.touch-hint{
  margin-top: 10px;
  font-size: 12px;
  color: rgba(255,255,255,.55);
  line-height: 1.25;
}
@media (max-width: 420px){
  .touch-actions{ grid-template-columns: repeat(2, 1fr); }
}

/* --- Touch Templates Manager (v16) --- */
.tpl-modal .modal-card{ padding-bottom: calc(var(--safe-bottom) + 14px); }
.tpl-header{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 14px 8px;
}
.tpl-title{
  font-size: 16px;
  font-weight: 700;
  letter-spacing: -0.2px;
}
.tpl-sub{
  font-size: 12px;
  color: rgba(255,255,255,.55);
  margin: 0 14px 10px;
  line-height: 1.25;
}
.tpl-list{ padding: 0 14px; display:flex; flex-direction:column; gap: 12px; }
.tpl-item{
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  padding: 12px;
}
.tpl-row{
  display:flex;
  align-items:center;
  gap: 10px;
  margin-bottom: 10px;
}
.tpl-row .text-input{ flex:1; }
.tpl-actions{
  display:flex;
  gap: 8px;
  margin-top: 10px;
}
.tpl-actions .touch-pill{ flex: 1; }
.tpl-area{
  width:100%;
  background: var(--bg-input);
  color: var(--text-primary);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  padding: 12px;
  font-size: 14px;
  line-height: 1.35;
  outline: none;
  resize: none;
  min-height: 150px;
  -webkit-text-fill-color: var(--text-primary);
}
.tpl-area:focus{
  border-color: rgba(10,132,255,.55);
  box-shadow: 0 0 0 3px rgba(10,132,255,.18);
}
.tpl-tools{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  padding: 12px 14px 0;
}
.tpl-tools .touch-pill{ width:100%; }

/* Reduce motion if user asks OS to */
@media (prefers-reduced-motion: reduce){
  *{ animation: none !important; transition: none !important; }
}


/* --- v12 iPhone adaptive fixes (safe-area + no dead space + scrollable modals) --- */
:root{
  --tabs-height: 70px;             /* visual height of tab bar (without safe area) */
  --tabs-total: calc(var(--tabs-height) + var(--safe-bottom));
  --app-height: 100vh;             /* will be set by JS to window.innerHeight for iOS keyboard */
}

html, body{
  height: 100%;
}

body{
  min-height: var(--app-height);
  padding-bottom: var(--tabs-total) !important;
}

/* Tab bar becomes a ‚Äúreal‚Äù bar with stable height */
.tabs{
  height: var(--tabs-total);
  padding-top: 6px;
  padding-bottom: var(--safe-bottom) !important;
  align-items: flex-end;
}

/* Content should not add extra random space at the bottom */
.view{
  /* IMPORTANT: keep content above fixed tab bar */
  padding-bottom: calc(var(--tabs-total) + 18px) !important;
  min-height: calc(var(--app-height) - var(--tabs-total) - var(--safe-top) - 10px);
  scroll-padding-bottom: var(--tabs-h);
}

/* Avoid iOS ‚Äúblack gap‚Äù caused by large padding and short tab bar */
.view:last-child{ margin-bottom: 0 !important; }

/* Modals: limit height, enable scrolling, keep header tappable */
.modal-card{
  max-height: calc(var(--app-height) - var(--safe-top) - 8px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  padding-bottom: calc(16px + var(--safe-bottom) + var(--kb, 0px)) !important;
}

.modal-scroll{
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex: 1 1 auto;
  min-height: 0; /* critical for iOS flex scroll */
  padding-bottom: calc(12px + var(--kb, 0px));
}

.modal-header{
  position: sticky;
  top: 0;
  background: #1C1C1E;
  padding-top: 6px;
  z-index: 10;
}

/* Bigger tap targets for modal actions */
.modal-header .btn-close,
.modal-header .btn-save{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
}
.modal-header .btn-close{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}
.modal-header .btn-save{
  background: rgba(10,132,255,.18);
  border: 1px solid rgba(10,132,255,.35);
}
.modal-header .btn-close:active,
.modal-header .btn-save:active{ transform: scale(.99); opacity: .92; }


/* Template modal header (same behavior) */
.tpl-header{
  position: sticky;
  top: 0;
  background: #1C1C1E;
  z-index: 10;
  padding-top: 6px;
}

/* Better touch targets on iPhone */
.tab-btn{
  padding: 10px 0 6px !important;
}

/* Prevent the sheet from hiding behind the home indicator when scrolling to the bottom */
.modal-card *{
  scroll-margin-bottom: calc(16px + var(--safe-bottom));
}



html.modal-lock,
body.modal-lock{
  overscroll-behavior: none;
  height: 100%;
  overflow: hidden;
}
body.modal-lock{
  -webkit-overflow-scrolling: auto;
}



/* --- v23 PWA iPhone FIX (fundamental) --- */
/* Stop window/body scrolling. All scrolling happens in #app-scroll and .modal-scroll. */
html.pwa-fixed, body.pwa-fixed{
  height: 100% !important;
  width: 100% !important;
  overflow: hidden !important;
  position: fixed !important;
  left: 0; top: 0;
}

body{
  padding-bottom: 0 !important;
  min-height: 0 !important;
}

#app-shell{
  position: fixed;
  left: 0;
  top: var(--vv-top, 0px);
  width: 100%;
  height: var(--vv-height, 100vh);
  overflow: hidden;
  background: var(--bg-body);
}

#app-scroll{
  position: absolute;
  left: 0; right: 0;
  top: 0;
  bottom: var(--tabs-h);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: calc(var(--safe-top, 0px) + 10px);
  padding-bottom: 16px;
}

#app-shell .tabs{
  position: absolute !important;
  left: 0; right: 0;
  bottom: 0 !important;
}

/* Ensure modals are also tied to the shell viewport */
#app-shell .modal{
  position: absolute !important;
  inset: 0 !important;
}

/* Modal content should never be hidden behind the keyboard */
#app-shell .modal-card{
  max-height: calc(var(--vv-height, 100vh) - 24px);
}

#app-shell .modal-scroll{
  padding-bottom: calc(16px + var(--kb, 0px)) !important;
  -webkit-overflow-scrolling: touch;
}

/* While modal is open, prevent background scroll area from moving */
html.modal-open #app-scroll{
  overflow: hidden;
}


/* --- v29: APP-SHELL (no ‚Äúsite‚Äù feel, no iOS jump) --- */
:root{
  --tabs-height: 66px;
  --tabs-h: calc(var(--tabs-height) + var(--safe-bottom));
  --tabs-total: var(--tabs-h);
}
html, body{
  height: 100% !important;
  overflow: hidden !important;
  background: var(--bg-body);
}
body{
  margin: 0 !important;
  padding: 0 !important;
  -webkit-text-size-adjust: 100%;
}
/* App viewport tied to visualViewport vars from JS */
#app-shell{
  position: fixed;
  left: 0; right: 0;
  top: var(--vv-top, 0px);
  height: var(--vv-height, 100vh);
  overflow: hidden;
  background: var(--bg-body);
}
/* Main scroll area (only this scrolls) */
#app-scroll{
  position: absolute;
  left: 0; right: 0;
  top: 0;
  bottom: var(--tabs-h);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: calc(var(--safe-top) + 8px);
  padding-bottom: 18px;
  scroll-padding-bottom: calc(var(--tabs-h) + 16px);
}
/* Tabs always pinned inside the shell */
#app-shell .tabs{
  position: absolute !important;
  left: 0; right: 0;
  bottom: 0 !important;
}
/* Views shouldn‚Äôt add huge bottom padding (shell already accounts for it) */
#app-shell .view{
  padding-bottom: 24px !important;
  min-height: auto !important;
}
/* Modals live inside shell; they must cover shell viewport */
#app-shell .modal{
  position: absolute !important;
  inset: 0 !important;
}
/* Modal sheet: stable height + internal scrolling */
#app-shell .modal-card{
  max-height: calc(var(--vv-height, 100vh) - 10px);
}
#app-shell .modal-scroll{
  -webkit-overflow-scrolling: touch;
}
/* Make tabbar feel native */
#app-shell .tabs{
  height: var(--tabs-h) !important;
  padding-bottom: var(--safe-bottom) !important;
}
#app-shell .tab-btn{
  font-size: 11px;
  padding: 10px 0 6px;
  line-height: 1.05;
}
#app-shell .tab-btn svg{ width: 24px; height: 24px; }
/* Prevent ‚Äúrubber band‚Äù black bars */
#app-shell, #app-scroll{ overscroll-behavior: none; }

</style>
</head>
<body class="app">
<div id="app-shell">

  <div id="app-scroll">

<!-- 1. –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† -->
    <div id="view-calc" class="view active">
        <div class="header">
            <div><h1>Productive Magic</h1><p>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ö–ü</p></div>
        </div>

        <div class="group-container" style="margin-bottom: 20px;">
            <div class="input-row">
                <div class="label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</div>
                <input type="text" id="inp-client" class="text-input" placeholder="–ò–≤–∞–Ω">
            </div>
            <div class="input-row">
                <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                <input type="tel" id="inp-phone" class="text-input" placeholder="8 9..." >
            </div>
            <div class="input-row">
                <div class="label">–°—Ç–∞—Ç—É—Å</div>
                <div class="value-wrapper"><div id="disp-status" class="value-display">–ò–Ω—Ç–µ—Ä–µ—Å</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-status" class="native-control" onchange="App.updateStatus()">
                    <option value="new" selected>–ò–Ω—Ç–µ—Ä–µ—Å (–°–ø—Ä–æ—Å–∏–ª)</option>
                    <option value="think">–î—É–º–∞–µ—Ç</option>
                    <option value="deposit">–ë—Ä–æ–Ω—å (–û–ø–ª–∞—á–µ–Ω–æ)</option>
                    <option value="cancel">–û—Ç–∫–∞–∑</option>
                </select>
            </div>
            <div class="input-row">
                <div class="label">–°–æ–±—ã—Ç–∏–µ</div>
                <div class="value-wrapper"><div id="disp-event-type" class="value-display">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-event-type" class="native-control" onchange="App.updateEventType()">
                    <option value="" disabled selected>–¢–∏–ø</option><option value="–°–≤–∞–¥—å–±–∞">–°–≤–∞–¥—å–±–∞</option><option value="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤</option><option value="–Æ–±–∏–ª–µ–π">–Æ–±–∏–ª–µ–π</option><option value="–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è">–î–µ–Ω—å –†–æ–∂–¥–µ–Ω–∏—è</option><option value="–î–µ—Ç—Å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫">–î–µ—Ç—Å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫</option><option value="–í–µ—á–µ—Ä–∏–Ω–∫–∞">–í–µ—á–µ—Ä–∏–Ω–∫–∞</option><option value="–í—ã–ø—É—Å–∫–Ω–æ–π">–í—ã–ø—É—Å–∫–Ω–æ–π</option><option value="–ß–∞—Å—Ç–Ω–æ–µ">–ß–∞—Å—Ç–Ω–æ–µ</option>
                </select>
            </div>
        </div>

        <div class="section-title">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</div>
        <div class="group-container">
            <div class="input-row" style="flex-direction:column; align-items:stretch;">
                <div style="display:flex; justify-content:space-between; align-items:center; width: 100%;">
                    <div class="label flex items-center">–î–∞—Ç–∞ <span id="badge-holiday" class="badge"></span></div>
                    <div class="value-wrapper"><div id="disp-date" class="value-display">–°–µ–≥–æ–¥–Ω—è</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                </div>
                <div id="conflict-msg" class="conflict-alert"></div>
                <input type="date" id="inp-date" class="native-control" onchange="App.updateDate()">
            </div>
            <div class="input-row">
                <div class="label">–í—Ä–µ–º—è</div>
                <input type="time" id="inp-time" class="text-input" value="18:00">
            </div>
            <div class="input-row">
                <div class="label">–†–µ–≥–∏–æ–Ω</div>
                <div class="value-wrapper"><div id="disp-region" class="value-display">–ù–µ –≤—ã–±—Ä–∞–Ω</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-region" class="native-control" onchange="App.updateRegion()"></select>
            </div>
            <div class="input-row">
                <div class="label">–ì–æ—Ä–æ–¥</div>
                <div class="value-wrapper"><div id="disp-city" class="value-display">...</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-city" class="native-control" disabled onchange="App.updateCity()"></select>
            </div>
        </div>

        <div class="section-title">–£—Å–ª—É–≥–∏</div>
        <div class="group-container">
            <div class="input-row">
                <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                <div class="value-wrapper"><div id="disp-cat" class="value-display">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-cat" class="native-control" onchange="App.updateCat()"></select>
            </div>
            <div class="input-row">
                <div class="label">–£—Å–ª—É–≥–∞</div>
                <div class="value-wrapper"><div id="disp-svc" class="value-display">...</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-svc" class="native-control" disabled></select>
            </div>
            <div class="service-adder">
                <div class="qty-control">
                    <div class="qty-btn" onclick="App.changeQty(-1)">-</div>
                    <div class="qty-val" id="svc-qty">1</div>
                    <div class="qty-btn" onclick="App.changeQty(1)">+</div>
                </div>
                <div class="btn-add-service" onclick="App.addService()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</div>
            </div>
        </div>

        <div id="cart-list" class="cart-list"></div>

        <div class="section-title">–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã / –ì–æ—Å—Ç–∏</div>
        <div class="group-container">
            <div style="display:flex; padding:12px 16px; gap:10px; border-bottom:0.5px solid var(--separator);">
                <input type="text" id="inp-manual-name" class="edit-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ø–∞ (–Ω–∞–ø—Ä. –ê—Ä–µ–Ω–¥–∞)" oninput="App.calc()">
                <input type="number" id="inp-manual-price" class="edit-input" style="width:90px; text-align:right;" placeholder="‚ÇΩ" oninput="App.calc()">
            </div>
            <div class="input-row">
                <div class="label">–ì–æ—Å—Ç–∏</div>
                <div class="value-wrapper"><div id="disp-guests" class="value-display">–î–æ 50 (0‚ÇΩ)</div><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div>
                <select id="inp-guests" class="native-control" onchange="App.updateGuests()">
                    <option value="0">–î–æ 50 —á–µ–ª–æ–≤–µ–∫ (0‚ÇΩ)</option>
                    <option value="5000">51‚Äì100 —á–µ–ª–æ–≤–µ–∫ (+5 000‚ÇΩ)</option>
                    <option value="10000">101‚Äì200 —á–µ–ª–æ–≤–µ–∫ (+10 000‚ÇΩ)</option>
                    <option value="custom">–ë–æ–ª–µ–µ 200 (–°–ª–∞–π–¥–µ—Ä)</option>
                </select>
            </div>
        </div>
        <div id="slider-wrap" class="slider-wrap" style="display:none; margin:10px 16px; background:var(--bg-card); padding:16px; border-radius:12px;">
            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:10px; color:#888;"><span>–¢–û–ß–ù–û–ï –ß–ò–°–õ–û</span><span id="slider-val" style="color:#fff;">250</span></div>
            <input type="range" id="inp-slider" min="201" max="500" value="250" step="5" oninput="App.calc()" style="width:100%;">
        </div>

        <!-- –ò–¢–û–ì -->
        <div class="total-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #333;">
                <span style="font-size:15px; color:#fff;">–†–∞–±–æ—Ç–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É (+6%)</span>
                <label class="switch">
                    <input type="checkbox" id="inp-tax" onchange="App.calc()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="bonus-alert" class="bonus-banner"></div>
            <div id="discount-badge" class="discount-badge">‚úÖ –°–∫–∏–¥–∫–∞ 10% –∑–∞ –æ–±—ä–µ–º</div>
            
            <div class="total-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å–º–µ—Ç–∞</div>
            <div id="total-sum" class="total-sum">0 ‚ÇΩ</div>
            
            <button class="btn-main" onclick="App.copy()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ö–ü
            </button>
        
            <button class="btn-secondary" onclick="Sales.open()">
                üéØ –ü—Ä–æ–¥–∞–∂–∏: —Å–∫—Ä–∏–ø—Ç—ã –∏ –¥–æ–∂–∏–º
            </button>
</div>
    </div>

<!-- 2. –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <div id="view-calendar" class="view">
        <div class="header"><h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1><div class="header-btn-add" onclick="Calendar.openModal()">+</div></div>
        <div class="calendar-header">
            <div class="month-nav" onclick="Calendar.prevMonth()">‚Äπ</div><div class="current-month" id="cal-month-title"></div><div class="month-nav" onclick="Calendar.nextMonth()">‚Ä∫</div>
        </div>
        <div class="weekdays"><div class="weekday">–ü–Ω</div><div class="weekday">–í—Ç</div><div class="weekday">–°—Ä</div><div class="weekday">–ß—Ç</div><div class="weekday">–ü—Ç</div><div class="weekday">–°–±</div><div class="weekday">–í—Å</div></div>
        <div id="calendar-grid" class="calendar-grid"></div>
        <div class="events-container"><div id="selected-date-title" class="selected-date-title">–°–æ–±—ã—Ç–∏—è</div><div id="events-list"></div></div>
    </div>

    <!-- 3. –ò–°–¢–û–†–ò–Ø -->
    <div id="view-history" class="view">
        <div class="header"><h1>–ò—Å—Ç–æ—Ä–∏—è</h1><p>–ë–∞–∑–∞ —Ä–∞—Å—á–µ—Ç–æ–≤</p></div>
        <div id="history-list" class="history-list"></div>
    </div>

    <!-- 4. –ù–ê–°–¢–†–û–ô–ö–ò (FIXED) -->
    <div id="view-settings" class="view">
        <div class="header"><h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
        
        <div class="section-title">–õ–æ–≥–∏—Å—Ç–∏–∫–∞ (–ì–æ—Ä–æ–¥–∞)</div>
        <div id="settings-travel-list" style="margin: 0 16px;"></div>
        <div style="margin: 10px 16px;"><div class="btn-add" onclick="Admin.addRegion()">+ –î–æ–±–∞–≤–∏—Ç—å –†–µ–≥–∏–æ–Ω</div></div>

        <div class="section-title">–£—Å–ª—É–≥–∏</div>
        <div id="settings-services-list" style="margin: 0 16px;"></div>
        <div style="margin: 10px 16px;"><div class="btn-add" onclick="Admin.addCategory()">+ –î–æ–±–∞–≤–∏—Ç—å –ö–∞—Ç–µ–≥–æ—Ä–∏—é</div></div>

        
        <div class="section-title">–ö–ü: —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ —Å—Å—ã–ª–∫–∏</div>

        <div class="settings-block" style="margin: 0 16px;">
            <div class="settings-header" onclick="Admin.toggleSection(this)">
                <span>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –±—Ä–æ–Ω–∏</span>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="settings-content open">
                <div id="settings-payments-list"></div>
                <div class="btn-add" onclick="Admin.addPayment()">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</div>
            </div>
        </div>

        <div class="settings-block" style="margin: 0 16px;">
            <div class="settings-header" onclick="Admin.toggleSection(this)">
                <span>–°—Å—ã–ª–∫–∏ (–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ / —Å–æ—Ü—Å–µ—Ç–∏ / –æ—Ç–∑—ã–≤—ã)</span>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="settings-content open">
                <div id="settings-links-list"></div>
                <div class="btn-add" onclick="Admin.addLink()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</div>
            </div>
        </div>


        <div class="section-title">–ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ–∫—É—Å–Ω–∏–∫–∞</div>
        <div class="settings-block" style="margin: 0 16px;">
            <div class="input-row"><div class="label">–ò–º—è –∞—Ä—Ç–∏—Å—Ç–∞</div><input id="cfg-performer" class="text-input" placeholder="–ù–∞–ø—Ä. –î–º–∏—Ç—Ä–∏–π –ö–æ—Å—Ç—é–∫"></div>
            <div class="input-row"><div class="label">–ó–∞–¥–∞—Ç–æ–∫ (%)</div><input id="cfg-deposit" type="number" class="text-input" placeholder="30"></div>
            <div class="input-row" style="align-items:center;">
                <div class="label">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ö–ü</div>
                <label class="switch" title="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ö–ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–±–µ–∑ –¥—É–±–ª–µ–π).">
                    <input type="checkbox" id="cfg-autosave">
                    <span class="slider"></span>
                </label>
            </div>
        </div>


        <div class="section-title">–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã</div>
        <div class="settings-block" style="margin: 0 16px;">
            <div class="settings-header" onclick="Admin.toggleSection(this)">
                <span>–ü—Ä–∞–∑–¥–Ω–∏–∫–∏ (–≥–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)</span>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="settings-content open">
                <div style="padding: 12px 16px; font-size: 12px; color: var(--text-secondary); line-height:1.3;">
                    –§–æ—Ä–º–∞—Ç –¥–∞—Ç: <b>–ú–ú-–î–î</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12-31). –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–º–Ω–æ–∂–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å–º–µ—Ç—É –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã/–ø–µ—Ä–∏–æ–¥—ã.
                </div>

                <div class="section-title" style="margin: 8px 16px 8px;">–¢–æ—á–Ω—ã–µ –¥–∞—Ç—ã</div>
                <div id="settings-holidays-list"></div>
                <div class="btn-add" onclick="HolidayCfg.addHoliday()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–∞—Ç—É</div>

                <div class="section-title" style="margin: 16px 16px 8px;">–ü–µ—Ä–∏–æ–¥—ã</div>
                <div id="settings-holidayranges-list"></div>
                <div class="btn-add" onclick="HolidayCfg.addRange()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥</div>
            </div>
        </div>


<div class="btn-add" style="margin: 10px 16px 0;" onclick="if(typeof Touch!=='undefined') Touch.openTplModal()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</div>

<div class="btn-reset" onclick="Admin.resetAll()">‚ö†Ô∏è –°–±—Ä–æ—Å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</div>
    </div>

  </div>

<div class="tabs">
        <div class="tab-btn active" data-tab="calc" onclick="switchTab('calc', this)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
        <div class="tab-btn" data-tab="calendar" onclick="switchTab('calendar', this)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <div class="tab-btn" data-tab="history" onclick="switchTab('history', this)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="tab-btn" data-tab="settings" onclick="switchTab('settings', this)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>

<!-- SALES MODAL -->
    <div id="sales-modal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="btn-close" onclick="Sales.close()">–ó–∞–∫—Ä—ã—Ç—å</span>
                <div class="modal-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                <span class="btn-save" onclick="Touch.openTplModal()">–®–∞–±–ª–æ–Ω—ã</span>
            </div>

            <div class="modal-scroll">
                <div class="tpl-sub" style="margin-top:0;">
                    –ë—ã—Å—Ç—Ä—ã–µ ‚Äú—É–º–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏‚Äù: –≤—ã–±–µ—Ä–∏ —Å–∫—Ä–∏–ø—Ç ‚Üí –ø–æ–¥—Å—Ç–∞–≤—è—Ç—Å—è –∏–º—è/–≥–æ—Ä–æ–¥/–¥–∞—Ç–∞/—Ü–µ–Ω–∞ ‚Üí –∫–æ–ø–∏—Ä—É–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π.
                    –í—Å—ë —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤ ‚Äú–®–∞–±–ª–æ–Ω—ã‚Äù.
                </div>

                <input id="sales-search" class="text-input" type="text" placeholder="–ü–æ–∏—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∏–ª–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è‚Ä¶">

                <div id="sales-list" class="sales-list"></div>

                <div class="section-title" style="margin: 14px 0 10px 0;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                <textarea id="sales-preview" class="touch-message" rows="6" placeholder="–í—ã–±–µ—Ä–∏ —Å–∫—Ä–∏–ø—Ç –≤—ã—à–µ‚Ä¶"></textarea>

                <div class="tpl-actions" style="padding: 14px 0 8px 0;">
                    <button class="touch-pill touch-primary" onclick="Sales.copy()" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="touch-pill ghost" onclick="Sales.applyToClipboardPlain()" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (—á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç)</button>
                </div>
            </div>
        </div>
    </div>

<!-- MODAL -->
    <div id="event-modal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <span class="btn-close" onclick="Calendar.closeModal()">–û—Ç–º–µ–Ω–∞</span>
                <div style="display:flex; gap:14px; align-items:center;">
                    <span id="btn-modal-delete" style="color: var(--danger); display:none; cursor:pointer;" onclick="Calendar.deleteFromModal()">–£–¥–∞–ª–∏—Ç—å</span>
                    <span id="btn-modal-save" class="btn-save" onclick="Calendar.saveManualEvent()">–î–æ–±–∞–≤–∏—Ç—å</span>
                </div>
            </div>
            <div class="modal-scroll">
<h2 style="font-size:20px; font-weight:700; margin-bottom:15px;">–ó–∞–ø–∏—Å—å</h2>
            <div class="group-container" style="margin:0;">
                <div class="input-row"><div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input id="mod-title" class="text-input" placeholder="–ò–≤–∞–Ω"></div>
                <div class="input-row"><div class="label">–î–∞—Ç–∞</div><input type="date" id="mod-date" class="native-control-inline"></div>
                <div class="input-row"><div class="label">–í—Ä–µ–º—è</div><input type="time" id="mod-time" class="native-control-inline"></div>
                <div class="input-row"><div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div><input id="mod-phone" class="text-input" placeholder="89..."></div>
                <div class="input-row">
                    <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                    <select id="mod-type" class="native-control-inline">
                        <option value="–°–≤–∞–¥—å–±–∞">–°–≤–∞–¥—å–±–∞</option><option value="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤</option><option value="–î–µ—Ç—Å–∫–∏–π">–î–µ—Ç—Å–∫–∏–π</option><option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="input-row"><div class="label">–°—É–º–º–∞</div><input type="number" id="mod-price" class="text-input" placeholder="0"></div>
                <div class="input-row" style="flex-direction:column; align-items:stretch;">
                    <div style="display:flex; justify-content:space-between; align-items:center; width: 100%;">
                        <div class="label">–ó–∞–º–µ—Ç–∫–∏</div>
                        <div class="value-wrapper"><div class="value-display" style="opacity:.6;">(–¥–ª—è —Å–µ–±—è)</div></div>
                    </div>
                    <textarea id="mod-notes" class="notes-area" placeholder="–ê–¥—Ä–µ—Å, —Ç–∞–π–º–∏–Ω–≥, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–ª–æ—â–∞–¥–∫–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞..." rows="4">
</textarea>
                </div>

                <!-- TOUCH: –±—ã—Å—Ç—Ä—ã–π –∫–æ–Ω—Ç–∞–∫—Ç —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–¥–ª—è —Ñ–æ–∫—É—Å–Ω–∏–∫–∞) -->
                <div class="section-title" style="margin-top:18px;">üé© –ö–ª–∏–µ–Ω—Ç ‚Äî –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã</div>
                <div class="touch-card">
                    <div class="touch-actions">
                        <button class="touch-btn" id="touch-manage" type="button">‚öôÔ∏è –®–∞–±–ª–æ–Ω—ã</button>
                        <button class="touch-btn" id="touch-vars" type="button">‚ú® –ü–æ–ª—è</button>
                    </div>

                    <div class="touch-chips" id="touch-templates"></div>

                    <textarea id="touch-message" class="touch-message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É‚Ä¶"></textarea>

                    <div class="touch-toolbar">
                        <button class="touch-pill" id="touch-copy" type="button">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="touch-pill" id="touch-share" type="button">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                        <button class="touch-pill touch-primary" id="touch-regenerate" type="button">‚Üª –°–æ–±—Ä–∞—Ç—å</button>
                    </div>

                    <div class="touch-faq-title">–ß–∞—Å—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã (–≤—Å—Ç–∞–≤–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ)</div>
                    <div class="touch-faq" id="touch-faq"></div>

                    <div class="touch-hint">–û–¥–∏–Ω —Ç–∞–ø –ø–æ —à–∞–±–ª–æ–Ω—É ‚Üí ‚Äú–°–æ–±—Ä–∞—Ç—å‚Äù ‚Üí ‚Äú–ü–æ–¥–µ–ª–∏—Ç—å—Å—è‚Äù (–≤—ã–±–∏—Ä–∞–µ—à—å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä). –ù–∏–∫–∞–∫–æ–π –º–∞–≥–∏–∏‚Ä¶ –∫—Ä–æ–º–µ —Ç–≤–æ–µ–π.</div>
                </div>

            </div>
            </div>
        </div>
    </div>

<!-- TOUCH TEMPLATES MANAGER -->
    <div id="tpl-modal" class="modal tpl-modal">
        <div class="modal-card">
            <div class="grabber"></div>

            <div class="tpl-header">
                <span class="btn-close" id="tpl-close">–ó–∞–∫—Ä—ã—Ç—å</span>
                <div class="tpl-title">–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                <span class="btn-save" id="tpl-add">–î–æ–±–∞–≤–∏—Ç—å</span>
            </div>

            <div class="modal-scroll">
                <div class="tpl-sub">
                    –ù–∞—Å—Ç—Ä–æ–π —Å–≤–æ–∏ ‚Äú–±—ã—Å—Ç—Ä—ã–µ –∫–∞—Å–∞–Ω–∏—è‚Äù: –æ–¥–∏–Ω —Ç–∞–ø ‚Üí –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç. –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏: <b>{{whenLine}}</b>, <b>{{priceLine}}</b>, <b>{{depositPercent}}</b>, <b>{{portfolioLine}}</b> –∏ –¥—Ä.
                </div>

                <div class="tpl-list" id="tpl-list"></div>

                <div class="tpl-tools">
                    <button class="touch-pill" id="tpl-export" type="button">–≠–∫—Å–ø–æ—Ä—Ç</button>
                    <button class="touch-pill" id="tpl-import" type="button">–ò–º–ø–æ—Ä—Ç</button>
                </div>
            </div>
        </div>
    </div>

<div id="toast" class="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>

</div>
<script>
    // --- DB INIT (FULL RESTORED v10) ---
    const DEFAULT_DB = {
        travel: {
            "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è": { fee: 1000, cities: {"–Ø—Ä–æ—Å–ª–∞–≤–ª—å": 0, "–†—ã–±–∏–Ω—Å–∫": 2000, "–¢—É—Ç–∞–µ–≤": 2000, "–£–≥–ª–∏—á": 2000, "–†–æ—Å—Ç–æ–≤": 2000, "–ü–µ—Ä–µ—Å–ª–∞–≤–ª—å-–ó–∞–ª–µ—Å—Å–∫–∏–π": 2000, "–ì–∞–≤—Ä–∏–ª–æ–≤-–Ø–º": 2000, "–î–∞–Ω–∏–ª–æ–≤": 2000, "–ü–æ—à–µ—Ö–æ–Ω—å–µ": 4000, "–ú—ã—à–∫–∏–Ω": 2000, "–õ—é–±–∏–º": 2000} },
            "–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è": { fee: 3000, cities: {"–ö–æ—Å—Ç—Ä–æ–º–∞": 2000, "–í–æ–ª–≥–æ—Ä–µ—á–µ–Ω—Å–∫": 2000, "–ë—É–π": 3000, "–ù–µ—Ä–µ—Ö—Ç–∞": 2000, "–®–∞—Ä—å—è": 6000, "–ú–∞–Ω—Ç—É—Ä–æ–≤–æ": 5500, "–ì–∞–ª–∏—á": 3500} },
            "–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è": { fee: 5000, cities: {"–ò–≤–∞–Ω–æ–≤–æ": 2000, "–ü–ª–µ—Å": 3000, "–ö–∏–Ω–µ—à–º–∞": 3500, "–®—É—è": 3000, "–¢–µ–π–∫–æ–≤–æ": 2500, "–ö–æ—Ö–º–∞": 2500, "–í–∏—á—É–≥–∞": 3000, "–§—É—Ä–º–∞–Ω–æ–≤": 2500, "–†–æ–¥–Ω–∏–∫–∏": 3000, "–ü—Ä–∏–≤–æ–ª–∂—Å–∫": 2000, "–Æ–∂–∞": 4000} },
            "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è": { fee: 10000, cities: {"–í–ª–∞–¥–∏–º–∏—Ä": 10000, "–°—É–∑–¥–∞–ª—å": 10000, "–ö–æ–≤—Ä–æ–≤": 10000, "–ú—É—Ä–æ–º": 17000, "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤": 10000, "–ì—É—Å—å-–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π": 13500} },
            "–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è": { fee: 9000, cities: {"–í–æ–ª–æ–≥–¥–∞": 9000, "–ß–µ—Ä–µ–ø–æ–≤–µ—Ü": 15000, "–°–æ–∫–æ–ª": 12000} },
            "–ú–æ—Å–∫–≤–∞ –∏ –ú–û": { fee: 15000, cities: {"–ú–æ—Å–∫–≤–∞": 15000, "–•–∏–º–∫–∏": 15000, "–ë–∞–ª–∞—à–∏—Ö–∞": 15000} }
        },
        services: {
            "–î–µ—Ç—Å–∫–∏–µ —à–æ—É": { "–î–µ—Ç—Å–∫–æ–µ —à–æ—É (30 –º–∏–Ω)": 11250, "–î–µ—Ç—Å–∫–æ–µ —à–æ—É (40 –º–∏–Ω)": 13750, "–ò–Ω–¥–∏–≤. –¥–µ—Ç—Å–∫–æ–µ —à–æ—É": 21250 },
            "–í–∑—Ä–æ—Å–ª—ã–µ —à–æ—É": { "–®–æ—É (20 –º–∏–Ω)": 17500, "–®–æ—É (30 –º–∏–Ω)": 23750, "–®–æ—É (40 –º–∏–Ω)": 30000 },
            "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è": { "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (30 –º–∏–Ω)": 13000, "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (1 —á)": 20000, "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (2 —á)": 30000, "–ú–∏–∫—Ä–æ–º–∞–≥–∏—è (3 —á)": 36000 },
            "–°–ø–µ—Ü-–ø—Ä–æ–µ–∫—Ç—ã": { "–°–≤–∞–¥—å–±–∞ (20 –º–∏–Ω)": 26250, "–°–≤–∞–¥—å–±–∞ (30 –º–∏–Ω)": 32500, "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ (20 –º–∏–Ω)": 26250, "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤ (30 –º–∏–Ω)": 32500, "–Æ–±–∏–ª–µ–π (20 –º–∏–Ω)": 23750, "–Æ–±–∏–ª–µ–π (30 –º–∏–Ω)": 30000, "–í—ã–ø—É—Å–∫–Ω–æ–π (20 –º–∏–Ω)": 23750, "–í—ã–ø—É—Å–∫–Ω–æ–π (30 –º–∏–Ω)": 30000 },
            "–ö–æ–Ω—Ü–µ—Ä—Ç—ã": { "–ú–∏–Ω–∏-—à–æ—É –°–ï–ö–†–ï–¢ (1 —á)": 150000, "–°–ø–µ–∫—Ç–∞–∫–ª—å –°–ï–ö–†–ï–¢ (2 —á)": 300000 }
        },
        settings: { extraGuest: 80, holidays: {"12-31":2, "01-01":2, "02-23":1.5, "03-08":1.5}, holidayRanges: [{sm:12, sd:15, em:12, ed:30, k:1.5}] },

        payments: [
            { title: "–¢-–ë–ê–ù–ö", text: "8 909 276 33 86\n–î–º–∏—Ç—Ä–∏–π –ü–∞–≤–ª–æ–≤–∏—á –ö." }
        ],
        links: [
            { label: "–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ", url: "" }
        ],

        events: [], history: []
    };

    let DB = {};


    // --- Date, safety & clipboard helpers (v11 improvements: local dates, safe strings, reliable copy) ---
    // local ISO date (YYYY-MM-DD) without UTC shift
    const isoLocal = (d = new Date()) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
    };
    // parse ISO date (YYYY-MM-DD) as LOCAL date (prevents Safari/UTC day shift)
    const parseISODate = (iso) => {
        if(!iso) return new Date();
        const parts = String(iso).split('-').map(n => parseInt(n,10));
        if(parts.length < 3 || parts.some(n => Number.isNaN(n))) return new Date(iso);
        const [y, m, d] = parts;
        return new Date(y, (m || 1) - 1, d || 1);
    };
    // basic HTML escape to prevent layout breaks from user input (name/phone/etc)
    const esc = (v) => String(v ?? '').replace(/[&<>"'`]/g, ch => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '`':'&#96;'
    }[ch]));
    // clipboard copy with fallback (works even on file:// in many cases)
    const copyTextToClipboard = async (text) => {
        try {
            if(navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch(e) {}
        try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly','');
            ta.style.position = 'fixed';
            ta.style.top = '-9999px';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch(e) { return false; }
    };
    let State = { date: isoLocal(), holidayK: 1, cart: [], bonus: "", discount: 0, serviceQty: 1, taxActive: false };
    
    // UI Helpers
    const el = (id) => document.getElementById(id);
    const fmt = (n) => n.toLocaleString('ru-RU') + ' ‚ÇΩ';
    const parseMoney = (v) => {
        const s = String(v ?? '').replace(/[^0-9]/g,'');
        return s ? parseInt(s,10) : 0;
    };
    const switchTab = (tab, btnEl) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+tab).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

        // Prefer explicit element; fallback to data-tab; last resort: global event (old inline handlers)
        const btn = btnEl || document.querySelector(`.tab-btn[data-tab="${tab}"]`) || (typeof event !== 'undefined' ? event.currentTarget : null);
        if(btn && btn.classList) btn.classList.add('active');

        if(tab === 'calendar') Calendar.render();
        if(tab === 'history') History.render();
    };

    // --- STORAGE ---
    const Storage = {
        load: () => {
            const saved = localStorage.getItem('kostyuk_crm_v10');
            if (saved) {
                try { DB = JSON.parse(saved); }
                catch(e) { DB = JSON.parse(JSON.stringify(DEFAULT_DB)); }
            } else {
                DB = JSON.parse(JSON.stringify(DEFAULT_DB));
            }

            // Forward-compatible defaults (older saves won't have new fields)
            if(!DB.events) DB.events = [];
            if(!DB.history) DB.history = [];
            if(!Array.isArray(DB.payments)) DB.payments = JSON.parse(JSON.stringify(DEFAULT_DB.payments || []));
            if(!Array.isArray(DB.links)) DB.links = JSON.parse(JSON.stringify(DEFAULT_DB.links || []));

            Admin.render();
            if(typeof HolidayCfg !== "undefined") HolidayCfg.render();
            App.init();
        },
        save: () => { localStorage.setItem('kostyuk_crm_v10', JSON.stringify(DB)); },
        reset: () => { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –±–∞–∑—É?')) { localStorage.removeItem('kostyuk_crm_v10'); location.reload(); } }
    };


    // --- APP LOGIC ---
    const App = {
        init: () => {
            el('inp-date').value = State.date;
            // Regions
            const rSel = el('inp-region'); rSel.innerHTML='<option disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ</option>';
            for(let r in DB.travel) rSel.add(new Option(r, r));
            // Categories
            const cSel = el('inp-cat'); cSel.innerHTML='<option disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ</option>';
            for(let c in DB.services) cSel.add(new Option(c, c));
            App.updateDate();
            if(typeof Touch !== 'undefined') Touch.init();

            // –ü—Ä–æ—Ñ–∏–ª—å —Ñ–æ–∫—É—Å–Ω–∏–∫–∞ (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
            if(typeof Touch !== 'undefined' && Touch.ensureCfg) Touch.ensureCfg();
            const p = el('cfg-performer');
            if(p){
                p.value = (DB.touchCfg && DB.touchCfg.performer) ? DB.touchCfg.performer : '';
                p.oninput = () => { if(!DB.touchCfg) DB.touchCfg = Touch.cfgDefaults(); DB.touchCfg.performer = p.value.trim() || '–§–æ–∫—É—Å–Ω–∏–∫'; Storage.save(); };
            }
            const d = el('cfg-deposit');
            if(d){
                d.value = (DB.touchCfg && typeof DB.touchCfg.depositPercent === 'number') ? DB.touchCfg.depositPercent : 30;
                d.oninput = () => { if(!DB.touchCfg) DB.touchCfg = Touch.cfgDefaults(); DB.touchCfg.depositPercent = Math.max(0, Math.min(100, parseInt(d.value||'30')||30)); Storage.save(); };
            }
            const a = el('cfg-autosave');
            if(a){
                a.checked = !!(DB.touchCfg && DB.touchCfg.autosaveOnCopy);
                a.onchange = () => { if(!DB.touchCfg) DB.touchCfg = Touch.cfgDefaults(); DB.touchCfg.autosaveOnCopy = !!a.checked; Storage.save(); };
            }
        },
        updateDate: () => {
            const val = el('inp-date').value; if(!val) return;
            State.date = val; const d = parseISODate(val);
            el('disp-date').innerText = d.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});
            el('disp-date').classList.add('filled');
            const m = d.getMonth()+1, day = d.getDate();
            const key = `${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            let k = 1;
            if(DB.settings.holidays[key]) k = DB.settings.holidays[key];
            else {
                // holidayRanges supports start/end month/day
                const md = (d.getMonth()+1) * 100 + d.getDate();
                for(let r of DB.settings.holidayRanges) {
                    const sm = r.sm || 1, sd = r.sd || 1;
                    const em = r.em || sm, ed = r.ed || sd;
                    const start = sm * 100 + sd;
                    const end = em * 100 + ed;
                    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äú—á–µ—Ä–µ–∑ –ù–æ–≤—ã–π –≥–æ–¥‚Äù: –µ—Å–ª–∏ –∫–æ–Ω–µ—Ü –º–µ–Ω—å—à–µ —Å—Ç–∞—Ä—Ç–∞, —Å—á–∏—Ç–∞–µ–º –ø–µ—Ä–∏–æ–¥–æ–º (start..12-31) –ò–õ–ò (01-01..end)
                    const inRange = start <= end ? (md >= start && md <= end) : (md >= start || md <= end);
                    if(inRange) { k = HolidayCfg.parseK(r.k); break; }
                }
            }
            State.holidayK = k;
            // keep calendar in sync with –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
            Calendar.selectedDate = parseISODate(State.date);
            el('badge-holiday').style.display = k > 1 ? 'inline-block' : 'none';
            el('badge-holiday').innerText = `x${k}`;
            App.checkConflicts(); App.calc();
        },
        checkConflicts: () => {
            const dStr = State.date;
            const cnt = DB.history.filter(h => (h.eventDateIso||'') === dStr && h.status !== 'cancel').length;
            const alert = el('conflict-msg');
            if(cnt > 0) { alert.style.display='block'; alert.innerText=`‚ö†Ô∏è –ó–∞–Ω—è—Ç–æ: ${cnt} –∑–∞–∫–∞–∑(–∞)`; }
            else { alert.style.display='none'; }
        },
        updateRegion: () => {
            const r = el('inp-region').value; el('disp-region').innerText=r; el('disp-region').classList.add('filled');
            const cSel = el('inp-city'); cSel.innerHTML=''; cSel.disabled=false;
            for(let c in DB.travel[r].cities) cSel.add(new Option(c, c));
            cSel.add(new Option("–î—Ä—É–≥–æ–π", "other")); cSel.value="";
            el('disp-city').innerText="..."; el('disp-city').classList.remove('filled'); App.calc();
        },
        updateCity: () => { const v = el('inp-city').value; el('disp-city').innerText=v==='other'?'–î—Ä—É–≥–æ–π':v; el('disp-city').classList.add('filled'); App.calc(); },
        updateCat: () => {
            const c = el('inp-cat').value; el('disp-cat').innerText=c; el('disp-cat').classList.add('filled');
            const sSel = el('inp-svc'); sSel.innerHTML=''; sSel.disabled=false;
            for(let s in DB.services[c]) sSel.add(new Option(s, s)); sSel.value="";
            el('disp-svc').innerText="..."; el('disp-svc').classList.remove('filled');
        },
        updateEventType: () => { const v=el('inp-event-type').value; el('disp-event-type').innerText=v; el('disp-event-type').classList.add('filled'); },
        updateStatus: () => { 
            const s = el('inp-status').value;
            const names = {'new':'–°–ø—Ä–æ—Å–∏–ª', 'think':'–î—É–º–∞–µ—Ç', 'deposit':'–ë—Ä–æ–Ω—å', 'cancel':'–û—Ç–∫–∞–∑'};
            el('disp-status').innerText = names[s]; el('disp-status').classList.add('filled');
        },
        changeQty: (d) => { let q=State.serviceQty+d; if(q<1)q=1; State.serviceQty=q; el('svc-qty').innerText=q; },
        addService: () => {
            const cat = el('inp-cat').value, svc = el('inp-svc').value;
            if(!cat || !svc) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É!");
            State.cart.push({ name: svc, price: DB.services[cat][svc], qty: State.serviceQty });
            State.serviceQty=1; el('svc-qty').innerText=1;
            el('disp-svc').innerText="..."; el('disp-svc').classList.remove('filled'); el('inp-svc').value="";
            App.renderCart(); App.calc();
        },
        removeService: (i) => { State.cart.splice(i,1); App.renderCart(); App.calc(); },
        renderCart: () => {
            const div = el('cart-list'); div.innerHTML='';
            State.cart.forEach((it,i) => {
                const k=State.holidayK, tot=Math.round(it.price*it.qty*k);
                div.innerHTML += `<div class="cart-item"><div class="cart-info"><div class="cart-name">${it.name} ${it.qty>1?`(x${it.qty})`:''}</div><div class="cart-price">${fmt(tot)}</div></div><div class="btn-remove" onclick="App.removeService(${i})">√ó</div></div>`;
            });
        },
        updateGuests: () => {
            const v=el('inp-guests').value;
            let t="–î–æ 50"; if(v==='5000')t="50-100"; if(v==='10000')t="100-200"; if(v==='custom')t="–°–ª–∞–π–¥–µ—Ä";
            el('slider-wrap').style.display = v==='custom'?'block':'none';
            el('disp-guests').innerText=t; App.calc();
        },
        calc: () => {
            const k = State.holidayK;
            let sTot=0; State.cart.forEach(i=> sTot+=i.price*i.qty*k); sTot=Math.round(sTot);
            State.discount=0; if(State.cart.length>1) { State.discount=Math.round(sTot*0.1); sTot-=State.discount; el('discount-badge').style.display='block'; }
            else el('discount-badge').style.display='none';

            const reg=el('inp-region').value, cit=el('inp-city').value;
            let road=0; if(reg&&cit) road = (cit==='other')?DB.travel[reg].fee : DB.travel[reg].cities[cit];
            const rTot=Math.round(road*(k>1?1.5:1));

            const gV=el('inp-guests').value; let guest=0;
            if(gV==='5000')guest=5000; if(gV==='10000')guest=10000;
            if(gV==='custom') { const n=parseInt(el('inp-slider').value); el('slider-val').innerText=n; guest = Math.max(0, (n-200) * DB.settings.extraGuest); }
            
            const man = parseMoney(el('inp-manual-price').value);
            
            let preTax = sTot+rTot+guest+man;
            State.taxActive = el('inp-tax').checked;
            let taxVal = State.taxActive ? Math.round(preTax*0.06) : 0;
            
            const total = preTax + taxVal;
            State.final = { total, sTot, rTot, guest, man, k, taxVal };

            let b = [];
            if(total>=15000) b.push("üéüÔ∏è 2 –±–∏–ª–µ—Ç–∞ –Ω–∞ —à–æ—É"); 
            if(total>=25000) b=["üé© –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å","üéüÔ∏è 2 –±–∏–ª–µ—Ç–∞"]; 
            if(total>=40000) b=["üî• –û–ø–∞—Å–Ω—ã–π —Ç—Ä—é–∫","üé© –§–æ–∫—É—Å","üéüÔ∏è 2 –±–∏–ª–µ—Ç–∞"];
            State.bonusList=b;
            el('bonus-alert').style.display=b.length>0?'block':'none';
            el('bonus-alert').innerText = b.length>0 ? b[0]+(b.length>1?" (+ –µ—â–µ)":"") : "";
            el('total-sum').innerText = fmt(total);
        },
        copy: () => {
            if(!State.final || State.final.total===0) return alert('0 ‚ÇΩ');

            const name = el('inp-client').value.trim() || '–ö–ª–∏–µ–Ω—Ç';
            const type = el('inp-event-type').value || '–°–æ–±—ã—Ç–∏–µ';
            const phone = el('inp-phone').value || '';
            const time = el('inp-time').value || '18:00';
            const status = el('inp-status').value || 'new';

            const depPct = (DB.touchCfg && typeof DB.touchCfg.depositPercent === 'number') ? DB.touchCfg.depositPercent : 30;
            const autoSave = !!(DB.touchCfg && DB.touchCfg.autosaveOnCopy);

            // (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: —Å–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∏ –∏—Å—Ç–æ—Ä–∏–∏ –ë–ï–ó –¥—É–±–ª–µ–π
            if(autoSave){
                const cityLabel = (el('disp-city')?.innerText || el('inp-city')?.value || '').trim();
                const eventTitle = `${type} - ${name}`;

                const notesLines = [];
                if(phone) notesLines.push(`–¢–µ–ª: ${phone}`);
                if(type) notesLines.push(`–¢–∏–ø: ${type}`);
                if(State.cart?.length) notesLines.push(`–£—Å–ª—É–≥–∏: ${State.cart.map(c=>c.name).join(', ')}`);
                notesLines.push(`–ò—Ç–æ–≥–æ: ${fmt(State.final.total)}`);
                if(depPct > 0) notesLines.push(`–ó–∞–¥–∞—Ç–æ–∫: ${depPct}% (${fmt(Math.round(State.final.total*(depPct/100)))})`);
                const notes = notesLines.join('\n');

                const eventObj = {
                    id: Date.now(),
                    title: eventTitle,
                    date: State.date,
                    time: time,
                    phone: phone,
                    price: State.final.total,
                    type: type,
                    details: State.cart.map(c=>c.name).join(', '),
                    notes
                };

                const existingEv = DB.events.find(e =>
                    e.date === State.date &&
                    e.time === time &&
                    ((phone && e.phone === phone) || (!phone && e.title === eventTitle))
                );

                if(existingEv){
                    Object.assign(existingEv, eventObj, { id: existingEv.id });
                } else {
                    DB.events.push(eventObj);
                }

                // History upsert (–¥–æ–±–∞–≤–ª—è–µ–º phone –∫–∞–∫ –ø–æ–ª–µ ‚Äî –Ω–µ –ª–æ–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏)
                const rec = {
                    id: Date.now(),
                    name: name || '–ö–ª–∏–µ–Ω—Ç',
                    phone: phone || '',
                    total: State.final.total,
                    date: new Date().toLocaleDateString('ru-RU'),
                    eventDate: parseISODate(State.date).toLocaleDateString('ru-RU'),
                    eventDateIso: State.date,
                    loc: cityLabel || '',
                    services: State.cart.map(c=>c.name).join(', '),
                    status: status
                };

                const existingH = DB.history.find(h =>
                    (h.eventDateIso||'') === State.date &&
                    (h.name||'') === rec.name &&
                    ((phone && (h.phone||'') === phone) || !phone) &&
                    (h.status||'') !== 'cancel'
                );

                if(existingH){
                    Object.assign(existingH, rec, { id: existingH.id });
                } else {
                    DB.history.unshift(rec);
                    if(DB.history.length > 50) DB.history.pop();
                }

                Storage.save();
            }

            // CLEAN COPY (—Ç–µ–∫—Å—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞)
            const dateStr = parseISODate(State.date).toLocaleDateString('ru-RU',{weekday:'short', day:'numeric', month:'long'});
            let lines = [`‚ú® –†–ê–°–ß–ï–¢: ${type.toUpperCase()} ‚ú®`];
            lines.push(``);
            lines.push(`üìÖ ${dateStr}`);
            const cityText = (el('disp-city')?.innerText || el('inp-city')?.value || '').trim();
            if(cityText) lines.push(`üìç ${cityText}`);
            lines.push(``);
            lines.push(`üé© –ü—Ä–æ–≥—Ä–∞–º–º–∞:`);
            State.cart.forEach(i => lines.push(`‚Ä¢ ${i.name} ‚Äî ${fmt(Math.round(i.price*i.qty*State.final.k))}`));

            if(State.discount>0) lines.push(`üéÅ –°–∫–∏–¥–∫–∞ 10%: -${fmt(State.discount)}`);
            if(State.final.rTot>0) lines.push(`üöï –õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${fmt(State.final.rTot)}`);
            if(State.final.guest>0) lines.push(`üë• –î–æ–ø–ª–∞—Ç–∞ –∑–∞ –≥–æ—Å—Ç–µ–π: ${fmt(State.final.guest)}`);
            if(State.final.man>0) lines.push(`üîπ –î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã: ${fmt(State.final.man)}`);
            if(State.final.taxVal>0) lines.push(`üìÑ –ù–∞–ª–æ–≥ / –î–æ–∫—É–º–µ–Ω—Ç—ã (6%): ${fmt(State.final.taxVal)}`);

            if(State.bonusList.length>0) { lines.push(``); lines.push(`üéÅ –í–ê–®–ò –ë–û–ù–£–°–´:`); State.bonusList.forEach(b=>lines.push(`‚úÖ ${b}`)); }

            const dep = depPct > 0 ? Math.round(State.final.total * (depPct/100)) : 0;
            lines.push(``);
            lines.push(`üí∞ –ò–¢–û–ì–û: ${fmt(State.final.total)}`);
            if(depPct > 0) lines.push(`üí≥ –ó–∞–¥–∞—Ç–æ–∫ (${depPct}%): ${fmt(dep)}`);
            lines.push(``);

            // –†–µ–∫–≤–∏–∑–∏—Ç—ã (–∏–∑ –ù–∞—Å—Ç—Ä–æ–µ–∫)
            if(Array.isArray(DB.payments) && DB.payments.length > 0){
                lines.push(`üì≤ –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –±—Ä–æ–Ω–∏:`);
                DB.payments.forEach((p, idx) => {
                    const title = String(p?.title ?? '').trim();
                    const text = String(p?.text ?? '').trim();
                    if(!title && !text) return;

                    if(title) lines.push(`${title}:`);
                    if(text){
                        text.split('\n').forEach(line => {
                            const ln = String(line ?? '').trim();
                            if(ln) lines.push(ln);
                        });
                    }
                    if(idx !== DB.payments.length - 1) lines.push(``);
                });
                lines.push(``);
            }

            // –°—Å—ã–ª–∫–∏ (–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ/—Å–æ—Ü—Å–µ—Ç–∏)
            if(Array.isArray(DB.links) && DB.links.length > 0){
                const list = DB.links
                    .map(l => ({ label: String(l?.label ?? '').trim(), url: String(l?.url ?? '').trim() }))
                    .filter(l => l.url.length > 0);

                if(list.length > 0){
                    lines.push(`üîó –°—Å—ã–ª–∫–∏:`);
                    list.forEach(l => lines.push(`‚Ä¢ ${l.label || '–°—Å—ã–ª–∫–∞'}: ${l.url}`));
                    lines.push(``);
                }
            }

            lines.push(`‚ö†Ô∏è –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –±—Ä–æ–Ω–∏—Ä—É—é—Ç—Å—è –∑–∞ –í–∞–º–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∑–∞–¥–∞—Ç–∫–∞.`);

            copyTextToClipboard(lines.join('\n').replace(/\u00A0/g,' ').replace(/[*_`]/g,'')).then((ok)=> {
                if(ok){
                    el('toast').innerText = autoSave ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!' : '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    el('toast').classList.add('show');
                    setTimeout(()=>el('toast').classList.remove('show'), 2000);
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
                }
            });
        }
    };

    // --- HISTORY ---
    const History = {
        add: (name, total, date, loc, status) => {
            const rec = { id: Date.now(), name: name||'–ö–ª–∏–µ–Ω—Ç', total, date: new Date().toLocaleDateString('ru-RU'), eventDate: parseISODate(date).toLocaleDateString('ru-RU'), eventDateIso: date, loc, services: State.cart.map(c=>c.name).join(', '), status: status || 'new' };
            DB.history.unshift(rec); if(DB.history.length>50) DB.history.pop(); Storage.save();
        },
        delete: (id) => { DB.history = DB.history.filter(h => h.id !== id); Storage.save(); History.render(); },
        setStatus: (id, st) => { const r = DB.history.find(h => h.id===id); if(r){ r.status=st; Storage.save(); History.render(); } },
        render: () => {
            const div = el('history-list'); if(!DB.history||DB.history.length===0) { div.innerHTML = '<div style="text-align:center; color:#555; margin-top:40px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; return; }
            div.innerHTML = '';
            DB.history.forEach(h => {
                let badge = '<span class="status-badge sb-new">–°–ü–†–û–°–ò–õ</span>';
                if(h.status === 'think') badge = '<span class="status-badge sb-think">–î–£–ú–ê–ï–¢</span>';
                if(h.status === 'deposit') badge = '<span class="status-badge sb-deposit">–ë–†–û–ù–¨</span>';
                if(h.status === 'cancel') badge = '<span class="status-badge sb-cancel">–û–¢–ö–ê–ó</span>';
                div.innerHTML += `<div class="history-item status-${h.status}"><div class="hist-top"><span class="hist-name">${esc(h.name)}</span><span class="hist-date">${h.date}</span></div><div class="hist-bot"><div class="hist-det">${badge} <b>${h.eventDate}</b><br>${esc(h.loc)}<br>${esc(h.services)}</div><div class="hist-price">${fmt(h.total)}</div></div><div class="btn-delete-hist" onclick="History.delete(${h.id})">√ó</div><div style="margin-top:10px; display:flex; gap:10px;"><button onclick="History.setStatus(${h.id}, 'deposit')" style="flex:1; background:#333; color:#30D158; border:1px solid #30D158; border-radius:6px; padding:6px; font-size:12px;">–û–ø–ª–∞—á–µ–Ω–æ</button><button onclick="History.setStatus(${h.id}, 'cancel')" style="flex:1; background:#333; color:#FF453A; border:1px solid #FF453A; border-radius:6px; padding:6px; font-size:12px;">–û—Ç–∫–∞–∑</button></div></div>`;
            });
        }
    };

    // --- ADMIN (FLEXIBLE) ---
    const Admin = {
        render: () => {
            const tDiv = el('settings-travel-list'); tDiv.innerHTML = '';
            for (let r in DB.travel) {
                const cities = DB.travel[r].cities; let cHtml = '';
                for(let c in cities) { cHtml += `<div class="set-row"><input class="set-input-name" value="${c}" onchange="Admin.renameCity('${r}','${c}',this.value)"><input type="number" class="set-input-price" value="${cities[c]}" onchange="Admin.setCityPrice('${r}','${c}',this.value)"><div class="btn-del-item" onclick="Admin.delCity('${r}','${c}')">√ó</div></div>`; }
                tDiv.innerHTML += `<div class="settings-block"><div class="settings-header" onclick="Admin.toggleSection(this)"><span>${r}</span><span class="toggle-icon">‚ñº</span></div><div class="settings-content"><div class="set-row" style="background:#2C2C2E;"><span style="font-size:15px; color:#aaa;">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</span><input type="number" class="set-input-price" value="${DB.travel[r].fee}" onchange="Admin.setRegionFee('${r}',this.value)"></div>${cHtml}<div class="btn-add-item" onclick="Admin.addCity('${r}')">+ –ì–æ—Ä–æ–¥</div><div class="btn-del-item" style="width:100%; font-size:14px; padding:10px;" onclick="Admin.delRegion('${r}')">–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥–∏–æ–Ω</div></div></div>`;
            }
            const sDiv = el('settings-services-list'); sDiv.innerHTML = '';
            for (let c in DB.services) {
                let sHtml = '';
                for(let s in DB.services[c]) { sHtml += `<div class="set-row"><input class="set-input-name" value="${s}" onchange="Admin.renameSvc('${c}','${s}',this.value)"><input type="number" class="set-input-price" value="${DB.services[c][s]}" onchange="Admin.setSvcPrice('${c}','${s}',this.value)"><div class="btn-del-item" onclick="Admin.delSvc('${c}','${s}')">√ó</div></div>`; }
                sDiv.innerHTML += `<div class="settings-block"><div class="settings-header" onclick="Admin.toggleSection(this)"><span>${c}</span><span class="toggle-icon">‚ñº</span></div><div class="settings-content">${sHtml}<div class="btn-add-item" onclick="Admin.addSvc('${c}')">+ –£—Å–ª—É–≥–∞</div><div class="btn-del-item" style="width:100%; font-size:14px; padding:10px;" onclick="Admin.delCat('${c}')">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div></div></div>`;
            }
            // --- –ö–ü: —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ ---
            const pDiv = el('settings-payments-list');
            if(pDiv){
                pDiv.innerHTML = '';
                const list = Array.isArray(DB.payments) ? DB.payments : [];
                if(list.length === 0){
                    pDiv.innerHTML = `<div style="padding:14px 16px; color:#888; font-size:13px;">–ü—É—Å—Ç–æ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –ö–ü.</div>`;
                } else {
                    list.forEach((p, idx) => {
                        const title = esc(p?.title ?? '');
                        const text = esc(p?.text ?? '');
                        pDiv.innerHTML += `
                            <div class="set-row" style="flex-direction:column; align-items:stretch;">
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <input class="set-input-name" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–ë–ü, –¢–∏–Ω—å–∫–æ—Ñ—Ñ, –ù–∞–ª–∏—á–Ω—ã–µ)" value="${title}" oninput="Admin.setPaymentTitle(${idx}, this.value)">
                                    <div class="btn-del-item" onclick="Admin.delPayment(${idx})">√ó</div>
                                </div>
                                <textarea class="edit-input" style="width:100%; margin-top:8px; min-height:78px; font-size:14px; resize:vertical;"
                                    placeholder="–õ—é–±—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã/–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏. –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫." oninput="Admin.setPaymentText(${idx}, this.value)">${text}</textarea>
                            </div>`;
                    });
                }
            }

            const lDiv = el('settings-links-list');
            if(lDiv){
                lDiv.innerHTML = '';
                const list = Array.isArray(DB.links) ? DB.links : [];
                if(list.length === 0){
                    lDiv.innerHTML = `<div style="padding:14px 16px; color:#888; font-size:13px;">–ü–æ–∫–∞ –Ω–µ—Ç —Å—Å—ã–ª–æ–∫ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ, —Å–æ—Ü—Å–µ—Ç–∏, –æ—Ç–∑—ã–≤—ã, —Å–∞–π—Ç.</div>`;
                } else {
                    list.forEach((l, idx) => {
                        const label = esc(l?.label ?? '');
                        const url = esc(l?.url ?? '');
                        lDiv.innerHTML += `
                            <div class="set-row">
                                <input class="set-input-name" style="flex:1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: Instagram)" value="${label}" oninput="Admin.setLinkLabel(${idx}, this.value)">
                                <input class="set-input-name" style="flex:2; font-size:14px;" placeholder="–°—Å—ã–ª–∫–∞ (https://...)" value="${url}" oninput="Admin.setLinkUrl(${idx}, this.value)">
                                <div class="btn-del-item" onclick="Admin.delLink(${idx})">√ó</div>
                            </div>`;
                    });
                }
            }

        },
        toggleSection: (el) => { const c = el.nextElementSibling; c.classList.toggle('open'); el.querySelector('.toggle-icon').style.transform = c.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)'; },
        addRegion: () => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞:"); if(n && !DB.travel[n]) { DB.travel[n]={fee:0, cities:{}}; Storage.save(); Admin.render(); } },
        delRegion: (r) => { if(confirm(`–£–¥–∞–ª–∏—Ç—å ${r}?`)) { delete DB.travel[r]; Storage.save(); Admin.render(); App.init(); } },
        setRegionFee: (r,v) => { DB.travel[r].fee=parseInt(v); Storage.save(); },
        addCity: (r) => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:"); if(n) { DB.travel[r].cities[n]=0; Storage.save(); Admin.render(); App.init(); } },
        delCity: (r,c) => { delete DB.travel[r].cities[c]; Storage.save(); Admin.render(); App.init(); },
        renameCity: (r,oldC,newC) => { if(oldC===newC || !newC) return; const price = DB.travel[r].cities[oldC]; delete DB.travel[r].cities[oldC]; DB.travel[r].cities[newC] = price; Storage.save(); App.init(); },
        setCityPrice: (r,c,v) => { DB.travel[r].cities[c]=parseInt(v); Storage.save(); },
        addCategory: () => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:"); if(n && !DB.services[n]) { DB.services[n]={}; Storage.save(); Admin.render(); App.init(); } },
        delCat: (c) => { if(confirm(`–£–¥–∞–ª–∏—Ç—å ${c}?`)) { delete DB.services[c]; Storage.save(); Admin.render(); App.init(); } },
        addSvc: (c) => { const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏:"); if(n) { DB.services[c][n]=0; Storage.save(); Admin.render(); App.init(); } },
        delSvc: (c,s) => { delete DB.services[c][s]; Storage.save(); Admin.render(); App.init(); },
        renameSvc: (c,oldS,newS) => { if(oldS===newS || !newS) return; const price = DB.services[c][oldS]; delete DB.services[c][oldS]; DB.services[c][newS] = price; Storage.save(); App.init(); },
        setSvcPrice: (c,s,v) => { DB.services[c][s]=parseInt(v); Storage.save(); },
        
        // --- Payments / Links for –ö–ü ---
        addPayment: () => {
            if(!Array.isArray(DB.payments)) DB.payments = [];
            DB.payments.push({ title: "–ù–æ–≤—ã–π —Å–ø–æ—Å–æ–±", text: "" });
            Storage.save(); Admin.render();
        },
        delPayment: (idx) => { if(!Array.isArray(DB.payments)) return; DB.payments.splice(idx,1); Storage.save(); Admin.render(); },
        setPaymentTitle: (idx, v) => { if(!Array.isArray(DB.payments)) return; DB.payments[idx].title = v; Storage.save(); },
        setPaymentText: (idx, v) => { if(!Array.isArray(DB.payments)) return; DB.payments[idx].text = v; Storage.save(); },

        addLink: () => {
            if(!Array.isArray(DB.links)) DB.links = [];
            DB.links.push({ label: "–°—Å—ã–ª–∫–∞", url: "" });
            Storage.save(); Admin.render();
        },
        delLink: (idx) => { if(!Array.isArray(DB.links)) return; DB.links.splice(idx,1); Storage.save(); Admin.render(); },
        setLinkLabel: (idx, v) => { if(!Array.isArray(DB.links)) return; DB.links[idx].label = v; Storage.save(); },
        setLinkUrl: (idx, v) => { if(!Array.isArray(DB.links)) return; DB.links[idx].url = v; Storage.save(); },

        resetAll: () => Storage.reset()
    };

    
    // --- HOLIDAYS (FLEXIBLE COEFFICIENTS) ---
    const HolidayCfg = {
        ensure: () => {
            if(!DB.settings) DB.settings = {};
            if(!DB.settings.holidays || typeof DB.settings.holidays !== 'object') {
                DB.settings.holidays = JSON.parse(JSON.stringify(DEFAULT_DB.settings.holidays || {}));
            }
            if(!Array.isArray(DB.settings.holidayRanges)) {
                DB.settings.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.settings.holidayRanges || []));
            }
        },
        normalizeMD: (raw) => {
            const s = String(raw || '').trim().replace(/[./\s]/g, '-');
            const m = s.match(/^(\d{1,2})-(\d{1,2})$/);
            if(!m) return null;
            let mm = Math.max(1, Math.min(12, parseInt(m[1],10)));
            let dd = Math.max(1, Math.min(31, parseInt(m[2],10)));
            return `${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
        },
        parseK: (v) => {
            let k = parseFloat(String(v).replace(',','.'));
            if(Number.isNaN(k)) k = 1;
            // keep reasonable range
            k = Math.max(1, Math.min(5, k));
            // round to 2 decimals (nice for UI)
            return Math.round(k * 100) / 100;
        },
        render: () => {
            HolidayCfg.ensure();

            const list = el('settings-holidays-list');
            const ranges = el('settings-holidayranges-list');
            if(!list || !ranges) return;

            // --- fixed dates ---
            const keys = Object.keys(DB.settings.holidays || {}).sort();
            list.innerHTML = keys.length ? '' : `<div style="padding: 10px 16px; color: rgba(255,255,255,.55); font-size: 13px;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞—Ç. –î–æ–±–∞–≤—å, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å ‚Äú–¥–æ—Ä–æ–≥–∏–µ‚Äù –¥–Ω–∏.</div>`;

            keys.forEach((key) => {
                const kVal = DB.settings.holidays[key];
                const row = document.createElement('div');
                row.className = 'set-row';
                row.innerHTML = `
                    <input class="set-input-name" value="${esc(key)}" placeholder="–ú–ú-–î–î" inputmode="numeric">
                    <input class="set-input-price" value="${esc(kVal)}" placeholder="√ó1.5" inputmode="decimal">
                    <div class="btn-del-item" title="–£–¥–∞–ª–∏—Ç—å">√ó</div>
                `;
                const inpKey = row.children[0];
                const inpK = row.children[1];
                const btnDel = row.children[2];

                // key change (rename)
                inpKey.onblur = () => {
                    const newKey = HolidayCfg.normalizeMD(inpKey.value);
                    if(!newKey) { inpKey.value = key; return; }
                    const kNow = HolidayCfg.parseK(inpK.value);
                    // rename safely
                    if(newKey !== key) {
                        delete DB.settings.holidays[key];
                    }
                    DB.settings.holidays[newKey] = kNow;
                    Storage.save();
                    HolidayCfg.render();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };

                // coefficient change
                inpK.onblur = () => {
                    const kk = HolidayCfg.parseK(inpK.value);
                    DB.settings.holidays[key] = kk;
                    inpK.value = kk;
                    Storage.save();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };

                btnDel.onclick = () => {
                    delete DB.settings.holidays[key];
                    Storage.save();
                    HolidayCfg.render();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };

                list.appendChild(row);
            });

            // --- ranges ---
            const rs = DB.settings.holidayRanges || [];
            ranges.innerHTML = rs.length ? '' : `<div style="padding: 10px 16px; color: rgba(255,255,255,.55); font-size: 13px;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–µ—Ä–∏–æ–¥–æ–≤. –î–æ–±–∞–≤—å, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Å–µ–∑–æ–Ω–Ω—ã–µ –Ω–∞–¥–±–∞–≤–∫–∏.</div>`;

            rs.forEach((r, i) => {
                const start = `${String(r.sm||1).padStart(2,'0')}-${String(r.sd||1).padStart(2,'0')}`;
                const end = `${String(r.em||1).padStart(2,'0')}-${String(r.ed||1).padStart(2,'0')}`;
                const kVal = HolidayCfg.parseK(r.k ?? 1);

                const wrap = document.createElement('div');
                wrap.className = 'set-row';
                wrap.style.gap = '8px';
                wrap.innerHTML = `
                    <input class="set-input-name" style="max-width:92px;" value="${esc(start)}" placeholder="–ú–ú-–î–î" inputmode="numeric">
                    <div style="opacity:.6; font-weight:700;">‚Üí</div>
                    <input class="set-input-name" style="max-width:92px;" value="${esc(end)}" placeholder="–ú–ú-–î–î" inputmode="numeric">
                    <input class="set-input-price" style="width:72px;" value="${esc(kVal)}" placeholder="√ó1.5" inputmode="decimal">
                    <div class="btn-del-item" title="–£–¥–∞–ª–∏—Ç—å">√ó</div>
                `;
                const inpStart = wrap.children[0];
                const inpEnd = wrap.children[2];
                const inpK = wrap.children[3];
                const btnDel = wrap.children[4];

                const saveRow = () => {
                    const s1 = HolidayCfg.normalizeMD(inpStart.value);
                    const s2 = HolidayCfg.normalizeMD(inpEnd.value);
                    if(!s1 || !s2) {
                        inpStart.value = start;
                        inpEnd.value = end;
                        return;
                    }
                    const [sm, sd] = s1.split('-').map(n=>parseInt(n,10));
                    const [em, ed] = s2.split('-').map(n=>parseInt(n,10));
                    const kk = HolidayCfg.parseK(inpK.value);

                    DB.settings.holidayRanges[i] = { sm, sd, em, ed, k: kk };
                    inpStart.value = s1;
                    inpEnd.value = s2;
                    inpK.value = kk;
                    Storage.save();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };

                inpStart.onblur = saveRow;
                inpEnd.onblur = saveRow;
                inpK.onblur = saveRow;

                btnDel.onclick = () => {
                    DB.settings.holidayRanges.splice(i, 1);
                    Storage.save();
                    HolidayCfg.render();
                    try { App.updateDate(); App.calc(); } catch(e){}
                };

                ranges.appendChild(wrap);
            });
        },
        addHoliday: () => {
            HolidayCfg.ensure();
            // pick next free key
            const candidates = ['12-31','01-01','03-08','02-23','06-01','09-01'];
            let key = candidates.find(k => !(k in DB.settings.holidays));
            if(!key){
                // fallback: today
                const d = new Date();
                key = `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                if(key in DB.settings.holidays){
                    // pick –±–ª–∏–∂–∞–π—à—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –¥–∞—Ç—É (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥–æ–¥–∞), —á—Ç–æ–±—ã –∫–ª—é—á –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤–∞–ª–∏–¥–Ω—ã–º –ú–ú-–î–î
                    let dd = new Date();
                    for(let step=0; step<366; step++){
                        const k2 = `${String(dd.getMonth()+1).padStart(2,'0')}-${String(dd.getDate()).padStart(2,'0')}`;
                        if(!(k2 in DB.settings.holidays)) { key = k2; break; }
                        dd.setDate(dd.getDate()+1);
                    }
                }
            }
            DB.settings.holidays[key] = 1.5;
            Storage.save();
            HolidayCfg.render();
            try { App.updateDate(); App.calc(); } catch(e){}
        },
        addRange: () => {
            HolidayCfg.ensure();
            DB.settings.holidayRanges.push({ sm: 12, sd: 15, em: 12, ed: 30, k: 1.5 });
            Storage.save();
            HolidayCfg.render();
            try { App.updateDate(); App.calc(); } catch(e){}
        }
    };


// --- CALENDAR ---
    const Calendar = {
        displayedDate: new Date(), selectedDate: new Date(),
        editingId: null,
        render: () => {
            const y = Calendar.displayedDate.getFullYear(), m = Calendar.displayedDate.getMonth();
            const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
            el('cal-month-title').innerText = `${months[m]} ${y}`;
            const firstDay = new Date(y, m, 1).getDay(); const daysInMonth = new Date(y, m+1, 0).getDate();
            const grid = el('calendar-grid'); grid.innerHTML = '';
            let start = firstDay === 0 ? 6 : firstDay - 1;
            for(let i=0; i<start; i++) grid.innerHTML += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const events = DB.events.filter(e => e.date === dateStr);
                let dotHtml = events.length > 0 ? `<div class="day-dots"><div class="dot active"></div></div>` : '';
                const isToday = isoLocal() === dateStr;
                const isSel = isoLocal(Calendar.selectedDate) === dateStr;
                grid.innerHTML += `<div class="day-cell ${isToday?'today':''} ${isSel?'selected':''}" onclick="Calendar.selectDay('${dateStr}')">${d}${dotHtml}</div>`;
            }
            Calendar.renderEventsList();
        },
        selectDay: (dStr) => { Calendar.selectedDate = parseISODate(dStr); Calendar.render(); },
        renderEventsList: () => {
            const dStr = isoLocal(Calendar.selectedDate);
            const events = DB.events.filter(e => e.date === dStr).sort((a,b) => a.time.localeCompare(b.time));
            el('selected-date-title').innerText = parseISODate(dStr).toLocaleDateString('ru-RU', {weekday:'long', day:'numeric', month:'long'});
            const list = el('events-list'); list.innerHTML = '';
            if(events.length === 0) { list.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>'; return; }
            events.forEach(ev => {
                const rawNotes = String(ev.notes || '').trim();
                const firstLine = rawNotes ? rawNotes.split(/\r?\n/)[0].trim() : '';
                const notesShort = firstLine.length > 42 ? (firstLine.slice(0, 42) + '‚Ä¶') : firstLine;

                const parts = [];
                if(ev.phone) parts.push(ev.phone);
                if(ev.type) parts.push(ev.type);
                if(notesShort) parts.push('üìù ' + notesShort);
                const sub = parts.join(' ‚Ä¢ ');

                list.innerHTML += `<div class="event-item" onclick="Calendar.openEdit(${ev.id})">
                    <div class="event-time">${ev.time}</div>
                    <div class="event-details" style="border-left:3px solid var(--accent);">
                        <div class="event-title">${esc(ev.title)}</div>
                        <div class="event-sub">${esc(sub)}</div>
                    </div>
                    <div class="event-price">${fmt(ev.price)}</div>
                    <div style="margin-left:10px; color:#FF453A; cursor:pointer;" onclick="event.stopPropagation(); Calendar.delEvent(${ev.id})">√ó</div>
                </div>`;
            });
        },
        prevMonth: () => { Calendar.displayedDate.setMonth(Calendar.displayedDate.getMonth()-1); Calendar.render(); },
        nextMonth: () => { Calendar.displayedDate.setMonth(Calendar.displayedDate.getMonth()+1); Calendar.render(); },
        openModal: () => {
            Calendar.editingId = null;
            el('event-modal').classList.add('active');
            
            if(window.__iosFix) window.__iosFix.lockBody();
            if(window.__iosFix) window.__iosFix.setHeights();
// reset fields for ADD mode
            el('mod-title').value = '';
            el('mod-phone').value = '';
            el('mod-price').value = '';
            if(el('mod-notes')) el('mod-notes').value = '';
            el('mod-time').value = '12:00';
            if(el('mod-type')) el('mod-type').value = '–°–≤–∞–¥—å–±–∞';
            el('mod-date').value = isoLocal(Calendar.selectedDate);

            
            if(typeof Touch !== 'undefined') Touch.prepareFromModal();
const saveBtn = el('btn-modal-save'); if(saveBtn) saveBtn.innerText = '–î–æ–±–∞–≤–∏—Ç—å';
            const delBtn = el('btn-modal-delete'); if(delBtn) delBtn.style.display = 'none';
        },
        closeModal: () => {
            el('event-modal').classList.remove('active');
            
            if(window.__iosFix) window.__iosFix.unlockBody();
            if(window.__iosFix && window.__iosFix.onModalClose) window.__iosFix.onModalClose();
            if(window.__iosFix) window.__iosFix.setHeights();
Calendar.editingId = null;
            const saveBtn = el('btn-modal-save'); if(saveBtn) saveBtn.innerText = '–î–æ–±–∞–≤–∏—Ç—å';
            const delBtn = el('btn-modal-delete'); if(delBtn) delBtn.style.display = 'none';
        },
        saveManualEvent: () => {
            const payload = {
                title: el('mod-title').value || '–°–æ–±—ã—Ç–∏–µ',
                date: el('mod-date').value,
                time: el('mod-time').value || '12:00',
                phone: el('mod-phone').value,
                type: el('mod-type') ? el('mod-type').value : '',
                price: parseInt(el('mod-price').value) || 0
            ,
                notes: (el('mod-notes') ? el('mod-notes').value : '').trim()};

            if(Calendar.editingId !== null){
                const idx = DB.events.findIndex(e => e.id === Calendar.editingId);
                if(idx !== -1){
                    DB.events[idx] = { ...DB.events[idx], ...payload, id: Calendar.editingId };
                } else {
                    // fallback: if somehow missing, create new
                    DB.events.push({ id: Date.now(), ...payload });
                }
            } else {
                DB.events.push({ id: Date.now(), ...payload });
            }

            Storage.save();
            Calendar.closeModal();
            Calendar.render();
        },
        openEdit: (id) => {
            const ev = DB.events.find(e => e.id === id);
            if(!ev) return;

            Calendar.editingId = id;
            el('event-modal').classList.add('active');

            
            if(window.__iosFix) window.__iosFix.lockBody();
            if(window.__iosFix) window.__iosFix.setHeights();
el('mod-title').value = ev.title || '';
            el('mod-date').value = ev.date || isoLocal(Calendar.selectedDate);
            el('mod-time').value = ev.time || '12:00';
            el('mod-phone').value = ev.phone || '';
            if(el('mod-type')) el('mod-type').value = ev.type || '–î—Ä—É–≥–æ–µ';
            el('mod-price').value = (ev.price ?? 0);

            
            if(el('mod-notes')) el('mod-notes').value = (ev.notes || '');
            if(typeof Touch !== 'undefined') Touch.prepareFromModal();
const saveBtn = el('btn-modal-save'); if(saveBtn) saveBtn.innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            const delBtn = el('btn-modal-delete'); if(delBtn) delBtn.style.display = 'inline';
        },
        deleteFromModal: () => {
            if(Calendar.editingId === null) return;
            const id = Calendar.editingId;
            if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            DB.events = DB.events.filter(e => e.id !== id);
            Storage.save();
            Calendar.closeModal();
            Calendar.render();
        },
        delEvent: (id) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { DB.events = DB.events.filter(e=>e.id!==id); Storage.save(); Calendar.render(); } }
    };

    


    // --- TOUCH: –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ –∫–∞—Å–∞–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–¥–ª—è —Ñ–æ–∫—É—Å–Ω–∏–∫–∞) ---
    const Touch = {
        activeTemplate: 'fast',
        auto: true,

        cfgDefaults: () => ({
            performer: '–§–æ–∫—É—Å–Ω–∏–∫',
            depositPercent: 30,
            autosaveOnCopy: false
        }),
        ensureCfg: () => {
            if(!DB.touchCfg) DB.touchCfg = Touch.cfgDefaults();
            if(typeof DB.touchCfg.performer !== 'string') DB.touchCfg.performer = '–§–æ–∫—É—Å–Ω–∏–∫';
            if(typeof DB.touchCfg.depositPercent !== 'number') DB.touchCfg.depositPercent = 30;
            if(typeof DB.touchCfg.autosaveOnCopy !== 'boolean') DB.touchCfg.autosaveOnCopy = false;
        },

        // --- Templates (editable, saved in DB) ---
        defaultTemplates: () => ([
            {
                id: 'fast',
                label: '–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç',
                body:
`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø {{performer}}.
{{whenLine}}
{{typeLine}}
{{priceLine}}

–ß—Ç–æ–±—ã —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞—Ç—å ‚Äú–¥–∞‚Äù –∏ —Å–¥–µ–ª–∞—Ç—å —à–æ—É –∏–¥–µ–∞–ª—å–Ω–æ, –∫–æ—Ä–æ—Ç–∫–æ —É—Ç–æ—á–Ω—é:
1) –ê–¥—Ä–µ—Å/–ø–ª–æ—â–∞–¥–∫–∞ (–¥–æ–º/–∫–∞—Ñ–µ/–∑–∞–ª)?
2) –°–∫–æ–ª—å–∫–æ –≥–æ—Å—Ç–µ–π –∏ –≤–æ–∑—Ä–∞—Å—Ç (–µ—Å–ª–∏ –¥–µ—Ç—Å–∫–∏–π)?
3) –ü–æ –≤—Ä–µ–º–µ–Ω–∏: –≤–æ —Å–∫–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ –∏ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤—ã —Ö–æ—Ç–∏—Ç–µ?
4) –ï—Å—Ç—å –ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω/–∫–æ–ª–æ–Ω–∫–∞? (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ä–µ—à–∞–µ–º)

{{portfolioLine}}
{{reviewsLine}}`
            },
            {
                id: 'faq',
                label: '–û—Ç–≤–µ—Ç—ã —Ä–∞–∑–æ–º',
                body:
`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø {{performer}}. –û—Ç–≤–µ—á—É –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –≤–∞–º –≤—Ä–µ–º—è üëá

‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –æ–±—ã—á–Ω–æ 45‚Äì60 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ 30/90 ‚Äî –ø–æ–¥ –∑–∞–ø—Ä–æ—Å).
üé≠ –§–æ—Ä–º–∞—Ç: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤, –≥–æ—Å—Ç–∏ —É—á–∞—Å—Ç–≤—É—é—Ç, –±–µ–∑ ‚Äú–¥–µ—Ç—Å–∫–æ–≥–æ —Å–∞–¥–∞‚Äù –∏ –±–µ–∑ –∑–∞–Ω—É–¥—Å—Ç–≤–∞.
üìç –ü–ª–æ—â–∞–¥–∫–∞: –Ω—É–∂–Ω–æ 2√ó3 –º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ + —Ä–æ–∑–µ—Ç–∫–∞ —Ä—è–¥–æ–º.
üé§ –ó–≤—É–∫: –∏–¥–µ–∞–ª—å–Ω–æ ‚Äî 1 –º–∏–∫—Ä–æ—Ñ–æ–Ω. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–¥—Å—Ç—Ä–æ—é—Å—å, —Å–∫–∞–∂—É –∫–∞–∫ –ª—É—á—à–µ.
{{priceFaqLine}}
üí≥ –ë—Ä–æ–Ω—å: –∑–∞–¥–∞—Ç–æ–∫ {{depositPercent}}% —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –¥–∞—Ç—É, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤ –¥–µ–Ω—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
üïí –ü—Ä–∏–µ–∑–∂–∞—é –∑–∞—Ä–∞–Ω–µ–µ: –æ–±—ã—á–Ω–æ –∑–∞ 30‚Äì40 –º–∏–Ω—É—Ç.

{{portfolioLine}}
{{reviewsLine}}

–ï—Å–ª–∏ —Å–∫–∞–∂–µ—Ç–µ –∞–¥—Ä–µ—Å, –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏ —Ñ–æ—Ä–º–∞—Ç ‚Äî —è –≤ –æ—Ç–≤–µ—Ç –ø—Ä–∏—à–ª—é —Ç–æ—á–Ω—ã–π –ø–ª–∞–Ω –∏ –∑–∞–∫—Ä–µ–ø–ª—é –±—Ä–æ–Ω—å.`
            },
            {
                id: 'deposit',
                label: '–ü—Ä–æ –∑–∞–¥–∞—Ç–æ–∫',
                body:
`–ß—Ç–æ–±—ã –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É ‚Äî –∑–∞–¥–∞—Ç–æ–∫ {{depositPercent}}%.
–≠—Ç–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –∑–∞ –≤–∞–º–∏, —è —É–∂–µ –Ω–∏–∫–æ–º—É –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ –æ—Ç–≤–µ—á–∞—é ‚Äú–¥–∞‚Äù.
–û—Å—Ç–∞—Ç–æ–∫ ‚Äî –≤ –¥–µ–Ω—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.

–ï—Å–ª–∏ —É–¥–æ–±–Ω–æ ‚Äî —Å–∫–∏–Ω—É —Ä–µ–∫–≤–∏–∑–∏—Ç—ã/—Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.`
            },
            {
                id: 'tech',
                label: '–¢–µ—Ö. —É—Å–ª–æ–≤–∏—è',
                body:
`–ü–æ —Ç–µ—Ö–Ω–∏–∫–µ –≤—Å—ë –ø—Ä–æ—Å—Ç–æ:
‚Ä¢ 2√ó3 –º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (—á—Ç–æ–±—ã –≥–æ—Å—Ç–∏ –≤—Å—ë –≤–∏–¥–µ–ª–∏);
‚Ä¢ —Ä–æ–∑–µ—Ç–∫–∞ 220V —Ä—è–¥–æ–º;
‚Ä¢ –µ—Å–ª–∏ –≥–æ—Å—Ç–µ–π –º–Ω–æ–≥–æ ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω (–∏–¥–µ–∞–ª—å–Ω–æ –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω–æ–π).
–ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏—Ç–µ, –ø–æ–¥–±–µ—Ä—ë–º —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à—É –ø–ª–æ—â–∞–¥–∫—É.`
            }

            ,
            {
                id: 'sales_sent_kp',
                label: '–ü—Ä–æ–¥–∞–∂–∏: –ø–æ—Å–ª–µ –ö–ü (–º—è–≥–∫–æ)',
                body:
`{{clientHi}}

–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª —Ä–∞—Å—á–µ—Ç –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é.
–ï—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –º–æ–≥—É –∑–∞–∫—Ä–µ–ø–∏—Ç—å –¥–∞—Ç—É –∑–∞ –≤–∞–º–∏: –∑–∞–¥–∞—Ç–æ–∫ {{depositPercent}}% —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è.

–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª?`
            },
            {
                id: 'sales_ping_2h',
                label: '–ü—Ä–æ–¥–∞–∂–∏: –ø–∏–Ω–≥ —á–µ—Ä–µ–∑ 2‚Äì3 —á–∞—Å–∞',
                body:
`{{clientHi}}

–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, —Ä–∞—Å—á—ë—Ç –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∏?
–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —è –±—ã—Å—Ç—Ä–æ –ø–æ–¥—Å–∫–∞–∂—É, –∫–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –±—É–¥–µ—Ç –ª—É—á—à–µ –ø–æ–¥ –≤–∞—à—É –∑–∞–¥–∞—á—É ‚Äî –ø–æ —ç–º–æ—Ü–∏—è–º –∏ –ø–æ –±—é–¥–∂–µ—Ç—É.`
            },
            {
                id: 'sales_ping_nextday',
                label: '–ü—Ä–æ–¥–∞–∂–∏: –ø–∏–Ω–≥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å',
                body:
`{{clientHi}}

–Ø –¥–µ—Ä–∂—É –¥–∞—Ç—É –≤ —Ä–µ–∑–µ—Ä–≤–µ –¥–æ –≤–µ—á–µ—Ä–∞ (—á—Ç–æ–±—ã –≤—ã —Å–ø–æ–∫–æ–π–Ω–æ –ø–æ–¥—É–º–∞–ª–∏).
–ï—Å–ª–∏ —Ä–µ—à–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ ‚Äú–ë—Ä–æ–Ω–∏—Ä—É–µ–º‚Äù, –∏ —è –ø—Ä–∏—à–ª—é —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–∞ –∑–∞–¥–∞—Ç–æ–∫ {{depositPercent}}%.`
            },
            {
                id: 'sales_objection_expensive',
                label: '–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: –¥–æ—Ä–æ–≥–æ',
                body:
`–ü–æ–Ω–∏–º–∞—é –≤–∞—Å üôå

–î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω–æ: –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å ‚Äú–≤–∞—É‚Äù, –Ω–æ –ø–æ–¥–∂–∞—Ç—å –±—é–¥–∂–µ—Ç:
1) —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30 –≤–º–µ—Å—Ç–æ 45‚Äì60);
2) —É–±—Ä–∞—Ç—å 1 –±–ª–æ–∫ –∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–∞–º–æ–µ —Å–∏–ª—å–Ω–æ–µ;
3) –≤—ã–±—Ä–∞—Ç—å –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —ç–º–æ—Ü–∏–∏.

–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ: —É–ª–æ–∂–∏—Ç—å—Å—è –≤ —Å—É–º–º—É –∏–ª–∏ —á—Ç–æ–±—ã –±—ã–ª–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ ‚Äú–≤–∞—É‚Äù?`
            },
            {
                id: 'sales_objection_think',
                label: '–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: –Ω–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å',
                body:
`–ö–æ–Ω–µ—á–Ω–æ, –ø–æ–¥—É–º–∞–π—Ç–µ —Å–ø–æ–∫–æ–π–Ω–æ üôÇ

–ß—Ç–æ–±—ã –≤–∞–º –ª–µ–≥—á–µ –±—ã–ª–æ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ, —É—Ç–æ—á–Ω—é 1 –≤–æ–ø—Ä–æ—Å:
—á—Ç–æ —Å–µ–π—á–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Å–º—É—â–∞–µ—Ç ‚Äî —Ü–µ–Ω–∞, —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ ‚Äú–ø–æ–¥–æ–π–¥—ë—Ç –ª–∏ –≥–æ—Å—Ç—è–º‚Äù?

–Ø –ø–æ–¥—Å—Ç—Ä–æ—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ç–∞–∫, —á—Ç–æ–±—ã –≤–∞–º –±—ã–ª–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ —Å–∫–∞–∑–∞—Ç—å ‚Äú–¥–∞‚Äù.`
            },
            {
                id: 'sales_objection_compare',
                label: '–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: —Å—Ä–∞–≤–Ω–∏–≤–∞—é –≤–∞—Ä–∏–∞–Ω—Ç—ã',
                body:
`–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å üôÇ

–ß—Ç–æ–±—ã –≤—ã —Å—Ä–∞–≤–Ω–∏–ª–∏ —á–µ—Å—Ç–Ω–æ, –≤–æ—Ç 3 –∫—Ä–∏—Ç–µ—Ä–∏—è:
1) –≥–∞—Ä–∞–Ω—Ç–∏–∏ (–¥–æ–≥–æ–≤–æ—Ä/—á–µ–∫/—Ä–µ–∑–µ—Ä–≤ –¥–∞—Ç—ã),
2) –æ—Ç–∑—ã–≤—ã/–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ,
3) —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–¥ –≤–∞—à—É –∞—É–¥–∏—Ç–æ—Ä–∏—é (–∞ –Ω–µ ‚Äú—à–∞–±–ª–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä‚Äù).

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äî —Å–∫–∏–Ω—É –∫–æ—Ä–æ—Ç–∫–æ 2‚Äì3 —Å–∏–ª—å–Ω—ã–µ —Ñ–∏—à–∫–∏ –∏–º–µ–Ω–Ω–æ –ø–æ–¥ –≤–∞—à —Ñ–æ—Ä–º–∞—Ç.`
            },
            {
                id: 'sales_objection_spouse',
                label: '–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ: –Ω—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å',
                body:
`–û–∫ üëç

–•–æ—Ç–∏—Ç–µ, —è –Ω–∞–ø–∏—à—É –≤–∞–º 3 —Å—Ç—Ä–æ–∫–∏ ‚Äú–¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏‚Äù ‚Äî —á—Ç–æ–±—ã –≤—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Å—É–ø—Ä—É–≥—É/—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É?

–¢–∞–º –±—É–¥–µ—Ç: –¥–∞—Ç–∞, —Ñ–æ—Ä–º–∞—Ç, —Ü–µ–Ω–∞, —á—Ç–æ –≤—Ö–æ–¥–∏—Ç, –∏ –∫–∞–∫ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –±—Ä–æ–Ω—å.`
            },
            {
                id: 'sales_booking',
                label: '–§–∏–Ω–∞–ª: –∑–∞–∫—Ä–µ–ø–ª—è–µ–º –±—Ä–æ–Ω—å',
                body:
`–°—É–ø–µ—Ä! –¢–æ–≥–¥–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ–º üîí

–ß—Ç–æ–±—ã –∑–∞–∫—Ä–µ–ø–∏—Ç—å –¥–∞—Ç—É, –Ω—É–∂–µ–Ω –∑–∞–¥–∞—Ç–æ–∫ {{depositPercent}}%: {{depositLine}}

{{paymentsBlock}}

–ö–∞–∫ –±—É–¥–µ—Ç —É–¥–æ–±–Ω–æ: —Å–µ–π—á–∞—Å –∏–ª–∏ —á—É—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è?`
            }

]),

        ensureTemplates: () => {
            if(!Array.isArray(DB.touchTemplates) || DB.touchTemplates.length === 0){
                DB.touchTemplates = Touch.defaultTemplates();
                Storage.save();
            } else {
                // minimal migration / normalization
                DB.touchTemplates = DB.touchTemplates
                    .map(t => ({
                        id: (t && t.id) ? String(t.id) : ('tpl_' + Date.now() + '_' + Math.random().toString(16).slice(2)),
                        label: (t && t.label) ? String(t.label).slice(0, 60) : '–®–∞–±–ª–æ–Ω',
                        body: (t && (t.body || t.text)) ? String(t.body || t.text) : ''
                    }))
                    .filter(t => t.label.trim() && t.body.trim());
                if(DB.touchTemplates.length === 0){
                    DB.touchTemplates = Touch.defaultTemplates();
                }
            }
            if(!DB.touchActiveTemplate) DB.touchActiveTemplate = DB.touchTemplates[0].id;
            Touch.activeTemplate = DB.touchActiveTemplate;
        },

        templates: () => { Touch.ensureTemplates(); return DB.touchTemplates; },

        // FAQ chips remain hardcoded (fast inserts)
        faq: () => ([
            { label: '‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', text: () => '‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –æ–±—ã—á–Ω–æ 45‚Äì60 –º–∏–Ω—É—Ç. –ú–æ–∂–Ω–æ –∫–æ—Ä–æ—á–µ/–¥–æ–ª—å—à–µ ‚Äî –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç.' },
            { label: 'üí≥ –ó–∞–¥–∞—Ç–æ–∫', text: (c) => `üí≥ –ë—Ä–æ–Ω—å: –∑–∞–¥–∞—Ç–æ–∫ ${c.depositPercent}%, –æ—Å—Ç–∞—Ç–æ–∫ ‚Äî –≤ –¥–µ–Ω—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.` },
            { label: 'üìç –ü–ª–æ—â–∞–¥–∫–∞', text: () => 'üìç –ü–ª–æ—â–∞–¥–∫–∞: –Ω—É–∂–Ω–æ 2√ó3 –º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ + —Ä–æ–∑–µ—Ç–∫–∞ —Ä—è–¥–æ–º.' },
            { label: 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω', text: () => 'üé§ –ï—Å–ª–∏ –≥–æ—Å—Ç–µ–π –º–Ω–æ–≥–æ ‚Äî –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ 1 –º–∏–∫—Ä–æ—Ñ–æ–Ω. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–¥—Å—Ç—Ä–æ—é—Å—å.' },
            { label: 'üïí –ü—Ä–∏–µ–∑–¥', text: () => 'üïí –ü—Ä–∏–µ–∑–∂–∞—é –∑–∞—Ä–∞–Ω–µ–µ: –æ–±—ã—á–Ω–æ –∑–∞ 30‚Äì40 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞.' },
            { label: 'üé≠ –§–æ—Ä–º–∞—Ç', text: () => 'üé≠ –§–æ—Ä–º–∞—Ç: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ ‚Äî –≥–æ—Å—Ç–∏ —É—á–∞—Å—Ç–≤—É—é—Ç, –≤—Å—ë –∂–∏–≤–æ –∏ –¥–∏–Ω–∞–º–∏—á–Ω–æ.' },
        ]),

        els: () => ({
            templates: el('touch-templates'),
            faq: el('touch-faq'),
            msg: el('touch-message'),
            btnCopy: el('touch-copy'),
            btnShare: el('touch-share'),
            btnGen: el('touch-regenerate'),
            btnManage: el('touch-manage'),
            btnVars: el('touch-vars'),
        }),

        digits: (s='') => String(s||'').replace(/\D/g,''),
        linkByLabel: (label) => {
            const l = (DB.links||[]).find(x => (x.label||'').toLowerCase().includes((label||'').toLowerCase()) && (x.url||'').trim());
            return l ? l.url.trim() : '';
        },

        ctxFromModal: () => {
            Touch.ensureCfg();
            const title = (el('mod-title')?.value || '').trim() || '–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ';
            const date = el('mod-date')?.value || '';
            const time = el('mod-time')?.value || '';
            const phone = (el('mod-phone')?.value || '').trim();
            const type = el('mod-type')?.value || '';
            const price = parseInt(el('mod-price')?.value || '0') || 0;
            const notes = (el('mod-notes')?.value || '').trim();
            const performer = DB.touchCfg.performer || '–§–æ–∫—É—Å–Ω–∏–∫';
            const depositPercent = (DB.touchCfg.depositPercent ?? 30);

            const portfolio = Touch.linkByLabel('–ø–æ—Ä—Ç—Ñ') || Touch.linkByLabel('portfolio') || (DB.links?.[0]?.url || '').trim();
            const reviews = Touch.linkByLabel('–æ—Ç–∑—ã–≤') || Touch.linkByLabel('review') || '';

            const when = [date, time].filter(Boolean).join(' ');
            const whenLine = when ? `–ü–æ –¥–∞—Ç–µ: ${when} ‚Äî —É—Ç–æ—á–Ω—é –∏ —Å—Ä–∞–∑—É –∑–∞—Ñ–∏–∫—Å–∏—Ä—É—é –≤—Ä–µ–º—è.` : '';
            const typeLine = type ? `–§–æ—Ä–º–∞—Ç: ${type}.` : '';
            const priceLine = price ? `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmt(price)} (–≤—Å—ë ‚Äú–ø–æ–¥ –∫–ª—é—á‚Äù, –±–µ–∑ —Å—é—Ä–ø—Ä–∏–∑–æ–≤).` : '';
            const priceFaqLine = price ? `üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmt(price)} (–≤–∫–ª—é—á–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∏ —Ä–µ–∫–≤–∏–∑–∏—Ç).` : '';
            const portfolioLine = portfolio ? `–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ${portfolio}` : '';
            const reviewsLine = reviews ? `–û—Ç–∑—ã–≤—ã: ${reviews}` : '';

            return {
                title, clientName: title, date, time, when, phone, type, price, notes,
                performer, depositPercent, portfolio, reviews,
                whenLine, typeLine, priceLine, priceFaqLine, portfolioLine, reviewsLine
            };
        },

        applyTokens: (body, ctx) => {
            const out = String(body||'').replace(/\{\{(\w+)\}\}/g, (m,k) => {
                const v = (ctx && Object.prototype.hasOwnProperty.call(ctx, k)) ? ctx[k] : '';
                return (v === undefined || v === null) ? '' : String(v);
            });
            return out
                .replace(/[ \t]+\n/g, '\n')
                .replace(/\n{3,}/g, '\n\n')
                .replace(/\n\s+\n/g, '\n\n')
                .trim();
        },

        buildMessage: () => {
            const c = Touch.ctxFromModal();
            const t = Touch.templates().find(x => x.id === Touch.activeTemplate) || Touch.templates()[0];
            return Touch.applyTokens(t.body || '', c);
        },

        render: () => {
            const E = Touch.els();
            if(!E.templates || !E.faq || !E.msg) return;

            Touch.ensureTemplates();

            // templates chips
            E.templates.innerHTML = '';
            Touch.templates().forEach(t => {
                const b = document.createElement('button');
                b.type = 'button';
                b.className = 'touch-chip' + (t.id === Touch.activeTemplate ? ' active' : '');
                b.textContent = t.label;
                b.onclick = () => {
                    Touch.activeTemplate = t.id;
                    DB.touchActiveTemplate = t.id;
                    Storage.save();
                    Touch.auto = true;
                    Touch.refresh(true);
                    Touch.render(); // update chip active state
                };
                E.templates.appendChild(b);
            });

            // faq chips
            E.faq.innerHTML = '';
            Touch.faq().forEach(f => {
                const b = document.createElement('button');
                b.type = 'button';
                b.textContent = f.label;
                b.onclick = () => {
                    const c = Touch.ctxFromModal();
                    const add = (typeof f.text === 'function' ? f.text(c) : String(f.text||'')).trim();
                    if(!add) return;
                    const cur = (E.msg.value || '').trim();
                    E.msg.value = (cur ? (cur + '\n\n' + add) : add);
                    Touch.auto = false;
                };
                E.faq.appendChild(b);
            });

            // message edits turn off auto
            E.msg.oninput = () => { Touch.auto = false; };
        },

        refresh: (force=false) => {
            const E = Touch.els();
            if(!E.msg) return;
            if(!Touch.auto && !force) return;
            E.msg.value = Touch.buildMessage();
        },

        toast: (txt='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!') => {
            const t = el('toast');
            if(!t) return;
            t.textContent = txt;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 1700);
        },

        shareText: async (text) => {
            if(navigator.share) {
                try { await navigator.share({ text }); return true; } catch(e) {}
            }
            return false;
        },

        // --- Template manager modal ---
        tplEls: () => ({
            modal: el('tpl-modal'),
            list: el('tpl-list'),
            close: el('tpl-close'),
            add: el('tpl-add'),
            exportBtn: el('tpl-export'),
            importBtn: el('tpl-import'),
        }),

        openTplModal: () => {
            const M = Touch.tplEls();
            if(!M.modal) return;
            Touch.ensureTemplates();
            M.modal.classList.add('active');
            
            if(window.__iosFix) window.__iosFix.lockBody();
            if(window.__iosFix) window.__iosFix.setHeights();
Touch.renderTplEditor();
        },
        closeTplModal: () => {
            const M = Touch.tplEls();
            if(!M.modal) return;
            M.modal.classList.remove('active');
        
            if(window.__iosFix) window.__iosFix.unlockBody();
            if(window.__iosFix && window.__iosFix.onModalClose) window.__iosFix.onModalClose();
            if(window.__iosFix) window.__iosFix.setHeights();
},

        newId: () => 'tpl_' + Date.now() + '_' + Math.random().toString(16).slice(2),
        esc: (s='') => String(s||'').replace(/[&<>"']/g, (ch) => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[ch])),

        renderTplEditor: () => {
            const M = Touch.tplEls();
            if(!M.list) return;
            Touch.ensureTemplates();

            M.list.innerHTML = '';
            DB.touchTemplates.forEach((t, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'tpl-item';

                const labelId = `tpl-label-${idx}`;
                const bodyId = `tpl-body-${idx}`;

                wrap.innerHTML = `
                    <div class="tpl-row">
                        <input id="${labelId}" class="text-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" value="${Touch.esc(t.label)}">
                    </div>
                    <textarea id="${bodyId}" class="tpl-area" placeholder="–¢–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞‚Ä¶ (–º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å {{whenLine}}, {{priceLine}}, {{depositPercent}} –∏ —Ç.–¥.)">${Touch.esc(t.body)}</textarea>
                    <div class="tpl-actions">
                        <button class="touch-pill touch-primary" data-act="save" data-idx="${idx}" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="touch-pill ghost" data-act="dup" data-idx="${idx}" type="button">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="touch-pill danger" data-act="del" data-idx="${idx}" type="button">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;

                M.list.appendChild(wrap);
            });

            // bind actions
            M.list.querySelectorAll('button[data-act]').forEach(btn => {
                btn.onclick = () => {
                    const act = btn.getAttribute('data-act');
                    const i = parseInt(btn.getAttribute('data-idx')||'0');
                    if(Number.isNaN(i) || !DB.touchTemplates[i]) return;

                    if(act === 'save'){
                        const l = (el(`tpl-label-${i}`)?.value || '').trim();
                        const b = (el(`tpl-body-${i}`)?.value || '').trim();
                        if(!l || !b){ Touch.toast('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã'); return; }
                        DB.touchTemplates[i].label = l.slice(0,60);
                        DB.touchTemplates[i].body = b;
                        Storage.save();
                        Touch.render();
                        Touch.toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
                        return;
                    }
                    if(act === 'dup'){
                        const base = DB.touchTemplates[i];
                        const copy = { id: Touch.newId(), label: (base.label + ' (–∫–æ–ø–∏—è)').slice(0,60), body: base.body };
                        DB.touchTemplates.splice(i+1, 0, copy);
                        Storage.save();
                        Touch.renderTplEditor();
                        Touch.render();
                        Touch.toast('–°–¥–µ–ª–∞–Ω–æ');
                        return;
                    }
                    if(act === 'del'){
                        if(DB.touchTemplates.length <= 1){ Touch.toast('–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã 1 —à–∞–±–ª–æ–Ω'); return; }
                        if(!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) return;
                        const removed = DB.touchTemplates.splice(i,1)[0];
                        if(DB.touchActiveTemplate === removed.id){
                            DB.touchActiveTemplate = DB.touchTemplates[0].id;
                            Touch.activeTemplate = DB.touchActiveTemplate;
                        }
                        Storage.save();
                        Touch.renderTplEditor();
                        Touch.render();
                        Touch.refresh(true);
                        Touch.toast('–£–¥–∞–ª–µ–Ω–æ');
                        return;
                    }
                };
            });
        },

        exportTemplates: async () => {
            Touch.ensureTemplates();
            const payload = JSON.stringify(DB.touchTemplates, null, 2);
            const ok = await copyTextToClipboard(payload);
            Touch.toast(ok ? '–≠–∫—Å–ø–æ—Ä—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω' : '–ù–µ —É–¥–∞–ª–æ—Å—å');
        },

        importTemplates: () => {
            const raw = prompt('–í—Å—Ç–∞–≤—å JSON (–º–∞—Å—Å–∏–≤ —à–∞–±–ª–æ–Ω–æ–≤). –ü—Ä–∏–º–µ—Ä: [{ "label":"...", "body":"..." }]');
            if(!raw) return;
            try{
                const parsed = JSON.parse(raw);
                if(!Array.isArray(parsed)) throw new Error('not array');
                const cleaned = parsed.map(t => ({
                    id: (t && t.id) ? String(t.id) : Touch.newId(),
                    label: (t && t.label) ? String(t.label).slice(0,60) : '',
                    body: (t && (t.body || t.text)) ? String(t.body || t.text) : ''
                })).filter(t => t.label.trim() && t.body.trim());
                if(cleaned.length === 0) { Touch.toast('–ü—É—Å—Ç–æ'); return; }
                DB.touchTemplates = cleaned;
                DB.touchActiveTemplate = DB.touchTemplates[0].id;
                Touch.activeTemplate = DB.touchActiveTemplate;
                Storage.save();
                Touch.renderTplEditor();
                Touch.render();
                Touch.refresh(true);
                Touch.toast('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
            }catch(e){
                Touch.toast('JSON –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω');
            }
        },

        varsHelpText: () => (
`–ü–æ–ª—è –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ (–∫–æ–ø–∏—Ä—É–π/–≤—Å—Ç–∞–≤–ª—è–π):
{{performer}}
{{clientName}}
{{whenLine}}
{{typeLine}}
{{priceLine}}
{{priceFaqLine}}
{{depositPercent}}
{{portfolioLine}}
{{reviewsLine}}
{{notes}}`
        ),

        act: async (kind) => {
            const E = Touch.els();

            if(kind === 'manage'){ Touch.openTplModal(); return; }
            if(kind === 'vars'){
                const ok = await copyTextToClipboard(Touch.varsHelpText());
                Touch.toast(ok ? '–ü–æ–ª—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã' : '–ù–µ —É–¥–∞–ª–æ—Å—å');
                return;
            }

            const message = (E.msg?.value || Touch.buildMessage()).trim();

            if(kind === 'copy'){
                const ok = await copyTextToClipboard(message);
                Touch.toast(ok ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å');
                return;
            }
            if(kind === 'share'){
                const ok = await Touch.shareText(message);
                if(!ok){
                    const ok2 = await copyTextToClipboard(message);
                    Touch.toast(ok2 ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å');
                }
                return;
            }
            if(kind === 'gen'){
                Touch.auto = true;
                Touch.refresh(true);
                Touch.toast('–ì–æ—Ç–æ–≤–æ');
                return;
            }
        },

        bind: () => {
            const E = Touch.els();
            E.btnCopy && (E.btnCopy.onclick = () => Touch.act('copy'));
            E.btnShare && (E.btnShare.onclick = () => Touch.act('share'));
            E.btnGen && (E.btnGen.onclick = () => Touch.act('gen'));
            E.btnManage && (E.btnManage.onclick = () => Touch.act('manage'));
            E.btnVars && (E.btnVars.onclick = () => Touch.act('vars'));

            const M = Touch.tplEls();
            M.close && (M.close.onclick = () => Touch.closeTplModal());
            M.add && (M.add.onclick = () => {
                Touch.ensureTemplates();
                DB.touchTemplates.unshift({ id: Touch.newId(), label: '–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω', body: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø {{performer}}.' });
                DB.touchActiveTemplate = DB.touchTemplates[0].id;
                Touch.activeTemplate = DB.touchActiveTemplate;
                Storage.save();
                Touch.renderTplEditor();
                Touch.render();
                Touch.refresh(true);
                Touch.toast('–î–æ–±–∞–≤–ª–µ–Ω–æ');
            });
            M.exportBtn && (M.exportBtn.onclick = () => Touch.exportTemplates());
            M.importBtn && (M.importBtn.onclick = () => Touch.importTemplates());

            // tap backdrop to close (like sheet)
            if(M.modal){
                M.modal.addEventListener('click', (e) => {
                    if(e.target === M.modal) Touch.closeTplModal();
                });
            }
        },

        init: () => {
            Touch.ensureCfg();
            Touch.ensureTemplates();
            Touch.render();
            Touch.bind();
        },

        prepareFromModal: () => {
            Touch.ensureCfg();
            Touch.ensureTemplates();
            Touch.render();
            Touch.refresh(true);
        }
    };


    // --- SALES HUB (smart follow-up scripts based on editable templates) ---
    const Sales = {
        currentId: null,
        showAll: false,

        isSalesTpl: (t) => {
            const l = (t?.label || '').toLowerCase();
            return (l.includes('–ø—Ä–æ–¥–∞–∂') || l.includes('–≤–æ–∑—Ä–∞–∂') || l.includes('—Ñ–∏–Ω–∞–ª'));
        },

        sanitizePlain: (s='') => String(s||'')
            .replace(/\u00A0/g,' ')
            .replace(/[*_`]/g,'')
            .replace(/[ \t]+\n/g, '\n')
            .replace(/\n{3,}/g, '\n\n')
            .trim(),

        getCtx: () => {
            // Context from Calculator (KP) screen
            const performer = (el('cfg-magician')?.value || '').trim() || '–§–æ–∫—É—Å–Ω–∏–∫';
            const depositPercent = parseInt(el('cfg-deposit')?.value || '30') || 30;

            const client = (el('inp-client')?.value || '').trim();
            const clientHi = client ? `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${client}!` : '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!';
            const date = el('inp-date')?.value || '';
            const city = (el('disp-city')?.innerText || el('inp-city')?.value || '').trim();
            const type = (el('inp-event-type')?.value || '').trim();

            let total = 0;
            try {
                total = (State && State.final && typeof State.final.total === 'number') ? State.final.total : 0;
            } catch(_) {}
            if(!total){
                const t = (el('total-sum')?.innerText || '').replace(/[^\d]/g,'');
                total = parseInt(t || '0') || 0;
            }

            const deposit = Math.round(total * (depositPercent/100));
            const depositLine = deposit ? fmt(deposit) : '';

            // Payments block (from Settings)
            let paymentsBlock = '';
            if(Array.isArray(DB.payments) && DB.payments.length > 0){
                const lines = [];
                lines.push('üì≤ –†–µ–∫–≤–∏–∑–∏—Ç—ã:');
                DB.payments.forEach((p) => {
                    const title = String(p?.title ?? '').trim();
                    const text = String(p?.text ?? '').trim();
                    if(!title && !text) return;
                    if(title) lines.push(`${title}:`);
                    if(text){
                        text.split('\n').forEach(line => {
                            const ln = String(line ?? '').trim();
                            if(ln) lines.push(ln);
                        });
                    }
                });
                paymentsBlock = lines.join('\n');
            }

            return {
                performer,
                clientName: client || '–ö–ª–∏–µ–Ω—Ç',
                clientHi,
                date,
                city,
                type,
                total,
                depositPercent,
                deposit,
                depositLine,
                paymentsBlock
            };
        },

        open: () => {
            const modal = el('sales-modal');
            if(!modal) return;

            Touch.ensureTemplates();

            Sales.showAll = false;
            Sales.currentId = null;

            modal.classList.add('active');
            if(window.__iosFix) window.__iosFix.lockBody();
            if(window.__iosFix) window.__iosFix.setHeights();

            Sales.render();

            // focus search (helps on iPhone)
            setTimeout(() => { try{ el('sales-search')?.focus(); }catch(_){} }, 80);
        },

        close: () => {
            const modal = el('sales-modal');
            if(!modal) return;
            modal.classList.remove('active');

            if(window.__iosFix) window.__iosFix.unlockBody();
            if(window.__iosFix && window.__iosFix.onModalClose) window.__iosFix.onModalClose();
            if(window.__iosFix) window.__iosFix.setHeights();
        },

        select: (id) => {
            Sales.currentId = id;
            Sales.renderPreview();
            Sales.renderListActive();
        },

        renderListActive: () => {
            const list = el('sales-list');
            if(!list) return;
            list.querySelectorAll('.sales-item').forEach(node => {
                const id = node.getAttribute('data-id');
                node.classList.toggle('active', id === Sales.currentId);
            });
        },

        renderPreview: () => {
            const preview = el('sales-preview');
            if(!preview) return;

            const tpl = Touch.templates().find(t => t.id === Sales.currentId) || null;
            if(!tpl){ preview.value = ''; return; }

            const ctx = Sales.getCtx();
            const msg = Touch.applyTokens(tpl.body || '', ctx);
            preview.value = msg;
        },

        render: () => {
            Sales.bindOnce();

            const q = (el('sales-search')?.value || '').trim().toLowerCase();
            const all = Touch.templates();
            const pool = Sales.showAll ? all : all.filter(Sales.isSalesTpl);

            const list = pool.filter(t => {
                if(!q) return true;
                const l = (t.label || '').toLowerCase();
                const b = (t.body || '').toLowerCase();
                return l.includes(q) || b.includes(q);
            });

            const listEl = el('sales-list');
            if(listEl){
                listEl.innerHTML = '';
                if(list.length === 0){
                    listEl.innerHTML = `<div class="tpl-sub">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤–∫–ª—é—á–∏ ‚Äú–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ‚Äù.</div>`;
                } else {
                    list.forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'sales-item' + (t.id === Sales.currentId ? ' active' : '');
                        div.setAttribute('data-id', t.id);
                        div.innerHTML = `
                            <div class="title">${Touch.esc(t.label)}</div>
                            <div class="hint">–¢–∞–ø ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {{clientName}}, {{date}}, {{city}}, {{depositPercent}}‚Ä¶</div>
                        `;
                        div.onclick = () => Sales.select(t.id);
                        listEl.appendChild(div);
                    });
                }
            }

            // Default selection (first item)
            if(!Sales.currentId){
                const first = list[0];
                if(first) Sales.currentId = first.id;
            }
            Sales.renderPreview();
            Sales.renderListActive();
        },

        copy: async () => {
            const preview = el('sales-preview');
            const text = (preview?.value || '').trim();
            if(!text){ Touch.toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å–∫—Ä–∏–ø—Ç'); return; }
            const ok = await copyTextToClipboard(text);
            Touch.toast(ok ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        },

        applyToClipboardPlain: async () => {
            const preview = el('sales-preview');
            const clean = Sales.sanitizePlain(preview?.value || '');
            if(!clean){ Touch.toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å–∫—Ä–∏–ø—Ç'); return; }
            const ok = await copyTextToClipboard(clean);
            Touch.toast(ok ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ (—á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç)' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
        },

        _bound: false,
        bindOnce: () => {
            if(Sales._bound) return;
            Sales._bound = true;

            const search = el('sales-search');
            if(search){
                search.addEventListener('input', () => Sales.render());
            }

            // Long-press on title toggles "show all" (no extra UI clutter)
            const title = document.querySelector('#sales-modal .modal-title');
            if(title){
                let t0 = 0;
                title.addEventListener('touchstart', ()=>{ t0 = Date.now(); }, {passive:true});
                title.addEventListener('touchend', ()=>{
                    const dt = Date.now()-t0;
                    if(dt > 420){
                        Sales.showAll = !Sales.showAll;
                        Touch.toast(Sales.showAll ? '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ: –í–ö–õ' : '–¢–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–∂–∏: –í–ö–õ');
                        Sales.render();
                    }
                }, {passive:true});
            }
        }
    };

    // --- Make objects available to inline onclick/onchange handlers (iOS/Safari-safe) ---
    try {
        window.switchTab = switchTab;
        window.App = App;
        window.Storage = Storage;
        window.History = History;
        window.Admin = Admin;
        window.Calendar = Calendar;
        if (typeof Touch !== 'undefined') window.Touch = Touch;
        if (typeof HolidayCfg !== 'undefined') window.HolidayCfg = HolidayCfg;
    } catch(e) {
        // If something is missing, avoid breaking app startup.
        console.warn('Expose globals failed', e);
    }

Storage.load();

// --- iOS PWA (Add to Home Screen) —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å: viewport, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, –ø—Ä—ã–∂–∫–∏ —Ñ–æ—Ä–º (v24) ---
    
    // --- App viewport + keyboard fix (v30, stable) ---
    (function(){
        const root = document.documentElement;
        const scroller = document.getElementById('app-scroll');

        function setViewportVars(){
            const vv = window.visualViewport;
            const h = vv ? vv.height : window.innerHeight;
            const top = vv ? vv.offsetTop : 0;

            root.style.setProperty('--vv-height', Math.round(h) + 'px');
            root.style.setProperty('--vv-top', Math.round(top) + 'px');

            const kb = vv ? Math.max(0, Math.round(window.innerHeight - vv.height - vv.offsetTop)) : 0;
            root.style.setProperty('--kb', kb + 'px');
            document.body.classList.toggle('kb-open', kb > 40);
        }

        function getScrollerFor(el){
            const modal = el && el.closest ? el.closest('.modal.active') : null;
            if(modal){
                return el.closest('.modal-scroll') || modal.querySelector('.modal-scroll') || modal;
            }
            return scroller || document.body;
        }

        function ensureVisible(el){
            if(!el) return;
            const s = getScrollerFor(el);
            if(!s || !s.getBoundingClientRect) return;

            const pad = 14;
            const vv = window.visualViewport;
            const vvTop = vv ? vv.offsetTop : 0;
            const vvH = vv ? vv.height : window.innerHeight;
            const vvBottom = vvTop + vvH;

            const sRect = s.getBoundingClientRect();
            const eRect = el.getBoundingClientRect();

            const visibleTop = Math.max(sRect.top + pad, vvTop + pad);
            const visibleBottom = Math.min(sRect.bottom - pad, vvBottom - pad);

            if(eRect.bottom > visibleBottom){
                s.scrollTop += (eRect.bottom - visibleBottom);
            } else if(eRect.top < visibleTop){
                s.scrollTop -= (visibleTop - eRect.top);
            }
        }

        setViewportVars();

        const vv = window.visualViewport;
        if(vv){
            vv.addEventListener('resize', setViewportVars, {passive:true});
            vv.addEventListener('scroll', setViewportVars, {passive:true});
        }
        window.addEventListener('resize', setViewportVars, {passive:true});
        window.addEventListener('orientationchange', () => setTimeout(setViewportVars, 250), {passive:true});

        let raf = 0;
        document.addEventListener('focusin', (e) => {
            const t = e.target;
            if(!t) return;
            const tag = (t.tagName || '').toUpperCase();
            if(tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') return;

            cancelAnimationFrame(raf);
            raf = requestAnimationFrame(() => { setViewportVars(); ensureVisible(t); });
            setTimeout(() => { setViewportVars(); ensureVisible(t); }, 140);
        }, true);
    })();

;



    // --- Manifest (Android/desktop) via Blob (single-folder friendly) ---
    (function(){
        try{
            const manifest = {
                name: "Productive Magic",
                short_name: "Productive Magic",
                start_url: ".",
                scope: ".",
                display: "standalone",
                background_color: "#0b0c10",
                theme_color: "#0b0c10",
                icons: [
                    { src: "icon-192-pm.png", sizes: "192x192", type: "image/png" },
                    { src: "icon-512-pm.png", sizes: "512x512", type: "image/png" }
                ]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
            const url = URL.createObjectURL(blob);
            let link = document.querySelector('link[rel="manifest"]');
            if(!link){
                link = document.createElement('link');
                link.rel = 'manifest';
                document.head.appendChild(link);
            }
            link.href = url;
        }catch(_){}
    })();

</script>
</body>
</html>
