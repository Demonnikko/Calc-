<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Illusionist OS — Умный калькулятор</title>

  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Illusionist OS" />
  <meta name="theme-color" content="#050507" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Styles -->
  <style>
/* === Inlined from styles.css === */
/* ============================================
   ILLUSIONIST OS - STYLES (УЛУЧШЕННАЯ ВЕРСИЯ)
   ============================================ */

:root {
  /* Colors - улучшенная контрастность */
  --bg: #050507;
  --panel: rgba(255,255,255,.10);      /* было .06 */
  --panel2: rgba(255,255,255,.12);     /* было .08 */
  --stroke: rgba(255,255,255,.15);     /* было .08 */
  --gold: #f59e0b;
  --muted: #94a3b8;
  --text: #e5e7eb;

  /* Safe-area */
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
  --safe-left: env(safe-area-inset-left);
  --safe-right: env(safe-area-inset-right);
}

/* ============================================
   BASE
   ============================================ */
html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden !important;
  max-width: 100vw !important;
  height: -webkit-fill-available;
  scroll-behavior: smooth;
  font-size: 16px; /* было 14px */
}

*, *::before, *::after {
  box-sizing: border-box;
}

body {
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  overflow-x: hidden;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
  padding-left: var(--safe-left);
  padding-right: var(--safe-right);
  overscroll-behavior: none;
}

/* ============================================
   FONTS
   ============================================ */
.font-cinzel { font-family: Cinzel, serif; }
.mono { font-family: "JetBrains Mono", ui-monospace, monospace; }

/* ============================================
   GLASS EFFECT
   ============================================ */
.glass {
  background: var(--panel);
  border: 1px solid var(--stroke);
  backdrop-filter: blur(16px); /* было 12px */
  -webkit-backdrop-filter: blur(16px);
}

/* ============================================
   HEADER
   ============================================ */
header {
  padding: 16px 20px; /* увеличено */
  padding-top: calc(16px + env(safe-area-inset-top)) !important;
  padding-left: max(20px, env(safe-area-inset-left)) !important;
  padding-right: max(20px, env(safe-area-inset-right)) !important;
}

/* ============================================
   MAIN
   ============================================ */
main {
  padding-left: max(16px, env(safe-area-inset-left)) !important;
  padding-right: max(16px, env(safe-area-inset-right)) !important;
  overflow-x: hidden !important;
}

/* ============================================
   ФОРМА: INPUTS & SELECTS
   ============================================ */
.form-input {
  width: 100%;
  background: rgba(255,255,255,.08); /* было .06 */
  border: 1.5px solid rgba(255,255,255,.12); /* было 1px .10 */
  border-radius: 14px; /* было 10px */
  padding: 14px 16px; /* было 8px 10px */
  font-size: 15px; /* было 12px */
  color: #e2e8f0;
  outline: none;
  transition: all 0.2s;
  min-height: 50px; /* добавлено для удобства тапа */
  -webkit-appearance: none;
  appearance: none;
}

.form-input:focus {
  border-color: rgba(245,158,11,.4);
  box-shadow: 0 0 0 4px rgba(245,158,11,.12);
  background: rgba(255,255,255,.10);
}

.form-input:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.form-input::placeholder {
  color: #64748b;
}

/* Mobile: prevent zoom on focus */
@media (max-width: 768px) {
  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="time"],
  select,
  textarea {
    font-size: 16px !important; /* iOS не зумит при >= 16px */
  }
}

/* ============================================
   BUTTONS
   ============================================ */
button {
  -webkit-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  cursor: pointer;
  transition: all 0.2s;
}

/* Золотая кнопка */
.btn-gold {
  width: 100%;
  border-radius: 16px;
  padding: 14px 18px; /* было 12px 14px */
  font-size: 15px; /* было 13px */
  font-weight: 800;
  letter-spacing: 0.02em;
  background: linear-gradient(135deg, rgba(245,158,11,.95), rgba(245,158,11,.75));
  color: #120a00;
  border: 1.5px solid rgba(245,158,11,.4);
  box-shadow: 0 12px 30px rgba(245,158,11,.2);
  min-height: 52px; /* для удобства тапа */
}

.btn-gold:hover {
  filter: brightness(1.05);
  transform: translateY(-1px);
  box-shadow: 0 16px 35px rgba(245,158,11,.25);
}

.btn-gold:active {
  transform: translateY(0);
}

/* Вторичная кнопка */
.btn-secondary {
  width: 100%;
  border-radius: 16px;
  padding: 14px 18px;
  font-size: 14px;
  font-weight: 700;
  background: rgba(255,255,255,.08);
  color: #e2e8f0;
  border: 1.5px solid rgba(255,255,255,.12);
  min-height: 52px;
}

.btn-secondary:hover {
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.2);
}

/* Кнопка-иконка */
.btn-icon {
  width: 50px; /* было 44px */
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 16px; /* было 14px */
  background: rgba(255,255,255,.08);
  border: 1.5px solid rgba(255,255,255,.12);
  flex-shrink: 0;
}

.btn-icon:hover {
  background: rgba(255,255,255,.12);
  border-color: rgba(255,255,255,.2);
}

/* Кнопка количества */
.btn-qty {
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 14px;
  background: rgba(255,255,255,.08);
  border: 1.5px solid rgba(255,255,255,.12);
  flex-shrink: 0;
}

.btn-qty:hover {
  background: rgba(255,255,255,.12);
  border-color: rgba(245,158,11,.3);
}

/* Кнопка добавления */
.btn-add {
  background: rgba(245,158,11,.12);
  border: 1.5px solid rgba(245,158,11,.25);
  color: rgba(245,158,11,.95);
  border-radius: 14px;
  padding: 12px 16px; /* было 7px 10px */
  font-size: 13px; /* было 11px */
  font-weight: 700;
  letter-spacing: 0.02em;
  min-height: 48px;
}

.btn-add:hover {
  background: rgba(245,158,11,.18);
  border-color: rgba(245,158,11,.35);
}

/* Кнопка удаления (мини) */
.btn-del-mini {
  background: rgba(239,68,68,.12);
  border: 1.5px solid rgba(239,68,68,.22);
  color: rgba(239,68,68,.95);
  border-radius: 12px;
  width: 44px; /* было 34px */
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.btn-del-mini:hover {
  background: rgba(239,68,68,.2);
  border-color: rgba(239,68,68,.35);
}

/* Кнопки управления данными */
.btn-data {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 16px; /* было 10px 14px */
  border-radius: 14px;
  font-size: 13px; /* было 11px */
  font-weight: 700;
  transition: all 0.2s;
  min-height: 48px;
}

.btn-export {
  background: rgba(34, 197, 94, 0.12);
  border: 1.5px solid rgba(34, 197, 94, 0.25);
  color: rgba(34, 197, 94, 0.95);
}
.btn-export:hover { background: rgba(34, 197, 94, 0.18); }

.btn-import {
  background: rgba(59, 130, 246, 0.12);
  border: 1.5px solid rgba(59, 130, 246, 0.25);
  color: rgba(59, 130, 246, 0.95);
}
.btn-import:hover { background: rgba(59, 130, 246, 0.18); }

.btn-backup {
  background: rgba(168, 85, 247, 0.12);
  border: 1.5px solid rgba(168, 85, 247, 0.25);
  color: rgba(168, 85, 247, 0.95);
}
.btn-backup:hover { background: rgba(168, 85, 247, 0.18); }

/* ============================================
   SPLASH
   ============================================ */
#splash {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
  background: radial-gradient(800px 600px at 30% 20%, rgba(245,158,11,.12), transparent 60%),
              radial-gradient(700px 500px at 70% 80%, rgba(99,102,241,.12), transparent 60%),
              var(--bg);
  z-index: 50;
  transition: opacity .65s ease, transform .65s ease;
}

#splash.hide {
  opacity: 0;
  transform: translateY(-8px);
  pointer-events: none;
}

/* ============================================
   TOAST
   ============================================ */
#toast {
  position: fixed;
  top: calc(20px + env(safe-area-inset-top));
  left: 20px;
  right: 20px;
  z-index: 60;
  opacity: 0;
  transform: translateY(-12px);
  transition: opacity .3s ease, transform .3s ease;
  pointer-events: none;
}

#toast.show {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

@media (min-width: 640px) {
  #toast {
    left: 50%;
    right: auto;
    width: 450px;
    max-width: calc(100vw - 40px);
    transform: translateX(-50%) translateY(-12px);
  }
  #toast.show {
    transform: translateX(-50%) translateY(0);
  }
}

/* ============================================
   MODALS
   ============================================ */
#view-settings,
#templates-modal,
#variants-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  display: none;
  z-index: 40;
  overflow: hidden;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

#view-settings.active,
#templates-modal.active,
#variants-modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Settings panel */
#view-settings .panel {
  position: fixed !important;
  left: 0 !important;
  right: 0 !important;
  top: env(safe-area-inset-top) !important;
  bottom: env(safe-area-inset-bottom) !important;
  transform: none !important;
  width: 100% !important;
  max-width: 100% !important;
  max-height: none !important;
  margin: 0 !important;
  border-radius: 0 !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  -webkit-overflow-scrolling: touch;
}

@media (min-width: 768px) {
  #view-settings .panel {
    position: absolute !important;
    left: 50% !important;
    top: 50% !important;
    right: auto !important;
    bottom: auto !important;
    transform: translate(-50%, -50%) !important;
    width: min(920px, calc(100% - 48px)) !important;
    max-width: min(920px, calc(100% - 48px)) !important;
    max-height: calc(100vh - 48px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
    border-radius: 24px !important;
  }
}

/* Templates & Variants modals */
.modal-content,
.variants-modal-content {
  background: #0a0a0c;
  border: 1.5px solid rgba(255, 255, 255, 0.15);
  border-radius: 24px;
  width: min(480px, calc(100% - 40px));
  max-height: calc(100vh - 80px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.variants-modal-content {
  width: min(580px, calc(100% - 40px));
}

#variants-modal {
  align-items: flex-start !important;
  padding-top: max(24px, env(safe-area-inset-top)) !important;
}

/* ============================================
   ADMIN SECTIONS
   ============================================ */
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  user-select: none;
  gap: 12px;
  padding: 8px 0;
}

.admin-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height .35s ease;
  padding-top: 0;
}

.admin-content.open {
  max-height: 1800px;
  padding-top: 12px;
}

/* ============================================
   EDIT ROWS
   ============================================ */
.edit-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  flex-wrap: wrap;
}

.edit-input {
  background: rgba(255,255,255,.08);
  border: 1.5px solid rgba(255,255,255,.12);
  border-radius: 12px;
  padding: 10px 12px; /* было 8px 10px */
  font-size: 14px; /* было 12px */
  color: #e2e8f0;
  outline: none;
  min-height: 44px;
  flex: 1;
  min-width: 0;
}

.edit-input:focus {
  border-color: rgba(245,158,11,.4);
  box-shadow: 0 0 0 3px rgba(245,158,11,.12);
}

/* ============================================
   BACKUP SLOTS
   ============================================ */
.backup-slot {
  background: rgba(255,255,255,0.05);
  border: 1.5px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 12px; /* было 10px 12px */
  cursor: pointer;
  transition: all 0.2s;
  min-height: 68px; /* было 56px */
}

.backup-slot:hover {
  background: rgba(255,255,255,0.08);
  border-color: rgba(245,158,11,0.35);
  transform: translateY(-1px);
}

.backup-slot.empty {
  opacity: 0.3;
  cursor: default;
}

.backup-slot.empty:hover {
  background: rgba(255,255,255,0.05);
  border-color: rgba(255,255,255,0.1);
  transform: none;
}

.backup-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--muted);
}

.backup-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #22c55e;
  animation: pulse 2s infinite;
}

.backup-dot.warning { background: #f59e0b; }
.backup-dot.error { background: #ef4444; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ============================================
   CART ITEMS
   ============================================ */
#cart-list > div {
  background: rgba(255,255,255,0.06);
  border: 1.5px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 14px 16px; /* было меньше */
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  transition: all 0.2s;
}

#cart-list > div:hover {
  background: rgba(255,255,255,0.08);
  border-color: rgba(255,255,255,0.12);
}

/* ============================================
   TEMPLATES
   ============================================ */
.template-card {
  background: rgba(245, 158, 11, 0.08);
  border: 1.5px solid rgba(245, 158, 11, 0.18);
  border-radius: 16px;
  padding: 14px 16px; /* было 10px 12px */
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
  min-height: 90px;
}

.template-card:hover {
  background: rgba(245, 158, 11, 0.14);
  border-color: rgba(245, 158, 11, 0.35);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(245, 158, 11, 0.15);
}

.template-card .template-name {
  font-size: 13px; /* было 11px */
  font-weight: 700;
  color: #f59e0b;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.template-card .template-info {
  font-size: 11px; /* было 9px */
  color: #64748b;
}

.template-card .template-price {
  font-size: 12px; /* было 10px */
  font-weight: 800;
  color: #e2e8f0;
  font-family: "JetBrains Mono", monospace;
  margin-top: 6px;
}

.template-card .template-delete {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: rgba(239, 68, 68, 0.15);
  color: rgba(239, 68, 68, 0.8);
  opacity: 0;
  transition: all 0.2s;
}

.template-card:hover .template-delete {
  opacity: 1;
}

.template-card .template-delete:hover {
  background: rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

/* ============================================
   ROUNDING BUTTONS
   ============================================ */
.rounding-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px; /* было 4px 8px */
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1.5px solid rgba(255, 255, 255, 0.1);
  color: #94a3b8;
  font-size: 12px; /* было 10px */
  font-weight: 600;
  font-family: "JetBrains Mono", monospace;
  transition: all 0.2s;
  min-height: 42px;
}

.rounding-btn:hover {
  background: rgba(245, 158, 11, 0.12);
  border-color: rgba(245, 158, 11, 0.3);
  color: #f59e0b;
  transform: translateY(-1px);
}

.rounding-btn-main {
  background: rgba(245, 158, 11, 0.1);
  border-color: rgba(245, 158, 11, 0.25);
  color: #f59e0b;
  font-weight: 700;
}

.rounding-btn-main:hover {
  background: rgba(245, 158, 11, 0.18);
}

.rounding-btn-reset {
  width: 32px;
  height: 32px;
  padding: 0;
  border-radius: 8px;
  background: rgba(239, 68, 68, 0.12);
  border: 1.5px solid rgba(239, 68, 68, 0.22);
  color: rgba(239, 68, 68, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.rounding-btn-reset:hover {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

/* ============================================
   VARIANTS
   ============================================ */
.variant-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1.5px solid rgba(255, 255, 255, 0.1);
  border-radius: 18px;
  padding: 18px 20px; /* было 14px 16px */
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  min-height: 140px;
}

.variant-card:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(245, 158, 11, 0.35);
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
}

.variant-card.variant-base {
  border-color: rgba(100, 116, 139, 0.35);
}
.variant-card.variant-base:hover {
  border-color: rgba(100, 116, 139, 0.5);
}

.variant-card.variant-optimal {
  border-color: rgba(245, 158, 11, 0.35);
  background: rgba(245, 158, 11, 0.06);
}
.variant-card.variant-optimal:hover {
  border-color: rgba(245, 158, 11, 0.5);
  background: rgba(245, 158, 11, 0.12);
}

.variant-card.variant-premium {
  border-color: rgba(168, 85, 247, 0.35);
  background: rgba(168, 85, 247, 0.06);
}
.variant-card.variant-premium:hover {
  border-color: rgba(168, 85, 247, 0.5);
  background: rgba(168, 85, 247, 0.12);
}

.variant-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.variant-badge {
  font-size: 10px; /* было 9px */
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 5px 10px;
  border-radius: 8px;
}

.variant-badge.badge-base {
  background: rgba(100, 116, 139, 0.25);
  color: #94a3b8;
}

.variant-badge.badge-optimal {
  background: rgba(245, 158, 11, 0.25);
  color: #f59e0b;
}

.variant-badge.badge-premium {
  background: rgba(168, 85, 247, 0.25);
  color: #a855f7;
}

.variant-price {
  font-size: 22px; /* было 18px */
  font-weight: 800;
  font-family: "JetBrains Mono", monospace;
}

.variant-price.price-base { color: #94a3b8; }
.variant-price.price-optimal { color: #f59e0b; }
.variant-price.price-premium { color: #a855f7; }

.variant-items {
  font-size: 13px; /* было 11px */
  color: #94a3b8;
  line-height: 1.6;
}

.variant-items li {
  padding: 4px 0;
  padding-left: 16px;
  position: relative;
}

.variant-items li::before {
  content: "•";
  position: absolute;
  left: 0;
  color: #64748b;
}

.variant-bonuses {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.variant-bonus-tag {
  display: inline-block;
  font-size: 10px;
  font-weight: 700;
  background: rgba(34, 197, 94, 0.18);
  color: #22c55e;
  padding: 4px 8px;
  border-radius: 6px;
  margin-right: 6px;
  margin-bottom: 6px;
}

.variant-copy-hint {
  position: absolute;
  top: 50%;
  right: 20px;
  transform: translateY(-50%);
  opacity: 0;
  transition: opacity 0.2s;
  color: #64748b;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.variant-card:hover .variant-copy-hint {
  opacity: 1;
}

.variant-recommended {
  position: absolute;
  top: -10px;
  right: 16px;
  font-size: 9px;
  font-weight: 800;
  text-transform: uppercase;
  background: linear-gradient(135deg, #f59e0b, #f97316);
  color: #000;
  padding: 4px 10px;
  border-radius: 6px;
  letter-spacing: 0.06em;
}

/* ============================================
   ANIMATIONS
   ============================================ */
.animate-enter {
  animation: enter .25s ease both;
}

@keyframes enter {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: none;
  }
}

.round-pulse {
  animation: roundPulse 0.3s ease;
}

@keyframes roundPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.error-input {
  border-color: #ef4444 !important;
  animation: shake 0.3s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* ============================================
   BACKGROUND CANVAS
   ============================================ */
#bg-canvas {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  opacity: 0.6;
}

/* ============================================
   UTILITIES
   ============================================ */
#import-file-input {
  display: none;
}

.hidden {
  display: none !important;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
  .lg\:grid-cols-2 {
    grid-template-columns: 1fr !important;
  }
  
  .lg\:col-span-2 {
    grid-column: span 1 !important;
  }
}

@media (max-width: 640px) {
  .grid-cols-2.md\:grid-cols-4 {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  .grid-cols-5 {
    grid-template-columns: repeat(3, 1fr) !important;
  }
}

@media (max-width: 480px) {
  /* Уменьшение отступов на очень маленьких экранах */
  .glass.rounded-3xl {
    border-radius: 24px !important;
    padding: 20px !important;
  }
  
  header {
    padding: 12px 16px !important;
  }
  
  .btn-gold,
  .btn-secondary {
    padding: 12px 16px !important;
    font-size: 14px !important;
  }
  
  .edit-row {
    flex-wrap: wrap !important;
    gap: 8px !important;
  }
  
  .backup-slot {
    padding: 8px !important;
    min-height: 56px !important;
  }
}

@media (max-width: 380px) {
  header .font-cinzel {
    font-size: 16px !important;
  }
  
  .backup-status {
    display: none !important;
  }
}

</style>
</head>

<body class="min-h-screen">
  <input type="file" id="import-file-input" accept=".json,.backup" />
  <canvas id="bg-canvas"></canvas>

  <!-- ========== SPLASH ========== -->
  <div id="splash">
    <div class="text-center px-6">
      <div class="mx-auto mb-6 w-20 h-20 rounded-3xl flex items-center justify-center glass">
        <i data-lucide="sparkles" class="w-10 h-10 text-amber-400"></i>
      </div>
      <div class="font-cinzel text-3xl tracking-wide text-white mb-3">Illusionist OS</div>
      <div class="text-lg text-slate-300 font-semibold">Умный калькулятор</div>
      <div class="mt-8 text-sm text-slate-400">Нажми, чтобы пропустить</div>
    </div>
  </div>

  <!-- ========== TOAST ========== -->
  <div id="toast">
    <div class="glass rounded-2xl px-5 py-4 shadow-xl">
      <div class="flex items-center gap-3">
        <i data-lucide="bell" class="w-5 h-5 text-amber-400"></i>
        <div id="toast-msg" class="text-base text-slate-200 font-semibold"></div>
      </div>
    </div>
  </div>

  <!-- ========== HEADER ========== -->
  <header class="relative z-10">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl glass flex items-center justify-center">
          <i data-lucide="wand-2" class="w-6 h-6 text-amber-400"></i>
        </div>
        <div>
          <div class="font-cinzel text-white tracking-wide text-lg">Illusionist OS</div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-slate-400 font-semibold">Умный калькулятор</span>
            <div id="backup-indicator" class="backup-status">
              <span class="backup-dot"></span>
              <span id="backup-status-text">Сохранено</span>
            </div>
          </div>
        </div>
      </div>

      <button id="btn-settings" class="btn-icon" aria-label="Настройки">
        <i data-lucide="settings" class="w-6 h-6 text-slate-200"></i>
      </button>
    </div>
  </header>

  <!-- ========== MAIN ========== -->
  <main class="relative z-10 px-4 pb-10">
    <div class="max-w-5xl mx-auto mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- ========== LEFT PANEL ========== -->
      <section class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="text-base font-extrabold text-white tracking-wide">Данные</div>
          <div id="holiday-alert" class="hidden text-xs font-extrabold text-amber-400 bg-amber-500/10 border border-amber-500/20 px-4 py-2 rounded-full">
            Праздник: x<span id="holiday-k">1</span>
          </div>
        </div>

        <!-- Date & Time -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Дата</label>
            <input type="date" id="inp-date" class="form-input" />
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Время</label>
            <input type="time" id="inp-time" class="form-input" value="18:00" />
          </div>
        </div>

        <!-- Client -->
        <div class="mb-4">
          <label class="text-sm text-slate-400 font-bold mb-2 block">Клиент</label>
          <input id="inp-client" class="form-input" placeholder="Имя клиента" />
        </div>

        <!-- Event Type -->
        <div class="mb-4">
          <label class="text-sm text-slate-400 font-bold mb-2 block">Тип события</label>
          <select id="inp-event-type" class="form-input">
            <option>Мероприятие</option>
            <option>Микромагия</option>
            <option>Сцена</option>
            <option>Концерт</option>
            <option>Репетиция</option>
            <option>Детское шоу</option>
          </select>
        </div>

        <!-- Region & City -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Регион</label>
            <select id="inp-region" class="form-input"></select>
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Город</label>
            <select id="inp-city" class="form-input" disabled></select>
          </div>
        </div>

        <!-- Category & Service -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Категория</label>
            <select id="inp-cat" class="form-input"></select>
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Услуга</label>
            <select id="inp-svc" class="form-input" disabled></select>
          </div>
        </div>

        <!-- Quantity & Add Button -->
        <div class="flex items-center gap-4 mb-6">
          <div class="flex items-center gap-3">
            <button id="btn-qty-minus" class="btn-qty" aria-label="Минус">
              <i data-lucide="minus" class="w-6 h-6 text-slate-200"></i>
            </button>
            <div class="glass rounded-2xl px-5 py-3 text-base font-extrabold mono min-w-[60px] text-center">
              x<span id="svc-qty">1</span>
            </div>
            <button id="btn-qty-plus" class="btn-qty" aria-label="Плюс">
              <i data-lucide="plus" class="w-6 h-6 text-slate-200"></i>
            </button>
          </div>

          <button id="btn-add-service" class="flex-1 btn-gold">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="plus-circle" class="w-5 h-5"></i>
              Добавить
            </span>
          </button>
        </div>

        <!-- Extras -->
        <div class="border-t border-white/10 pt-6">
          <div class="text-base font-extrabold text-white mb-4">Доплаты</div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-sm text-slate-400 font-bold mb-2 block">Название</label>
              <input id="inp-manual-name" class="form-input" placeholder="Напр. Аренда зала" />
            </div>
            <div>
              <label class="text-sm text-slate-400 font-bold mb-2 block">Сумма</label>
              <input id="inp-manual-price" type="number" class="form-input text-right mono" placeholder="0" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm text-slate-400 font-bold mb-2 block">Гости</label>
              <select id="inp-guests" class="form-input">
                <option value="0">Без доплаты</option>
                <option value="1000">+1 000 ₽</option>
                <option value="2000">+2 000 ₽</option>
                <option value="3000">+3 000 ₽</option>
              </select>
            </div>
            <div class="flex items-end">
              <label class="flex items-center gap-3 text-sm text-slate-300 font-bold select-none px-4 py-3 glass rounded-2xl w-full cursor-pointer hover:bg-white/10 transition">
                <input type="checkbox" id="inp-tax" class="accent-amber-500 w-5 h-5" />
                Договор (+6%)
              </label>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 grid grid-cols-2 gap-3">
          <button id="btn-copy-prices" class="btn-secondary">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="list" class="w-5 h-5"></i>
              <span class="hidden sm:inline">Цены + бонусы</span>
              <span class="sm:hidden">Цены</span>
            </span>
          </button>
          <button id="btn-copy-quote" class="btn-gold">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="copy" class="w-5 h-5"></i>
              <span class="hidden sm:inline">Скопировать КП</span>
              <span class="sm:hidden">КП</span>
            </span>
          </button>
        </div>

        <div class="mt-3">
          <button id="btn-open-variants" class="btn-secondary w-full">
            <span class="flex items-center justify-center gap-2">
              <i data-lucide="layers" class="w-5 h-5"></i>
              3 варианта КП
            </span>
          </button>
        </div>
      </section>

      <!-- ========== RIGHT PANEL ========== -->
      <section class="glass rounded-3xl p-6">
        <!-- Templates -->
        <div class="flex items-center justify-between mb-3">
          <div class="text-base font-extrabold text-white tracking-wide">Шаблоны</div>
          <button id="btn-open-templates-modal" class="text-sm font-bold text-amber-400 hover:text-amber-300 transition">
            Управлять
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3" id="templates-list"></div>
        <div id="templates-empty" class="hidden text-sm text-slate-500 bg-white/5 border border-white/10 rounded-2xl p-4 mb-3">
          Пока нет шаблонов. Собери корзину и нажми "Сохранить".
        </div>

        <button id="btn-save-as-template" class="btn-add hidden w-full mb-4">
          + Сохранить как шаблон
        </button>

        <!-- Cart -->
        <div class="border-t border-white/10 pt-6 mt-6">
          <div class="flex items-center justify-between mb-4">
            <div class="text-base font-extrabold text-white tracking-wide">Корзина</div>
            <div id="discount-badge" class="hidden text-xs font-extrabold text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-4 py-2 rounded-full">
              Скидка 10%
            </div>
          </div>

          <div id="cart-list" class="space-y-3 mb-6"></div>

          <!-- Total -->
          <div class="border-t border-white/10 pt-6">
            <div class="flex items-baseline justify-between mb-4">
              <div class="text-slate-300 font-bold text-base">Итого</div>
              <div id="total-sum" class="text-3xl font-extrabold text-amber-400 mono">0 ₽</div>
            </div>

            <!-- Rounding controls -->
            <div id="rounding-controls" class="hidden mb-6">
              <div class="flex items-center justify-between mb-3">
                <div class="text-sm text-slate-400 font-bold">Округлить</div>
                <div id="rounding-applied" class="hidden text-xs text-slate-400 font-bold flex items-center gap-2">
                  <span>Разница:</span>
                  <span id="rounding-diff" class="text-amber-400 mono">+0 ₽</span>
                  <button id="btn-round-reset" class="rounding-btn-reset hidden" title="Сбросить">
                    <i data-lucide="x" class="w-3 h-3"></i>
                  </button>
                </div>
              </div>

              <div class="flex flex-wrap gap-2">
                <button id="btn-round-down" class="rounding-btn">
                  <i data-lucide="corner-down-left" class="w-4 h-4"></i>
                  <span id="round-down-value">0</span>
                </button>
                <button id="btn-round-nearest" class="rounding-btn rounding-btn-main">
                  <i data-lucide="target" class="w-4 h-4"></i>
                  <span id="round-nearest-value">0</span>
                </button>
                <button id="btn-round-up" class="rounding-btn">
                  <i data-lucide="corner-up-right" class="w-4 h-4"></i>
                  <span id="round-up-value">0</span>
                </button>
              </div>
            </div>

            <!-- Bonuses -->
            <div>
              <div class="text-sm text-slate-400 font-bold mb-3">Бонусы (что получает клиент)</div>
              <div id="bonus-list" class="flex flex-wrap gap-2 mb-4"></div>
            </div>

            <div class="text-sm text-slate-500 leading-relaxed">
              Клиенту важно знать: <span class="text-slate-300 font-bold">сколько</span> и
              <span class="text-slate-300 font-bold">что он получит</span>.
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- ========== SETTINGS MODAL ========== -->
  <div id="view-settings" aria-hidden="true">
    <div class="panel glass p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <div class="font-cinzel text-white text-xl mb-1">Настройки</div>
          <div class="text-sm text-slate-400 font-semibold">Админка базы цен • реквизиты • бонусы</div>
        </div>
        <button id="btn-close-settings" class="btn-icon" aria-label="Закрыть">
          <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
        </button>
      </div>

      <!-- DATA MANAGEMENT -->
      <div class="glass rounded-2xl p-5 mb-6 border-2 border-emerald-500/20">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <i data-lucide="database" class="w-6 h-6 text-emerald-400"></i>
            <span class="text-base font-extrabold text-white">Управление данными</span>
          </div>
          <div class="text-xs text-slate-500 mono" id="db-version-display">v2.0</div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-5">
          <button id="btn-export-data" class="btn-data btn-export">
            <i data-lucide="download" class="w-5 h-5"></i>
            <span>Экспорт</span>
          </button>
          <button id="btn-import-data" class="btn-data btn-import">
            <i data-lucide="upload" class="w-5 h-5"></i>
            <span>Импорт</span>
          </button>
          <button id="btn-create-backup" class="btn-data btn-backup">
            <i data-lucide="save" class="w-5 h-5"></i>
            <span>Бэкап</span>
          </button>
        </div>

        <div class="mb-4">
          <div class="text-sm text-slate-400 font-bold mb-3 flex items-center justify-between">
            <span>Автобэкапы (5 слотов)</span>
            <span class="text-xs text-slate-500" id="last-backup-time">—</span>
          </div>
          <div class="grid grid-cols-5 gap-2" id="backup-slots-container"></div>
        </div>

        <div class="bg-white/5 rounded-xl p-4">
          <div class="flex items-center justify-between text-sm mb-3">
            <div class="flex items-center gap-2">
              <i data-lucide="shield-check" class="w-5 h-5 text-emerald-400"></i>
              <span class="text-slate-300 font-semibold">Целостность данных</span>
            </div>
            <span class="text-emerald-400 font-bold" id="data-integrity-status">OK</span>
          </div>
          <div class="grid grid-cols-3 gap-3 text-xs text-slate-500">
            <div>Услуг: <span class="text-slate-300 font-bold" id="stats-services">0</span></div>
            <div>Регионов: <span class="text-slate-300 font-bold" id="stats-regions">0</span></div>
            <div>Бонусов: <span class="text-slate-300 font-bold" id="stats-bonuses">0</span></div>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="glass rounded-2xl p-5 mb-6">
        <div class="text-base font-extrabold text-white mb-4">Профиль</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Подпись</label>
            <input id="cfg-performer" class="form-input" placeholder="Напр. Дмитрий" />
          </div>
          <div>
            <label class="text-sm text-slate-400 font-bold mb-2 block">Бронь (%)</label>
            <input id="cfg-deposit" type="number" class="form-input text-right mono" placeholder="30" />
          </div>
        </div>
      </div>

      <!-- Admin quick actions -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <button id="btn-add-region" class="btn-add">+ Регион</button>
        <button id="btn-add-category" class="btn-add">+ Категория</button>
        <button id="btn-add-holiday" class="btn-add">+ Праздник</button>
        <button id="btn-add-range" class="btn-add">+ Период</button>
        <button id="btn-add-bonus" class="btn-add">+ Бонус</button>
        <button id="btn-add-payment" class="btn-add">+ Реквизиты</button>
        <button id="btn-add-link" class="btn-add">+ Ссылка</button>
        <button id="btn-reset-db" class="btn-add bg-red-500/10 border-red-500/25 text-red-300 hover:bg-red-500/20">Сброс БД</button>
      </div>

      <!-- Admin sections -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 pb-6">
        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">Логистика</div>
          <div id="settings-travel-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">Услуги</div>
          <div id="settings-services-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">Праздничные даты</div>
          <div id="settings-holidays-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">Праздничные периоды</div>
          <div id="settings-ranges-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">Бонусы</div>
          <div id="settings-bonuses-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5">
          <div class="text-base font-extrabold text-white mb-3">Реквизиты</div>
          <div id="settings-payments-list" class="space-y-2"></div>
        </div>

        <div class="glass rounded-2xl p-5 lg:col-span-2">
          <div class="text-base font-extrabold text-white mb-3">Ссылки</div>
          <div id="settings-links-list" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== TEMPLATES MODAL ========== -->
  <div id="templates-modal" aria-hidden="true">
    <div class="modal-content glass p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <div class="font-cinzel text-white text-xl mb-1">Шаблоны</div>
          <div class="text-sm text-slate-400 font-semibold">Нажми по карточке — применить. ✕ — удалить.</div>
        </div>
        <button id="btn-close-templates-modal" class="btn-icon" aria-label="Закрыть">
          <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
        </button>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4" id="templates-list-modal"></div>
      <div id="templates-empty-modal" class="hidden text-sm text-slate-500 bg-white/5 border border-white/10 rounded-2xl p-4 mb-4">
        Пока нет шаблонов.
      </div>

      <button id="btn-save-as-template-modal" class="btn-add w-full">
        + Сохранить текущую корзину
      </button>
    </div>
  </div>

  <!-- ========== VARIANTS MODAL ========== -->
  <div id="variants-modal" aria-hidden="true">
    <div class="variants-modal-content glass p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <div class="font-cinzel text-white text-xl mb-1">3 варианта КП</div>
          <div class="text-sm text-slate-400 font-semibold">Нажми по варианту — КП скопируется.</div>
        </div>
        <button id="btn-close-variants" class="btn-icon" aria-label="Закрыть">
          <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
        </button>
      </div>

      <div class="space-y-4" id="variants-container"></div>

      <div class="mt-6 text-sm text-slate-500 leading-relaxed">
        Оптимальный — самый продающий. Премиум — для тех, кто готов платить больше.
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
/* === Inlined from app.js === */
/* ============================================
   ILLUSIONIST OS - APP.JS
   Основная логика приложения
   ============================================ */

'use strict';

// ============================================
// КОНСТАНТЫ И КОНФИГУРАЦИЯ
// ============================================
const DB_VERSION = '2.0';
const STORAGE_KEY = 'illusionist_calc_db';
const BACKUP_KEY = 'illusionist_backups';
const MAX_BACKUPS = 5;
const AUTO_BACKUP_INTERVAL = 5 * 60 * 1000; // 5 минут

// ============================================
// UTILITIES
// ============================================
const Utils = {
  escapeHtml: (text) => {
    if (!text) return '';
    const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
    return String(text).replace(/[&<>"']/g, (m) => map[m]);
  },

  sanitizeText: (text, maxLength = 1000) => {
    if (!text) return '';
    return String(text)
      .replace(/[\x00-\x1F\x7F]/g, '')
      .substring(0, maxLength)
      .trim();
  },

  sanitizeNumber: (value, min = 0, max = 999999, defaultValue = null) => {
    const num = parseInt(value, 10);
    if (isNaN(num)) return defaultValue !== null ? defaultValue : min;
    return Math.max(min, Math.min(max, num));
  },

  sanitizeFloat: (value, min = 0, max = 100, defaultValue = null) => {
    const num = parseFloat(value);
    if (isNaN(num)) return defaultValue !== null ? defaultValue : min;
    return Math.max(min, Math.min(max, num));
  },

  validateDateKey: (key) => {
    if (!key || typeof key !== 'string') return false;
    const regex = /^(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
    if (!regex.test(key)) return false;
    const [m, d] = key.split('-').map(Number);
    const daysInMonth = [31,29,31,30,31,30,31,31,30,31,30,31];
    return d <= daysInMonth[m - 1];
  },

  parseMonthDay: (mmdd) => {
    const s = String(mmdd || '').trim();
    if (!Utils.validateDateKey(s)) return null;
    const [mm, dd] = s.split('-').map(n => parseInt(n, 10));
    return { mm, dd };
  },

  formatPrice: (num) => {
    if (typeof num !== 'number' || isNaN(num)) return '0';
    return Math.round(num).toLocaleString('ru-RU');
  },

  createElement: (tag, className = '', textContent = '') => {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (textContent) el.textContent = textContent;
    return el;
  },

  clearElement: (element) => {
    if (!element) return;
    while (element.firstChild) element.removeChild(element.firstChild);
  },

  addOption: (select, value, text) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = text;
    select.appendChild(option);
  },

  copyToClipboard: async (text) => {
    if (!text) return false;
    if (navigator.clipboard && window.isSecureContext) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        console.warn('Clipboard API failed, trying fallback...', err);
      }
    }
    try {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.top = '0';
      textArea.style.left = '-9999px';
      textArea.style.opacity = '0';
      textArea.setAttribute('readonly', '');
      document.body.appendChild(textArea);
      textArea.select();
      textArea.setSelectionRange(0, 99999);
      const successful = document.execCommand('copy');
      document.body.removeChild(textArea);
      return successful;
    } catch (err) {
      console.error('Fallback clipboard failed:', err);
      return false;
    }
  },

  debounce: (func, wait = 300) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  throttle: (func, limit = 300) => {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  },

  formatDate: (dateString) => {
    if (!dateString) return '';
    try {
      const date = new Date(dateString + 'T00:00:00');
      if (isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        weekday: 'short'
      });
    } catch (e) {
      console.error('Date formatting error:', e);
      return dateString;
    }
  },

  formatDateTime: (timestamp) => {
    if (!timestamp) return '—';
    try {
      const date = new Date(timestamp);
      return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return '—';
    }
  },

  simpleHash: (str) => {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return Math.abs(hash).toString(16);
  },

  saveToStorage: (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
      return true;
    } catch (err) {
      console.error('Storage save error:', err);
      return false;
    }
  },

  loadFromStorage: (key, defaultValue = null) => {
    try {
      const item = localStorage.getItem(key);
      if (item === null) return defaultValue;
      return JSON.parse(item);
    } catch (err) {
      console.error('Storage load error:', err);
      return defaultValue;
    }
  },

  isValidObject: (obj) => obj !== null && typeof obj === 'object' && !Array.isArray(obj),

  validateInput: (input, validator, errorClass = 'error-input') => {
    if (!input) return false;
    const isValid = validator(input.value);
    if (!isValid) {
      input.classList.add(errorClass);
      setTimeout(() => input.classList.remove(errorClass), 300);
    }
    return isValid;
  }
};

// ============================================
// DEFAULT DATABASE
// ============================================
const DEFAULT_DB = {
  version: DB_VERSION,
  travel: {
    "Ярославская область": {
      fee: 3000,
      cities: { "Ярославль": 0, "Ростов Великий": 1500 }
    },
    "Костромская область": {
      fee: 5000,
      cities: { "Кострома": 0 }
    }
  },
  services: {
    "Сцена": {
      "Шоу Секрет (45 минут)": 35000,
      "Шоу Секрет (60 минут)": 45000
    },
    "Микромагия": {
      "Микромагия (30 минут)": 20000,
      "Микромагия (60 минут)": 30000
    },
    "Детские шоу": {
      "Индив. детское шоу (30 минут + мастер класс 1 час)": 25000,
      "Детское шоу (60 минут)": 35000
    }
  },
  holidays: {
    "12-31": 2.0,
    "01-01": 2.0
  },
  holidayRanges: [
    { sm: 12, sd: 20, em: 12, ed: 30, k: 1.5 }
  ],
  bonuses: [
    { threshold: 30000, text: "Мини-сувенир гостям" },
    { threshold: 50000, text: "Фото/видео с фишкой шоу" },
    { threshold: 70000, text: "Доп. интерактив / сюрприз эффект" }
  ],
  payments: [
    { title: "Перевод", text: "СБП / карта: +7 (___) ___-__-__" }
  ],
  links: [
    { label: "Портфолио", url: "https://example.com" }
  ],
  config: {
    performer: "Illusionist",
    deposit: 30
  }
};

// ============================================
// GLOBAL STATE
// ============================================
let DB = {};
let State = {
  date: (function() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  })(),
  holidayK: 1,
  serviceQty: 1,
  cart: [],
  finalTotal: 0,
  finalDetails: {
    servicesTotal: 0,
    discount: 0,
    travel: 0,
    manPrice: 0,
    guestPrice: 0,
    tax: 0,
    k: 1
  },
  activeBonuses: []
};

// ============================================
// DATA MANAGER
// ============================================
const DataManager = {
  calculateChecksum: (data) => Utils.simpleHash(JSON.stringify(data)),

  validateData: (data) => {
    if (!data || typeof data !== 'object') {
      return { valid: false, error: 'Некорректный формат данных' };
    }

    const required = ['travel', 'services', 'holidays', 'bonuses', 'payments', 'links', 'config'];
    for (const key of required) {
      if (!(key in data)) {
        return { valid: false, error: `Отсутствует поле: ${key}` };
      }
    }

    if (!Utils.isValidObject(data.travel)) {
      return { valid: false, error: 'Некорректная структура travel' };
    }
    if (!Utils.isValidObject(data.services)) {
      return { valid: false, error: 'Некорректная структура services' };
    }
    if (!Utils.isValidObject(data.holidays)) {
      return { valid: false, error: 'Некорректная структура holidays' };
    }
    if (!Array.isArray(data.bonuses)) {
      return { valid: false, error: 'bonuses должен быть массивом' };
    }
    if (!Array.isArray(data.payments)) {
      return { valid: false, error: 'payments должен быть массивом' };
    }
    if (!Array.isArray(data.links)) {
      return { valid: false, error: 'links должен быть массивом' };
    }
    if ('holidayRanges' in data && !Array.isArray(data.holidayRanges)) {
      return { valid: false, error: 'holidayRanges должен быть массивом' };
    }

    return { valid: true };
  },

  exportData: () => {
    try {
      const exportData = {
        ...DB,
        version: DB_VERSION,
        exportedAt: new Date().toISOString(),
        checksum: DataManager.calculateChecksum(DB)
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `illusionist-backup-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      App.showToast('Данные экспортированы!');
      return true;
    } catch (err) {
      console.error('❌ Export error:', err);
      App.showToast('Ошибка экспорта');
      return false;
    }
  },

  importData: (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        const validation = DataManager.validateData(data);

        if (!validation.valid) {
          App.showToast(validation.error);
          reject(new Error(validation.error));
          return;
        }

        if (data.checksum) {
          const { checksum, exportedAt, ...cleanData } = data;
          const calculated = DataManager.calculateChecksum(cleanData);
          if (checksum !== calculated) {
            if (!confirm('Контрольная сумма не совпадает. Данные могли быть изменены. Продолжить?')) {
              reject(new Error('Cancelled'));
              return;
            }
          }
        }

        DataManager.createBackup('Перед импортом');

        const { checksum, exportedAt, ...importedData } = data;

        DB = {
          ...JSON.parse(JSON.stringify(DEFAULT_DB)),
          ...importedData,
          version: DB_VERSION
        };

        if (!Array.isArray(DB.holidayRanges)) {
          DB.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.holidayRanges));
        }

        Storage.save();
        App.updateUI();
        Admin.render();
        DataManager.updateStats();

        App.showToast('Данные импортированы!');
        resolve(true);
      } catch (err) {
        console.error('❌ Import error:', err);
        App.showToast('Ошибка чтения файла');
        reject(err);
      }
    };

    reader.onerror = () => {
      App.showToast('Ошибка чтения файла');
      reject(new Error('File read error'));
    };

    reader.readAsText(file);
  }),

  createBackup: (label = null) => {
    try {
      const backups = Utils.loadFromStorage(BACKUP_KEY, []);
      const backup = {
        id: Date.now(),
        label: label || `Бэкап ${backups.length + 1}`,
        timestamp: new Date().toISOString(),
        data: JSON.parse(JSON.stringify(DB)),
        checksum: DataManager.calculateChecksum(DB)
      };

      backups.unshift(backup);
      if (backups.length > MAX_BACKUPS) backups.pop();

      Utils.saveToStorage(BACKUP_KEY, backups);
      DataManager.renderBackupSlots();
      App.showToast('Бэкап создан!');
      return true;
    } catch (err) {
      console.error('❌ Backup error:', err);
      App.showToast('Ошибка создания бэкапа');
      return false;
    }
  },

  restoreBackup: (backupId) => {
    try {
      const backups = Utils.loadFromStorage(BACKUP_KEY, []);
      const backup = backups.find(b => b.id === backupId);

      if (!backup) {
        App.showToast('Бэкап не найден');
        return false;
      }

      if (!confirm(`Восстановить "${backup.label}"?\nТекущие данные будут заменены.`)) {
        return false;
      }

      const calculated = DataManager.calculateChecksum(backup.data);
      if (backup.checksum !== calculated) {
        if (!confirm('Контрольная сумма не совпадает. Продолжить?')) {
          return false;
        }
      }

      DB = {
        ...JSON.parse(JSON.stringify(DEFAULT_DB)),
        ...backup.data,
        version: DB_VERSION
      };

      if (!Array.isArray(DB.holidayRanges)) {
        DB.holidayRanges = JSON.parse(JSON.stringify(DEFAULT_DB.holidayRanges));
      }

      Storage.save();
      App.updateUI();
      Admin.render();
      DataManager.updateStats();

      App.showToast('Данные восстановлены!');
      return true;
    } catch (err) {
      console.error('❌ Restore error:', err);
      App.showToast('Ошибка восстановления');
      return false;
    }
  },

  deleteBackup: (backupId) => {
    try {
      let backups = Utils.loadFromStorage(BACKUP_KEY, []);
      backups = backups.filter(b => b.id !== backupId);
      Utils.saveToStorage(BACKUP_KEY, backups);
      DataManager.renderBackupSlots();
      App.showToast('Бэкап удалён');
      return true;
    } catch (err) {
      console.error('❌ Delete backup error:', err);
      return false;
    }
  },

  autoBackup: () => {
    const backups = Utils.loadFromStorage(BACKUP_KEY, []);
    const lastBackup = backups[0];

    if (lastBackup) {
      const currentChecksum = DataManager.calculateChecksum(DB);
      if (lastBackup.checksum === currentChecksum) return;
    }

    try {
      const backup = {
        id: Date.now(),
        label: 'Автобэкап',
        timestamp: new Date().toISOString(),
        data: JSON.parse(JSON.stringify(DB)),
        checksum: DataManager.calculateChecksum(DB)
      };

      const allBackups = Utils.loadFromStorage(BACKUP_KEY, []);
      allBackups.unshift(backup);
      if (allBackups.length > MAX_BACKUPS) allBackups.pop();
      Utils.saveToStorage(BACKUP_KEY, allBackups);

      DataManager.renderBackupSlots();
    } catch (err) {
      console.error('❌ Auto-backup error:', err);
    }
  },

  renderBackupSlots: () => {
    const container = document.getElementById('backup-slots-container');
    if (!container) return;

    const backups = Utils.loadFromStorage(BACKUP_KEY, []);
    Utils.clearElement(container);

    for (let i = 0; i < MAX_BACKUPS; i++) {
      const backup = backups[i];
      const slot = Utils.createElement('div', `backup-slot ${backup ? '' : 'empty'}`);

      if (backup) {
        slot.innerHTML = `
          <div class="text-xs font-bold text-amber-400 truncate">${Utils.escapeHtml(backup.label)}</div>
          <div class="text-[10px] text-slate-500">${Utils.formatDateTime(backup.timestamp)}</div>
        `;
        slot.title = `${backup.label}\nПравый клик — удалить`;
        slot.addEventListener('click', () => DataManager.restoreBackup(backup.id));
        slot.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (confirm(`Удалить "${backup.label}"?`)) {
            DataManager.deleteBackup(backup.id);
          }
        });
      } else {
        slot.innerHTML = `
          <div class="text-xs text-slate-600">Пусто</div>
          <div class="text-[10px] text-slate-700">—</div>
        `;
      }

      container.appendChild(slot);
    }

    const lastBackupEl = document.getElementById('last-backup-time');
    if (lastBackupEl && backups[0]) {
      lastBackupEl.textContent = `Последний: ${Utils.formatDateTime(backups[0].timestamp)}`;
    } else if (lastBackupEl) {
      lastBackupEl.textContent = '—';
    }
  },

  updateStats: () => {
    const servicesCount = Object.values(DB.services || {}).reduce(
      (sum, cat) => sum + Object.keys(cat || {}).length,
      0
    );
    const regionsCount = Object.keys(DB.travel || {}).length;
    const bonusesCount = (DB.bonuses || []).length;

    const servicesEl = document.getElementById('stats-services');
    const regionsEl = document.getElementById('stats-regions');
    const bonusesEl = document.getElementById('stats-bonuses');
    const versionEl = document.getElementById('db-version-display');
    const integrityEl = document.getElementById('data-integrity-status');

    if (servicesEl) servicesEl.textContent = servicesCount;
    if (regionsEl) regionsEl.textContent = regionsCount;
    if (bonusesEl) bonusesEl.textContent = bonusesCount;
    if (versionEl) versionEl.textContent = `v${DB.version || DB_VERSION}`;

    if (integrityEl) {
      const isValid = DataManager.validateData(DB).valid;
      integrityEl.textContent = isValid ? 'OK' : 'ОШИБКА';
      integrityEl.className = isValid ? 'text-emerald-400 font-bold' : 'text-red-400 font-bold';
    }
  },

  updateBackupIndicator: (status = 'saved') => {
    const dot = document.querySelector('#backup-indicator .backup-dot');
    const text = document.getElementById('backup-status-text');
    if (!dot || !text) return;

    switch (status) {
      case 'saving':
        dot.className = 'backup-dot warning';
        text.textContent = 'Сохранение...';
        break;
      case 'saved':
        dot.className = 'backup-dot';
        text.textContent = 'Сохранено';
        break;
      case 'error':
        dot.className = 'backup-dot error';
        text.textContent = 'Ошибка!';
        break;
    }
  },

  init: () => {
    const fileInput = document.getElementById('import-file-input');
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          DataManager.importData(e.target.files[0])
            .catch(err => console.error(err))
            .finally(() => {
              fileInput.value = '';
            });
        }
      });
    }

    document.getElementById('btn-export-data')?.addEventListener('click', DataManager.exportData);
    document.getElementById('btn-import-data')?.addEventListener('click', () => {
      document.getElementById('import-file-input')?.click();
    });
    document.getElementById('btn-create-backup')?.addEventListener('click', () => {
      const label = prompt('Название бэкапа:', `Бэкап ${new Date().toLocaleDateString('ru-RU')}`);
      if (label !== null) DataManager.createBackup(label || undefined);
    });

    DataManager.renderBackupSlots();
    DataManager.updateStats();
    DataManager.updateBackupIndicator('saved');

    setInterval(DataManager.autoBackup, AUTO_BACKUP_INTERVAL);
  }
};

// ============================================
// STORAGE
// ============================================
const Storage = {
  save: () => {
    DataManager.updateBackupIndicator('saving');
    try {
      DB.version = DB_VERSION;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
      DataManager.updateBackupIndicator('saved');
      DataManager.updateStats();
      return true;
    } catch (err) {
      console.error('❌ Storage save error:', err);
      DataManager.updateBackupIndicator('error');
      if (err.name === 'QuotaExceededError') {
        App.showToast('Хранилище переполнено');
      }
      return false;
    }
  },

  load: () => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (!stored) {
        DB = JSON.parse(JSON.stringify(DEFAULT_DB));
        DB.version = DB_VERSION;
        DataManager.updateBackupIndicator('saved');
        return true;
      }

      const parsed = JSON.parse(stored);

      DB = {
        ...JSON.parse(JSON.stringify(DEFAULT_DB)),
        travel: Utils.isValidObject(parsed.travel) ? parsed.travel : DEFAULT_DB.travel,
        services: Utils.isValidObject(parsed.services) ? parsed.services : DEFAULT_DB.services,
        holidays: Utils.isValidObject(parsed.holidays) ? parsed.holidays : DEFAULT_DB.holidays,
        holidayRanges: Array.isArray(parsed.holidayRanges) ? parsed.holidayRanges : DEFAULT_DB.holidayRanges,
        bonuses: Array.isArray(parsed.bonuses) ? parsed.bonuses : DEFAULT_DB.bonuses,
        payments: Array.isArray(parsed.payments) ? parsed.payments : DEFAULT_DB.payments,
        links: Array.isArray(parsed.links) ? parsed.links : DEFAULT_DB.links,
        config: Utils.isValidObject(parsed.config) ? { ...DEFAULT_DB.config, ...parsed.config } : DEFAULT_DB.config,
        version: DB_VERSION
      };

      DataManager.updateBackupIndicator('saved');
      return true;
    } catch (err) {
      console.error('❌ Storage load error:', err);
      DB = JSON.parse(JSON.stringify(DEFAULT_DB));
      DB.version = DB_VERSION;
      DataManager.updateBackupIndicator('error');
      return false;
    }
  },

  reset: () => {
    try {
      localStorage.removeItem(STORAGE_KEY);
      DataManager.updateBackupIndicator('saved');
      return true;
    } catch (err) {
      console.error('❌ Storage reset error:', err);
      DataManager.updateBackupIndicator('error');
      return false;
    }
  }
};

// ============================================
// APP - ОСНОВНАЯ ЛОГИКА
// ============================================
const App = {
  init: () => {
    try {
      Storage.load();
      DataManager.init();

      App.migrateServicesNames();
      App.setupEventListeners();
      App.initProfileInputs();
      App.updateUI();

      const dateInput = document.getElementById('inp-date');
      if (dateInput) {
        dateInput.value = State.date;
        App.updateDate();
      }

      // Particles: on by default only on bigger screens & when user didn't request reduced motion
      const ENABLE_PARTICLES = (window.innerWidth > 768) && !(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
      if (ENABLE_PARTICLES) App.renderParticles();

      if (window.lucide) lucide.createIcons();
      App.startSplash();
      App.registerSWInline();

      DataManager.updateBackupIndicator('saved');

      console.log('✅ App initialized');
    } catch (err) {
      console.error('❌ App initialization failed:', err);
      App.showToast('Ошибка инициализации');
      DataManager.updateBackupIndicator('error');
    }
  },

  setupEventListeners: () => {
    // Settings modal
    document.getElementById('btn-settings')?.addEventListener('click', App.toggleSettings);
    document.getElementById('btn-close-settings')?.addEventListener('click', App.toggleSettings);
    document.getElementById('view-settings')?.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'view-settings') App.toggleSettings();
    });

    // Date
    document.getElementById('inp-date')?.addEventListener('change', App.updateDate);

    // Region & City
    document.getElementById('inp-region')?.addEventListener('change', App.updateRegion);
    document.getElementById('inp-city')?.addEventListener('change', App.calc);

    // Category
    document.getElementById('inp-cat')?.addEventListener('change', App.updateCat);

    // Quantity
    document.getElementById('btn-qty-minus')?.addEventListener('click', () => App.changeQty(-1));
    document.getElementById('btn-qty-plus')?.addEventListener('click', () => App.changeQty(1));

    // Add service
    document.getElementById('btn-add-service')?.addEventListener('click', App.addService);

    // Copy buttons
    document.getElementById('btn-copy-prices')?.addEventListener('click', App.copyPriceList);
    document.getElementById('btn-copy-quote')?.addEventListener('click', App.copyQuote);

    // Manual price
    const manualPriceInput = document.getElementById('inp-manual-price');
    if (manualPriceInput) {
      manualPriceInput.addEventListener('input', Utils.debounce(() => {
        const value = Utils.sanitizeNumber(manualPriceInput.value, 0, 999999);
        manualPriceInput.value = value || '';
        App.calc();
      }, 250));
    }

    // Guests & Tax
    document.getElementById('inp-guests')?.addEventListener('change', App.calc);
    document.getElementById('inp-tax')?.addEventListener('change', App.calc);

    // Admin buttons
    const bind = (id, fn) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', fn);
    };

    bind('btn-add-bonus', () => Admin.addBonus());
    bind('btn-add-region', () => Admin.addRegion());
    bind('btn-add-category', () => Admin.addCategory());
    bind('btn-add-holiday', () => Admin.addHoliday());
    bind('btn-add-range', () => Admin.addRange());
    bind('btn-add-payment', () => Admin.addPayment());
    bind('btn-add-link', () => Admin.addLink());
    bind('btn-reset-db', () => Admin.reset());
  },

  initProfileInputs: () => {
    const performerInput = document.getElementById('cfg-performer');
    if (performerInput) {
      performerInput.value = DB.config?.performer || 'Illusionist';
      performerInput.addEventListener('input', Utils.debounce(() => {
        DB.config.performer = Utils.sanitizeText(performerInput.value, 100);
        Storage.save();
        DataManager.updateStats();
      }, 350));
    }

    const depositInput = document.getElementById('cfg-deposit');
    if (depositInput) {
      depositInput.value = DB.config?.deposit ?? 30;
      depositInput.addEventListener('input', Utils.debounce(() => {
        const value = Utils.sanitizeNumber(depositInput.value, 0, 100, 30);
        depositInput.value = value;
        DB.config.deposit = value;
        Storage.save();
        DataManager.updateStats();
      }, 350));
    }
  },

  migrateServicesNames: () => {
    try {
      if (!DB.services || !DB.services["Детские шоу"]) return;
      const oldKey = "Индив. детское шоу";
      const newKey = "Индив. детское шоу (30 минут + мастер класс 1 час)";
      if (DB.services["Детские шоу"][oldKey] != null && DB.services["Детские шоу"][newKey] == null) {
        DB.services["Детские шоу"][newKey] = DB.services["Детские шоу"][oldKey];
        delete DB.services["Детские шоу"][oldKey];
        Storage.save();
      }
    } catch (err) {
      console.error('Migration error:', err);
    }
  },

  registerSWInline: () => {
    try {
      if (!('serviceWorker' in navigator)) return;
      const swCode = `
        const CACHE = 'illusionist-os-cache-v1';
        self.addEventListener('install', (e) => {
          e.waitUntil((async () => {
            try {
              const cache = await caches.open(CACHE);
            } catch (e) {}
          })());
          self.skipWaiting();
        });
        self.addEventListener('activate', (e) => {
          e.waitUntil((async () => {
            try {
              const keys = await caches.keys();
              await Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)));
            } catch (e) {}
            self.clients.claim();
          })());
        });
        self.addEventListener('fetch', (e) => {
          e.respondWith((async () => {
            try {
              const res = await fetch(e.request);
              return res;
            } catch (err) {
              const cached = await caches.match(e.request);
              if (cached) return cached;
              throw err;
            }
          })());
        });
      `;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const swUrl = URL.createObjectURL(blob);

      navigator.serviceWorker.register(swUrl).catch(() => {});
      setTimeout(() => {
        try {
          URL.revokeObjectURL(swUrl);
        } catch (e) {}
      }, 5000);
    } catch (e) {}
  },

  startSplash: () => {
    const splash = document.getElementById('splash');
    if (!splash) return;

    if (window.lucide) {
      try {
        lucide.createIcons();
      } catch (err) {}
    }

    const MIN_MS = 2800;
    let dismissed = false;

    const hide = () => {
      if (dismissed) return;
      dismissed = true;
      splash.classList.add('hide');
      setTimeout(() => {
        if (splash.parentNode) splash.remove();
      }, 700);
    };

    splash.addEventListener('click', hide, { once: true });
    splash.addEventListener('touchstart', hide, { once: true, passive: true });
    setTimeout(hide, MIN_MS);
  },

  updateUI: () => {
    try {
      App.updateRegionSelect();
      App.updateCategorySelect();
      App.updateCat();
      if (window.lucide) lucide.createIcons();
      DataManager.updateStats();
      DataManager.renderBackupSlots();
      Admin.render();
    } catch (err) {
      console.error('UI update error:', err);
    }
  },

  updateRegionSelect: () => {
    const regionSelect = document.getElementById('inp-region');
    if (!regionSelect) return;

    const currentValue = regionSelect.value;
    Utils.clearElement(regionSelect);
    Utils.addOption(regionSelect, '', 'Выберите...');
    regionSelect.options[0].disabled = true;
    regionSelect.options[0].selected = true;

    if (DB.travel && Utils.isValidObject(DB.travel)) {
      Object.keys(DB.travel).sort().forEach(region => {
        Utils.addOption(regionSelect, region, region);
      });
    }

    if (currentValue && DB.travel?.[currentValue]) {
      regionSelect.value = currentValue;
    }
  },

  updateCategorySelect: () => {
    const catSelect = document.getElementById('inp-cat');
    if (!catSelect) return;

    const currentValue = catSelect.value;
    Utils.clearElement(catSelect);
    Utils.addOption(catSelect, '', 'Выберите...');
    catSelect.options[0].disabled = true;
    catSelect.options[0].selected = true;

    if (DB.services && Utils.isValidObject(DB.services)) {
      Object.keys(DB.services).sort().forEach(category => {
        Utils.addOption(catSelect, category, category);
      });
    }

    if (currentValue && DB.services?.[currentValue]) {
      catSelect.value = currentValue;
    }
  },

  updateDate: () => {
    const dateInput = document.getElementById('inp-date');
    if (!dateInput) return;

    const val = dateInput.value;
    if (!val) return;

    try {
      State.date = val;
      const [y, m, d] = val.split('-').map(Number);
      if (!m || !d) return;

      const key = `${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

      let k = (DB.holidays && DB.holidays[key]) ? Utils.sanitizeFloat(DB.holidays[key], 1, 10) : 1;

      if (k === 1 && DB.holidayRanges && Array.isArray(DB.holidayRanges)) {
        const md = m * 100 + d;
        for (let range of DB.holidayRanges) {
          if (!Utils.isValidObject(range)) continue;
          const start = (range.sm || 0) * 100 + (range.sd || 0);
          const end = (range.em || 0) * 100 + (range.ed || 0);
          const inRange = start <= end ? (md >= start && md <= end) : (md >= start || md <= end);
          if (inRange) {
            k = Utils.sanitizeFloat(range.k, 1, 10);
            break;
          }
        }
      }

      State.holidayK = k;

      const badge = document.getElementById('holiday-alert');
      const kSpan = document.getElementById('holiday-k');
      if (badge && kSpan) {
        if (k > 1) {
          badge.classList.remove('hidden');
          kSpan.textContent = k;
        } else {
          badge.classList.add('hidden');
        }
      }

      App.calc();
    } catch (err) {
      console.error('Date update error:', err);
    }
  },

  updateRegion: () => {
    const regionSelect = document.getElementById('inp-region');
    const citySelect = document.getElementById('inp-city');
    if (!regionSelect || !citySelect) return;

    const region = regionSelect.value;
    Utils.clearElement(citySelect);
    citySelect.disabled = false;

    if (region && DB.travel && DB.travel[region] && DB.travel[region].cities) {
      const cities = DB.travel[region].cities;
      Object.keys(cities).sort().forEach(city => {
        Utils.addOption(citySelect, city, city);
      });
      Utils.addOption(citySelect, 'other', 'Другой');
    } else {
      citySelect.disabled = true;
    }

    App.calc();
  },

  updateCat: () => {
    const catSelect = document.getElementById('inp-cat');
    const svcSelect = document.getElementById('inp-svc');
    if (!catSelect || !svcSelect) return;

    const category = catSelect.value;
    Utils.clearElement(svcSelect);
    svcSelect.disabled = false;

    if (category && DB.services && DB.services[category]) {
      const services = DB.services[category];
      Object.keys(services).sort().forEach(service => {
        Utils.addOption(svcSelect, service, service);
      });
    } else {
      svcSelect.disabled = true;
    }
  },

  changeQty: (delta) => {
    const qtySpan = document.getElementById('svc-qty');
    if (!qtySpan) return;

    let newQty = State.serviceQty + delta;
    newQty = Utils.sanitizeNumber(newQty, 1, 99);
    State.serviceQty = newQty;
    qtySpan.textContent = newQty;
  },

  addService: () => {
    const catSelect = document.getElementById('inp-cat');
    const svcSelect = document.getElementById('inp-svc');
    if (!catSelect || !svcSelect) return;

    const cat = catSelect.value;
    const svc = svcSelect.value;

    if (!cat || !svc) {
      App.showToast('Выберите услугу!');
      return;
    }

    const basePrice = DB.services?.[cat]?.[svc];
    if (typeof basePrice !== 'number' || isNaN(basePrice) || basePrice < 0) {
      App.showToast('Некорректная цена услуги');
      return;
    }

    State.cart.push({
      name: Utils.sanitizeText(svc, 200),
      price: basePrice,
      qty: State.serviceQty
    });

    State.serviceQty = 1;
    const qtySpan = document.getElementById('svc-qty');
    if (qtySpan) qtySpan.textContent = 1;

    App.renderCart();
    App.calc();
    App.showToast('Услуга добавлена');
  },

  removeService: (idx) => {
    if (idx >= 0 && idx < State.cart.length) {
      State.cart.splice(idx, 1);
      App.renderCart();
      App.calc();
    }
  },

  renderCart: () => {
    const cartList = document.getElementById('cart-list');
    if (!cartList) return;

    Utils.clearElement(cartList);

    State.cart.forEach((item, idx) => {
      const total = Math.round(item.price * item.qty * State.holidayK);

      const wrapper = Utils.createElement(
        'div',
        'animate-enter'
      );

      const leftDiv = Utils.createElement('div', 'flex-1 min-w-0');

      const nameDiv = Utils.createElement('div', 'text-base font-semibold text-white mb-1');
      nameDiv.textContent = item.name;

      if (item.qty > 1) {
        const qtySpan = Utils.createElement('span', 'text-amber-400 text-sm ml-2');
        qtySpan.textContent = `×${item.qty}`;
        nameDiv.appendChild(qtySpan);
      }

      const priceDiv = Utils.createElement('div', 'text-sm text-slate-400 mono');
      priceDiv.textContent = `${Utils.formatPrice(item.price)} ₽`;

      leftDiv.appendChild(nameDiv);
      leftDiv.appendChild(priceDiv);

      const rightDiv = Utils.createElement('div', 'flex items-center gap-4 flex-shrink-0');

      const totalSpan = Utils.createElement('span', 'font-extrabold text-amber-400 text-base mono');
      totalSpan.textContent = `${Utils.formatPrice(total)} ₽`;

      const delBtn = Utils.createElement('button', 'text-slate-500 hover:text-red-400 transition p-2');
      delBtn.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i>';
      delBtn.addEventListener('click', () => App.removeService(idx));

      rightDiv.appendChild(totalSpan);
      rightDiv.appendChild(delBtn);

      wrapper.appendChild(leftDiv);
      wrapper.appendChild(rightDiv);
      cartList.appendChild(wrapper);
    });
    if (window.lucide) lucide.createIcons();

    // keep 'Save template' button in sync with cart state
    if (typeof Templates !== 'undefined' && Templates.updateSaveButton) Templates.updateSaveButton();
  },

  calc: () => {
    try {
      const k = State.holidayK || 1;
      let servicesTotal = 0;

      State.cart.forEach(item => {
        if (typeof item.price === 'number' && typeof item.qty === 'number') {
          servicesTotal += item.price * item.qty * k;
        }
      });

      let discount = 0;
      const discountBadge = document.getElementById('discount-badge');
      if (State.cart.length > 1) {
        discount = Math.round(servicesTotal * 0.1);
        if (discountBadge) discountBadge.classList.remove('hidden');
      } else {
        if (discountBadge) discountBadge.classList.add('hidden');
      }
      servicesTotal -= discount;

      const regionSelect = document.getElementById('inp-region');
      const citySelect = document.getElementById('inp-city');
      let travel = 0;

      if (regionSelect && citySelect) {
        const region = regionSelect.value;
        const city = citySelect.value;

        if (region && city && DB.travel?.[region]) {
          const baseTravel = city === 'other'
            ? (DB.travel[region].fee || 0)
            : (DB.travel[region].cities?.[city] || 0);

          travel = Math.round(baseTravel * (k > 1 ? 1.5 : 1));
        }
      }

      const manualPriceInput = document.getElementById('inp-manual-price');
      const manPrice = manualPriceInput ? Utils.sanitizeNumber(manualPriceInput.value, 0, 999999, 0) : 0;

      const guestsSelect = document.getElementById('inp-guests');
      const guestPrice = guestsSelect ? Utils.sanitizeNumber(guestsSelect.value, 0, 999999, 0) : 0;

      const taxCheckbox = document.getElementById('inp-tax');
      const useTax = taxCheckbox ? taxCheckbox.checked : false;

      let preTax = servicesTotal + travel + manPrice + guestPrice;
      const tax = useTax ? Math.round(preTax * 0.06) : 0;

      State.finalTotal = preTax + tax;

      // If rounding was applied ранее — после любых перерасчётов сбрасываем округление,
      // чтобы оно не «прилипало» к новой корзине.
      if (typeof Rounding !== 'undefined' && Rounding.state && Rounding.state.isApplied) {
        if (typeof Rounding.clearStateSilently === 'function') Rounding.clearStateSilently();
        if (typeof Rounding.updateUI === 'function') Rounding.updateUI();
      }
      State.finalDetails = { servicesTotal, discount, travel, manPrice, guestPrice, tax, k };

      const totalSumEl = document.getElementById('total-sum');
      if (totalSumEl) {
        totalSumEl.textContent = `${Utils.formatPrice(State.finalTotal)} ₽`;
      }

      App.updateBonuses();

    } catch (err) {
      console.error('Calculation error:', err);
    }
  },

  updateBonuses: () => {
    State.activeBonuses = App.getBonusesForTotal(State.finalTotal);
    const bonusListEl = document.getElementById('bonus-list');
    if (!bonusListEl) return;

    Utils.clearElement(bonusListEl);

    if (State.activeBonuses.length > 0) {
      State.activeBonuses.forEach(bonus => {
        const bonusDiv = Utils.createElement(
          'div',
          'inline-block bg-amber-500/10 text-amber-400 border border-amber-500/20 px-4 py-2 rounded-full text-sm font-bold uppercase tracking-wider animate-enter'
        );
        bonusDiv.textContent = bonus.text;
        bonusListEl.appendChild(bonusDiv);
      });
    }
  },

  getBonusesForTotal: (total) => {
    if (!DB.bonuses || !Array.isArray(DB.bonuses) || DB.bonuses.length === 0) return [];
    return DB.bonuses
      .filter(b => Utils.isValidObject(b) && 
                   typeof b.threshold === 'number' && 
                   !isNaN(b.threshold) && 
                   typeof b.text === 'string' && 
                   b.text.length > 0 && 
                   total >= b.threshold)
      .slice()
      .sort((a, b) => (a.threshold || 0) - (b.threshold || 0));
  },

  copyPriceList: async () => {
    const catSelect = document.getElementById('inp-cat');
    if (!catSelect) return;

    const cat = catSelect.value;
    if (!cat || !DB.services || !DB.services[cat]) {
      App.showToast('Выберите категорию');
      return;
    }

    const services = DB.services[cat];
    if (Object.keys(services).length === 0) {
      App.showToast('Категория пустая');
      return;
    }

    const k = State.holidayK || 1;
    const dateRaw = document.getElementById('inp-date')?.value || '';
    const dateFmt = Utils.formatDate(dateRaw);

    const bonusesSorted = (DB.bonuses || [])
      .filter(b => Utils.isValidObject(b) && typeof b.threshold === 'number')
      .slice()
      .sort((a, b) => (a.threshold || 0) - (b.threshold || 0));
    const hasBonuses = bonusesSorted.length > 0;

    let text = `ЦЕНЫ: ${Utils.sanitizeText(cat, 100)}\n`;
    if (dateFmt) text += `Дата: ${dateFmt}\n`;
    if (k > 1) text += `Праздничный коэффициент: ×${k}\n`;
    text += `\n`;

    const lines = [];
    Object.keys(services).forEach(name => {
      const base = services[name];
      if (typeof base !== 'number' || isNaN(base) || base < 0) return;

      const price = Math.round(base * k);
      const safeName = Utils.sanitizeText(name, 200);

      let bonusLine = '';
      if (hasBonuses) {
        const earned = bonusesSorted.filter(b => price >= (b.threshold || 0));
        if (earned.length > 0) {
          const bonusTexts = earned.map(b => `✅ ${Utils.sanitizeText(b.text, 200)}`).join(', ');
          bonusLine = `  Бонусы: ${bonusTexts}`;
        } else {
          const next = bonusesSorted.find(b => price < (b.threshold || 0));
          if (next) {
            const diff = Math.max(0, (next.threshold || 0) - price);
            const nextText = Utils.sanitizeText(next.text, 200);
            bonusLine = `  Бонусы: пока нет (ещё ${Utils.formatPrice(diff)} ₽ до "${nextText}")`;
          } else {
            bonusLine = `  Бонусы: все разблокированы! 🎉`;
          }
        }
      }

      lines.push(`• ${safeName} — ${Utils.formatPrice(price)} ₽${bonusLine ? `\n${bonusLine}` : ''}`);
    });

    text += lines.join('\n') + '\n';

    if (hasBonuses) {
      text += `\nБОНУСЫ ПО СУММЕ:\n`;
      bonusesSorted.forEach(b => {
        const threshold = Utils.formatPrice(b.threshold || 0);
        const bonusText = Utils.sanitizeText(b.text, 200);
        text += `• От ${threshold} ₽ — ${bonusText}\n`;
      });
    }

    const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
    text += `\nВаш ${performer}`;

    const success = await Utils.copyToClipboard(text);
    App.showToast(success ? 'Цены + бонусы скопированы!' : 'Не удалось скопировать');
  },

  copyQuote: async () => {
    if (!State.finalTotal || State.finalTotal <= 0) {
      App.showToast('Сумма 0 ₽');
      return;
    }

    const client = Utils.sanitizeText(document.getElementById('inp-client')?.value, 100) || 'Клиент';
    const type = document.getElementById('inp-event-type')?.value || 'Мероприятие';

    const dateRaw = document.getElementById('inp-date')?.value || '';
    const dateFmt = Utils.formatDate(dateRaw) || dateRaw;

    const time = document.getElementById('inp-time')?.value || '18:00';
    const city = document.getElementById('inp-city')?.value || '';

    const depPct = DB.config?.deposit || 30;
    const deposit = Math.round(State.finalTotal * (depPct / 100));

    let text = `${client}\n\n`;
    text += `РАСЧЕТ: ${type.toUpperCase()}\n`;
    text += `${dateFmt} / ${time}\n`;
    if (city && city !== 'other') text += `${Utils.sanitizeText(city, 100)}\n`;
    text += `\nПрограмма:\n`;

    State.cart.forEach(item => {
      const price = Math.round(item.price * item.qty * State.finalDetails.k);
      const safeName = Utils.sanitizeText(item.name, 200);
      text += `• ${safeName}${item.qty > 1 ? ` ×${item.qty}` : ''} — ${Utils.formatPrice(price)} ₽\n`;
    });

    if (State.finalDetails.discount > 0) {
      text += `Скидка 10%: -${Utils.formatPrice(State.finalDetails.discount)} ₽\n`;
    }
    if (State.finalDetails.travel > 0) {
      text += `Логистика: ${Utils.formatPrice(State.finalDetails.travel)} ₽\n`;
    }
    if (State.finalDetails.guestPrice > 0) {
      text += `Доплата за гостей: ${Utils.formatPrice(State.finalDetails.guestPrice)} ₽\n`;
    }
    if (State.finalDetails.manPrice > 0) {
      const manName = Utils.sanitizeText(document.getElementById('inp-manual-name')?.value, 100) || 'Доп';
      text += `${manName}: ${Utils.formatPrice(State.finalDetails.manPrice)} ₽\n`;
    }
    if (State.finalDetails.tax > 0) {
      text += `Договор (+6%): ${Utils.formatPrice(State.finalDetails.tax)} ₽\n`;
    }

    const earned = App.getBonusesForTotal(State.finalTotal);
    if (earned.length > 0) {
      text += `\nБонусы:\n`;
      earned.forEach(b => {
        text += `• ${Utils.sanitizeText(b.text, 200)}\n`;
      });
    }

    text += `\nИТОГО: ${Utils.formatPrice(State.finalTotal)} ₽\n`;
    text += `Бронь даты (${depPct}%): ${Utils.formatPrice(deposit)} ₽\n`;

    if (DB.payments && Array.isArray(DB.payments)) {
      text += `\nРеквизиты:\n`;
      DB.payments.forEach(p => {
        if (Utils.isValidObject(p)) {
          const title = Utils.sanitizeText(p.title, 100);
          const payText = Utils.sanitizeText(p.text, 500);
          text += `${title}: ${payText}\n`;
        }
      });
    }

    if (DB.links && Array.isArray(DB.links)) {
      text += `\nСсылки:\n`;
      DB.links.forEach(l => {
        if (Utils.isValidObject(l)) {
          const label = Utils.sanitizeText(l.label, 100);
          const url = Utils.sanitizeText(l.url, 500);
          text += `• ${label}: ${url}\n`;
        }
      });
    }

    const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
    text += `\nВаш ${performer}`;

    const success = await Utils.copyToClipboard(text);
    App.showToast(success ? 'КП скопировано!' : 'Не удалось скопировать');
  },

  toggleSettings: () => {
    const modal = document.getElementById('view-settings');
    if (!modal) return;

    const isOpen = modal.classList.contains('active');

    if (!isOpen) {
      Admin.render();
      DataManager.renderBackupSlots();
      DataManager.updateStats();
      modal.classList.add('active');
      if (window.lucide) lucide.createIcons();
    } else {
      modal.classList.remove('active');
      App.updateUI();
    }
  },

  showToast: (msg) => {
    const toast = document.getElementById('toast');
    const msgEl = document.getElementById('toast-msg');
    if (!toast || !msgEl) return;

    msgEl.textContent = Utils.sanitizeText(msg, 200);
    toast.classList.add('show');

    // If there's a previous click handler, remove it to avoid stacking listeners
    if (App._toastClickHandler) {
      toast.removeEventListener('click', App._toastClickHandler);
      App._toastClickHandler = null;
    }

    const hideOnClick = () => {
      toast.classList.remove('show');
      clearTimeout(App._toastTimer);
      toast.removeEventListener('click', hideOnClick);
      if (App._toastClickHandler === hideOnClick) App._toastClickHandler = null;
    };

    App._toastClickHandler = hideOnClick;
    toast.addEventListener('click', hideOnClick);

    clearTimeout(App._toastTimer);
    App._toastTimer = setTimeout(() => {
      toast.classList.remove('show');
      toast.removeEventListener('click', hideOnClick);
      if (App._toastClickHandler === hideOnClick) App._toastClickHandler = null;
    }, 3000);
  },

  renderParticles: () => {
    const canvas = document.getElementById('bg-canvas');
    if (!canvas) return;
    // Respect user's reduced-motion preference
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    // Simple performance gate for small screens
    if (window.innerWidth <= 768) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let particles = [];
    const resize = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };
    window.addEventListener('resize', Utils.throttle(resize, 250));
    resize();

    for (let i = 0; i < 40; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 2,
        d: Math.random() * Math.PI * 2,
        s: Math.random() * 0.5 + 0.1,
        c: Math.random() > 0.5 ? '#f59e0b' : '#64748b'
      });
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.x += Math.cos(p.d) * p.s;
        p.y += Math.sin(p.d) * p.s;

        if (p.x < 0) p.x = canvas.width;
        if (p.x > canvas.width) p.x = 0;
        if (p.y < 0) p.y = canvas.height;
        if (p.y > canvas.height) p.y = 0;

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = p.c;
        ctx.globalAlpha = 0.3;
        ctx.fill();
      });
      requestAnimationFrame(animate);
    }
    animate();
  }
};

// ============================================
// ADMIN
// ============================================
const Admin = {
  render: () => {
    try {
      Admin.renderTravel();
      Admin.renderServices();
      Admin.renderHolidays();
      Admin.renderRanges();
      Admin.renderBonuses();
      Admin.renderPayments();
      Admin.renderLinks();
      if (window.lucide) lucide.createIcons();
      DataManager.updateStats();
    } catch (err) {
      console.error('❌ Admin render error:', err);
    }
  },

  toggleSection: (headerElement) => {
    if (!headerElement) return;
    const content = headerElement.nextElementSibling;
    const icon = headerElement.querySelector('i');
    if (content) content.classList.toggle('open');
    if (icon) {
      icon.style.transform = content && content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)';
    }
  },

};

// ============================================
// BOOT
// ============================================
// Warn before leaving when cart isn't empty
window.addEventListener('beforeunload', (e) => {
  try {
    if (typeof State !== 'undefined' && Array.isArray(State.cart) && State.cart.length > 0) {
      e.preventDefault();
      e.returnValue = '';
    }
  } catch (_) {}
});

document.addEventListener('DOMContentLoaded', () => {
  App.init();
});

</script>
  <script>
/* === Inlined from admin.js === */
/* ============================================
   ILLUSIONIST OS - ADMIN.JS
   Методы администрирования базы данных
   ============================================ */

// Продолжение Admin объекта
Object.assign(Admin, {
  // ========== TRAVEL (ЛОГИСТИКА) ==========
  renderTravel: () => {
    const container = document.getElementById('settings-travel-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!DB.travel || !Utils.isValidObject(DB.travel)) {
      container.textContent = 'Нет регионов';
      return;
    }

    Object.keys(DB.travel).sort().forEach(region => {
      const regionData = DB.travel[region];
      if (!Utils.isValidObject(regionData)) return;

      const wrapper = Utils.createElement('div', 'bg-white/5 rounded-xl p-4 mb-3');

      const header = Utils.createElement('div', 'admin-header');
      header.addEventListener('click', function() {
        Admin.toggleSection(this);
      });

      const titleSpan = Utils.createElement('span', 'font-bold text-base text-amber-500');
      titleSpan.textContent = region;

      const iconEl = document.createElement('i');
      iconEl.setAttribute('data-lucide', 'chevron-down');
      iconEl.className = 'w-5 h-5 text-slate-500 transition-transform';

      header.appendChild(titleSpan);
      header.appendChild(iconEl);

      const content = Utils.createElement('div', 'admin-content');

      const feeRow = Admin.createFeeRow(region, regionData.fee || 0);
      content.appendChild(feeRow);

      if (Utils.isValidObject(regionData.cities)) {
        Object.keys(regionData.cities).sort().forEach(city => {
          const cityRow = Admin.createCityRow(region, city, regionData.cities[city]);
          content.appendChild(cityRow);
        });
      }

      const addCityBtn = Utils.createElement('button', 'btn-add mt-3 text-sm', '+ Город');
      addCityBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        Admin.addCity(region);
      });
      content.appendChild(addCityBtn);

      const delRegionBtn = Utils.createElement(
        'button',
        'text-xs text-red-400 mt-4 w-full text-right opacity-60 hover:opacity-100 transition',
        'Удалить регион'
      );
      delRegionBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        Admin.delRegion(region);
      });
      content.appendChild(delRegionBtn);

      wrapper.appendChild(header);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    });
  },

  createFeeRow: (region, fee) => {
    const row = Utils.createElement('div', 'edit-row mb-4 pb-4 border-b border-white/5');
    const label = Utils.createElement('span', 'text-sm text-slate-400 flex-shrink-0 w-24', 'База:');
    const input = Utils.createElement('input', 'edit-input w-32 text-right mono');
    input.type = 'number';
    input.value = fee;
    input.min = '0';
    input.addEventListener('change', () => Admin.setRegionFee(region, input.value));
    row.appendChild(label);
    row.appendChild(input);
    return row;
  },

  createCityRow: (region, city, price) => {
    const row = Utils.createElement('div', 'edit-row ml-4');

    const nameInput = Utils.createElement('input', 'edit-input flex-1');
    nameInput.value = city;
    nameInput.maxLength = 100;
    nameInput.addEventListener('change', () => {
      const newName = Utils.sanitizeText(nameInput.value, 100);
      if (newName && newName !== city) Admin.renameCity(region, city, newName);
      else nameInput.value = city;
    });

    const priceInput = Utils.createElement('input', 'edit-input w-32 text-right mono');
    priceInput.type = 'number';
    priceInput.value = price;
    priceInput.min = '0';
    priceInput.addEventListener('change', () => Admin.setCityPrice(region, city, priceInput.value));

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delCity(region, city));

    row.appendChild(nameInput);
    row.appendChild(priceInput);
    row.appendChild(delBtn);
    return row;
  },

  addRegion: () => {
    const name = prompt('Название региона:');
    if (!name) return;

    const sanitized = Utils.sanitizeText(name, 100);
    if (!sanitized) {
      App.showToast('Некорректное имя');
      return;
    }
    if (DB.travel[sanitized]) {
      App.showToast('Регион уже существует');
      return;
    }

    DB.travel[sanitized] = { fee: 0, cities: {} };
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  delRegion: (region) => {
    if (!confirm(`Удалить регион "${region}"?`)) return;
    delete DB.travel[region];
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  setRegionFee: (region, value) => {
    if (!DB.travel[region]) return;
    DB.travel[region].fee = Utils.sanitizeNumber(value, 0);
    Storage.save();
  },

  addCity: (region) => {
    if (!DB.travel[region]) return;
    const name = prompt('Название города:');
    if (!name) return;

    const sanitized = Utils.sanitizeText(name, 100);
    if (!sanitized) {
      App.showToast('Некорректное имя');
      return;
    }

    DB.travel[region].cities[sanitized] = 0;
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  delCity: (region, city) => {
    if (!DB.travel[region] || !DB.travel[region].cities) return;
    delete DB.travel[region].cities[city];
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  renameCity: (region, oldName, newName) => {
    if (!DB.travel[region] || !DB.travel[region].cities) return;
    if (oldName === newName) return;
    const price = DB.travel[region].cities[oldName];
    delete DB.travel[region].cities[oldName];
    DB.travel[region].cities[newName] = price;
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  setCityPrice: (region, city, value) => {
    if (!DB.travel[region] || !DB.travel[region].cities) return;
    DB.travel[region].cities[city] = Utils.sanitizeNumber(value, 0);
    Storage.save();
  },

  // ========== SERVICES (УСЛУГИ) ==========
  renderServices: () => {
    const container = document.getElementById('settings-services-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!DB.services || !Utils.isValidObject(DB.services)) {
      container.textContent = 'Нет категорий';
      return;
    }

    Object.keys(DB.services).sort().forEach(category => {
      const services = DB.services[category];
      if (!Utils.isValidObject(services)) return;

      const wrapper = Utils.createElement('div', 'bg-white/5 rounded-xl p-4 mb-3');

      const header = Utils.createElement('div', 'admin-header');
      header.addEventListener('click', function() {
        Admin.toggleSection(this);
      });

      const titleSpan = Utils.createElement('span', 'font-bold text-base text-purple-400');
      titleSpan.textContent = category;

      const iconEl = document.createElement('i');
      iconEl.setAttribute('data-lucide', 'chevron-down');
      iconEl.className = 'w-5 h-5 text-slate-500 transition-transform';

      header.appendChild(titleSpan);
      header.appendChild(iconEl);

      const content = Utils.createElement('div', 'admin-content');

      Object.keys(services).sort().forEach(service => {
        const serviceRow = Admin.createServiceRow(category, service, services[service]);
        content.appendChild(serviceRow);
      });

      const addSvcBtn = Utils.createElement('button', 'btn-add mt-3 text-sm', '+ Услуга');
      addSvcBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        Admin.addSvc(category);
      });
      content.appendChild(addSvcBtn);

      const delCatBtn = Utils.createElement(
        'button',
        'text-xs text-red-400 mt-4 w-full text-right opacity-60 hover:opacity-100 transition',
        'Удалить категорию'
      );
      delCatBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        Admin.delCat(category);
      });
      content.appendChild(delCatBtn);

      wrapper.appendChild(header);
      wrapper.appendChild(content);
      container.appendChild(wrapper);
    });
  },

  createServiceRow: (category, service, price) => {
    const row = Utils.createElement('div', 'edit-row ml-4');

    const nameInput = Utils.createElement('input', 'edit-input flex-1');
    nameInput.value = service;
    nameInput.maxLength = 200;
    nameInput.addEventListener('change', () => {
      const newName = Utils.sanitizeText(nameInput.value, 200);
      if (newName && newName !== service) Admin.renameSvc(category, service, newName);
      else nameInput.value = service;
    });

    const priceInput = Utils.createElement('input', 'edit-input w-32 text-right mono');
    priceInput.type = 'number';
    priceInput.value = price;
    priceInput.min = '0';
    priceInput.addEventListener('change', () => Admin.setSvcPrice(category, service, priceInput.value));

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delSvc(category, service));

    row.appendChild(nameInput);
    row.appendChild(priceInput);
    row.appendChild(delBtn);
    return row;
  },

  addCategory: () => {
    const name = prompt('Название категории:');
    if (!name) return;

    const sanitized = Utils.sanitizeText(name, 100);
    if (!sanitized) {
      App.showToast('Некорректное имя');
      return;
    }
    if (DB.services[sanitized]) {
      App.showToast('Категория уже существует');
      return;
    }

    DB.services[sanitized] = {};
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  delCat: (category) => {
    if (!confirm(`Удалить категорию "${category}"?`)) return;
    delete DB.services[category];
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  addSvc: (category) => {
    if (!DB.services[category]) return;
    const name = prompt('Название услуги:');
    if (!name) return;

    const sanitized = Utils.sanitizeText(name, 200);
    if (!sanitized) {
      App.showToast('Некорректное имя');
      return;
    }

    DB.services[category][sanitized] = 0;
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  delSvc: (category, service) => {
    if (!DB.services[category]) return;
    delete DB.services[category][service];
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  renameSvc: (category, oldName, newName) => {
    if (!DB.services[category]) return;
    if (oldName === newName) return;
    const price = DB.services[category][oldName];
    delete DB.services[category][oldName];
    DB.services[category][newName] = price;
    Storage.save();
    Admin.render();
    App.updateUI();
  },

  setSvcPrice: (category, service, value) => {
    if (!DB.services[category]) return;
    DB.services[category][service] = Utils.sanitizeNumber(value, 0);
    Storage.save();
  },

  // ========== HOLIDAYS (ПРАЗДНИКИ) ==========
  renderHolidays: () => {
    const container = document.getElementById('settings-holidays-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!DB.holidays || !Utils.isValidObject(DB.holidays)) {
      container.textContent = 'Нет праздничных дат';
      return;
    }

    Object.keys(DB.holidays).sort().forEach(key => {
      container.appendChild(Admin.createHolidayRow(key, DB.holidays[key]));
    });
  },

  createHolidayRow: (key, value) => {
    const row = Utils.createElement('div', 'edit-row');

    const keyInput = Utils.createElement('input', 'edit-input w-32 text-center mono');
    keyInput.value = key;
    keyInput.placeholder = 'MM-DD';
    keyInput.maxLength = 5;
    keyInput.addEventListener('change', () => {
      const newKey = keyInput.value.trim();
      if (Utils.validateDateKey(newKey) && newKey !== key) {
        Admin.updateHolidayKey(key, newKey);
      } else {
        keyInput.value = key;
        if (!Utils.validateDateKey(newKey)) {
          Utils.validateInput(keyInput, () => false);
          App.showToast('Неверный формат даты (MM-DD)');
        }
      }
    });

    const valInput = Utils.createElement('input', 'edit-input w-28 text-center text-amber-400 font-extrabold mono');
    valInput.type = 'number';
    valInput.value = value;
    valInput.min = '1';
    valInput.max = '10';
    valInput.step = '0.1';
    valInput.addEventListener('change', () => Admin.updateHolidayVal(key, valInput.value));

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delHoliday(key));

    row.appendChild(keyInput);
    row.appendChild(valInput);
    row.appendChild(delBtn);
    return row;
  },

  addHoliday: () => {
    const date = prompt('Дата (ММ-ДД):', '12-31');
    if (!date) return;
    if (!Utils.validateDateKey(date)) {
      App.showToast('Неверный формат даты (MM-DD)');
      return;
    }
    DB.holidays[date] = 1.5;
    Storage.save();
    Admin.render();
  },

  delHoliday: (key) => {
    delete DB.holidays[key];
    Storage.save();
    Admin.render();
  },

  updateHolidayKey: (oldKey, newKey) => {
    const value = DB.holidays[oldKey];
    delete DB.holidays[oldKey];
    DB.holidays[newKey] = value;
    Storage.save();
    Admin.render();
  },

  updateHolidayVal: (key, value) => {
    DB.holidays[key] = Utils.sanitizeFloat(value, 1, 10);
    Storage.save();
  },

  // ========== HOLIDAY RANGES (ПЕРИОДЫ) ==========
  renderRanges: () => {
    const container = document.getElementById('settings-ranges-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!DB.holidayRanges || !Array.isArray(DB.holidayRanges) || DB.holidayRanges.length === 0) {
      container.textContent = 'Нет периодов';
      return;
    }

    DB.holidayRanges.forEach((range, index) => {
      container.appendChild(Admin.createRangeRow(range, index));
    });
  },

  createRangeRow: (range, index) => {
    const row = Utils.createElement('div', 'edit-row');

    const start = `${String(range.sm || 12).padStart(2, '0')}-${String(range.sd || 1).padStart(2, '0')}`;
    const end = `${String(range.em || 12).padStart(2, '0')}-${String(range.ed || 31).padStart(2, '0')}`;

    const startInput = Utils.createElement('input', 'edit-input w-28 text-center text-sm mono');
    startInput.value = start;
    startInput.maxLength = 5;
    startInput.addEventListener('change', () => Admin.updateRange(index, 'start', startInput.value));

    const arrow = Utils.createElement('span', 'text-slate-500 text-lg', '→');

    const endInput = Utils.createElement('input', 'edit-input w-28 text-center text-sm mono');
    endInput.value = end;
    endInput.maxLength = 5;
    endInput.addEventListener('change', () => Admin.updateRange(index, 'end', endInput.value));

    const kInput = Utils.createElement('input', 'edit-input w-24 text-center text-amber-400 font-extrabold mono');
    kInput.type = 'number';
    kInput.value = range.k || 1.5;
    kInput.min = '1';
    kInput.max = '10';
    kInput.step = '0.1';
    kInput.addEventListener('change', () => Admin.updateRange(index, 'k', kInput.value));

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delRange(index));

    row.appendChild(startInput);
    row.appendChild(arrow);
    row.appendChild(endInput);
    row.appendChild(kInput);
    row.appendChild(delBtn);
    return row;
  },

  addRange: () => {
    const start = prompt('Старт периода (ММ-ДД):', '12-20');
    if (!start) return;
    if (!Utils.validateDateKey(start)) {
      App.showToast('Неверный старт (MM-DD)');
      return;
    }

    const end = prompt('Конец периода (ММ-ДД):', '12-30');
    if (!end) return;
    if (!Utils.validateDateKey(end)) {
      App.showToast('Неверный конец (MM-DD)');
      return;
    }

    const kStr = prompt('Коэффициент (например 1.5):', '1.5');
    if (kStr === null) return;
    const k = Utils.sanitizeFloat(kStr, 1, 10, 1.5);

    const s = Utils.parseMonthDay(start);
    const e = Utils.parseMonthDay(end);
    if (!s || !e) {
      App.showToast('Неверный формат даты');
      return;
    }

    if (!Array.isArray(DB.holidayRanges)) DB.holidayRanges = [];
    DB.holidayRanges.push({ sm: s.mm, sd: s.dd, em: e.mm, ed: e.dd, k });
    Storage.save();
    Admin.render();
  },

  updateRange: (index, field, value) => {
    if (!Array.isArray(DB.holidayRanges) || !DB.holidayRanges[index]) return;
    const r = DB.holidayRanges[index];

    if (field === 'k') {
      r.k = Utils.sanitizeFloat(value, 1, 10, r.k || 1.5);
      Storage.save();
      return;
    }

    const md = Utils.parseMonthDay(value);
    if (!md) {
      App.showToast('Неверный формат (MM-DD)');
      Admin.render();
      return;
    }

    if (field === 'start') {
      r.sm = md.mm;
      r.sd = md.dd;
    }
    if (field === 'end') {
      r.em = md.mm;
      r.ed = md.dd;
    }

    Storage.save();
    Admin.render();
  },

  delRange: (index) => {
    if (!Array.isArray(DB.holidayRanges)) return;
    DB.holidayRanges.splice(index, 1);
    Storage.save();
    Admin.render();
  },

  // ========== BONUSES (БОНУСЫ) ==========
  renderBonuses: () => {
    const container = document.getElementById('settings-bonuses-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!Array.isArray(DB.bonuses) || DB.bonuses.length === 0) {
      container.innerHTML = `<div class="text-sm text-slate-500">Нет бонусов</div>`;
      return;
    }

    DB.bonuses
      .slice()
      .sort((a, b) => (a.threshold || 0) - (b.threshold || 0))
      .forEach((bonus, idx) => {
        container.appendChild(Admin.createBonusRow(bonus, idx));
      });
  },

  createBonusRow: (bonus, idx) => {
    const row = Utils.createElement('div', 'edit-row');

    const thr = Utils.createElement('input', 'edit-input w-36 text-right mono');
    thr.type = 'number';
    thr.value = bonus.threshold ?? 0;
    thr.min = '0';
    thr.addEventListener('change', () => {
      DB.bonuses[idx].threshold = Utils.sanitizeNumber(thr.value, 0, 999999, 0);
      Storage.save();
      App.calc();
      Admin.renderBonuses();
    });

    const text = Utils.createElement('input', 'edit-input flex-1');
    text.value = bonus.text ?? '';
    text.maxLength = 200;
    text.addEventListener('change', () => {
      DB.bonuses[idx].text = Utils.sanitizeText(text.value, 200);
      Storage.save();
      App.calc();
      Admin.renderBonuses();
    });

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delBonus(idx));

    row.appendChild(thr);
    row.appendChild(text);
    row.appendChild(delBtn);
    return row;
  },

  addBonus: () => {
    const thr = prompt('Порог (₽):', '50000');
    if (thr === null) return;
    const threshold = Utils.sanitizeNumber(thr, 0, 999999, 0);

    const text = prompt('Текст бонуса:', 'Бонус клиенту');
    if (!text) return;

    if (!Array.isArray(DB.bonuses)) DB.bonuses = [];
    DB.bonuses.push({
      threshold,
      text: Utils.sanitizeText(text, 200)
    });
    Storage.save();
    App.calc();
    Admin.renderBonuses();
  },

  delBonus: (idx) => {
    if (!Array.isArray(DB.bonuses) || !DB.bonuses[idx]) return;
    if (!confirm('Удалить бонус?')) return;
    DB.bonuses.splice(idx, 1);
    Storage.save();
    App.calc();
    Admin.renderBonuses();
  },

  // ========== PAYMENTS (РЕКВИЗИТЫ) ==========
  renderPayments: () => {
    const container = document.getElementById('settings-payments-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!Array.isArray(DB.payments) || DB.payments.length === 0) {
      container.innerHTML = `<div class="text-sm text-slate-500">Нет реквизитов</div>`;
      return;
    }

    DB.payments.forEach((p, idx) => {
      container.appendChild(Admin.createPaymentRow(p, idx));
    });
  },

  createPaymentRow: (p, idx) => {
    const row = Utils.createElement('div', 'edit-row');

    const title = Utils.createElement('input', 'edit-input w-40');
    title.value = p.title ?? '';
    title.maxLength = 100;
    title.addEventListener('change', () => {
      DB.payments[idx].title = Utils.sanitizeText(title.value, 100);
      Storage.save();
    });

    const text = Utils.createElement('input', 'edit-input flex-1');
    text.value = p.text ?? '';
    text.maxLength = 500;
    text.addEventListener('change', () => {
      DB.payments[idx].text = Utils.sanitizeText(text.value, 500);
      Storage.save();
    });

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delPayment(idx));

    row.appendChild(title);
    row.appendChild(text);
    row.appendChild(delBtn);
    return row;
  },

  addPayment: () => {
    const title = prompt('Название реквизитов:', 'Перевод');
    if (!title) return;
    const text = prompt('Текст реквизитов:', 'СБП / карта: ...');
    if (!text) return;

    if (!Array.isArray(DB.payments)) DB.payments = [];
    DB.payments.push({
      title: Utils.sanitizeText(title, 100),
      text: Utils.sanitizeText(text, 500)
    });
    Storage.save();
    Admin.renderPayments();
  },

  delPayment: (idx) => {
    if (!Array.isArray(DB.payments) || !DB.payments[idx]) return;
    if (!confirm('Удалить реквизиты?')) return;
    DB.payments.splice(idx, 1);
    Storage.save();
    Admin.renderPayments();
  },

  // ========== LINKS (ССЫЛКИ) ==========
  renderLinks: () => {
    const container = document.getElementById('settings-links-list');
    if (!container) return;

    Utils.clearElement(container);

    if (!Array.isArray(DB.links) || DB.links.length === 0) {
      container.innerHTML = `<div class="text-sm text-slate-500">Нет ссылок</div>`;
      return;
    }

    DB.links.forEach((l, idx) => {
      container.appendChild(Admin.createLinkRow(l, idx));
    });
  },

  createLinkRow: (l, idx) => {
    const row = Utils.createElement('div', 'edit-row');

    const label = Utils.createElement('input', 'edit-input w-40');
    label.value = l.label ?? '';
    label.maxLength = 100;
    label.addEventListener('change', () => {
      DB.links[idx].label = Utils.sanitizeText(label.value, 100);
      Storage.save();
    });

    const url = Utils.createElement('input', 'edit-input flex-1 mono');
    url.value = l.url ?? '';
    url.maxLength = 500;
    url.addEventListener('change', () => {
      DB.links[idx].url = Utils.sanitizeText(url.value, 500);
      Storage.save();
    });

    const delBtn = Utils.createElement('button', 'btn-del-mini');
    delBtn.innerHTML = '<i data-lucide="trash-2" class="w-5 h-5"></i>';
    delBtn.addEventListener('click', () => Admin.delLink(idx));

    row.appendChild(label);
    row.appendChild(url);
    row.appendChild(delBtn);
    return row;
  },

  addLink: () => {
    const label = prompt('Название ссылки:', 'Портфолио');
    if (!label) return;
    const url = prompt('URL:', 'https://');
    if (!url) return;

    if (!Array.isArray(DB.links)) DB.links = [];
    DB.links.push({
      label: Utils.sanitizeText(label, 100),
      url: Utils.sanitizeText(url, 500)
    });
    Storage.save();
    Admin.renderLinks();
  },

  delLink: (idx) => {
    if (!Array.isArray(DB.links) || !DB.links[idx]) return;
    if (!confirm('Удалить ссылку?')) return;
    DB.links.splice(idx, 1);
    Storage.save();
    Admin.renderLinks();
  },

  // ========== RESET ==========
  reset: () => {
    const hard = confirm('Сбросить базу цен на дефолт?\n\nOK = Сбросить\nОтмена = Отмена');
    if (!hard) return;

    try {
      DataManager.createBackup('Перед сбросом');
    } catch (e) {}

    DB = JSON.parse(JSON.stringify(DEFAULT_DB));
    DB.version = DB_VERSION;
    Storage.save();

    State.cart = [];
    State.finalTotal = 0;
    State.serviceQty = 1;

    App.updateUI();
    App.renderCart();
    App.calc();
    App.showToast('База сброшена');
  }
});

</script>
  <script>
/* === Inlined from modules.js === */
/* ============================================
   ILLUSIONIST OS - MODULES.JS
   Модули: Templates, Rounding, Variants
   ============================================ */

'use strict';

// ============================================
// TEMPLATES MODULE
// ============================================
const TEMPLATES_KEY = 'illusionist_templates';

const Templates = {
  load: () => Utils.loadFromStorage(TEMPLATES_KEY, []),
  
  save: (templates) => Utils.saveToStorage(TEMPLATES_KEY, templates),

  createFromCart: () => {
    if (State.cart.length === 0) {
      App.showToast('Корзина пуста');
      return false;
    }

    const name = prompt('Название шаблона:', 'Мой шаблон');
    if (!name) return false;

    const sanitizedName = Utils.sanitizeText(name, 50);
    if (!sanitizedName) {
      App.showToast('Некорректное название');
      return false;
    }

    const templates = Templates.load();

    if (templates.some(t => t.name === sanitizedName)) {
      if (!confirm(`Шаблон "${sanitizedName}" уже существует. Заменить?`)) return false;
      const idx = templates.findIndex(t => t.name === sanitizedName);
      if (idx >= 0) templates.splice(idx, 1);
    }

    const baseTotal = State.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

    const template = {
      id: Date.now(),
      name: sanitizedName,
      items: JSON.parse(JSON.stringify(State.cart)),
      baseTotal: baseTotal,
      createdAt: new Date().toISOString()
    };

    templates.unshift(template);
    if (templates.length > 10) templates.pop();

    Templates.save(templates);
    Templates.render();
    Templates.updateSaveButton();

    App.showToast(`Шаблон "${sanitizedName}" сохранён`);
    return true;
  },

  apply: (templateId) => {
    const templates = Templates.load();
    const template = templates.find(t => t.id === templateId);

    if (!template) {
      App.showToast('Шаблон не найден');
      return false;
    }

    let mode = 'replace';
    if (State.cart.length > 0) {
      const action = confirm(`Корзина не пуста.\n\nOK = Заменить корзину\nОтмена = Добавить к текущей`);
      mode = action ? 'replace' : 'add';
    }

    if (mode === 'replace') {
      State.cart = JSON.parse(JSON.stringify(template.items));
    } else {
      template.items.forEach(item => {
        State.cart.push(JSON.parse(JSON.stringify(item)));
      });
    }

    App.renderCart();
    App.calc();
    Templates.updateSaveButton();

    App.showToast(`Шаблон "${template.name}" применён`);
    return true;
  },

  delete: (templateId) => {
    const templates = Templates.load();
    const template = templates.find(t => t.id === templateId);
    if (!template) return false;

    if (!confirm(`Удалить шаблон "${template.name}"?`)) return false;

    Templates.save(templates.filter(t => t.id !== templateId));
    Templates.render();
    Templates.updateSaveButton();
    App.showToast('Шаблон удалён');
    return true;
  },

  pluralize: (n, forms) => {
    const n10 = n % 10;
    const n100 = n % 100;
    if (n10 === 1 && n100 !== 11) return forms[0];
    if (n10 >= 2 && n10 <= 4 && (n100 < 10 || n100 >= 20)) return forms[1];
    return forms[2];
  },

  renderTo: (containerId, emptyId) => {
    const container = document.getElementById(containerId);
    const emptyMsg = document.getElementById(emptyId);
    if (!container) return;

    const templates = Templates.load();
    Utils.clearElement(container);

    if (templates.length === 0) {
      container.classList.add('hidden');
      if (emptyMsg) emptyMsg.classList.remove('hidden');
      return;
    }

    container.classList.remove('hidden');
    if (emptyMsg) emptyMsg.classList.add('hidden');

    templates.forEach(template => {
      const card = Utils.createElement('div', 'template-card');
      card.dataset.id = template.id;

      const itemsCount = template.items.reduce((sum, item) => sum + item.qty, 0);
      const itemsWord = Templates.pluralize(itemsCount, ['услуга', 'услуги', 'услуг']);

      card.innerHTML = `
        <div class="template-name">${Utils.escapeHtml(template.name)}</div>
        <div class="template-info">${itemsCount} ${itemsWord}</div>
        <div class="template-price">${Utils.formatPrice(template.baseTotal)} ₽</div>
        <button class="template-delete" title="Удалить">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      `;

      card.addEventListener('click', (e) => {
        if (e.target.closest('.template-delete')) return;
        Templates.apply(template.id);
      });

      const delBtn = card.querySelector('.template-delete');
      if (delBtn) {
        delBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          Templates.delete(template.id);
        });
      }

      container.appendChild(card);
    });

    if (window.lucide) lucide.createIcons();
  },

  render: () => {
    Templates.renderTo('templates-list', 'templates-empty');
    Templates.renderTo('templates-list-modal', 'templates-empty-modal');
  },

  updateSaveButton: () => {
    const btn = document.getElementById('btn-save-as-template');
    if (btn) {
      State.cart.length > 0 ? btn.classList.remove('hidden') : btn.classList.add('hidden');
    }
  },

  openModal: () => {
    const modal = document.getElementById('templates-modal');
    if (!modal) return;
    Templates.render();
    modal.classList.add('active');
    if (window.lucide) lucide.createIcons();
  },

  closeModal: () => {
    const modal = document.getElementById('templates-modal');
    if (!modal) return;
    modal.classList.remove('active');
  },

  init: () => {
    document.getElementById('btn-save-as-template')?.addEventListener('click', Templates.createFromCart);
    document.getElementById('btn-save-as-template-modal')?.addEventListener('click', () => {
      const ok = Templates.createFromCart();
      if (ok) Templates.openModal();
    });

    document.getElementById('btn-open-templates-modal')?.addEventListener('click', Templates.openModal);
    document.getElementById('btn-open-templates-modal')?.addEventListener('touchstart', Templates.openModal, { passive: true });

    document.getElementById('btn-close-templates-modal')?.addEventListener('click', Templates.closeModal);
    document.getElementById('templates-modal')?.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'templates-modal') Templates.closeModal();
    });

    Templates.render();
    Templates.updateSaveButton();
    console.log('✅ Templates module initialized');
  }
};

// ============================================
// ROUNDING MODULE
// ============================================
const Rounding = {
  step: 1000,

  state: {
    isApplied: false,
    originalTotal: 0,
    roundedTotal: 0,
    diff: 0
  },

  calculate: (total) => {
    if (total <= 0) return { down: 0, nearest: 0, up: 0 };
    const step = Rounding.step;
    const down = Math.floor(total / step) * step;
    const up = Math.ceil(total / step) * step;
    const nearest = (total - down) < (up - total) ? down : up;

    if (total === down) {
      return { down: down - step, nearest: down, up: down + step };
    }
    return { down, nearest, up };
  },

  apply: (roundedValue) => {
    const originalTotal = Rounding.state.isApplied ? Rounding.state.originalTotal : State.finalTotal;

    if (roundedValue === originalTotal) {
      Rounding.reset();
      return;
    }

    Rounding.state.isApplied = true;
    Rounding.state.originalTotal = originalTotal;
    Rounding.state.roundedTotal = roundedValue;
    Rounding.state.diff = roundedValue - originalTotal;

    State.finalTotal = roundedValue;

    const totalEl = document.getElementById('total-sum');
    if (totalEl) {
      totalEl.classList.add('round-pulse');
      totalEl.textContent = `${Utils.formatPrice(roundedValue)} ₽`;
      setTimeout(() => totalEl.classList.remove('round-pulse'), 300);
    }

    Rounding.updateUI();
    App.updateBonuses();

    const diffStr = Rounding.state.diff >= 0 
      ? `+${Utils.formatPrice(Rounding.state.diff)}` 
      : Utils.formatPrice(Rounding.state.diff);
    App.showToast(`Округлено: ${diffStr} ₽`);
  },

  reset: () => {
    if (!Rounding.state.isApplied) return;

    State.finalTotal = Rounding.state.originalTotal;

    const totalEl = document.getElementById('total-sum');
    if (totalEl) {
      totalEl.textContent = `${Utils.formatPrice(State.finalTotal)} ₽`;
    }

    Rounding.state = {
      isApplied: false,
      originalTotal: 0,
      roundedTotal: 0,
      diff: 0
    };
    Rounding.updateUI();
    App.updateBonuses();

    App.showToast('Округление сброшено');
  },

  clearStateSilently: () => {
    Rounding.state = {
      isApplied: false,
      originalTotal: 0,
      roundedTotal: 0,
      diff: 0
    };
  },

  updateUI: () => {
    const controls = document.getElementById('rounding-controls');
    const applied = document.getElementById('rounding-applied');
    const resetBtn = document.getElementById('btn-round-reset');
    const diffEl = document.getElementById('rounding-diff');

    const baseTotal = Rounding.state.isApplied ? Rounding.state.originalTotal : State.finalTotal;

    if (baseTotal > 0) {
      if (controls) controls.classList.remove('hidden');

      const options = Rounding.calculate(baseTotal);

      const downEl = document.getElementById('round-down-value');
      const nearestEl = document.getElementById('round-nearest-value');
      const upEl = document.getElementById('round-up-value');

      if (downEl) downEl.textContent = Utils.formatPrice(options.down);
      if (nearestEl) nearestEl.textContent = Utils.formatPrice(options.nearest);
      if (upEl) upEl.textContent = Utils.formatPrice(options.up);
    } else {
      if (controls) controls.classList.add('hidden');
    }

    if (Rounding.state.isApplied) {
      if (applied) applied.classList.remove('hidden');
      if (resetBtn) resetBtn.classList.remove('hidden');

      if (diffEl) {
        const diffStr = Rounding.state.diff >= 0 
          ? `+${Utils.formatPrice(Rounding.state.diff)} ₽` 
          : `${Utils.formatPrice(Rounding.state.diff)} ₽`;
        diffEl.textContent = diffStr;
      }
    } else {
      if (applied) applied.classList.add('hidden');
      if (resetBtn) resetBtn.classList.add('hidden');
    }

    if (window.lucide) lucide.createIcons();
  },

  setStep: (step) => {
    Rounding.step = Utils.sanitizeNumber(step, 100, 100000, 1000);
    Rounding.updateUI();
  },

  init: () => {
    const downBtn = document.getElementById('btn-round-down');
    const nearestBtn = document.getElementById('btn-round-nearest');
    const upBtn = document.getElementById('btn-round-up');
    const resetBtn = document.getElementById('btn-round-reset');

    if (downBtn) {
      downBtn.addEventListener('click', () => {
        const baseTotal = Rounding.state.isApplied ? Rounding.state.originalTotal : State.finalTotal;
        const options = Rounding.calculate(baseTotal);
        Rounding.apply(options.down);
      });
    }

    if (nearestBtn) {
      nearestBtn.addEventListener('click', () => {
        const baseTotal = Rounding.state.isApplied ? Rounding.state.originalTotal : State.finalTotal;
        const options = Rounding.calculate(baseTotal);
        Rounding.apply(options.nearest);
      });
    }

    if (upBtn) {
      upBtn.addEventListener('click', () => {
        const baseTotal = Rounding.state.isApplied ? Rounding.state.originalTotal : State.finalTotal;
        const options = Rounding.calculate(baseTotal);
        Rounding.apply(options.up);
      });
    }

    if (resetBtn) resetBtn.addEventListener('click', Rounding.reset);

    console.log('✅ Rounding module initialized');
  }
};

// ============================================
// VARIANTS MODULE
// ============================================
const Variants = {
  current: { base: null, optimal: null, premium: null },

  open: () => {
    const modal = document.getElementById('variants-modal');
    if (!modal) return;

    const v = Variants.generate();
    if (!v) return;

    Variants.renderModal(v);
    modal.classList.add('active');
    if (window.lucide) lucide.createIcons();
  },

  close: () => {
    const modal = document.getElementById('variants-modal');
    if (!modal) return;
    modal.classList.remove('active');
  },

  findUpgrade: (item, multiplier = 1.2) => {
    if (!item || typeof item.price !== 'number') return null;

    const target = item.price * multiplier;
    let candidates = [];

    const scanAll = () => {
      if (!DB.services || !Utils.isValidObject(DB.services)) return;
      Object.keys(DB.services).forEach(cat => {
        const services = DB.services[cat];
        if (!Utils.isValidObject(services)) return;
        Object.keys(services).forEach(name => {
          const price = services[name];
          if (typeof price !== 'number' || isNaN(price)) return;
          candidates.push({ name, price });
        });
      });
    };

    scanAll();

    const above = candidates
      .filter(c => c.price >= target)
      .sort((a, b) => a.price - b.price);

    if (above.length === 0) return null;

    const best = above[0];
    return {
      name: Utils.sanitizeText(best.name, 200),
      price: best.price,
      qty: item.qty
    };
  },

  findExtraService: (existingItems) => {
    const existingNames = new Set((existingItems || []).map(i => i.name));
    let all = [];
    if (DB.services && Utils.isValidObject(DB.services)) {
      Object.keys(DB.services).forEach(cat => {
        const services = DB.services[cat];
        if (!Utils.isValidObject(services)) return;
        Object.keys(services).forEach(name => {
          const price = services[name];
          if (typeof price !== 'number' || isNaN(price)) return;
          all.push({ name, price });
        });
      });
    }
    all = all.filter(s => !existingNames.has(s.name)).sort((a, b) => b.price - a.price);
    if (all.length === 0) return null;
    return {
      name: Utils.sanitizeText(all[0].name, 200),
      price: all[0].price,
      qty: 1
    };
  },

  computeTravel: (k) => {
    const regionSelect = document.getElementById('inp-region');
    const citySelect = document.getElementById('inp-city');
    let travel = 0;

    if (regionSelect && citySelect) {
      const region = regionSelect.value;
      const city = citySelect.value;

      if (region && city && DB.travel?.[region]) {
        const baseTravel = city === 'other'
          ? (DB.travel[region].fee || 0)
          : (DB.travel[region].cities?.[city] || 0);

        travel = Math.round(baseTravel * (k > 1 ? 1.5 : 1));
      }
    }
    return travel;
  },

  computeExtras: (k) => {
    const manualPriceInput = document.getElementById('inp-manual-price');
    const manPrice = manualPriceInput ? Utils.sanitizeNumber(manualPriceInput.value, 0, 999999, 0) : 0;

    const guestsSelect = document.getElementById('inp-guests');
    const guestPrice = guestsSelect ? Utils.sanitizeNumber(guestsSelect.value, 0, 999999, 0) : 0;

    const taxCheckbox = document.getElementById('inp-tax');
    const useTax = taxCheckbox ? taxCheckbox.checked : false;

    const travel = Variants.computeTravel(k);

    return { manPrice, guestPrice, travel, useTax };
  },

  calcTotalForItems: (items, k) => {
    let servicesTotal = items.reduce((acc, item) => acc + (item.price * item.qty * k), 0);
    let discount = 0;
    if (items.length > 1) {
      discount = Math.round(servicesTotal * 0.1);
      servicesTotal -= discount;
    }

    const ex = Variants.computeExtras(k);
    const preTax = servicesTotal + ex.travel + ex.manPrice + ex.guestPrice;
    const tax = ex.useTax ? Math.round(preTax * 0.06) : 0;
    const total = Math.round(preTax + tax);

    return {
      total,
      servicesTotal,
      discount,
      travel: ex.travel,
      manPrice: ex.manPrice,
      guestPrice: ex.guestPrice,
      tax,
      k
    };
  },

  generate: () => {
    if (State.cart.length === 0) {
      App.showToast('Добавьте услуги в корзину');
      return null;
    }

    const k = State.holidayK || 1;

    const baseItems = JSON.parse(JSON.stringify(State.cart));
    const optimalItems = JSON.parse(JSON.stringify(State.cart));
    const premiumItems = JSON.parse(JSON.stringify(State.cart));

    optimalItems.forEach((item, idx) => {
      const upgraded = Variants.findUpgrade(item, 1.2);
      if (upgraded) optimalItems[idx] = upgraded;
    });

    premiumItems.forEach((item, idx) => {
      const upgraded = Variants.findUpgrade(item, 1.5);
      if (upgraded) premiumItems[idx] = upgraded;
    });

    if (premiumItems.length === baseItems.length) {
      const extra = Variants.findExtraService(premiumItems);
      if (extra) premiumItems.push(extra);
    }

    const base = Variants.calcTotalForItems(baseItems, k);
    let optimal = Variants.calcTotalForItems(optimalItems, k);
    let premium = Variants.calcTotalForItems(premiumItems, k);

    if (optimal.total <= base.total) optimal.total = Math.round(base.total * 1.15);
    if (premium.total <= optimal.total) premium.total = Math.round(optimal.total * 1.2);

    const pack = {
      base: {
        label: 'Базовый',
        badge: 'badge-base',
        cls: 'variant-base',
        priceCls: 'price-base',
        items: baseItems,
        totals: base,
        total: base.total
      },
      optimal: {
        label: 'Оптимальный',
        badge: 'badge-optimal',
        cls: 'variant-optimal',
        priceCls: 'price-optimal',
        items: optimalItems,
        totals: optimal,
        total: optimal.total,
        recommended: true
      },
      premium: {
        label: 'Премиум',
        badge: 'badge-premium',
        cls: 'variant-premium',
        priceCls: 'price-premium',
        items: premiumItems,
        totals: premium,
        total: premium.total
      }
    };

    Variants.current = pack;
    return pack;
  },

  buildQuoteTextFor: (variantKey) => {
    const v = Variants.current?.[variantKey];
    if (!v) return '';

    const client = Utils.sanitizeText(document.getElementById('inp-client')?.value, 100) || 'Клиент';
    const type = document.getElementById('inp-event-type')?.value || 'Мероприятие';

    const dateRaw = document.getElementById('inp-date')?.value || '';
    const dateFmt = Utils.formatDate(dateRaw) || dateRaw;

    const time = document.getElementById('inp-time')?.value || '18:00';
    const city = document.getElementById('inp-city')?.value || '';

    const depPct = DB.config?.deposit || 30;
    const deposit = Math.round(v.total * (depPct / 100));

    let text = `${client}\n\n`;
    text += `КП (${v.label.toUpperCase()}): ${type.toUpperCase()}\n`;
    text += `${dateFmt} / ${time}\n`;
    if (city && city !== 'other') text += `${Utils.sanitizeText(city, 100)}\n`;
    text += `\nПрограмма:\n`;

    const k = State.holidayK || 1;
    v.items.forEach(item => {
      const price = Math.round(item.price * item.qty * k);
      const safeName = Utils.sanitizeText(item.name, 200);
      text += `• ${safeName}${item.qty > 1 ? ` ×${item.qty}` : ''} — ${Utils.formatPrice(price)} ₽\n`;
    });

    const details = Variants.calcTotalForItems(v.items, k);
    if (details.discount > 0) text += `Скидка 10%: -${Utils.formatPrice(details.discount)} ₽\n`;
    if (details.travel > 0) text += `Логистика: ${Utils.formatPrice(details.travel)} ₽\n`;
    if (details.guestPrice > 0) text += `Доплата за гостей: ${Utils.formatPrice(details.guestPrice)} ₽\n`;
    if (details.manPrice > 0) {
      const manName = Utils.sanitizeText(document.getElementById('inp-manual-name')?.value, 100) || 'Доп';
      text += `${manName}: ${Utils.formatPrice(details.manPrice)} ₽\n`;
    }
    if (details.tax > 0) text += `Договор (+6%): ${Utils.formatPrice(details.tax)} ₽\n`;

    const earned = App.getBonusesForTotal(v.total);
    if (earned.length > 0) {
      text += `\nБонусы:\n`;
      earned.forEach(b => {
        text += `• ${Utils.sanitizeText(b.text, 200)}\n`;
      });
    }

    text += `\nИТОГО: ${Utils.formatPrice(v.total)} ₽\n`;
    text += `Бронь даты (${depPct}%): ${Utils.formatPrice(deposit)} ₽\n`;

    if (DB.payments && Array.isArray(DB.payments)) {
      text += `\nРеквизиты:\n`;
      DB.payments.forEach(p => {
        if (Utils.isValidObject(p)) {
          const title = Utils.sanitizeText(p.title, 100);
          const payText = Utils.sanitizeText(p.text, 500);
          text += `${title}: ${payText}\n`;
        }
      });
    }

    if (DB.links && Array.isArray(DB.links)) {
      text += `\nСсылки:\n`;
      DB.links.forEach(l => {
        if (Utils.isValidObject(l)) {
          const label = Utils.sanitizeText(l.label, 100);
          const url = Utils.sanitizeText(l.url, 500);
          text += `• ${label}: ${url}\n`;
        }
      });
    }

    const performer = Utils.sanitizeText(DB.config?.performer || 'Illusionist', 100);
    text += `\nВаш ${performer}`;
    return text;
  },

  renderModal: (pack) => {
    const container = document.getElementById('variants-container');
    if (!container) return;
    Utils.clearElement(container);

    const order = ['base', 'optimal', 'premium'];

    order.forEach(key => {
      const v = pack[key];
      if (!v) return;

      const card = Utils.createElement('div', `variant-card ${v.cls}`);
      if (v.recommended) {
        const rec = Utils.createElement('div', 'variant-recommended', 'Рекомендуем');
        card.appendChild(rec);
      }

      const header = Utils.createElement('div', 'variant-header');
      header.innerHTML = `
        <span class="variant-badge ${v.badge}">${Utils.escapeHtml(v.label)}</span>
        <span class="variant-price ${v.priceCls}">${Utils.formatPrice(v.total)} ₽</span>
      `;

      const list = document.createElement('ul');
      list.className = 'variant-items';
      v.items.forEach(it => {
        const li = document.createElement('li');
        li.textContent = `${it.name}${it.qty > 1 ? ` ×${it.qty}` : ''}`;
        list.appendChild(li);
      });

      const bonuses = App.getBonusesForTotal(v.total);
      const bonusesWrap = Utils.createElement('div', 'variant-bonuses');
      if (bonuses.length > 0) {
        bonuses.forEach(b => {
          const tag = Utils.createElement('span', 'variant-bonus-tag', Utils.sanitizeText(b.text, 60));
          bonusesWrap.appendChild(tag);
        });
      } else {
        bonusesWrap.innerHTML = `<div class="text-xs text-slate-500">Бонусы: пока не активны</div>`;
      }

      const hint = Utils.createElement('div', 'variant-copy-hint');
      hint.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i><span>Скопировать</span>`;

      card.appendChild(header);
      card.appendChild(list);
      card.appendChild(bonusesWrap);
      card.appendChild(hint);

      card.addEventListener('click', async () => {
        const text = Variants.buildQuoteTextFor(key);
        const ok = await Utils.copyToClipboard(text);
        App.showToast(ok ? `КП (${v.label}) скопировано!` : 'Не удалось скопировать');
        Variants.close();
      });

      container.appendChild(card);
    });

    if (window.lucide) lucide.createIcons();
  },

  init: () => {
    document.getElementById('btn-open-variants')?.addEventListener('click', Variants.open);
    document.getElementById('btn-close-variants')?.addEventListener('click', Variants.close);
    document.getElementById('variants-modal')?.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'variants-modal') Variants.close();
    });
    console.log('✅ Variants module initialized');
  }
};

// ============================================
// INIT ALL MODULES
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  Templates.init();
  Rounding.init();
  Variants.init();
});

</script>
</body>
</html>
